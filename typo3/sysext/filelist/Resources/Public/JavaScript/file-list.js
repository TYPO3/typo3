/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{lll as c}from"@typo3/core/lit-helper.js";import T from"@typo3/core/document-service.js";import m from"@typo3/backend/notification.js";import P from"@typo3/backend/info-window.js";import{FileListActionSelector as M,FileListActionUtility as L,FileListActionEvent as p}from"@typo3/filelist/file-list-actions.js";import b from"@typo3/backend/icons.js";import v from"@typo3/core/ajax/ajax-request.js";import s from"@typo3/core/event/regular-event.js";import{ModuleStateStorage as E}from"@typo3/backend/storage/module-state-storage.js";import w from"@typo3/backend/modal.js";import{SeverityEnum as S}from"@typo3/backend/enum/severity.js";import U from"@typo3/backend/severity.js";import{MultiRecordSelectionSelectors as R}from"@typo3/backend/multi-record-selection.js";import k from"@typo3/backend/context-menu.js";import"@typo3/backend/element/progress-bar-element.js";var u;(function(g){g.fileListFormSelector='form[name="fileListForm"]',g.commandSelector='input[name="cmd"]',g.searchFieldSelector='input[name="searchTerm"]',g.pointerFieldSelector='input[name="pointer"]'})(u||(u={}));const y="typo3:filelist:openElementBrowser";class d{constructor(){this.downloadFilesAndFolders=t=>{t.preventDefault();const e=t.target,n=t.detail,i=n.configuration,r=[];n.checkboxes.forEach(a=>{if(a.checked){const l=a.closest(M.elementSelector),f=L.getResourceForElement(l);r.unshift(f)}}),r.length?this.triggerDownload(r,i.downloadUrl,e):m.warning(c("file_download.invalidSelection"))},new s(y,t=>{const e=new URL(t.detail.actionUrl,window.location.origin);e.searchParams.set("expandFolder",t.detail.identifier),e.searchParams.set("mode",t.detail.mode),w.advanced({type:w.types.iframe,content:e.toString(),size:w.sizes.large}).addEventListener("typo3-modal-hidden",()=>{top.list_frame.document.location.reload()})}).bindTo(document),new s(p.primary,t=>{const e=t.detail,n=e.resources[0],i=e.trigger.closest("[data-default-language-access]");if(n.type==="file"&&i!==null){const r=new URL(top.TYPO3.settings.FormEngine.moduleUrl,window.location.origin);n.metaUid>0?r.searchParams.set("edit[sys_file_metadata]["+n.metaUid+"]","edit"):(r.searchParams.set("edit[sys_file_metadata][0]","new"),r.searchParams.set("defVals[sys_file_metadata][file]",n.uid.toString(10))),r.searchParams.set("module",top.TYPO3.ModuleMenu.App.getCurrentModule()),r.searchParams.set("returnUrl",d.getReturnUrl("")),window.location.href=r.toString()}if(n.type==="folder"){const r=d.parseQueryParameters(document.location);r.id=n.identifier;const a=new URL(window.location.pathname,window.location.origin);for(const[l,f]of Object.entries(r))a.searchParams.set(l,f);window.location.href=a.toString()}}).bindTo(document),new s(p.primaryContextmenu,t=>{const e=t.detail,n=e.resources[0];k.show("sys_file",n.identifier,"","","",e.trigger,e.event)}).bindTo(document),new s(p.show,t=>{const n=t.detail.resources[0];d.openInfoPopup("_"+n.type.toUpperCase(),n.identifier)}).bindTo(document),new s(p.download,t=>{const e=t.detail,n=e.resources[0];this.triggerDownload([n],e.url,e.trigger)}).bindTo(document),new s(p.updateOnlineMedia,t=>{const e=t.detail,n=e.resources[0];this.updateOnlineMedia(n,e.url)}).bindTo(document),T.ready().then(()=>{d.processTriggers(),new s("click",(t,e)=>{t.preventDefault(),document.dispatchEvent(new CustomEvent(y,{detail:{actionUrl:e.href,identifier:e.dataset.identifier,mode:e.dataset.mode}}))}).delegateTo(document,".t3js-element-browser")}),new s("multiRecordSelection:action:edit",this.editFileMetadata).bindTo(document),new s("multiRecordSelection:action:delete",this.deleteMultiple).bindTo(document),new s("multiRecordSelection:action:download",this.downloadFilesAndFolders).bindTo(document),new s("multiRecordSelection:action:copyMarked",t=>{d.submitClipboardFormWithCommand("copyMarked",t.target)}).bindTo(document),new s("multiRecordSelection:action:removeMarked",t=>{d.submitClipboardFormWithCommand("removeMarked",t.target)}).bindTo(document);const o=document.querySelector([u.fileListFormSelector,u.searchFieldSelector].join(" "))?.value!=="";new s("search",t=>{const e=t.target;e.value===""&&o&&e.closest(u.fileListFormSelector)?.submit()}).delegateTo(document,u.searchFieldSelector)}static submitClipboardFormWithCommand(o,t){const e=t.closest(u.fileListFormSelector);if(!e)return;const n=e.querySelector(u.commandSelector);if(n){if(n.value=o,o==="copyMarked"||o==="removeMarked"){const i=e.querySelector(u.pointerFieldSelector),r=d.parseQueryParameters(document.location).pointer;i&&r&&(i.value=r)}e.submit()}}static openInfoPopup(o,t){P.showItem(o,t)}static processTriggers(){const o=document.querySelector(".filelist-main");o!==null&&E.update("media",o.dataset.filelistCurrentIdentifier)}static parseQueryParameters(o){const t=new URLSearchParams(o.search);return Object.fromEntries(t.entries())}static getReturnUrl(o){if(o===""){const t=top.list_frame.document.forms.namedItem("fileListForm");t!==null?o=t.action:o=top.list_frame.document.location.pathname+top.list_frame.document.location.search}return o}deleteMultiple(o){o.preventDefault();const e=o.detail.configuration;w.advanced({title:e.title||"Delete",content:e.content||"Are you sure you want to delete those files and folders?",severity:S.warning,buttons:[{text:TYPO3.lang["button.close"]||"Close",active:!0,btnClass:"btn-default",trigger:(n,i)=>i.hideModal()},{text:e.ok||TYPO3.lang["button.ok"]||"OK",btnClass:"btn-"+U.getCssClass(S.warning),trigger:(n,i)=>{d.submitClipboardFormWithCommand("delete",o.target),i.hideModal()}}]})}editFileMetadata(o){o.preventDefault();const t=o.detail,e=t.configuration;if(!e||!e.idField||!e.table)return;const n=[];if(t.checkboxes.forEach(i=>{const r=i.closest(R.elementSelector);r!==null&&r.dataset[e.idField]&&n.push(r.dataset[e.idField])}),n.length){const i=new URL(top.TYPO3.settings.FormEngine.moduleUrl,window.location.origin);i.searchParams.set("edit["+e.table+"]["+n.join(",")+"]","edit"),i.searchParams.set("returnUrl",d.getReturnUrl(e.returnUrl||"")),(e.columnsOnly||[]).forEach((a,l)=>{i.searchParams.set("columnsOnly["+e.table+"]["+l+"]",a)}),window.location.href=i.toString()}else m.warning("The selected elements can not be edited.")}triggerDownload(o,t,e){if(o.length===1){const a=o.at(0);if(a.type==="file"){this.invokeDownload(a.url,a.name);return}}m.info(c("file_download.prepare"),"",2);const n=e?.innerHTML;e&&(e.setAttribute("disabled","disabled"),b.getIcon("spinner-circle",b.sizes.small).then(a=>{e.innerHTML=a}));const i=this.getProgress();i.start();const r=o.map(a=>a.identifier);new v(t).post({items:r}).then(async a=>{let l=a.response.headers.get("Content-Disposition");if(!l){const h=await a.resolve();h.success===!1&&h.status?m.warning(c("file_download."+h.status),c("file_download."+h.status+".message"),10):m.error(c("file_download.error"));return}l=l.substring(l.indexOf(" filename=")+10);const f=await a.raw().arrayBuffer(),F=new Blob([f],{type:a.raw().headers.get("Content-Type")}),C=URL.createObjectURL(F);this.invokeDownload(C,l),m.success(c("file_download.success"),"",2)}).catch(()=>{m.error(c("file_download.error"))}).finally(()=>{i.done(),e&&(e.removeAttribute("disabled"),e.innerHTML=n)})}updateOnlineMedia(o,t){if(!t||!o.uid||o.type!=="file")return;const e=this.getProgress();e.start(),new v(t).post({resource:o}).then(()=>{m.success(c("online_media.update.success"))}).catch(()=>{m.error(c("online_media.update.error"))}).finally(()=>{e.done(),window.location.reload()})}invokeDownload(o,t){const e=document.createElement("a");e.href=o,e.download=t,document.body.appendChild(e),e.click(),URL.revokeObjectURL(o),document.body.removeChild(e)}getProgress(){return(!this.progressBar||!this.progressBar.isConnected)&&(this.progressBar=document.createElement("typo3-backend-progress-bar"),document.querySelector(".module-loading-indicator").appendChild(this.progressBar)),this.progressBar}}export{d as default,y as fileListOpenElementBrowser};
