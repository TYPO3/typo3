/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{lll as c}from"@typo3/core/lit-helper.js";import T from"@typo3/core/document-service.js";import m from"@typo3/backend/notification.js";import M from"@typo3/backend/info-window.js";import{FileListActionSelector as L,FileListActionUtility as R,FileListActionEvent as f}from"@typo3/filelist/file-list-actions.js";import w from"nprogress";import v from"@typo3/backend/icons.js";import S from"@typo3/core/ajax/ajax-request.js";import l from"@typo3/core/event/regular-event.js";import{ModuleStateStorage as E}from"@typo3/backend/storage/module-state-storage.js";import h from"@typo3/backend/modal.js";import{SeverityEnum as F}from"@typo3/backend/enum/severity.js";import U from"@typo3/backend/severity.js";import{MultiRecordSelectionSelectors as O}from"@typo3/backend/multi-record-selection.js";import D from"@typo3/backend/context-menu.js";var u;(function(p){p.fileListFormSelector='form[name="fileListForm"]',p.commandSelector='input[name="cmd"]',p.searchFieldSelector='input[name="searchTerm"]',p.pointerFieldSelector='input[name="pointer"]'})(u||(u={}));const y="typo3:filelist:openElementBrowser";class s{constructor(){this.downloadFilesAndFolders=t=>{t.preventDefault();const e=t.target,n=t.detail,r=n.configuration,i=[];n.checkboxes.forEach(a=>{if(a.checked){const d=a.closest(L.elementSelector),b=R.getResourceForElement(d);i.unshift(b)}}),i.length?this.triggerDownload(i,r.downloadUrl,e):m.warning(c("file_download.invalidSelection"))},new l(y,t=>{const e=new URL(t.detail.actionUrl,window.location.origin);e.searchParams.set("expandFolder",t.detail.identifier),e.searchParams.set("mode",t.detail.mode),h.advanced({type:h.types.iframe,content:e.toString(),size:h.sizes.large}).addEventListener("typo3-modal-hidden",()=>{top.list_frame.document.location.reload()})}).bindTo(document),new l(f.primary,t=>{const e=t.detail,n=e.resources[0],r=e.trigger.closest("[data-default-language-access]");if(n.type==="file"&&r!==null&&(window.location.href=top.TYPO3.settings.FormEngine.moduleUrl+"&edit[sys_file_metadata]["+n.metaUid+"]=edit&returnUrl="+s.getReturnUrl("")),n.type==="folder"){const i=s.parseQueryParameters(document.location);i.id=n.identifier;let a="";Object.keys(i).forEach(d=>{i[d]!==""&&(a=a+"&"+d+"="+i[d])}),window.location.href=window.location.pathname+"?"+a.substring(1)}}).bindTo(document),new l(f.primaryContextmenu,t=>{const e=t.detail,n=e.resources[0];D.show("sys_file",n.identifier,"","","",e.trigger,e.event)}).bindTo(document),new l(f.show,t=>{const n=t.detail.resources[0];s.openInfoPopup("_"+n.type.toUpperCase(),n.identifier)}).bindTo(document),new l(f.download,t=>{const e=t.detail,n=e.resources[0];this.triggerDownload([n],e.url,e.trigger)}).bindTo(document),new l(f.updateOnlineMedia,t=>{const e=t.detail,n=e.resources[0];this.updateOnlineMedia(n,e.url)}).bindTo(document),T.ready().then(()=>{s.processTriggers(),new l("click",(t,e)=>{t.preventDefault(),document.dispatchEvent(new CustomEvent(y,{detail:{actionUrl:e.href,identifier:e.dataset.identifier,mode:e.dataset.mode}}))}).delegateTo(document,".t3js-element-browser")}),new l("multiRecordSelection:action:edit",this.editFileMetadata).bindTo(document),new l("multiRecordSelection:action:delete",this.deleteMultiple).bindTo(document),new l("multiRecordSelection:action:download",this.downloadFilesAndFolders).bindTo(document),new l("multiRecordSelection:action:copyMarked",t=>{s.submitClipboardFormWithCommand("copyMarked",t.target)}).bindTo(document),new l("multiRecordSelection:action:removeMarked",t=>{s.submitClipboardFormWithCommand("removeMarked",t.target)}).bindTo(document);const o=document.querySelector([u.fileListFormSelector,u.searchFieldSelector].join(" "))?.value!=="";new l("search",t=>{const e=t.target;e.value===""&&o&&e.closest(u.fileListFormSelector)?.submit()}).delegateTo(document,u.searchFieldSelector)}static submitClipboardFormWithCommand(o,t){const e=t.closest(u.fileListFormSelector);if(!e)return;const n=e.querySelector(u.commandSelector);if(n){if(n.value=o,o==="copyMarked"||o==="removeMarked"){const r=e.querySelector(u.pointerFieldSelector),i=s.parseQueryParameters(document.location).pointer;r&&i&&(r.value=i)}e.submit()}}static openInfoPopup(o,t){M.showItem(o,t)}static processTriggers(){const o=document.querySelector(".filelist-main");o!==null&&E.update("media",o.dataset.filelistCurrentIdentifier)}static parseQueryParameters(o){const t={};if(o&&Object.prototype.hasOwnProperty.call(o,"search")){const e=o.search.substr(1).split("&");for(let n=0;n<e.length;n++){const r=e[n].split("=");t[decodeURIComponent(r[0])]=decodeURIComponent(r[1])}}return t}static getReturnUrl(o){if(o===""){const t=top.list_frame.document.forms.namedItem("fileListForm");t!==null?o=t.action:o=top.list_frame.document.location.pathname+top.list_frame.document.location.search}return encodeURIComponent(o)}deleteMultiple(o){o.preventDefault();const e=o.detail.configuration;h.advanced({title:e.title||"Delete",content:e.content||"Are you sure you want to delete those files and folders?",severity:F.warning,buttons:[{text:TYPO3.lang["button.close"]||"Close",active:!0,btnClass:"btn-default",trigger:(n,r)=>r.hideModal()},{text:e.ok||TYPO3.lang["button.ok"]||"OK",btnClass:"btn-"+U.getCssClass(F.warning),trigger:(n,r)=>{s.submitClipboardFormWithCommand("delete",o.target),r.hideModal()}}]})}editFileMetadata(o){o.preventDefault();const t=o.detail,e=t.configuration;if(!e||!e.idField||!e.table)return;const n=[];if(t.checkboxes.forEach(r=>{const i=r.closest(O.elementSelector);i!==null&&i.dataset[e.idField]&&n.push(i.dataset[e.idField])}),n.length){let r=top.TYPO3.settings.FormEngine.moduleUrl+"&edit["+e.table+"]["+n.join(",")+"]=edit&returnUrl="+s.getReturnUrl(e.returnUrl||"");const i=e.columnsOnly||[];i.length>0&&(r+=i.map((a,d)=>"&columnsOnly["+e.table+"]["+d+"]="+a).join("")),window.location.href=r}else m.warning("The selected elements can not be edited.")}triggerDownload(o,t,e){if(o.length===1){const i=o.at(0);if(i.type==="file"){this.invokeDownload(i.url,i.name);return}}m.info(c("file_download.prepare"),"",2);const n=e?.innerHTML;e&&(e.setAttribute("disabled","disabled"),v.getIcon("spinner-circle",v.sizes.small).then(i=>{e.innerHTML=i})),w.configure({parent:"#typo3-filelist",showSpinner:!1}).start();const r=o.map(i=>i.identifier);new S(t).post({items:r}).then(async i=>{let a=i.response.headers.get("Content-Disposition");if(!a){const g=await i.resolve();g.success===!1&&g.status?m.warning(c("file_download."+g.status),c("file_download."+g.status+".message"),10):m.error(c("file_download.error"));return}a=a.substring(a.indexOf(" filename=")+10);const d=await i.raw().arrayBuffer(),b=new Blob([d],{type:i.raw().headers.get("Content-Type")}),C=URL.createObjectURL(b);this.invokeDownload(C,a),m.success(c("file_download.success"),"",2)}).catch(()=>{m.error(c("file_download.error"))}).finally(()=>{w.done(),e&&(e.removeAttribute("disabled"),e.innerHTML=n)})}updateOnlineMedia(o,t){!t||!o.uid||o.type!=="file"||(w.configure({parent:"#typo3-filelist",showSpinner:!1}).start(),new S(t).post({resource:o}).then(()=>{m.success(c("online_media.update.success"))}).catch(()=>{m.error(c("online_media.update.error"))}).finally(()=>{w.done(),window.location.reload()}))}invokeDownload(o,t){const e=document.createElement("a");e.href=o,e.download=t,document.body.appendChild(e),e.click(),URL.revokeObjectURL(o),document.body.removeChild(e)}}export{s as default,y as fileListOpenElementBrowser};
