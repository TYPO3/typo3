/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{MessageUtility as u}from"@typo3/backend/utility/message-utility.js";import f from"@typo3/backend/element-browser.js";import a from"@typo3/core/event/regular-event.js";import m from"@typo3/backend/icons.js";import{FileListActionSelector as g,FileListActionUtility as h,FileListActionEvent as r}from"@typo3/filelist/file-list-actions.js";import y from"@typo3/backend/info-window.js";import w from"@typo3/core/ajax/ajax-request.js";class l{constructor(){this.importSelection=e=>{e.preventDefault();const t=e.target,n=e.detail.checkboxes;if(!n.length)return;const o=[];n.forEach(i=>{if(i.checked){const s=i.closest(g.elementSelector),c=h.getResourceForElement(s);c.type==="file"&&c.uid&&o.unshift(c)}}),o.length&&(m.getIcon("spinner-circle",m.sizes.small,null,null,m.markupIdentifiers.inline).then(i=>{t.classList.add("disabled"),t.innerHTML=i}),l.handleNext(o),new a("message",i=>{if(!u.verifyOrigin(i.origin))throw"Denied message sent by "+i.origin;i.data.actionName==="typo3:foreignRelation:inserted"&&(o.length>0?l.handleNext(o):f.focusOpenerAndClose())}).bindTo(window))},new a(r.primary,e=>{e.preventDefault();const t=e.detail;t.originalAction=r.primary,t.action=r.select,document.dispatchEvent(new CustomEvent(r.select,{detail:t}))}).bindTo(document),new a(r.select,e=>{e.preventDefault();const t=e.detail,n=t.resources[0];n.type==="file"&&l.insertElement(n.name,n.uid,t.originalAction===r.primary),n.type==="folder"&&this.loadContent(n)}).bindTo(document),new a(r.show,e=>{e.preventDefault();const n=e.detail.resources[0];y.showItem("_"+n.type.toUpperCase(),n.identifier)}).bindTo(document),new a("multiRecordSelection:action:import",this.importSelection).bindTo(document)}static insertElement(e,t,n){return f.insertElement("sys_file",String(t),e,String(t),n)}static handleNext(e){if(e.length>0){const t=e.pop();l.insertElement(t.name,Number(t.uid))}}async loadContent(e){if(e.type!=="folder")return;const t=document.location.href+"&contentOnly=1&expandFolder="+e.identifier,o=await(await new w(t).get()).resolve(),i=document.querySelector(".element-browser-main-content .element-browser-body");i.innerHTML=o;const s=document.querySelector("typo3-backend-component-filestorage-browser-tree");if(s){const c=encodeURIComponent(e.identifier),d=s.nodes.find(p=>p.identifier===c);d&&(await s.expandNodeParents(d),s.selectNode(d,!1))}}}var b=new l;export{b as default};
