/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{customElement as D}from"lit/decorators.js";import{Tree as T}from"@typo3/backend/tree/tree.js";import{TreeNodePositionEnum as d}from"@typo3/backend/tree/tree-node.js";import{DataTransferTypes as _}from"@typo3/backend/enum/data-transfer-types.js";import{FORM_EDITOR_TREE_EVENTS as N}from"@typo3/form/backend/form-editor-tree-events.js";var y=function(h,e,t,i){var s=arguments.length,r=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(h,e,t,i);else for(var n=h.length-1;n>=0;n--)(a=h[n])&&(r=(s<3?a(r):s>3?a(e,t,r):a(e,t))||r);return s>3&&r&&Object.defineProperty(e,t,r),r};const C=0,g=1,O="node-validation-error",P="node-validation-error",S="overlay-missing";let E=class extends T{constructor(){super(),this.nodeMetadata=new Map,this.nodeValidationState=new Map,this.settings.showIcons=!0,this.settings.defaultProperties={hasChildren:!1,nameSourceField:"label",type:"form_element",prefix:"",suffix:"",locked:!1,loaded:!0,overlayIcon:"",selectable:!0,expanded:!1,checked:!1},this.settings.dataUrl="",this.settings.filterUrl="",this.allowNodeEdit=!1,this.allowNodeDrag=!0,this.allowNodeSorting=!0}setNodes(e){this.syncExpandedStates(),this.nodeMetadata.clear();const t=this.convertToTreeNodes(e);this.nodes=this.enhanceNodes(t),this.requestUpdate()}setSelectedNode(e){const t=this.nodes.find(i=>i.identifier===e);t&&this.selectNode(t,!1)}setNodeValidationError(e,t=!0){const i=this.nodeValidationState.get(e)||{hasError:!1,childHasError:!1};i.hasError=t,this.nodeValidationState.set(e,i);const s=this.nodes.find(r=>r.identifier===e);s&&this.updateNodeOverlayIcon(s,t),this.requestUpdate()}setNodeChildHasError(e,t=!0){const i=this.nodeValidationState.get(e)||{hasError:!1,childHasError:!1};i.childHasError=t,this.nodeValidationState.set(e,i),this.requestUpdate()}clearAllValidationErrors(){this.nodeValidationState.forEach((e,t)=>{if(e.hasError){const i=this.nodes.find(s=>s.identifier===t);i&&this.updateNodeOverlayIcon(i,!1)}}),this.nodeValidationState.clear(),this.requestUpdate()}updateNodeOverlayIcon(e,t){const i=this.getOriginalOverlayIcon(e);t?e.overlayIcon=S:e.overlayIcon=i}getOriginalOverlayIcon(e){const t=this.nodeMetadata.get(e.identifier);return t?t.originalOverlayIcon:""}getNodeValidationState(e){return this.nodeValidationState.get(e)||null}search(e){this.filter(e)}filter(e){if(typeof e=="string"&&(this.searchTerm=e),this.searchTerm){const t=this.searchTerm.toLowerCase();this.nodes.forEach(i=>{this.nodeMatchesSearchTerm(i,t)?(i.__hidden=!1,this.showParentNodes(i)):i.__hidden=!0})}else this.nodes.forEach(t=>{t.__hidden=!1});this.requestUpdate()}nodeMatchesSearchTerm(e,t){return e.name.toLowerCase().includes(t)||e.identifier.toLowerCase().includes(t)||e.note&&e.note.toLowerCase().includes(t)}async loadData(){this.loading=!1}async fetchData(){return[]}async loadChildren(e){e.loaded=!0}hideChildren(e){e.__expanded=!1,this.saveNodeStatus(e),this.dispatchEvent(new CustomEvent("typo3:tree:expand-toggle",{detail:{node:e}})),this.requestUpdate()}async showChildren(e){e.__expanded=!0,await this.loadChildren(e),this.saveNodeStatus(e),this.dispatchEvent(new CustomEvent("typo3:tree:expand-toggle",{detail:{node:e}})),this.requestUpdate()}selectNode(e,t=!0){super.selectNode(e,t),this.requestUpdate(),this.dispatchEvent(new CustomEvent("typo3:form-editor-tree:node-clicked",{detail:{identifierPath:e.identifier},bubbles:!0,composed:!0}))}async moveNode(e,t,i){const s=e.identifier,r=t.identifier,a=e.parentIdentifier,n=this.getParentNode(e);let l,o;i===d.INSIDE?(l=r,o=t):(l=t.parentIdentifier,o=this.getParentNode(t));const f=Array.from(this.nodes),c=f.indexOf(t);let p="",u="";i===d.BEFORE?(c>0&&(p=f[c-1].identifier),u=r):i===d.AFTER&&(p=r,c<f.length-1&&(u=f[c+1].identifier));const I=a!==l,v=this.nodes.indexOf(e);v>-1&&this.nodeMap.splice(v,1),e.parentIdentifier=l,o?e.depth=o.depth+1:e.depth=0,n&&this.getNodeChildren(n).length===0&&(n.hasChildren=!1,n.__expanded=!1),o&&(o.hasChildren||(o.hasChildren=!0,o.__expanded=!0),o.__expanded||await this.showChildren(o));let m=this.nodes.indexOf(t);(i===d.INSIDE||i===d.AFTER)&&m++,this.nodeMap.splice(m,0,e),this.requestUpdate(),I?this.dispatchEvent(new CustomEvent("typo3:form-editor-tree:dnd-change",{detail:{itemIdentifierPath:s,parentIdentifierPath:l,position:i,previousIdentifierPath:p,nextIdentifierPath:u},bubbles:!0,composed:!0})):this.dispatchEvent(new CustomEvent("typo3:form-editor-tree:dnd-update",{detail:{movedIdentifierPath:s,previousIdentifierPath:p,nextIdentifierPath:u},bubbles:!0,composed:!0}))}async firstUpdated(){await super.firstUpdated()}getNodeClasses(e){const t=super.getNodeClasses(e),i=this.nodeValidationState.get(e.identifier);return i&&(i.hasError&&t.push(O),i.childHasError&&t.push(P)),t}handleNodeDrop(e){const t=super.handleNodeDrop(e);return this.cleanDrag(),t&&(this.nodeDragMode=null,this.nodeDragPosition=null,this.refreshDragToolTip(),window.dispatchEvent(new DragEvent("dragend",{bubbles:!0,cancelable:!1}))),t}handleNodeDoubleClick(e,t){e.preventDefault(),e.stopPropagation(),this.dispatchFormEditorEvent(N.NODE_EDIT,{identifierPath:t.identifier,currentLabel:t.name})}handleNodeDelete(e){this.dispatchFormEditorEvent(N.NODE_DELETE,{identifierPath:e.identifier})}handleNodeMove(){}handleNodeDragStart(e,t){if(t.depth===0){e.preventDefault();return}super.handleNodeDragStart(e,t)}createDataTransferItemsFromNode(e){return[{type:_.treenode,data:this.getNodeTreeIdentifier(e)}]}handleNodeDragOver(e){if(!super.handleNodeDragOver(e))return!1;const i=this.getNodeFromDragEvent(e);return!i||!this.draggingNode?!1:this.isDropAllowedForFormEditor(this.draggingNode,i,this.nodeDragPosition)?!0:(this.nodeDragMode=null,this.nodeDragPosition=null,this.refreshDragToolTip(),this.cleanDrag(),!1)}isDropAllowedForFormEditor(e,t,i){if(e===t||e.depth===C)return!1;const s=this.getFormElementByNode(e);if(s?.isTopLevel&&i===d.INSIDE)return!1;const r=this.getTargetDepthAfterDrop(t,i);if(s?.isTopLevel&&r!==g)return!1;if(r===g){const a=this.getFormElementByNode(e);if(a&&!a.isTopLevel)return!1}if(i===d.INSIDE){const a=this.getFormElementByNode(t);if(a&&!a.isComposite||a?.isTopLevel&&s?.isTopLevel)return!1}return!this.isNodeDescendantOf(t,e)}getTargetDepthAfterDrop(e,t){return t===d.INSIDE?e.depth+1:e.depth}getFormElementByNode(e){const t=this.nodeMetadata.get(e.identifier);return t?{identifier:e.identifier,identifierPath:e.identifier,label:e.name,type:e.recordType,iconIdentifier:e.icon,isComposite:t.isComposite,isTopLevel:t.isTopLevel,enabled:!e.overlayIcon?.includes("hidden")}:null}isNodeDescendantOf(e,t){return e.__treeParents.includes(t.__treeIdentifier)}dispatchFormEditorEvent(e,t){this.dispatchEvent(new CustomEvent(e,{detail:t,bubbles:!0,composed:!0}))}syncExpandedStates(){this.nodes&&this.nodes.length>0&&this.nodes.forEach(e=>{this.saveNodeStatus(e)})}showParentNodes(e){e.__treeParents&&e.__treeParents.length>0&&e.__treeParents.forEach(t=>{const i=this.getNodeByTreeIdentifier(t);i&&(i.__hidden=!1,i.__expanded=!0)})}convertToTreeNodes(e,t="",i=0){const s=[];return e.forEach(r=>{const a=r.enabled===!1?"overlay-hidden":"";this.nodeMetadata.set(r.identifierPath,{isComposite:r.isComposite,isTopLevel:r.isTopLevel,originalOverlayIcon:a});const n={type:"form_element",identifier:r.identifierPath,parentIdentifier:t,recordType:r.type,name:r.label,note:r.type?r.type:"",prefix:"",suffix:"",tooltip:`identifier=${r.identifier}`,depth:i,hasChildren:r.isComposite&&!!r.children&&r.children.length>0,loaded:!0,editable:!1,deletable:!1,icon:r.iconIdentifier,overlayIcon:r.enabled===!1?"overlay-hidden":"",statusInformation:[],labels:[],nameSourceField:"label",locked:!1,selectable:!0};if(s.push(n),r.children&&r.children.length>0){const l=this.convertToTreeNodes(r.children,r.identifierPath,i+1);s.push(...l)}}),s}};E=y([D("typo3-backend-navigation-component-formeditor-tree")],E);export{E as FormEditorTree};
