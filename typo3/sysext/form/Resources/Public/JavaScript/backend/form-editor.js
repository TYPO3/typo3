/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import a from"jquery";import c from"@typo3/backend/notification.js";import*as l from"@typo3/form/backend/form-editor/core.js";const n=l.assert;class g{constructor(t,e,i){this.isRunning=!1,this.unsavedContent=!1,this.configuration=t||{},this.mediator=e,this.viewModel=i}getPublisherSubscriber(){return l.getPublisherSubscriber()}undoApplicationState(){this.getApplicationStateStack().incrementCurrentStackPointer()}redoApplicationState(){this.getApplicationStateStack().decrementCurrentStackPointer()}getMaximalApplicationStates(){return this.getApplicationStateStack().getMaximalStackSize()}getCurrentApplicationStates(){return this.getApplicationStateStack().getCurrentStackSize()}getCurrentApplicationStatePosition(){return this.getApplicationStateStack().getCurrentStackPointer()}setFormDefinition(t){n(a.type(t)==="object",'Invalid parameter "formDefinition"',1519855175),this.getApplicationStateStack().setCurrentState("formDefinition",this.getFactory().createFormElement(t,void 0,void 0,!0))}getRunningAjaxRequest(t){return n(this.getUtility().isNonEmptyString(t),'Invalid parameter "type"',1475378543),l.getRunningAjaxRequest(t)}getUtility(){return l.getUtility()}assert(t,e,i){this.getUtility().assert(t,e,i)}buildPropertyPath(t,e,i,r,o){this.getUtility().isUndefinedOrNull(r)&&(r=this.getCurrentlySelectedFormElement());const s=this.getRepository().findFormElement(r);return this.getUtility().buildPropertyPath(t,e,i,s,o)}addPropertyValidationValidator(t,e){this.getPropertyValidationService().addValidator(t,e)}validateCurrentlySelectedFormElementProperty(t){return this.validateFormElementProperty(this.getCurrentlySelectedFormElement(),t)}validateFormElementProperty(t,e){const i=this.getRepository().findFormElement(t);return this.getPropertyValidationService().validateFormElementProperty(i,e)}validateFormElement(t){const e=this.getRepository().findFormElement(t);return this.getPropertyValidationService().validateFormElement(e)}validationResultsHasErrors(t){return this.getPropertyValidationService().validationResultsHasErrors(t)}validateFormElementRecursive(t,e){const i=this.getRepository().findFormElement(t);return this.getPropertyValidationService().validateFormElementRecursive(i,e)}setUnsavedContent(t){n(a.type(t)==="boolean",'Invalid parameter "unsavedContent"',1475378544),this.unsavedContent=t}getUnsavedContent(){return this.unsavedContent}getRootFormElement(){return this.getRepository().getRootFormElement()}getCurrentlySelectedFormElement(){return this.getRepository().findFormElementByIdentifierPath(this.getApplicationStateStack().getCurrentState("currentlySelectedFormElementIdentifierPath"))}setCurrentlySelectedFormElement(t,e){e=!!e;const i=this.getRepository().findFormElement(t);this.getApplicationStateStack().setCurrentState("currentlySelectedFormElementIdentifierPath",i.get("__identifierPath")),e||this.refreshCurrentlySelectedPageIndex(),this.getPublisherSubscriber().publish("core/currentlySelectedFormElementChanged",[i])}getFormElementByIdentifierPath(t){return n(this.getUtility().isNonEmptyString(t),'Invalid parameter "identifierPath"',1475378545),this.getRepository().findFormElementByIdentifierPath(t)}isFormElementIdentifierUsed(t){return this.getRepository().isFormElementIdentifierUsed(t)}createAndAddFormElement(t,e,i){const r=this.addFormElement(this.createFormElement(t,i),e,i);return r.set("renderables",r.get("renderables")),r}addFormElement(t,e,i){this.saveApplicationState(),this.getUtility().isUndefinedOrNull(e)&&(e=this.getCurrentlySelectedFormElement());const r=this.getRepository().findFormElement(e);return n(a.type(t)==="object",'Invalid parameter "formElement"',1475434337),this.getRepository().addFormElement(t,r,!0,i)}createFormElement(t,e){n(this.getUtility().isNonEmptyString(t),'Invalid parameter "formElementType"',1475434336);const i=this.getRepository().getNextFreeFormElementIdentifier(t),r=this.getFormElementDefinitionByType(t,void 0);return this.getFactory().createFormElement({type:t,identifier:i,label:r.label||t},void 0,void 0,void 0,e)}removeFormElement(t,e){this.saveApplicationState();const i=this.getRepository().findFormElement(t),r=i.get("__parentRenderable");return this.getRepository().removeFormElement(i,!0,e),r}moveFormElement(t,e,i,r){this.saveApplicationState();let o=this.getRepository().findFormElement(t);const s=this.getRepository().findFormElement(i);return n(e==="after"||e==="before"||e==="inside",'Invalid position "'+e+'"',1475378551),o=this.getRepository().moveFormElement(o,e,s,!0),r=!!r,r||o.get("__parentRenderable").set("renderables",o.get("__parentRenderable").get("renderables")),o}getPropertyCollectionElementConfiguration(t,e,i){let r,o;this.getUtility().isUndefinedOrNull(i)&&(i=this.getCurrentlySelectedFormElement());const s=this.getRepository().findFormElement(i);n(this.getUtility().isNonEmptyString(t),'Invalid parameter "collectionElementIdentifier"',1475378555),n(this.getUtility().isNonEmptyString(e),'Invalid parameter "collectionName"',1475378556);const p=this.getFormElementDefinitionByType(s.get("type"),void 0);return this.getUtility().isUndefinedOrNull(p.propertyCollections)?{}:(r=p.propertyCollections[e],n(!this.getUtility().isUndefinedOrNull(r),'Invalid collection name "'+e+'"',1475446108),o=this.getRepository().findCollectionElementByIdentifierPath(t,r),a.extend(!0,{},o))}getIndexFromPropertyCollectionElement(t,e,i){this.getUtility().isUndefinedOrNull(i)&&(i=this.getCurrentlySelectedFormElement());const r=this.getRepository().findFormElement(i);return n(this.getUtility().isNonEmptyString(t),'Invalid parameter "collectionElementIdentifier"',1475378557),n(this.getUtility().isNonEmptyString(e),'Invalid parameter "collectionName"',1475378558),this.getRepository().getIndexFromPropertyCollectionElementByIdentifier(t,e,r)}createAndAddPropertyCollectionElement(t,e,i,r,o){return this.addPropertyCollectionElement(this.createPropertyCollectionElement(t,e,r),e,i,o)}addPropertyCollectionElement(t,e,i,r){let o;this.saveApplicationState(),this.getUtility().isUndefinedOrNull(i)&&(i=this.getCurrentlySelectedFormElement());const s=this.getRepository().findFormElement(i);return n(a.type(t)==="object",'Invalid parameter "collectionElement"',1475443301),n(this.getUtility().isNonEmptyString(e),'Invalid parameter "collectionName"',1475443300),this.getUtility().isUndefinedOrNull(r)&&(o=s.get(e),a.type(o)==="array"&&o.length>0&&(r=o[o.length-1].identifier)),this.getRepository().addPropertyCollectionElement(t,e,s,r,!1)}createPropertyCollectionElement(t,e,i){return n(this.getUtility().isNonEmptyString(t),'Invalid parameter "collectionElementIdentifier"',1475378559),n(this.getUtility().isNonEmptyString(e),'Invalid parameter "collectionName"',1475378560),a.type(i)!=="object"&&(i={}),this.getFactory().createPropertyCollectionElement(t,i,e)}removePropertyCollectionElement(t,e,i,r){this.saveApplicationState(),this.getUtility().isUndefinedOrNull(i)&&(i=this.getCurrentlySelectedFormElement());const o=this.getRepository().findFormElement(i);n(this.getUtility().isNonEmptyString(t),'Invalid parameter "collectionElementIdentifier"',1475378561),n(this.getUtility().isNonEmptyString(e),'Invalid parameter "collectionName"',1475378562),this.getRepository().removePropertyCollectionElementByIdentifier(o,t,e,!0),r=!!r,r||this.getPublisherSubscriber().publish("core/formElement/somePropertyChanged",["__fakeProperty"])}movePropertyCollectionElement(t,e,i,r,o,s){this.saveApplicationState(),o=this.getRepository().findFormElement(o),n(a.type(t)==="string",'Invalid parameter "collectionElementToMove"',1477404352),n(a.type(i)==="string",'Invalid parameter "referenceCollectionElement"',1477404353),n(e==="after"||e==="before",'Invalid position "'+e+'"',1477404354),n(this.getUtility().isNonEmptyString(r),'Invalid parameter "collectionName"',1477404355),this.getRepository().movePropertyCollectionElement(t,e,i,r,o,s)}getFormElementDefinitionByType(t,e){n(this.getUtility().isNonEmptyString(t),'Invalid parameter "elementType"',1475378563);const i=this.getRepository().getFormEditorDefinition("formElements",t);if(e!==void 0){const r=i[e];return r!==null&&typeof r=="object"?a.extend(!0,{},r):r}return i!==null&&typeof i=="object"?a.extend(!0,{},i):i}getFormElementDefinition(t,e){return t=this.getRepository().findFormElement(t),this.getFormElementDefinitionByType(t.get("type"),e)}getFormEditorDefinition(t,e){return this.getRepository().getFormEditorDefinition(t,e)}getFormElementPropertyValidatorDefinition(t){n(this.getUtility().isNonEmptyString(t),'Invalid parameter "validatorIdentifier"',1475672362);const e=this.getRepository().getFormEditorDefinition("formElementPropertyValidators",t);return a.extend(!0,{},e)}getCurrentlySelectedPageIndex(){return this.getApplicationStateStack().getCurrentState("currentlySelectedPageIndex")}refreshCurrentlySelectedPageIndex(){this.getApplicationStateStack().setCurrentState("currentlySelectedPageIndex",this.getPageIndexFromFormElement(this.getCurrentlySelectedFormElement()))}getCurrentlySelectedPage(){const t=this.getRepository().getRootFormElement().get("renderables")[this.getCurrentlySelectedPageIndex()];return n(a.type(t)==="object","No page found",1477786068),t}getLastTopLevelElementOnCurrentPage(){const t=this.getCurrentlySelectedPage().get("renderables");if(!this.getUtility().isUndefinedOrNull(t))return t[t.length-1]}getLastFormElementWithinParentFormElement(t){return t=this.getRepository().findFormElement(t),t.get("__identifierPath")===this.getRootFormElement().get("__identifierPath")?t:t.get("__parentRenderable").get("renderables")[t.get("__parentRenderable").get("renderables").length-1]}getPageIndexFromFormElement(t){return t=this.getRepository().findFormElement(t),this.getRepository().getIndexForEnclosingCompositeFormElementWhichIsOnTopLevelForFormElement(t)}renderCurrentFormPage(){this.renderFormPage(this.getCurrentlySelectedPageIndex())}renderFormPage(t){n(a.type(t)==="number",'Invalid parameter "pageIndex"',1475446442),this.getDataBackend().renderFormDefinitionPage(t)}findEnclosingCompositeFormElementWhichIsNotOnTopLevel(t){return this.getRepository().findEnclosingCompositeFormElementWhichIsNotOnTopLevel(this.getRepository().findFormElement(t))}findEnclosingGridRowFormElement(t){return this.getRepository().findEnclosingGridRowFormElement(this.getRepository().findFormElement(t))}getNonCompositeNonToplevelFormElements(){return this.getRepository().getNonCompositeNonToplevelFormElements()}isRootFormElementSelected(){return this.getCurrentlySelectedFormElement().get("__identifierPath")===this.getRootFormElement().get("__identifierPath")}getViewModel(){return this.viewModel}saveFormDefinition(){this.getDataBackend().saveFormDefinition()}run(){if(this.isRunning)throw"You can not run the app twice (1473200696)";try{this.bootstrap(),this.isRunning=!0}catch(t){if(!(t instanceof Error))throw t;c.error(TYPO3.lang["formEditor.error.headline"],TYPO3.lang["formEditor.error.message"]+`\r
\r
`+TYPO3.lang["formEditor.error.technicalReason"]+`\r
`+t.message)}return this}saveApplicationState(){this.getApplicationStateStack().addAndReset({formDefinition:this.getApplicationStateStack().getCurrentState("formDefinition").clone(),currentlySelectedPageIndex:this.getApplicationStateStack().getCurrentState("currentlySelectedPageIndex"),currentlySelectedFormElementIdentifierPath:this.getApplicationStateStack().getCurrentState("currentlySelectedFormElementIdentifierPath")})}getDataBackend(){return l.getDataBackend()}getFactory(){return l.getFactory()}getRepository(){return l.getRepository()}getPropertyValidationService(){return l.getPropertyValidationService()}getApplicationStateStack(){return l.getApplicationStateStack()}ajaxSetup(){a.ajaxSetup({beforeSend:()=>{this.getPublisherSubscriber().publish("ajax/beforeSend")},complete:()=>{this.getPublisherSubscriber().publish("ajax/complete")}})}dataBackendSetup(t,e,i){n(a.type(t)==="object",'Invalid parameter "endpoints"',1475379748),n(this.getUtility().isNonEmptyString(e),'Invalid parameter "prototypeName"',1475927876),n(this.getUtility().isNonEmptyString(i),'Invalid parameter "formPersistenceIdentifier"',1475379749),l.getDataBackend().setEndpoints(t),l.getDataBackend().setPrototypeName(e),l.getDataBackend().setPersistenceIdentifier(i)}repositorySetup(t){n(a.type(t)==="object",'Invalid parameter "formEditorDefinitions"',1475379750),this.getRepository().setFormEditorDefinitions(t)}viewSetup(t){n(a.type(this.viewModel.bootstrap)==="function",'The view model does not implement the method "bootstrap"',1475492374),this.getUtility().isUndefinedOrNull(t)&&(t=[]),this.viewModel.bootstrap(m,t)}mediatorSetup(){n(a.type(this.mediator.bootstrap)==="function",'The mediator does not implement the method "bootstrap"',1475492032),this.mediator.bootstrap(m,this.viewModel)}applicationStateStackSetup(t,e){n(a.type(t)==="object",'Invalid parameter "rootFormElement"',1475379751),a.type(e)!=="number"&&(e=10),this.getApplicationStateStack().setMaximalStackSize(e),this.getApplicationStateStack().addAndReset({currentlySelectedPageIndex:0,currentlySelectedFormElementIdentifierPath:t.identifier},!0),this.getApplicationStateStack().setCurrentState("formDefinition",this.getFactory().createFormElement(t,void 0,void 0,!0))}bootstrap(){this.mediatorSetup(),this.ajaxSetup(),this.dataBackendSetup(this.configuration.endpoints,this.configuration.prototypeName,this.configuration.formPersistenceIdentifier),this.repositorySetup(this.configuration.formEditorDefinitions),this.applicationStateStackSetup(this.configuration.formDefinition,this.configuration.maximumUndoSteps),this.setCurrentlySelectedFormElement(this.getRepository().getRootFormElement()),this.viewSetup(this.configuration.additionalViewModelModules)}}let m=null;function h(d,t,e){return m===null&&(m=new g(d,t,e)),m}export{g as FormEditor,h as getInstance};
