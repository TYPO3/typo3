/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import i from"jquery";import*as _ from"@typo3/form/backend/form-editor/helper.js";import P from"@typo3/backend/icons.js";import W from"sortablejs";var u;(function(e){e.hidden="hidden",e.connect="connect",e.line="line",e.last="last"})(u||(u={}));const j={domElementClassNames:{collapsed:"collapsed",expanded:"expanded",hasChildren:"has-children",sortable:"sortable",noNesting:"no-nesting"},domElementDataAttributeNames:{abstractType:"data-element-abstract-type"},domElementDataAttributeValues:{collapse:"actions-chevron-end",expander:"treeExpander",title:"treeTitle"},isSortable:!0};let F=null,A=null,f=null;const p={};function d(){return A}function r(e){return m().isUndefinedOrNull(e)?_.setConfiguration(F):_.setConfiguration(e)}function m(){return d().getUtility()}function N(e,t,n){return d().assert(e,t,n)}function x(){return d().getRootFormElement()}function k(){return d().getCurrentlySelectedFormElement()}function g(){return d().getPublisherSubscriber()}function h(e,t){return d().getFormElementDefinition(e,t)}function C(e){const t=document.createElement("span");return t.classList.add("formeditor-tree-line","formeditor-tree-line--"+e),t}function w(e,t,n){N(i.type(e)==="object",'Invalid parameter "formElement"',1478715704);const a=i("<li></li>");h(e,"_isCompositeFormElement")||a.addClass(r().getDomElementClassName("noNesting"));const l=i("<div></div>").addClass("formeditor-tree-item").attr(r().getDomElementDataAttribute("elementIdentifier"),e.get("__identifierPath")).append(i("<span></span>").addClass("formeditor-tree-title").attr(r().getDomElementDataAttribute("identifier"),r().getDomElementDataAttributeValue("title")).append(T(e)));h(e,"_isCompositeFormElement")&&l.attr(r().getDomElementDataAttribute("abstractType"),"isCompositeFormElement"),h(e,"_isTopLevelFormElement")&&l.attr(r().getDomElementDataAttribute("abstractType"),"isTopLevelFormElement");const s=document.createElement("span");s.classList.add("caret");const o=i("<span></span>").addClass("formeditor-tree-expander").attr("data-identifier",r().getDomElementDataAttributeValue("expander")).append(s);l.prepend(o);const D=e.get("renderingOptions.enabled")===!1?"overlay-hidden":null;P.getIcon(h(e,"iconIdentifier"),P.sizes.small,D,P.states.default).then(function(b){o.after(i("<span></span>").addClass("formeditor-tree-icon").addClass(r().getDomElementClassName("icon")).attr("title","id = "+e.get("identifier")).append(b)),h(e,"_isCompositeFormElement")?e.get("renderables")&&e.get("renderables").length>0?(o.before(C(t!=n?u.connect:u.last)),a.addClass(r().getDomElementClassName("hasChildren"))):o.before(C(u.connect)).remove():(l.prepend(C(t!=n?u.connect:u.last)),o.remove());let c=e.get("__parentRenderable");for(;c&&c.get("__identifierPath")!==x().get("__identifierPath");)c.get("__identifierPath")===d().getLastFormElementWithinParentFormElement(c).get("__identifierPath")?l.prepend(C(u.hidden)):l.prepend(C(u.line)),c=c.get("__parentRenderable")}),a.append(l),g().publish("view/tree/render/listItemAdded",[a,e]);const I=e.get("renderables");let y=null;if(i.type(I)==="array"){y=i("<ol></ol>");for(let b=0,c=I.length;b<c;++b)y.append(w(I[b],b+1,c))}return y&&a.append(y),a}function V(){const e={handle:"div"+r().getDomElementDataAttribute("elementIdentifier","bracesWithKey"),draggable:"li",animation:200,fallbackTolerance:200,fallbackOnBody:!0,swapThreshold:.6,dragClass:"formeditor-sortable-drag",ghostClass:"formeditor-sortable-ghost",onChange:function(n){let a;const l=K(i(n.item));l&&(a=d().findEnclosingCompositeFormElementWhichIsNotOnTopLevel(l)),g().publish("view/tree/dnd/change",[i(n.item),l,a])},onEnd:function(n){const a=v(i(n.item)),l=S(i(n.item),"prev"),s=S(i(n.item),"next");g().publish("view/tree/dnd/update",[i(n.item),a,l,s]),g().publish("view/tree/dnd/stop",[v(i(n.item))])}},t=f.get(0).querySelector("ol."+r().getDomElementClassName("sortable"));new W(t,{...e,group:"tree-step-nodes",put:["tree-step-nodes"]}),t.querySelectorAll("ol").forEach(function(n){new W(n,{...e,group:"tree-leaves-nodes",pull:["tree-leaves-nodes"]})})}function R(){const e=function(t){if(h(t,"_isCompositeFormElement")){const a=E(t);a.length&&(a.closest("li").hasClass(r().getDomElementClassName("expanded"))?p[t.get("__identifierPath")]=!0:p[t.get("__identifierPath")]=!1),m().isUndefinedOrNull(p[t.get("__identifierPath")])&&(p[t.get("__identifierPath")]=!0)}const n=t.get("renderables");if(i.type(n)==="array")for(let a=0,l=n.length;a<l;++a)e(n[a])};e(x());for(const t of Object.keys(p))try{d().getFormElementByIdentifierPath(t)}catch{delete p[t]}}function B(){for(const e of Object.keys(p)){const t=E(e);t.length&&(p[e]?t.closest("li").removeClass(r().getDomElementClassName("collapsed")).addClass(r().getDomElementClassName("expanded")):t.closest("li").addClass(r().getDomElementClassName("collapsed")).removeClass(r().getDomElementClassName("expanded")))}}function O(e){N(i.type(e)==="object",'Invalid parameter "formElement"',1478721208);const t=i("<ol></ol>").addClass(r().getDomElementClassName("sortable"));if(i.type(e.get("renderables"))==="array")for(let n=0,a=e.get("renderables").length;n<a;++n)t.append(w(e.get("renderables")[n],n+1,a));return t}function q(e){d().getUtility().isUndefinedOrNull(e)&&(e=x()),R(),f.off().empty().append(O(e));let t=0;f.on("click",function(n){const a=i(n.target).closest(r().getDomElementDataAttribute("elementIdentifier","bracesWithKey")).attr(r().getDomElementDataAttribute("elementIdentifier"));m().isUndefinedOrNull(a)||!m().isNonEmptyString(a)||(t++,t===1&&setTimeout(function(){t===1?g().publish("view/tree/node/clicked",[a]):G(a),t=0},300))}),i(r().getDomElementDataIdentifierSelector("expander"),f).on("click",function(){i(this).closest("li").toggleClass(r().getDomElementClassName("collapsed")).toggleClass(r().getDomElementClassName("expanded"))}),F.isSortable&&V(),B()}function H(){return i(r().getDomElementDataAttribute("elementIdentifier","bracesWithKey"),f)}function U(e){return i(e).find(r().getDomElementDataAttribute("elementIdentifier","bracesWithKey")).first()}function v(e){return U(i(e)).attr(r().getDomElementDataAttribute("elementIdentifier"))}function L(e){return i(e).parent().closest("li").find(r().getDomElementDataAttribute("elementIdentifier","bracesWithKey")).first()}function K(e){return L(e).attr(r().getDomElementDataAttribute("elementIdentifier"))}function S(e,t){m().isUndefinedOrNull(t)&&(t="prev");const n=v(e);return e=t==="prev"?i(e).prev("li"):i(e).next("li"),e.find(r().getDomElementDataAttribute("elementIdentifier","bracesWithKey")).not(r().getDomElementDataAttribute("elementIdentifier","bracesWithKeyValue",[n])).first().attr(r().getDomElementDataAttribute("elementIdentifier"))}function z(e,t){let n;m().isUndefinedOrNull(e)?n=T(t):(n=document.createElement("span"),n.textContent=e),i(r().getDomElementDataIdentifierSelector("title"),E(t)).get(0).replaceChildren(n)}function E(e){let t;return typeof e=="string"?t=e:m().isUndefinedOrNull(e)?t=k().get("__identifierPath"):t=e.get("__identifierPath"),i(r().getDomElementDataAttribute("elementIdentifier","bracesWithKeyValue",[t]),f)}function T(e){m().isUndefinedOrNull(e)&&(e=k()),N(i.type(e)==="object",'Invalid parameter "formElement"',1478719287);const t=document.createElement("span");t.textContent=e.get("label")?e.get("label"):e.get("identifier");const n=document.createElement("small");return n.textContent="("+h(e,"label")+")",t.appendChild(n),t}function $(){return f}function G(e){const t=E(e),a=i(r().getDomElementDataIdentifierSelector("title"),t).children()[0].childNodes[0].nodeValue.trim();let l=!0;const s=i("<input>").attr("class","formeditor-tree-edit").attr("type","text").attr("value",a).on("click",o=>{o.stopPropagation()}).on("keyup",function(o){if(o.keyCode===13||o.keyCode===9){const D=this.value.trim();m().isNonEmptyString(D)&&D!==a?(l=!1,s.remove(),g().publish("view/tree/node/changed",[e,D])):(l=!1,s.remove())}else o.keyCode===27&&(l=!1,s.remove())}).on("blur",function(){if(l){const o=this.value.trim();s.remove(),m().isNonEmptyString(o)&&o!==a&&g().publish("view/tree/node/changed",[e,o])}});t.append(s),s.focus()}function J(e,t,n){return A=e,N(i.type(t)==="object",'Invalid parameter "appendToDomElement"',1478714814),f=i(t),F=i.extend(!0,j,n||{}),_.bootstrap(A),this}export{J as bootstrap,T as buildTitleByFormElement,H as getAllTreeNodes,K as getParentTreeNodeIdentifierPathWithinDomElement,L as getParentTreeNodeWithinDomElement,S as getSiblingTreeNodeIdentifierPathWithinDomElement,$ as getTreeDomElement,E as getTreeNode,v as getTreeNodeIdentifierPathWithinDomElement,U as getTreeNodeWithinDomElement,O as renderCompositeFormElementChildsAsSortableList,q as renew,z as setTreeNodeTitle};
