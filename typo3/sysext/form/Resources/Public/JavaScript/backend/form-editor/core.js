/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import s from"jquery";function o(g,e,t){if(typeof g=="function"&&(g=g()!==!1),!g)throw e=e||"Assertion failed",t&&(e=e+" ("+t+")"),typeof Error<"u"?new Error(e):e}class R{assert(e,t,i){o(e,t,i)}isUndefinedOrNull(e){return e==null}isNonEmptyArray(e){return Array.isArray(e)&&e.length>0}isNonEmptyString(e){return typeof e=="string"&&e.length>0}canBeInterpretedAsInteger(e){if(typeof e=="number")return!0;if(typeof e!="string")return!1;const t=e;return(t*1).toString()===t.toString()&&t.toString().indexOf(".")===-1}buildPropertyPath(e,t,i,r,n){let a="";return n=!!n,this.isNonEmptyString(t)||this.isNonEmptyString(i)?(o(this.isNonEmptyString(t),'Invalid parameter "collectionElementIdentifier"',1475412569),o(this.isNonEmptyString(i),'Invalid parameter "collectionName"',1475412570),a=i+"."+S.getIndexFromPropertyCollectionElementByIdentifier(t,i,r)):a="",this.isUndefinedOrNull(e)||(o(this.isNonEmptyString(e),'Invalid parameter "propertyPath"',1475415988),this.isNonEmptyString(a)?a=a+"."+e:a=e),n||o(this.isNonEmptyString(a),"The property path could not be resolved",1475663210),a}convertToSimpleObject(e){o(s.type(e)==="object",'Invalid parameter "formElement"',1475377782);const t={},i="getObjectData"in e&&typeof e.getObjectData=="function"?e.getObjectData():e,r=i.renderables;delete i.renderables;for(const[n,a]of Object.entries(i))n.match(/^__/)||(a!==null&&typeof a=="object"&&!Array.isArray(a)?t[n]=this.convertToSimpleObject(a):s.type(a)!=="function"&&s.type(a)!=="undefined"&&(t[n]=a));if(s.type(r)==="array"){t.renderables=[];for(let n=0,a=r.length;n<a;++n)t.renderables.push(this.convertToSimpleObject(r[n]))}return t}}class V{constructor(){this.validators={}}addValidatorIdentifiersToFormElementProperty(e,t,i,r,n,a){o(s.type(e)==="object",'Invalid parameter "formElement"',1475661025),o(s.type(t)==="array",'Invalid parameter "validators"',1475661026),o(s.type(t)==="array",'Invalid parameter "validators"',1479238074);const l=e.get("__identifierPath");i=d.buildPropertyPath(i,r,n,e);const p=u().getCurrentState("propertyValidationServiceRegisteredValidators");d.isUndefinedOrNull(p[l])&&(p[l]={}),d.isUndefinedOrNull(p[l][i])&&(p[l][i]={validators:[],configuration:a});for(const c of t)p[l][i].validators.indexOf(c)===-1&&p[l][i].validators.push(c);u().setCurrentState("propertyValidationServiceRegisteredValidators",p)}removeValidatorIdentifiersFromFormElementProperty(e,t){o(s.type(e)==="object",'Invalid parameter "formElement"',1475700618),o(d.isNonEmptyString(t),'Invalid parameter "propertyPath"',1475706896);const i=e.get("__identifierPath"),r={},n=u().getCurrentState("propertyValidationServiceRegisteredValidators");if(i in n)for(const a of Object.keys(n[i]||{}))a.indexOf(t)>-1||(r[a]=n[i][a]);n[i]=r,u().setCurrentState("propertyValidationServiceRegisteredValidators",n)}removeAllValidatorIdentifiersFromFormElement(e){o(s.type(e)==="object",'Invalid parameter "formElement"',1475668189);const t={},i=u().getCurrentState("propertyValidationServiceRegisteredValidators");for(const r of Object.keys(i||{}))r===e.get("__identifierPath")||r.indexOf(e.get("__identifierPath")+"/")>-1||(t[r]=i[r]);u().setCurrentState("propertyValidationServiceRegisteredValidators",t)}addValidator(e,t){o(d.isNonEmptyString(e),'Invalid parameter "validatorIdentifier"',1475669143),o(s.type(t)==="function",'Invalid parameter "func"',1475669144),o(s.type(this.validators[e])!=="function",'The validator "'+e+'" is already registered',1475669145),this.validators[e]=t}validateFormElementProperty(e,t){let i;o(s.type(e)==="object",'Invalid parameter "formElement"',1475676517),o(d.isNonEmptyString(t),'Invalid parameter "propertyPath"',1475676518);const r=e.get("__identifierPath"),n=[],a=u().getCurrentState("propertyValidationServiceRegisteredValidators");if(i={propertyValidatorsMode:"AND"},!d.isUndefinedOrNull(a[r])&&s.type(a[r][t])==="object"&&s.type(a[r][t].validators)==="array"){i=a[r][t].configuration;for(let l=0,p=a[r][t].validators.length;l<p;++l){const c=a[r][t].validators[l];if(s.type(this.validators[c])!=="function")continue;const f=this.validators[c](e,t);d.isNonEmptyString(f)&&n.push(f)}}return n.length>0&&i.propertyValidatorsMode==="OR"&&n.length!==a[r][t].validators.length?[]:n}validateFormElement(e){o(s.type(e)==="object",'Invalid parameter "formElement"',1475749668);const t=e.get("__identifierPath"),i=[],r=u().getCurrentState("propertyValidationServiceRegisteredValidators");if(!d.isUndefinedOrNull(r[t]))for(const n of Object.keys(r[t]))i.push({propertyPath:n,validationResults:this.validateFormElementProperty(e,n)});return i}validationResultsHasErrors(e){o(s.type(e)==="array",'Invalid parameter "validationResults"',1478613477);for(let t=0,i=e.length;t<i;++t)for(let r=0,n=e[t].validationResults.length;r<n;++r)if(e[t].validationResults[r].validationResults&&e[t].validationResults[r].validationResults.length>0)return!0;return!1}validateFormElementRecursive(e,t,i){if(o(s.type(e)==="object",'Invalid parameter "formElement"',1475756764),t=!!t,i=i||[],i.push({formElementIdentifierPath:e.get("__identifierPath"),validationResults:this.validateFormElement(e)}),t&&this.validationResultsHasErrors(i))return i;const r=e.get("renderables");if(s.type(r)==="array"){for(let n=0,a=r.length;n<a;++n)if(this.validateFormElementRecursive(r[n],t,i),t&&this.validationResultsHasErrors(i))return i}return i}addValidatorIdentifiersFromFormElementPropertyCollections(e){o(s.type(e)==="object",'Invalid parameter "formElement"',1475707334);const t=S.getFormEditorDefinition("formElements",e.get("type"));if(!d.isUndefinedOrNull(t.propertyCollections)){for(const i of Object.keys(t.propertyCollections))if(Array.isArray(t.propertyCollections[i])){for(let r=0,n=t.propertyCollections[i].length;r<n;++r)if(!(s.type(t.propertyCollections[i][r].editors)!=="array"||S.getIndexFromPropertyCollectionElementByIdentifier(t.propertyCollections[i][r].identifier,i,e)===-1))for(let a=0,l=t.propertyCollections[i][r].editors.length;a<l;++a){if(s.type(t.propertyCollections[i][r].editors[a].propertyValidators)!=="array")continue;const p={propertyValidatorsMode:"AND"};!d.isUndefinedOrNull(t.propertyCollections[i][r].editors[a].propertyValidatorsMode)&&t.propertyCollections[i][r].editors[a].propertyValidatorsMode==="OR"&&(p.propertyValidatorsMode="OR"),this.addValidatorIdentifiersToFormElementProperty(e,t.propertyCollections[i][r].editors[a].propertyValidators,t.propertyCollections[i][r].editors[a].propertyPath,t.propertyCollections[i][r].identifier,i,p)}}}}}class P{constructor(){this.topics={},this.subscriberUid=-1}publish(e,t){if(o(d.isNonEmptyString(e),'Invalid parameter "topic"',1475358066),d.isUndefinedOrNull(this.topics[e]))return;const i=this.topics[e];for(const r of i)r.func(e,t)}subscribe(e,t){o(d.isNonEmptyString(e),'Invalid parameter "topic"',1475358067),o(s.type(t)==="function",'Invalid parameter "func"',1475411986),d.isUndefinedOrNull(this.topics[e])&&(this.topics[e]=[]);const i=(++this.subscriberUid).toString();return this.topics[e].push({token:i,func:t}),i}unsubscribe(e){o(d.isNonEmptyString(e),'Invalid parameter "token"',1475358068);for(const t of Object.values(this.topics)){const i=t;for(let r=0,n=i.length;r<n;++r)if(i[r].token===e)return i.splice(r,1),e}return null}}function E(g,e,t,i){if(o(s.type(g)==="object",'Invalid parameter "modelToExtend"',1475358069),o(s.type(e)==="object"||s.type(e)==="array",'Invalid parameter "modelExtension"',1475358070),i=!!i,t=t||"",s.isEmptyObject(e))o(t!=="","Empty path is not allowed",1474640022),g.on(t,"core/formElement/somePropertyChanged"),g.set(t,e,i);else{const r={...e};for(const n of Object.keys(r)){const a=t===""?n:t+"."+n;g.on(a,"core/formElement/somePropertyChanged"),r[n]!==null&&(typeof r[n]=="object"||Array.isArray(r[n]))?E(g,r[n],a,i):t==="properties.options"?g.set(t,e,i):g.set(a,r[n],i)}}}class N{constructor(){this.objectData={},this.publisherTopics={}}get(e){let t,i;for(o(d.isNonEmptyString(e),'Invalid parameter "key"',1475361755),i=this.objectData;e.indexOf(".")>0;){if(t=e.slice(0,e.indexOf(".")),e=e.slice(t.length+1),!(t in i))return;i=i[t]}return i[e]}set(e,t,i){let r,n,a,l,p;o(d.isNonEmptyString(e),'Invalid parameter "key"',1475361756),i=!!i;const c=this.get(e);for(p=this.objectData,r=e;r.indexOf(".")>0;)n=r.slice(0,r.indexOf(".")),r=r.slice(n.length+1),s.isNumeric(n)&&(n=parseInt(n,10)),l=r.indexOf("."),a=l===-1?r:r.slice(0,l),s.type(p[n])==="undefined"?s.isNumeric(a)?p[n]=[]:p[n]={}:s.isNumeric(a)===!1&&s.type(p[n])==="array"&&(p[n]={...p[n]}),p=p[n];if(p[r]=t,!d.isUndefinedOrNull(this.publisherTopics[e])&&!i)for(let f=0,m=this.publisherTopics[e].length;f<m;++f)b.publish(this.publisherTopics[e][f],[e,t,c,this.objectData.__identifierPath])}unset(e,t){let i,r,n;o(d.isNonEmptyString(e),'Invalid parameter "key"',1489321637),t=!!t;const a=this.get(e);if(e.indexOf(".")>0?(r=e.split("."),n=r.pop(),r=r.join("."),i=this.get(r),typeof i<"u"&&delete i[n]):o(!1,"remove toplevel properties is not supported",1489319753),!d.isUndefinedOrNull(this.publisherTopics[e])&&!t)for(let l=0,p=this.publisherTopics[e].length;l<p;++l)b.publish(this.publisherTopics[e][l],[e,void 0,a,this.objectData.__identifierPath])}on(e,t){o(d.isNonEmptyString(e),'Invalid parameter "key"',1475361757),o(d.isNonEmptyString(t),'Invalid parameter "topicName"',1475361758),s.type(this.publisherTopics[e])!=="array"&&(this.publisherTopics[e]=[]),this.publisherTopics[e].indexOf(t)===-1&&this.publisherTopics[e].push(t)}off(e,t){o(d.isNonEmptyString(e),'Invalid parameter "key"',1475361759),o(d.isNonEmptyString(t),'Invalid parameter "topicName"',1475361760),s.type(this.publisherTopics[e])==="array"&&(this.publisherTopics[e]=this.publisherTopics[e].filter(i=>t!==i))}getObjectData(){return s.extend(!0,{},this.objectData)}toString(){const e=this.getObjectData(),{renderables:t,__parentRenderable:i,...r}=e,n=t||null;let a=null;d.isUndefinedOrNull(i)||(a=i.getObjectData().__identifierPath+" (filtered)");const l=r;if(a!==null&&(l.__parentRenderable=a),n!==null&&Array.isArray(n)){const p=[];for(let c=0,f=n.length;c<f;++c){const m=n[c];p.push(JSON.parse(m.toString()))}l.renderables=p}return JSON.stringify(l,null,2)}clone(){const e=this.getObjectData(),t=e.renderables||null;delete e.renderables,delete e.__parentRenderable,e.renderables=t?!0:null;const i=new N;if(E(i,e,"",!0),t!==null&&Array.isArray(t)){const r=[];for(let n=0,a=t.length;n<a;++n){let l=t[n];l=l.clone(),l.set("__parentRenderable",i,!0),r.push(l)}i.set("renderables",r,!0)}return i}}function U(g){g=g||{};const e=new N;return E(e,g,"",!0),e}class T{setFormEditorDefinitions(e){o(s.type(e)==="object",'Invalid parameter "formEditorDefinitions"',1475364394);for(const t of Object.keys(e)){const i=t;if(!(e[i]!==null&&typeof e[i]!="object"))for(const r of Object.keys(e[i]))(e[i][r]===null||typeof e[i][r]!="object")&&(e[i][r]={})}this.formEditorDefinitions=e}getFormEditorDefinition(e,t){return o(d.isNonEmptyString(e),'Invalid parameter "definitionName"',1475364952),o(d.isNonEmptyString(t),'Invalid parameter "subject"',1475364953),s.extend(!0,{},this.formEditorDefinitions[e][t])}getRootFormElement(){return u().getCurrentState("formDefinition")}addFormElement(e,t,i,r){let n,a,l;o(s.type(e)==="object",'Invalid parameter "formElement"',1475436224),o(s.type(t)==="object",'Invalid parameter "referenceFormElement"',1475364956),d.isUndefinedOrNull(r)&&(r=!0),r=!!r,i=!!i;const p=this.getFormEditorDefinition("formElements",e.get("type")),c=this.getFormEditorDefinition("formElements",t.get("type"));if(!p._isTopLevelFormElement&&c._isCompositeFormElement?(s.type(t.get("renderables"))!=="array"&&t.set("renderables",[],r),e.set("__parentRenderable",t,r),e.set("__identifierPath",t.get("__identifierPath")+"/"+e.get("identifier"),r),t.get("renderables").push(e)):(t.get("__identifierPath")===u().getCurrentState("formDefinition").get("__identifierPath")?(l=t.get("renderables"),t=l[l.length-1]):p._isTopLevelFormElement&&!c._isTopLevelFormElement?t=this.findEnclosingCompositeFormElementWhichIsOnTopLevel(t):p._isCompositeFormElement&&(n=this.findEnclosingCompositeFormElementWhichIsNotOnTopLevel(t),n&&(t=n)),e.set("__parentRenderable",t.get("__parentRenderable"),r),e.set("__identifierPath",t.get("__parentRenderable").get("__identifierPath")+"/"+e.get("identifier"),r),a=t.get("__parentRenderable").get("renderables"),a.splice(a.indexOf(t)+1,0,e)),i&&s.type(p.editors)==="array")for(let f=0,m=p.editors.length;f<m;++f){if(s.type(p.editors[f].propertyValidators)!=="array")continue;const C={propertyValidatorsMode:"AND"};!d.isUndefinedOrNull(p.editors[f].propertyValidatorsMode)&&p.editors[f].propertyValidatorsMode==="OR"&&(C.propertyValidatorsMode="OR"),F.addValidatorIdentifiersToFormElementProperty(e,p.editors[f].propertyValidators,p.editors[f].propertyPath,void 0,void 0,C)}return e}removeFormElement(e,t,i){d.isUndefinedOrNull(i)&&(i=!0),i=!!i,t=!!t,o(s.type(e)==="object",'Invalid parameter "formElement"',1475364957),o(s.type(e.get("__parentRenderable"))==="object","Removing the root element is not allowed",1472553024);const r=e.get("__parentRenderable").get("renderables");r.splice(r.indexOf(e),1),e.get("__parentRenderable").set("renderables",r,i),t&&F.removeAllValidatorIdentifiersFromFormElement(e)}moveFormElement(e,t,i,r){let n,a,l;o(s.type(e)==="object",'Invalid parameter "formElementToMove"',1475364958),o(t==="after"||t==="before"||t==="inside",'Invalid position "'+t+'"',1475364959),o(s.type(i)==="object",'Invalid parameter "referenceFormElement"',1475364960),d.isUndefinedOrNull(r)&&(r=!0),r=!!r;const p=this.getFormEditorDefinition("formElements",e.get("type")),c=this.getFormEditorDefinition("formElements",i.get("type"));this.removeFormElement(e,!1);const f=(m,C)=>{o(s.type(m)==="object",'Invalid parameter "formElement"',1475364961),o(d.isNonEmptyString(C),'Invalid parameter "pathPrefix"',1475364962);const I=m.get("__identifierPath"),y=C+"/"+m.get("identifier"),v=u().getCurrentState("propertyValidationServiceRegisteredValidators");d.isUndefinedOrNull(v[I])||(v[y]=v[I],delete v[I]),u().setCurrentState("propertyValidationServiceRegisteredValidators",v),m.set("__identifierPath",y,r);const _=m.get("renderables");if(s.type(_)==="array")for(let j=0,D=_.length;j<D;++j)f(_[j],m.get("__identifierPath"))};return t==="inside"?(o(!p._isTopLevelFormElement,"This move is not allowed",1476993731),o(c._isCompositeFormElement,"This move is not allowed",1476993732),e.set("__parentRenderable",i,r),f(e,i.get("__identifierPath")),a=i.get("renderables"),d.isUndefinedOrNull(a)&&(a=[]),a.splice(0,0,e),i.set("renderables",a,r)):p._isTopLevelFormElement&&c._isTopLevelFormElement?(n=i.get("__parentRenderable").get("renderables"),l=n.indexOf(i),t==="after"?n.splice(l+1,0,e):n.splice(l,0,e),i.get("__parentRenderable").set("renderables",n,r)):(e.get("__parentRenderable").get("identifier")===i.get("__parentRenderable").get("identifier")?(n=i.get("__parentRenderable").get("renderables"),l=n.indexOf(i)):(e.set("__parentRenderable",i.get("__parentRenderable"),r),f(e,i.get("__parentRenderable").get("__identifierPath")),n=i.get("__parentRenderable").get("renderables"),l=n.indexOf(i)),t==="after"?n.splice(l+1,0,e):n.splice(l,0,e),i.get("__parentRenderable").set("renderables",n,r)),e}getIndexForEnclosingCompositeFormElementWhichIsOnTopLevelForFormElement(e){let t;o(s.type(e)==="object",'Invalid parameter "formElement"',1475364963);const i=this.getFormEditorDefinition("formElements",e.get("type"));return i._isTopLevelFormElement&&i._isCompositeFormElement?t=e:e.get("__identifierPath")===u().getCurrentState("formDefinition").get("__identifierPath")?t=u().getCurrentState("formDefinition").get("renderables")[0]:t=this.findEnclosingCompositeFormElementWhichIsOnTopLevel(e),t.get("__parentRenderable").get("renderables").indexOf(t)}findEnclosingCompositeFormElementWhichIsOnTopLevel(e){let t;for(o(s.type(e)==="object",'Invalid parameter "formElement"',1475364964),o(s.type(e.get("__parentRenderable"))==="object","The root element is never encloused by anything",1472556223),t=this.getFormEditorDefinition("formElements",e.get("type"));!t._isTopLevelFormElement;)e=e.get("__parentRenderable"),t=this.getFormEditorDefinition("formElements",e.get("type"));return e}findEnclosingGridRowFormElement(e){let t;for(o(s.type(e)==="object",'Invalid parameter "formElement"',1490520271),t=this.getFormEditorDefinition("formElements",e.get("type"));!t._isGridRowFormElement;){if(t._isTopLevelFormElement)return null;e=e.get("__parentRenderable"),t=this.getFormEditorDefinition("formElements",e.get("type"))}return t._isTopLevelFormElement?null:e}findEnclosingCompositeFormElementWhichIsNotOnTopLevel(e){let t;for(o(s.type(e)==="object",'Invalid parameter "formElement"',1475364965),t=this.getFormEditorDefinition("formElements",e.get("type"));!t._isCompositeFormElement;){if(t._isTopLevelFormElement)return null;e=e.get("__parentRenderable"),t=this.getFormEditorDefinition("formElements",e.get("type"))}return t._isTopLevelFormElement?null:e}getNonCompositeNonToplevelFormElements(){const e=[],t=i=>{o(s.type(i)==="object",'Invalid parameter "formElement"',1475364961);const r=this.getFormEditorDefinition("formElements",i.get("type"));!r._isTopLevelFormElement&&!r._isCompositeFormElement&&e.push(i);const n=i.get("renderables");if(s.type(n)==="array")for(let a=0,l=n.length;a<l;++a)t(n[a])};return t(this.getRootFormElement()),e}isFormElementIdentifierUsed(e){let t;o(d.isNonEmptyString(e),'Invalid parameter "identifier"',1475364966);const i=r=>{let n;if(r.get("identifier")===e&&(t=!0),!t&&(n=r.get("renderables"),s.type(n)==="array"))for(let a=0,l=n.length;a<l&&(i(n[a]),!t);++a);};return i(u().getCurrentState("formDefinition")),t}getNextFreeFormElementIdentifier(e){let t;o(d.isNonEmptyString(e),'Invalid parameter "formElementType"',1475373676);const i=e.toLowerCase().replace(/[^a-z0-9]/g,"-")+"-";for(t=1;this.isFormElementIdentifierUsed(i+t);)t++;return i+t}findFormElementByIdentifierPath(e){let t,i;o(d.isNonEmptyString(e),'Invalid parameter "identifierPath"',1475373677);let r=u().getCurrentState("formDefinition");const n=e.split("/"),a=n.length;for(let l=0;l<a;++l){const p=n[l];if(l===0||l===a){o(p===r.get("identifier"),'"'+p+'" does not exist in path "'+e+'"',1472424333);continue}if(i=r.get("renderables"),Array.isArray(i)){t=null;for(let c=0,f=i.length;c<f;++c)if(p===i[c].get("identifier")){t=i[c];break}o(s.type(t)!=="null",'Could not find form element "'+p+'" in path "'+e+'"',1472424334),r=t}else o(!1,"No form elements found",1472424330)}return r}findFormElement(e){return typeof e=="object"&&(e=e.get("__identifierPath")),this.findFormElementByIdentifierPath(e)}findCollectionElementByIdentifierPath(e,t){o(d.isNonEmptyString(e),'Invalid parameter "collectionElementIdentifier"',1475375281),o(s.type(t)==="array",'Invalid parameter "collection"',1475375282);for(let i=0,r=t.length;i<r;++i)if(t[i].identifier===e)return t[i]}getIndexFromPropertyCollectionElementByIdentifier(e,t,i){o(d.isNonEmptyString(e),'Invalid parameter "collectionElementIdentifier"',1475375283),o(s.type(i)==="object",'Invalid parameter "formElement"',1475375284),o(d.isNonEmptyString(t),'Invalid parameter "collectionName"',1475375285);const r=i.get(t);if(s.type(r)==="array"){for(let n=0,a=r.length;n<a;++n)if(r[n].identifier===e)return n}return-1}addPropertyCollectionElement(e,t,i,r,n){let a,l;o(s.type(e)==="object",'Invalid parameter "collectionElementToAdd"',1475375686),o(s.type(i)==="object",'Invalid parameter "formElement"',1475375687),o(d.isNonEmptyString(t),'Invalid parameter "collectionName"',1475375688),d.isUndefinedOrNull(n)&&(n=!0),n=!!n,a=i.get(t),s.type(a)!=="array"&&(E(i,[],t,!0),a=i.get(t)),d.isUndefinedOrNull(r)?l=0:(l=this.getIndexFromPropertyCollectionElementByIdentifier(r,t,i)+1,o(-1<l,"Could not find collection element "+r+" within collection "+t,1477413154)),a.splice(l,0,e),i.set(t,a,!0),F.removeValidatorIdentifiersFromFormElementProperty(i,t);for(let p=0,c=a.length;p<c;++p)E(i,a[p],t+"."+p,!0);return i.set(t,a,!0),F.addValidatorIdentifiersFromFormElementPropertyCollections(i),i.set(t,a,n),i}removePropertyCollectionElementByIdentifier(e,t,i,r){o(d.isNonEmptyString(t),'Invalid parameter "collectionElementIdentifier"',1475375689),o(s.type(e)==="object",'Invalid parameter "formElement"',1475375690),o(d.isNonEmptyString(i),'Invalid parameter "collectionName"',1475375691);const n=e.get(i);o(s.type(n)==="array",'The collection "'+i+'" does not exist',1475375692),d.isUndefinedOrNull(r)&&(r=!0),r=!!r,F.removeValidatorIdentifiersFromFormElementProperty(e,i);const a=this.getIndexFromPropertyCollectionElementByIdentifier(t,i,e);n.splice(a,1),e.set(i,n,r),F.addValidatorIdentifiersFromFormElementPropertyCollections(e)}movePropertyCollectionElement(e,t,i,r,n,a){let l;o(t==="after"||t==="before",'Invalid position "'+t+'"',1477404485),o(s.type(i)==="string",'Invalid parameter "referenceCollectionElementIdentifier"',1477404486),o(s.type(n)==="object",'Invalid parameter "formElement"',1477404488);const p=n.get(r);o(s.type(p)==="array",'The collection "'+r+'" does not exist',1477404490);const c=this.findCollectionElementByIdentifierPath(e,p);o(s.type(c)==="object",'Invalid parameter "collectionElementToMove"',1477404484),this.removePropertyCollectionElementByIdentifier(n,e,r);const f=this.getIndexFromPropertyCollectionElementByIdentifier(i,r,n);o(-1<f,"Could not find collection element "+i+" within collection "+r,1477404489),t==="before"&&(l=p[f-1],d.isUndefinedOrNull(l)?i=void 0:i=l.identifier),this.addPropertyCollectionElement(c,r,n,i,a)}}class k{createFormElement(e,t,i,r,n){let a;o(s.type(e)==="object",'Invalid parameter "configuration"',1475375693),o(d.isNonEmptyString(e.identifier),'"identifier" must not be empty',1475436040),o(d.isNonEmptyString(e.type),'"type" must not be empty',1475604050),r=!!r,d.isUndefinedOrNull(n)&&(n=!0),n=!!n;const l=S.getFormEditorDefinition("formElements",e.type),p=e.renderables;delete e.renderables;const c={},f=l.predefinedDefaults||{};for(const y of Object.keys(e))d.isUndefinedOrNull(S.formEditorDefinitions[y])||(f[y]=f[y]||{},c[y]=s.extend(f[y]||{},e[y]),delete f[y],delete e[y]);t=t||"";const m=t===""?e.identifier:t+"/"+e.identifier,C={...f,...e,renderables:p?!0:null,__parentRenderable:null,__identifierPath:m},I=U(C);I.set("__parentRenderable",i||null,n);for(const[y,v]of Object.entries(c)){let _=0;for(const j of Object.values(v)){let D;const w=this.createPropertyCollectionElement(j.identifier,j,y);_>0&&(D=c[y][_-1].identifier),S.addPropertyCollectionElement(w,y,I,D,!0),++_}}if(r&&s.type(l.editors)==="array")for(let y=0,v=l.editors.length;y<v;++y){if(s.type(l.editors[y].propertyValidators)!=="array")continue;const _={propertyValidatorsMode:"AND"};!d.isUndefinedOrNull(l.editors[y].propertyValidatorsMode)&&l.editors[y].propertyValidatorsMode==="OR"&&(_.propertyValidatorsMode="OR"),F.addValidatorIdentifiersToFormElementProperty(I,l.editors[y].propertyValidators,l.editors[y].propertyPath,void 0,void 0,_)}if(s.type(p)==="array"){a=[];for(let y=0,v=p.length;y<v;++y)a.push(this.createFormElement(p[y],m,I,r,n));I.set("renderables",a,n)}return I}createPropertyCollectionElement(e,t,i){let r;o(d.isNonEmptyString(e),'Invalid parameter "collectionElementIdentifier"',1475377160),o(s.type(t)==="object",'Invalid parameter "collectionElementConfiguration"',1475377161),o(d.isNonEmptyString(i),'Invalid parameter "collectionName"',1475377162),t.identifier=e;const n=S.getFormEditorDefinition(i,e);return"predefinedDefaults"in n&&n.predefinedDefaults?r=n.predefinedDefaults:r={},s.extend(r,t)}}class O{constructor(){this.endpoints={},this.prototypeName=null,this.persistenceIdentifier=null}setEndpoints(e){o(s.type(e)==="object",'Invalid parameter "endpoints"',1475377488),this.endpoints=e}setPrototypeName(e){o(d.isNonEmptyString(e),'Invalid parameter "prototypeName"',1475928095),this.prototypeName=e}setPersistenceIdentifier(e){o(d.isNonEmptyString(e),'Invalid parameter "persistenceIdentifier"',1475377489),this.persistenceIdentifier=e}saveFormDefinition(){o(d.isNonEmptyString(this.endpoints.saveForm),'The endpoint "saveForm" is not configured',1475520918),h.saveForm&&h.saveForm.abort(),h.saveForm=s.post(this.endpoints.saveForm,{formPersistenceIdentifier:this.persistenceIdentifier,formDefinition:JSON.stringify(d.convertToSimpleObject(u().getCurrentState("formDefinition")))},(e,t,i)=>{h.saveForm===i&&(h.saveForm=null,e.status==="success"?b.publish("core/ajax/saveFormDefinition/success",[e]):b.publish("core/ajax/saveFormDefinition/error",[e]))}),h.saveForm.fail((e,t,i)=>{b.publish("core/ajax/error",[e,t,i])})}renderFormDefinitionPage(e){o(s.isNumeric(e),'Invalid parameter "pageIndex"',1475377781),o(d.isNonEmptyString(this.endpoints.formPageRenderer),'The endpoint "formPageRenderer" is not configured',1473447677),h.renderFormDefinitionPage&&h.renderFormDefinitionPage.abort(),h.renderFormDefinitionPage=s.post(this.endpoints.formPageRenderer,{formDefinition:JSON.stringify(d.convertToSimpleObject(u().getCurrentState("formDefinition"))),pageIndex:e,prototypeName:this.prototypeName},(t,i,r)=>{h.renderFormDefinitionPage===r&&(h.renderFormDefinitionPage=null,b.publish("core/ajax/renderFormDefinitionPage/success",[t,e]))}),h.renderFormDefinitionPage.fail((t,i,r)=>{b.publish("core/ajax/error",[t,i,r])})}}class x{constructor(){this.stackSize=10,this.stackPointer=0,this.stack=[]}add(e,t){o(s.type(e)==="object",'Invalid parameter "applicationState"',1477847415),t=!!t,s.extend(e,{propertyValidationServiceRegisteredValidators:s.extend(!0,{},this.getCurrentState("propertyValidationServiceRegisteredValidators"))}),this.stack.splice(0,0,e),this.stack.length>this.stackSize&&this.stack.splice(this.stackSize-1,this.stack.length-this.stackSize),t||b.publish("core/applicationState/add",[e,this.getCurrentStackPointer(),this.getCurrentStackSize()])}addAndReset(e,t){o(s.type(e)==="object",'Invalid parameter "applicationState"',1477872641),this.stackPointer>0&&this.stack.splice(0,this.stackPointer),this.stackPointer=0,this.add(e,!0),t||b.publish("core/applicationState/add",[this.getCurrentState(),this.getCurrentStackPointer(),this.getCurrentStackSize()])}getCurrentState(e){if(e===void 0)return this.stack[this.stackPointer]||void 0;if(o(e==="formDefinition"||e==="currentlySelectedPageIndex"||e==="currentlySelectedFormElementIdentifierPath"||e==="propertyValidationServiceRegisteredValidators",'Invalid parameter "type"',1477932754),s.type(this.stack[this.stackPointer])!=="undefined")return this.stack[this.stackPointer][e]}setCurrentState(e,t){o(e==="formDefinition"||e==="currentlySelectedPageIndex"||e==="currentlySelectedFormElementIdentifierPath"||e==="propertyValidationServiceRegisteredValidators",'Invalid parameter "type"',1477934111),this.stack[this.stackPointer][e]=t}setMaximalStackSize(e){o(s.type(e)==="number",'Invalid parameter "size"',1477846933),this.stackSize=e}getMaximalStackSize(){return this.stackSize}getCurrentStackSize(){return this.stack.length}getCurrentStackPointer(){return this.stackPointer}setCurrentStackPointer(e){o(s.type(e)==="number",'Invalid parameter "size"',1477852138),e<0?this.stackPointer=0:e>this.stack.length-1?this.stackPointer=this.stack.length-1:this.stackPointer=e}decrementCurrentStackPointer(){this.setCurrentStackPointer(--this.stackPointer)}incrementCurrentStackPointer(){this.setCurrentStackPointer(++this.stackPointer)}}function A(g){return o(d.isNonEmptyString(g),'Invalid parameter "ajaxRequestIdentifier"',1475358064),h[g]||null}const d=new R,L=new O,h={},F=new V,B=new x,b=new P,S=new T,z=new k;function W(){return d}function M(){return L}function J(){return F}function u(){return B}function H(){return b}function q(){return z}function G(){return S}export{x as ApplicationStateStack,O as DataBackend,k as Factory,N as Model,V as PropertyValidationService,P as PublisherSubscriber,T as Repository,R as Utility,o as assert,u as getApplicationStateStack,M as getDataBackend,q as getFactory,J as getPropertyValidationService,H as getPublisherSubscriber,G as getRepository,A as getRunningAjaxRequest,W as getUtility};
