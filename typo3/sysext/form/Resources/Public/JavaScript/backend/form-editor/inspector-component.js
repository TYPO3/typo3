/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import n from"jquery";import*as A from"@typo3/form/backend/form-editor/helper.js";import D from"@typo3/backend/icons.js";import j from"@typo3/backend/modal.js";import{MessageUtility as ce}from"@typo3/backend/utility/message-utility.js";import me from"sortablejs";import{selector as de}from"@typo3/core/literals.js";import{PropertyGridEditorUpdateEvent as ue}from"@typo3/form/backend/form-editor/component/property-grid-editor.js";import{FormElementSelectorSelectedEvent as Ee}from"@typo3/form/backend/form-editor/component/form-element-selector.js";const ye={domElementClassNames:{buttonFormElementRemove:"formeditor-inspector-element-remove-button",collectionElement:"formeditor-inspector-collection-element",finisherEditorPrefix:"t3-form-inspector-finishers-editor-",inspectorEditor:"formeditor-inspector-element",inspectorInputGroup:"input-group",validatorEditorPrefix:"formeditor-inspector-validators-editor-"},domElementDataAttributeNames:{contentElementSelectorTarget:"data-insert-target",finisher:"data-finisher-identifier",validator:"data-validator-identifier",randomId:"data-random-id",randomIdTarget:"data-random-id-attribute",randomIdIndex:"data-random-id-number",maximumFileSize:"data-maximumFileSize"},domElementDataAttributeValues:{collapse:"actions-view-table-expand",editorControlsInputGroup:"inspectorEditorControlsGroup",editorWrapper:"editorWrapper",editorControlsWrapper:"inspectorEditorControlsWrapper",formElementHeaderEditor:"inspectorFormElementHeaderEditor",formElementSelectorControlsWrapper:"inspectorEditorFormElementSelectorControlsWrapper",formElementSelectorSplitButtonContainer:"inspectorEditorFormElementSelectorSplitButtonContainer",formElementSelectorSplitButtonListContainer:"inspectorEditorFormElementSelectorSplitButtonListContainer",iconNotAvailable:"actions-close",inspector:"inspector","Inspector-CheckboxEditor":"Inspector-CheckboxEditor","Inspector-CollectionElementHeaderEditor":"Inspector-CollectionElementHeaderEditor","Inspector-FinishersEditor":"Inspector-FinishersEditor","Inspector-FormElementHeaderEditor":"Inspector-FormElementHeaderEditor","Inspector-PropertyGridEditor":"Inspector-PropertyGridEditor","Inspector-RemoveElementEditor":"Inspector-RemoveElementEditor","Inspector-RequiredValidatorEditor":"Inspector-RequiredValidatorEditor","Inspector-SingleSelectEditor":"Inspector-SingleSelectEditor","Inspector-MultiSelectEditor":"Inspector-MultiSelectEditor","Inspector-GridColumnViewPortConfigurationEditor":"Inspector-GridColumnViewPortConfigurationEditor","Inspector-TextareaEditor":"Inspector-TextareaEditor","Inspector-TextEditor":"Inspector-TextEditor","Inspector-Typo3WinBrowserEditor":"Inspector-Typo3WinBrowserEditor","Inspector-ValidatorsEditor":"Inspector-ValidatorsEditor","Inspector-ValidationErrorMessageEditor":"Inspector-ValidationErrorMessageEditor",inspectorFinishers:"inspectorFinishers",inspectorValidators:"inspectorValidators",viewportButton:"viewportButton"},domElementIdNames:{finisherPrefix:"t3-form-inspector-finishers-",validatorPrefix:"t3-form-inspector-validators-"},isSortable:!0};let U=null,B=null;function f(){return B}function O(){return f().getViewModel()}function a(e){return c().isUndefinedOrNull(e)?A.setConfiguration(U):A.setConfiguration(e)}function c(){return f().getUtility()}function p(e,t,r){return f().assert(e,t,r)}function be(){return f().getRootFormElement()}function y(){return f().getCurrentlySelectedFormElement()}function w(){return f().getPublisherSubscriber()}function N(e,t){return f().getFormElementDefinition(e,t)}function z(e,t,r,l){switch(e.templateName){case"Inspector-FormElementHeaderEditor":$(e,t);break;case"Inspector-CollectionElementHeaderEditor":Y(e,t,r,l);break;case"Inspector-MaximumFileSizeEditor":J(e,t);break;case"Inspector-TextEditor":Q(e,t,r,l);break;case"Inspector-FinishersEditor":G("finishers",e,t);break;case"Inspector-ValidatorsEditor":G("validators",e,t);break;case"Inspector-ValidationErrorMessageEditor":X(e,t);break;case"Inspector-RemoveElementEditor":oe(e,t,r,l);break;case"Inspector-RequiredValidatorEditor":ne(e,t,r,l);break;case"Inspector-CheckboxEditor":re(e,t,r,l);break;case"Inspector-CountrySelectEditor":Z(e,t,r,l);break;case"Inspector-SingleSelectEditor":C(e,t,r,l);break;case"Inspector-MultiSelectEditor":H(e,t,r,l);break;case"Inspector-GridColumnViewPortConfigurationEditor":ee(e,t);break;case"Inspector-PropertyGridEditor":te(e,t,r,l);break;case"Inspector-TextareaEditor":ae(e,t,r,l);break;case"Inspector-Typo3WinBrowserEditor":le(e,t,r,l);break;default:break}w().publish("view/inspector/editor/insert/perform",[e,t,r,l])}function fe(e,t){j.advanced({type:j.types.iframe,content:TYPO3.settings.FormEditor.typo3WinBrowserUrl+"&mode="+e+"&bparams="+t,size:j.sizes.large})}function ve(){window.addEventListener("message",function(e){if(!ce.verifyOrigin(e.origin))throw"Denied message sent by "+e.origin;if(e.data.actionName==="typo3:elementBrowser:elementAdded"){if(typeof e.data.fieldName>"u")throw"fieldName not defined in message";if(typeof e.data.value>"u")throw"value not defined in message";const t=e.data.value.split("_");n(a().getDomElementDataAttribute("contentElementSelectorTarget","bracesWithKeyValue",[e.data.fieldName])).val(t.pop()).trigger("paste")}})}function he(e,t){return e==="finishers"?a().getDomElementClassName("finisherEditorPrefix")+t:a().getDomElementClassName("validatorEditorPrefix")+t}function L(e,t,r){return e==="finishers"?a().getDomElementIdName("finisherPrefix",r)+t:a().getDomElementIdName("validatorPrefix",r)+t}function ge(e,t){e.addClass(a().getDomElementClassName("sortable")),new me(e.get(0),{draggable:a().getDomElementClassName("collectionElement",!0),filter:"input,textarea,select",preventOnFilter:!1,animation:200,fallbackTolerance:200,swapThreshold:.6,dragClass:"formeditor-sortable-drag",ghostClass:"formeditor-sortable-ghost",onEnd:function(r){let l;t==="finishers"?l=a().getDomElementDataAttribute("finisher"):l=a().getDomElementDataAttribute("validator");const o=n(r.item).attr(l),s=n(r.item).prevAll(a().getDomElementClassName("collectionElement",!0)).first().attr(l),m=n(r.item).nextAll(a().getDomElementClassName("collectionElement",!0)).first().attr(l);w().publish("view/inspector/collectionElements/dnd/update",[o,s,m,t])}})}function R(e){return n(a().getDomElementDataIdentifierSelector("editorWrapper"),n(e))}function F(e){return n(a().getDomElementDataIdentifierSelector("editorControlsWrapper"),n(e))}function g(e,t){let r,l,o;o=f().validateCurrentlySelectedFormElementProperty(e),o.length>0?(a().getTemplatePropertyDomElement("validationErrors",t).html('<span class="text-danger">'+o[0]+"</span>"),O().setElementValidationErrorClass(F(t),"hasError")):(a().getTemplatePropertyDomElement("validationErrors",t).html(""),O().removeElementValidationErrorClass(F(t),"hasError")),o=f().validateFormElement(y()),l=e.split("."),l=l[0]+"."+l[1],r=!1;for(let s=0,m=o.length;s<m;++s)if(o[s].propertyPath.indexOf(l,0)===0&&o[s].validationResults&&o[s].validationResults.length>0){r=!0;break}r?O().setElementValidationErrorClass(F(t).closest(a().getDomElementClassName("collectionElement",!0))):O().removeElementValidationErrorClass(F(t).closest(a().getDomElementClassName("collectionElement",!0)))}function _(e,t){p(n.type(e)==="array",'Invalid configuration "errorCodes"',1489932939),p(n.type(t)==="array",'Invalid configuration "propertyData"',1489932940);for(let r=0,l=e.length;r<l;++r)for(let o=0,s=t.length;o<s;++o)if(parseInt(e[r],10)===parseInt(t[o].code,10)&&c().isNonEmptyString(t[o].message))return t[o].message;return null}function W(e,t,r){if(p(n.type(t)==="array",'Invalid configuration "propertyData"',1489932942),!c().isUndefinedOrNull(e)&&n.type(e)==="array"){const l=[];for(let o=0,s=e.length;o<s;++o){let m=!1;for(let i=0,d=t.length;i<d;++i)parseInt(e[o],10)===parseInt(t[i].code,10)&&(m=!0,c().isNonEmptyString(r)?t[i].message=r:(t.splice(i,1),--d));m||c().isNonEmptyString(r)&&l.push({code:e[o],message:r})}t=t.concat(l)}return t}function K(e){p(n.type(e)==="object",'Invalid input "html"',1523904699),n(a().getDomElementClassName("inspectorEditor",!0)).each(function(){const t=n(this),r={};n(a().getDomElementDataAttribute("randomId","bracesWithKey"),t).each(function(){const l=n(this),o=l.attr(a().getDomElementDataAttribute("randomIdTarget")),s=l.attr(a().getDomElementDataAttribute("randomIdIndex"));l.is("["+o+"]")||(s in r||(r[s]="fe"+Math.floor(Math.random()*42)+Date.now()),l.attr(o,r[s]))})})}function x(){return n(a().getDomElementDataIdentifierSelector("inspector"))}function V(){return n(a().getDomElementDataIdentifierSelector("inspectorFinishers"),x())}function k(){return n(a().getDomElementDataIdentifierSelector("inspectorValidators"),x())}function M(e,t){return e==="finishers"?n(a().getDomElementDataAttribute("finisher","bracesWithKeyValue",[t]),V()):n(a().getDomElementDataAttribute("validator","bracesWithKeyValue",[t]),k())}function Pe(e,t){c().isUndefinedOrNull(e)&&(e=y()),x().off().empty();const r=N(e,void 0);if(n.type(r.editors)==="array"){for(let l=0,o=r.editors.length;l<o;++l){const s=a().getTemplate(r.editors[l].templateName).clone();if(!s.length)continue;const m=n(s.html());n(m).first().addClass(a().getDomElementClassName("inspectorEditor")),x().append(n(m)),K(m),z(r.editors[l],m)}n.type(t)==="function"&&t()}}function Ie(e,t){let r,l,o;p(c().isNonEmptyString(e),'Invalid parameter "collectionName"',1478354853),p(c().isNonEmptyString(t),'Invalid parameter "collectionElementIdentifier"',1478354854);const s=f().getPropertyCollectionElementConfiguration(t,e);if(n.type(s.editors)!=="array")return;const m=n("<div></div>").addClass(a().getDomElementClassName("collectionElement")).addClass("panel").addClass("panel-default");e==="finishers"?(o=V(),m.attr(a().getDomElementDataAttribute("finisher"),t)):(o=k(),m.attr(a().getDomElementDataAttribute("validator"),t)),o.append(m);const i=s.editors.length;i>0&&s.editors[0].identifier==="header"&&(l=document.createElement("div"),l.classList.add("panel-body"),r=document.createElement("div"),r.classList.add("panel-collapse","collapse"),r.id=L(e,t),r.appendChild(l));for(let d=0;d<i;++d){const b=a().getTemplate(s.editors[d].templateName).clone();if(!b.length)continue;const E=n(b.html());n(E).first().addClass(he(e,s.editors[d].identifier)).addClass(a().getDomElementClassName("inspectorEditor")),d===0&&r?M(e,t).append(E).append(r):d===i-1&&r&&s.editors[d].identifier==="removeButton"||d>0&&r?l.append(E.get(0)):M(e,t).append(E),K(E),z(s.editors[d],E,t,e)}(i===2&&s.editors[0].identifier==="header"&&s.editors[1].identifier==="removeButton"||i===1&&s.editors[0].identifier==="header")&&n(a().getDomElementDataIdentifierSelector("collapse"),m).remove(),U.isSortable&&ge(o,e)}function G(e,t,r){let l,o,s;p(c().isNonEmptyString(e),'Invalid configuration "collectionName"',1478362968),p(n.type(t)==="object",'Invalid parameter "editorConfiguration"',1475423098),p(n.type(r)==="object",'Invalid parameter "editorHtml"',1475423099),p(c().isNonEmptyString(t.label),'Invalid configuration "label"',1475423100),p(n.type(t.selectOptions)==="array",'Invalid configuration "selectOptions"',1475423101),e==="finishers"?(o=V(),l=be().get(e)):(o=k(),l=y().get(e)),o.off().empty(),a().getTemplatePropertyDomElement("label",r).text(t.label);const m=a().getTemplatePropertyDomElement("selectOptions",r),i=!c().isUndefinedOrNull(l)&&l.length>0;if(i)for(let d=0,b=l.length;d<b;++d)w().publish("view/inspector/collectionElement/existing/selected",[l[d].identifier,e]);s=!0;for(let d=0,b=t.selectOptions.length;d<b;++d){let E=!0;if(!c().isUndefinedOrNull(l)){for(let u=0,h=l.length;u<h;++u)if(l[u].identifier===t.selectOptions[d].value){E=!1;break}}E&&(m.append(new Option(t.selectOptions[d].label,t.selectOptions[d].value)),t.selectOptions[d].value!==""&&(s=!1))}if(s){a().getTemplatePropertyDomElement("select-group",r).off().empty().remove();const d=a().getTemplatePropertyDomElement("label-no-select",r);i?d.text(t.label):d.remove();return}a().getTemplatePropertyDomElement("label-no-select",r).remove(),m.on("change",function(){if(n(this).val()!==""){const d=n(this).val();n(de`option[value="${d}"]`,n(this)).remove(),f().getPublisherSubscriber().publish("view/inspector/collectionElement/new/selected",[d,e])}})}function $(e,t){p(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1475421525),p(n.type(t)==="object",'Invalid parameter "editorHtml"',1475421526),D.getIcon(N(y(),"iconIdentifier"),D.sizes.small,null,D.states.default).then(function(r){a().getTemplatePropertyDomElement("header-label",t).append(n(r).addClass(a().getDomElementClassName("icon"))).append(ie()).append("<code>"+y().get("identifier")+"</code>")})}function Y(e,t,r,l){p(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1475421258),p(c().isNonEmptyString(e.label),'Invalid configuration "label"',1475421257),p(n.type(t)==="object",'Invalid parameter "editorHtml"',1475421259);const o=function(m){const i=a().getTemplatePropertyDomElement("panel-icon",t);m?i.replaceWith(m):i.remove();const d=f().getPropertyCollectionElementConfiguration(r,l).editors;if(!(d.length===2&&d[0].identifier==="header"&&d[1].identifier==="removeButton"||d.length===1&&d[0].identifier==="header")){const u=document.createElement("button");u.classList.add("panel-button","collapsed"),u.setAttribute("type","button"),u.setAttribute("data-bs-toggle","collapse"),u.setAttribute("data-bs-target",L(l,r,!0)),u.setAttribute("aria-expaned","false"),u.setAttribute("aria-controls",L(l,r));const h=document.createElement("span");h.classList.add("caret"),a().getTemplatePropertyDomElement("panel-heading-row",t).find(".panel-title").before(h),a().getTemplatePropertyDomElement("panel-heading-row",t).wrapInner(u)}const E=M(l,r).get(0).querySelector(".formeditor-inspector-element-remove-button");if(E){const u=E.querySelector("button");u.classList.add("btn-sm"),u.querySelector(".btn-label").classList.add("visually-hidden");const h=document.createElement("div");h.classList.add("panel-actions"),h.append(u),a().getTemplatePropertyDomElement("panel-heading-row",t).append(h)}E?.remove()},s=f().getFormEditorDefinition(l,r);"iconIdentifier"in s?D.getIcon(s.iconIdentifier,D.sizes.small,null,D.states.default).then(function(m){o(m)}):o(),e.label&&a().getTemplatePropertyDomElement("panel-title",t).removeAttr("data-template-property").append(e.label)}function J(e,t){if(p(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1475421258),p(c().isNonEmptyString(e.label),'Invalid configuration "label"',1475421257),p(n.type(t)==="object",'Invalid parameter "editorHtml"',1475421259),e.label){const r=a().getTemplatePropertyDomElement("label",t),l=r.attr(a().getDomElementDataAttribute("maximumFileSize"));r.append(e.label.replace("{0}",l))}}function Q(e,t,r,l){p(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1475421053),p(n.type(t)==="object",'Invalid parameter "editorHtml"',1475421054),p(c().isNonEmptyString(e.label),'Invalid configuration "label"',1475421055),p(c().isNonEmptyString(e.propertyPath),'Invalid configuration "propertyPath"',1475421056),a().getTemplatePropertyDomElement("label",t).append(e.label),I(e,t),c().isNonEmptyString(e.placeholder)&&a().getTemplatePropertyDomElement("propertyPath",t).attr("placeholder",e.placeholder);const o=f().buildPropertyPath(e.propertyPath,r,l),s=y().get(o);if(g(o,t),a().getTemplatePropertyDomElement("propertyPath",t).val(s),!c().isUndefinedOrNull(e.additionalElementPropertyPaths)&&n.type(e.additionalElementPropertyPaths)==="array")for(let m=0,i=e.additionalElementPropertyPaths.length;m<i;++m)y().set(e.additionalElementPropertyPaths[m],s);se(e,t,o),a().getTemplatePropertyDomElement("propertyPath",t).on("keyup paste",function(){if(e.doNotSetIfPropertyValueIsEmpty&&!c().isNonEmptyString(n(this).val())?y().unset(o):y().set(o,n(this).val()),g(o,t),!c().isUndefinedOrNull(e.additionalElementPropertyPaths)&&n.type(e.additionalElementPropertyPaths)==="array")for(let m=0,i=e.additionalElementPropertyPaths.length;m<i;++m)e.doNotSetIfPropertyValueIsEmpty&&!c().isNonEmptyString(n(this).val())?y().unset(e.additionalElementPropertyPaths[m]):y().set(e.additionalElementPropertyPaths[m],n(this).val())})}function X(e,t){p(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1489874121),p(n.type(t)==="object",'Invalid parameter "editorHtml"',1489874122),p(c().isNonEmptyString(e.label),'Invalid configuration "label"',1489874123),p(c().isNonEmptyString(e.propertyPath),'Invalid configuration "propertyPath"',1489874124),a().getTemplatePropertyDomElement("label",t).append(e.label),I(e,t);const r=f().buildPropertyPath(e.propertyPath);let l=y().get(r);if(!c().isUndefinedOrNull(l)&&n.type(l)==="array"){const o=_(e.errorCodes,l);c().isUndefinedOrNull(o)||a().getTemplatePropertyDomElement("propertyPath",t).val(o)}a().getTemplatePropertyDomElement("propertyPath",t).on("keyup paste",function(){l=y().get(r),c().isUndefinedOrNull(l)&&(l=[]),y().set(r,W(e.errorCodes,l,n(this).val()))})}function Z(e,t,r,l){p(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1674826430),p(n.type(t)==="object",'Invalid parameter "editorHtml"',1674826431),p(c().isNonEmptyString(e.label),'Invalid configuration "label"',1674826432);const o=f().buildPropertyPath(e.propertyPath,r,l);a().getTemplatePropertyDomElement("label",t).append(e.label),I(e,t);const s=a().getTemplatePropertyDomElement("selectOptions",t),m=y().get(o)||{};g(o,t);const i=n("option",s);s.empty();for(let d=0,b=i.length;d<b;++d){let E=!1;for(const h of Object.keys(m))if(i[d].value===m[h]){E=!0;break}const u=new Option(i[d].text,d.toString(),!1,E);n(u).data({value:i[d].value}),s.append(u)}s.on("change",function(){const d=[];n("option:selected",n(this)).each(function(){d.push(n(this).data("value"))}),y().set(o,d),g(o,t)})}function C(e,t,r,l){p(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1475421048),p(n.type(t)==="object",'Invalid parameter "editorHtml"',1475421049),p(c().isNonEmptyString(e.label),'Invalid configuration "label"',1475421050),p(c().isNonEmptyString(e.propertyPath),'Invalid configuration "propertyPath"',1475421051),p(n.type(e.selectOptions)==="array",'Invalid configuration "selectOptions"',1475421052);const o=f().buildPropertyPath(e.propertyPath,r,l);a().getTemplatePropertyDomElement("label",t).append(e.label),I(e,t);const s=a().getTemplatePropertyDomElement("selectOptions",t),m=y().get(o);g(o,t);for(let i=0,d=e.selectOptions.length;i<d;++i){let b;e.selectOptions[i].value===m?b=new Option(e.selectOptions[i].label,i.toString(),!1,!0):b=new Option(e.selectOptions[i].label,i.toString()),n(b).data({value:e.selectOptions[i].value}),s.append(b)}s.on("change",function(){y().set(o,n("option:selected",n(this)).data("value")),g(o,t)})}function H(e,t,r,l){p(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1485712399),p(n.type(t)==="object",'Invalid parameter "editorHtml"',1485712400),p(c().isNonEmptyString(e.label),'Invalid configuration "label"',1485712401),p(c().isNonEmptyString(e.propertyPath),'Invalid configuration "propertyPath"',1485712402),p(n.type(e.selectOptions)==="array",'Invalid configuration "selectOptions"',1485712403);const o=f().buildPropertyPath(e.propertyPath,r,l);a().getTemplatePropertyDomElement("label",t).append(e.label),I(e,t);const s=a().getTemplatePropertyDomElement("selectOptions",t),m=y().get(o)||{};g(o,t);for(let i=0,d=e.selectOptions.length;i<d;++i){let b=null;for(const E of Object.keys(m))if(e.selectOptions[i].value===m[E]){b=new Option(e.selectOptions[i].label,i.toString(),!1,!0);break}b||(b=new Option(e.selectOptions[i].label,i.toString())),n(b).data({value:e.selectOptions[i].value}),s.append(b)}s.on("change",function(){const i=[];n("option:selected",n(this)).each(function(){i.push(n(this).data("value"))}),y().set(o,i),g(o,t)})}function ee(e,t){if(p(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1489528242),p(n.type(t)==="object",'Invalid parameter "editorHtml"',1489528243),p(c().isNonEmptyString(e.label),'Invalid configuration "label"',1489528244),p(n.type(e.configurationOptions.viewPorts)==="array",'Invalid configurationOptions "viewPorts"',1489528245),p(!c().isUndefinedOrNull(e.configurationOptions.numbersOfColumnsToUse.label),'Invalid configurationOptions "numbersOfColumnsToUse"',1489528246),p(!c().isUndefinedOrNull(e.configurationOptions.numbersOfColumnsToUse.propertyPath),'Invalid configuration "selectOptions"',1489528247),!N(y().get("__parentRenderable"),"_isGridRowFormElement")){t.remove();return}a().getTemplatePropertyDomElement("label",t).append(e.label);const r=n(a().getDomElementDataIdentifierSelector("viewportButton"),n(t)).clone();n(a().getDomElementDataIdentifierSelector("viewportButton"),n(t)).remove();const l=a().getTemplatePropertyDomElement("numbersOfColumnsToUse",n(t)).clone();a().getTemplatePropertyDomElement("numbersOfColumnsToUse",n(t)).remove();const o=F(t),s=function(m){a().getTemplatePropertyDomElement("numbersOfColumnsToUse",n(t)).off().empty().remove();const i=n(l).clone(!0,!0);R(t).after(i),n("input",i).focus(),a().getTemplatePropertyDomElement("numbersOfColumnsToUse-label",i).append(e.configurationOptions.numbersOfColumnsToUse.label.replace("{@viewPortLabel}",m.data("viewPortLabel"))),a().getTemplatePropertyDomElement("numbersOfColumnsToUse-description",i).append(e.configurationOptions.numbersOfColumnsToUse.description);const d=e.configurationOptions.numbersOfColumnsToUse.propertyPath.replace("{@viewPortIdentifier}",m.data("viewPortIdentifier"));a().getTemplatePropertyDomElement("numbersOfColumnsToUse-propertyPath",i).val(y().get(d)),a().getTemplatePropertyDomElement("numbersOfColumnsToUse-propertyPath",i).on("keyup paste change",function(){const b=n(this);n.isNumeric(b.val())||b.val(""),y().set(d,b.val())})};for(let m=0,i=e.configurationOptions.viewPorts.length;m<i;++m){const d=e.configurationOptions.viewPorts[m].viewPortIdentifier,b=e.configurationOptions.viewPorts[m].label,E=n(r).clone(!0,!0);if(E.text(d),E.data("viewPortIdentifier",d),E.data("viewPortLabel",b),E.attr("title",b),o.append(E),m===i-1){const u=n(l).clone(!0,!0);R(t).after(u),s(E),E.addClass(a().getDomElementClassName("active"))}n("button",o).on("click",function(){const u=n(this);n("button",o).removeClass(a().getDomElementClassName("active")),u.addClass(a().getDomElementClassName("active")),s(u)})}}function te(e,t,r,l){p(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1475419226),p(n.type(t)==="object",'Invalid parameter "editorHtml"',1475419227),p(n.type(e.enableAddRow)==="boolean",'Invalid configuration "enableAddRow"',1475419228),p(n.type(e.enableDeleteRow)==="boolean",'Invalid configuration "enableDeleteRow"',1475419230),p(n.type(e.isSortable)==="boolean",'Invalid configuration "isSortable"',1475419229),p(c().isNonEmptyString(e.propertyPath),'Invalid configuration "propertyPath"',1475419231),p(c().isNonEmptyString(e.label),'Invalid configuration "label"',1475419232),a().getTemplatePropertyDomElement("label",t).append(e.label),I(e,t);const o=(()=>{const u=f().buildPropertyPath(void 0,r,l,void 0,!0);return c().isNonEmptyString(u)?u+".":u})(),s=c().isUndefinedOrNull(e.multiSelection)?!1:!!e.multiSelection,m=c().isNonEmptyArray(e.gridColumns)?e.gridColumns.some(u=>u.name==="selected"):!0,i=(()=>{const u=y().get(o+"defaultValue");return c().isUndefinedOrNull(u)?{}:s?u:{0:u}})(),d=(()=>{const u=y(),h=o+e.propertyPath,P=u.get(h)||{};let T;return Array.isArray(P)?T=P.map((v,S)=>({id:"fe"+Math.floor(Math.random()*42)+Date.now(),label:c().isUndefinedOrNull(v._label)?v:v._label,value:c().isUndefinedOrNull(v._label)?S:v._value,selected:!1})):typeof P=="object"&&(T=Object.entries(P).map(([v,S])=>({id:"fe"+Math.floor(Math.random()*42)+Date.now(),label:S,value:v,selected:!1}))),T.map(v=>{for(const S of Object.keys(i))if(i[S]===v.value){v.selected=!0;break}return v})})(),b=c().isUndefinedOrNull(e.useLabelAsFallbackValue)?!0:e.useLabelAsFallbackValue,E=t instanceof HTMLElement?t.querySelector("typo3-form-property-grid-editor"):t.get(0).querySelector("typo3-form-property-grid-editor");E.enableAddRow=e.enableAddRow,E.enableSelection=m,E.enableMultiSelection=s,E.enableSorting=e.isSortable??!1,E.enableDeleteRow=e.enableDeleteRow??!1,E.enableLabelAsFallbackValue=b,E.entries=d,c().isNonEmptyArray(e.gridColumns)&&e.gridColumns.forEach(u=>{u.name==="label"&&(E.labelLabel=u.title,E.enableLabelFormElementSelectionButton=u.enableFormelementSelectionButton),u.name==="value"&&(E.labelValue=u.title,E.enableValueFormElementSelectionButton=u.enableFormelementSelectionButton),u.name==="selected"&&(E.labelSelected=u.title)}),(E.enableLabelFormElementSelectionButton||E.enableValueFormElementSelectionButton)&&(E.formElements=pe()),E.addEventListener(ue.eventName,u=>{const h=u.data,P=[],T=[];for(const v of h){const S=v.label,q=v.value===""?v.label:c().canBeInterpretedAsInteger(v.value)?parseInt(v.value,10):v.value;v.selected&&P.push(q),T.push({_label:S,_value:q})}s?y().set(o+"defaultValue",P):y().set(o+"defaultValue",P[0]??"",!0),y().set(o+e.propertyPath,T),g(o+e.propertyPath,t)}),g(o+e.propertyPath,t)}function ne(e,t,r,l){p(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1475417093),p(n.type(t)==="object",'Invalid parameter "editorHtml"',1475417094),p(c().isNonEmptyString(e.validatorIdentifier),'Invalid configuration "validatorIdentifier"',1475417095),p(c().isNonEmptyString(e.label),'Invalid configuration "label"',1475417096);const o=e.validatorIdentifier;a().getTemplatePropertyDomElement("label",t).append(e.label);let s,m,i;c().isNonEmptyString(e.propertyPath)&&(m=f().buildPropertyPath(e.propertyPath,r,l)),c().isNonEmptyString(e.propertyValue)?s=e.propertyValue:s="";const d=f().buildPropertyPath(e.configurationOptions.validationErrorMessage.propertyPath),b=a().getTemplatePropertyDomElement("validationErrorMessage",n(t)).clone();a().getTemplatePropertyDomElement("validationErrorMessage",n(t)).remove();const E=function(){const u=n(b).clone(!0,!0);R(t).after(u),a().getTemplatePropertyDomElement("validationErrorMessage-label",u).append(e.configurationOptions.validationErrorMessage.label),a().getTemplatePropertyDomElement("validationErrorMessage-description",u).append(e.configurationOptions.validationErrorMessage.description),i=y().get(d),c().isUndefinedOrNull(i)&&(i=[]);const h=_(e.configurationOptions.validationErrorMessage.errorCodes,i);c().isUndefinedOrNull(h)||a().getTemplatePropertyDomElement("validationErrorMessage-propertyPath",u).val(h),a().getTemplatePropertyDomElement("validationErrorMessage-propertyPath",u).on("keyup paste",function(){let P=y().get(d);c().isUndefinedOrNull(P)&&(P=[]),y().set(d,W(e.configurationOptions.validationErrorMessage.errorCodes,P,n(this).val()))})};f().getIndexFromPropertyCollectionElement(o,"validators")!==-1&&(n('input[type="checkbox"]',n(t)).prop("checked",!0),E()),n('input[type="checkbox"]',n(t)).on("change",function(){a().getTemplatePropertyDomElement("validationErrorMessage",n(t)).off().empty().remove(),n(this).is(":checked")?(E(),w().publish("view/inspector/collectionElement/new/selected",[o,"validators"]),c().isNonEmptyString(m)&&y().set(m,s)):(w().publish("view/inspector/removeCollectionElement/perform",[o,"validators"]),c().isNonEmptyString(m)&&y().unset(m),i=y().get(d),c().isUndefinedOrNull(i)&&(i=[]),y().set(d,W(e.configurationOptions.validationErrorMessage.errorCodes,i,"")))})}function re(e,t,r,l){p(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1476218671),p(n.type(t)==="object",'Invalid parameter "editorHtml"',1476218672),p(c().isNonEmptyString(e.label),'Invalid configuration "label"',1476218673),p(c().isNonEmptyString(e.propertyPath),'Invalid configuration "propertyPath"',1476218674),a().getTemplatePropertyDomElement("label",t).append(e.label),I(e,t);const o=f().buildPropertyPath(e.propertyPath,r,l),s=y().get(o);(e.propertyPath==="renderingOptions.enabled"&&c().isUndefinedOrNull(s)||n.type(s)==="boolean"&&s||s==="true"||s===1||s==="1")&&n('input[type="checkbox"]',n(t)).prop("checked",!0),n('input[type="checkbox"]',n(t)).on("change",function(){n(this).is(":checked")?y().set(o,!0):y().set(o,!1)})}function ae(e,t,r,l){p(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1475412567),p(n.type(t)==="object",'Invalid parameter "editorHtml"',1475412568),p(c().isNonEmptyString(e.propertyPath),'Invalid configuration "propertyPath"',1475416098),p(c().isNonEmptyString(e.label),'Invalid configuration "label"',1475416099);const o=f().buildPropertyPath(e.propertyPath,r,l);a().getTemplatePropertyDomElement("label",t).append(e.label),I(e,t);const s=y().get(o);n("textarea",n(t)).val(s),g(o,t),n("textarea",n(t)).on("keyup paste",function(){y().set(o,n(this).val()),g(o,t)})}function le(e,t,r,l){p(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1477300587),p(n.type(t)==="object",'Invalid parameter "editorHtml"',1477300588),p(c().isNonEmptyString(e.label),'Invalid configuration "label"',1477300589),p(c().isNonEmptyString(e.buttonLabel),'Invalid configuration "buttonLabel"',1477318981),p(c().isNonEmptyString(e.propertyPath),'Invalid configuration "propertyPath"',1477300590),a().getTemplatePropertyDomElement("label",t).append(e.label),a().getTemplatePropertyDomElement("buttonLabel",t).append(e.buttonLabel),I(e,t),n("form",n(t)).prop("name",e.propertyPath),D.getIcon(e.iconIdentifier,D.sizes.small).then(function(m){a().getTemplatePropertyDomElement("image",t).append(n(m))}),a().getTemplatePropertyDomElement("onclick",t).on("click",function(){const m=Math.floor(Math.random()*1e5+1);n(this).closest(a().getDomElementDataIdentifierSelector("editorControlsWrapper")).find(a().getDomElementDataAttribute("contentElementSelectorTarget","bracesWithKey")).attr(a().getDomElementDataAttribute("contentElementSelectorTarget"),m),fe("db",m+"|||"+e.browsableType)}),ve();const o=f().buildPropertyPath(e.propertyPath,r,l),s=y().get(o);g(o,t),a().getTemplatePropertyDomElement("propertyPath",t).val(s),a().getTemplatePropertyDomElement("propertyPath",t).on("keyup paste",function(){y().set(o,n(this).val()),g(o,t)})}function oe(e,t,r,l){p(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1475412563),p(n.type(t)==="object",'Invalid parameter "editorHtml"',1475412564),c().isUndefinedOrNull(r)?n("button",n(t)).addClass(a().getDomElementClassName("buttonFormElementRemove")+" "+a().getDomElementClassName("buttonFormEditor")):n("button",n(t)).addClass(a().getDomElementClassName("buttonCollectionElementRemove")),n("button",n(t)).on("click",function(){c().isUndefinedOrNull(r)?O().showRemoveFormElementModal():O().showRemoveCollectionElementModal(r,l)})}function se(e,t,r){p(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1484574704),p(n.type(t)==="object",'Invalid parameter "editorHtml"',1484574705),p(c().isNonEmptyString(r),'Invalid parameter "propertyPath"',1484574706);const l=t instanceof HTMLElement?t.querySelector("typo3-form-element-selector"):t.get(0).querySelector("typo3-form-element-selector");l&&(e.enableFormelementSelectionButton===!0?(l.elements=pe(),l.addEventListener(Ee.eventName,o=>{let s;s=y().get(r)||"",s.length===0?s=`{${o.value}}`:s=`${s} {${o.value}}`,y().set(r,s),a().getTemplatePropertyDomElement("propertyPath",t).val(s),g(r,t)})):l.remove())}function pe(){return f().getNonCompositeNonToplevelFormElements().map(t=>({icon:N(t,"iconIdentifier"),label:t.get("label"),value:t.get("identifier")}))}function ie(e){c().isUndefinedOrNull(e)&&(e=y()),p(n.type(e)==="object",'Invalid parameter "formElement"',1478967319);let t;e.get("type")==="Form"?t=e.get("type"):t=N(e,"label")?N(e,"label"):e.get("identifier");const r=document.createElement("span");return r.textContent=t,r}function I(e,t){c().isNonEmptyString(e.description)?a().getTemplatePropertyDomElement("description",t).text(e.description):a().getTemplatePropertyDomElement("description",t).remove()}function De(e,t){return B=e,U=n.extend(!0,ye,t||{}),A.bootstrap(B),this}export{De as bootstrap,ie as buildTitleByFormElement,M as getCollectionElementDomElement,V as getFinishersContainerDomElement,x as getInspectorDomElement,k as getValidatorsContainerDomElement,re as renderCheckboxEditor,Ie as renderCollectionElementEditors,Y as renderCollectionElementHeaderEditor,G as renderCollectionElementSelectionEditor,Z as renderCountrySelectEditor,I as renderDescription,Pe as renderEditors,J as renderFileMaxSizeEditor,$ as renderFormElementHeaderEditor,se as renderFormElementSelectorEditorAddition,ee as renderGridColumnViewPortConfigurationEditor,H as renderMultiSelectEditor,te as renderPropertyGridEditor,oe as renderRemoveElementEditor,ne as renderRequiredValidatorEditor,C as renderSingleSelectEditor,Q as renderTextEditor,ae as renderTextareaEditor,le as renderTypo3WinBrowserEditor,X as renderValidationErrorMessageEditor};
