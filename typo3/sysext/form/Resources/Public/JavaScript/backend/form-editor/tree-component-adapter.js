/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import o from"jquery";import*as B from"@typo3/form/backend/form-editor/helper.js";import{FORM_EDITOR_TREE_EVENTS as h}from"@typo3/form/backend/form-editor-tree-events.js";import{stripTags as G}from"@typo3/form/backend/form-editor/utility/string-utility.js";import"@typo3/form/backend/form-editor-tree-container.js";let v=null,i=null,a=null;function s(){return v}function l(){return s().getPublisherSubscriber()}function F(){return s().getRootFormElement()}function b(){return s().getCurrentlySelectedFormElement()}function f(e,t){return s().getFormElementDefinition(e,t)}function y(e){const t=e.get("label")||e.get("identifier"),n={identifier:e.get("identifier"),identifierPath:e.get("__identifierPath"),label:G(t),type:f(e,"label"),iconIdentifier:f(e,"iconIdentifier"),isComposite:f(e,"_isCompositeFormElement"),isTopLevel:f(e,"_isTopLevelFormElement"),enabled:e.get("renderingOptions.enabled")!==!1,children:[]},r=e.get("renderables");return Array.isArray(r)&&r.length>0&&(n.children=r.map(d=>y(d))),n}function K(){const e=F(),t=y(e);return t.expanded=!0,[t]}function E(e){if(!i)return;const t=K();requestAnimationFrame(()=>{i.setNodes(t);let n=e;if(!n)try{n=b()}catch{n=null}if(n){const r=n.get("__identifierPath");i.setSelectedNode(r)}})}function D(e,t){if(!t)try{t=b()}catch{return}e&&t.set("label",e),E(t)}function I(e){let t;if(typeof e=="string")t=e;else{let n=e;if(!n)try{n=b()}catch{return o()}t=n.get("__identifierPath")}return o(`[data-id="${t}"]`,a)}function C(){return o(".tree-item",a)}function _(e,t=!0){i&&i.setNodeValidationError(e,t)}function L(e,t=!0){i&&i.setNodeChildHasError(e,t)}function A(){i&&i.clearAllValidationErrors()}function S(){return a}function x(e){const t=document.createElement("span");t.textContent=e.get("label")?e.get("label"):e.get("identifier");const n=document.createElement("small");return n.textContent="("+f(e,"label")+")",t.appendChild(n),t}function $(e){return o(e).find(".tree-item-content").first()}function O(e){return o(e).closest("[data-id]").attr("data-id")||""}function T(e){return o(e).parent().closest("li[data-id]").find(".tree-item-content").first()}function R(e){return T(e).closest("li[data-id]").attr("data-id")||""}function W(e,t="prev"){const n=o(e).closest("li[data-id]");return(t==="prev"?n.prev("li[data-id]"):n.next("li[data-id]")).attr("data-id")||""}function V(){return o("<div></div>")}function P(){return window.parent.document.querySelector("typo3-backend-navigation-component-formeditortree")}function M(){const e=P();return e?Promise.resolve(e):new Promise(t=>{const n=()=>{clearTimeout(r),window.parent.document.removeEventListener("typo3:tree-container:ready",n);const d=P();t(d)};window.parent.document.addEventListener("typo3:tree-container:ready",n);const r=window.setTimeout(()=>{window.parent.document.removeEventListener("typo3:tree-container:ready",n),console.warn("[FormEditor Tree Adapter] Tree container not found within timeout"),t(null)},5e3)})}function H(e,t){return v=e,a=t,i=P(),i?k():M().then(n=>{n&&(i=n,k(),v&&F()&&E())}),{renew:E,setTreeNodeTitle:D,getTreeNode:I,getAllTreeNodes:C,setNodeValidationError:_,setNodeChildHasError:L,clearAllValidationErrors:A,getTreeDomElement:S,buildTitleByFormElement:x,getTreeNodeWithinDomElement:$,getTreeNodeIdentifierPathWithinDomElement:O,getParentTreeNodeWithinDomElement:T,getParentTreeNodeIdentifierPathWithinDomElement:R,getSiblingTreeNodeIdentifierPathWithinDomElement:W,renderCompositeFormElementChildsAsSortableList:V,bootstrap:H}}function k(){i&&(i.addEventListener(h.NODE_CLICKED,e=>{const t=e,{identifierPath:n}=t.detail;try{l().publish("view/tree/node/clicked",[n])}catch{}}),i.addEventListener(h.NODE_EDIT,e=>{const t=e,{identifierPath:n}=t.detail;l().publish("view/tree/node/clicked",[n])}),i.addEventListener(h.DND_UPDATE,e=>{const t=e,{movedIdentifierPath:n,previousIdentifierPath:r,nextIdentifierPath:d}=t.detail,m=o(`[data-id="${n}"]`,a);l().publish("view/tree/dnd/update",[m,n,r,d]),l().publish("view/tree/dnd/stop",[n])}),i.addEventListener(h.DND_CHANGE,e=>{const t=e,{itemIdentifierPath:n,parentIdentifierPath:r,position:d,previousIdentifierPath:m,nextIdentifierPath:N}=t.detail,g=o(`[data-id="${n}"]`,a),q=s().findEnclosingCompositeFormElementWhichIsNotOnTopLevel(r);l().publish("view/tree/dnd/change",[g,r,q]);let c,u;d==="inside"?(c="inside",u=r):N?(c="before",u=N):m?(c="after",u=m):(c="inside",u=r);try{const p=s().moveFormElement(n,c,u,!1),w=p.get("__identifierPath");p&&g.length>0&&g.attr(B.getDomElementDataAttribute("elementIdentifier"),w),l().publish("view/tree/dnd/stop",[w])}catch(p){console.error("[FormEditor Tree] Failed to move element:",p)}}))}export{H as bootstrap,x as buildTitleByFormElement,A as clearAllValidationErrors,C as getAllTreeNodes,R as getParentTreeNodeIdentifierPathWithinDomElement,T as getParentTreeNodeWithinDomElement,W as getSiblingTreeNodeIdentifierPathWithinDomElement,S as getTreeDomElement,I as getTreeNode,O as getTreeNodeIdentifierPathWithinDomElement,$ as getTreeNodeWithinDomElement,V as renderCompositeFormElementChildsAsSortableList,E as renew,L as setNodeChildHasError,_ as setNodeValidationError,D as setTreeNodeTitle};
