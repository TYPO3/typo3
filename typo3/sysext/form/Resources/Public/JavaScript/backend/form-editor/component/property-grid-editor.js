/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{LitElement as f,html as d,nothing as h}from"lit";import{repeat as v}from"lit/directives/repeat.js";import{classMap as g}from"lit/directives/class-map.js";import{live as b}from"lit/directives/live.js";import{property as s,state as u,customElement as y}from"lit/decorators.js";import"@typo3/backend/element/icon-element.js";import"@typo3/form/backend/form-editor/component/form-element-selector.js";var a=function(p,e,t,l){var i=arguments.length,o=i<3?e:l===null?l=Object.getOwnPropertyDescriptor(e,t):l,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(p,e,t,l);else for(var c=p.length-1;c>=0;c--)(r=p[c])&&(o=(i<3?r(o):i>3?r(e,t,o):r(e,t))||o);return i>3&&o&&Object.defineProperty(e,t,o),o};class m extends Event{static{this.eventName="typo3:backend:form-editor:component:property-grid-editor:update"}constructor(e){super(m.eventName),this.data=e}}let n=class extends f{constructor(){super(...arguments),this.entries=[],this.formElements=[],this.labelLabel="Label",this.labelValue="Value",this.labelSelected="Selected",this.labelAdd="Add",this.labelRemove="Remove",this.labelMove="Move",this.enableAddRow=!1,this.enableDeleteRow=!1,this.enableSelection=!0,this.enableMultiSelection=!1,this.enableSorting=!1,this.enableLabelAsFallbackValue=!1,this.enableLabelFormElementSelectionButton=!1,this.enableValueFormElementSelectionButton=!1,this.draggedEntry=null,this.movedEntry=null,this.activeElementRef=null}createRenderRoot(){return this}updated(e){if(this.activeElementRef&&(this.activeElementRef.focus(),this.activeElementRef=null),e.has("entries")){const t=e.get("entries");t!==void 0&&JSON.stringify(t)!==JSON.stringify(this.entries)&&this.dispatchEvent(new m(this.entries))}}render(){return d`<div class=property-grid-editor>${this.entries?.length?d`<div class=property-grid-editor__entries>${v(this.entries,e=>e.id,e=>this.renderEntry(e))}</div>`:h} ${this.enableAddRow?d`<div class=property-grid-editor__actions><button class="btn btn-sm btn-default" title=${this.labelAdd} @click=${this.handleCreate}><typo3-backend-icon identifier=actions-plus size=small></typo3-backend-icon><span class=btn-label>${this.labelAdd}</span></button></div>`:h}</div>`}renderEntry(e){return d`<div class=${g({"property-grid-editor__entry":!0,moving:this.movedEntry===e,dragging:this.draggedEntry===e})} @dragover=${t=>this.handleDragOver(t)} @dragenter=${t=>this.handleDragEnter(t,e)} @drop=${t=>this.handleDrop(t)} @dragend=${t=>this.handleDragEnd(t)}><div class=property-grid-editor__entry-inputs><div class=form-group><label for=${e.id}-label class=form-label>${this.labelLabel}</label><div class="input-group form-control-wrap"><input id=${e.id}-label class="form-control form-control-sm" type=text @change=${t=>this.handleChange(t,"label",e)} @keyup=${t=>this.handleChange(t,"label",e)} @focusout=${()=>this.handleFocusOut(e)} .value=${b(e.label)}> ${this.renderFormElementSelectionButton(this.enableLabelFormElementSelectionButton,"label",e)}</div></div><div class=form-group><label for=${e.id}-value class=form-label>${this.labelValue}</label><div class="input-group form-control-wrap"><input id=${e.id}-value class="form-control form-control-sm" type=text @change=${t=>this.handleChange(t,"value",e)} @keyup=${t=>this.handleChange(t,"value",e)} .value=${b(e.value)}> ${this.renderFormElementSelectionButton(this.enableValueFormElementSelectionButton,"value",e)}</div></div>${this.enableSelection||this.enableMultiSelection?d`<div class=form-check><input id=${e.id}-selected class=form-check-input type=checkbox @change=${t=>this.handleChange(t,"selected",e)} .checked=${b(e.selected)}> <label for=${e.id}-selected class=form-check-label>${this.labelSelected}</label></div>`:h}</div>${this.enableSorting||this.enableDeleteRow?d`<div class=property-grid-editor__entry-buttons>${this.enableSorting?d`<button class="btn btn-sm btn-default" title=${this.labelMove} draggable=true @click=${t=>this.handleMoveClick(t,e)} @keydown=${this.handleMoveKeyDown} @dragstart=${t=>this.handleDragStart(t,e)}><typo3-backend-icon identifier=${this.movedEntry===e?"actions-thumbtack":"actions-move-move"} size=small></typo3-backend-icon></button>`:h} ${this.enableDeleteRow?d`<button class="btn btn-sm btn-default" title=${this.labelRemove} @click=${()=>this.handleRemove(e)}><typo3-backend-icon identifier=actions-delete size=small></typo3-backend-icon></button>`:h}</div>`:h}</div>`}renderFormElementSelectionButton(e,t,l){return!e||!this.formElements?.length?d`${h}`:d`<typo3-form-element-selector @typo3:backend:form-editor:component:form-element-selector:selected=${i=>this.handleFormElementSelection(i,t,l)} elements=${JSON.stringify(this.formElements)} size=small></typo3-form-element-selector>`}handleFormElementSelection(e,t,l){const i=l[t];i?this.setEntryProperty(l,t,`${i} {${e.value}}`):this.setEntryProperty(l,t,`{${e.value}}`)}handleFocusOut(e){this.enableLabelAsFallbackValue&&e.value===""&&this.setEntryProperty(e,"value",e.label)}handleChange(e,t,l){const i=e.target,o=i.type==="checkbox"?i.checked:i.value;this.setEntryProperty(l,t,o)}handleRemove(e){this.entries=this.entries.filter(t=>t!==e)}handleCreate(){const e={id:"fe"+Math.floor(Math.random()*42)+Date.now(),label:"",value:"",selected:!1};this.entries=[...this.entries,e]}handleDragStart(e,t){e.stopImmediatePropagation(),this.draggedEntry=t,e.dataTransfer?.setData("text/plain","dragging"),e.dataTransfer?.setDragImage(new Image,0,0)}handleDragOver(e){e.preventDefault(),e.stopImmediatePropagation()}handleDragEnter(e,t){if(e.preventDefault(),e.stopImmediatePropagation(),!this.draggedEntry||this.draggedEntry===t)return;const l=[...this.entries],i=l.indexOf(this.draggedEntry),o=l.indexOf(t);l.splice(i,1);const r=(i<o,o);l.splice(r,0,this.draggedEntry),this.entries=l}handleDrop(e){e.preventDefault(),e.stopImmediatePropagation(),this.draggedEntry=null}handleDragEnd(e){e.stopImmediatePropagation(),this.draggedEntry=null}handleMoveClick(e,t){this.movedEntry===t?this.movedEntry=null:this.movedEntry=t}handleMoveKeyDown(e){if(this.movedEntry===null||!["ArrowDown","ArrowUp","Home","End","Enter","Space","Escape","Tab"].includes(e.code)||e.altKey||e.ctrlKey)return;e.preventDefault();let l;switch(e.code){case"Escape":case"Enter":case"Space":this.movedEntry=null;return;case"ArrowUp":l=-1;break;case"ArrowDown":l=1;break;default:return}const i=[...this.entries],o=i.indexOf(this.movedEntry),r=o+l;if(r<0||r>=i.length)return;i.splice(o,1);const c=(o<r,r);i.splice(c,0,this.movedEntry),this.entries=i,this.activeElementRef=e.target.closest("button")}setEntryProperty(e,t,l){const i=this.entries.indexOf(e);if(i===-1)return;const o={...e};if(t==="label"&&(o.label=String(l)),t==="value"&&(o.value=String(l)),t==="selected"&&(o.selected=!!l,o.selected===!0&&!this.enableMultiSelection)){this.entries=this.entries.map((r,c)=>c===i?o:{...r,selected:!1});return}this.entries=this.entries.map((r,c)=>c===i?o:r)}};a([s({type:Array,attribute:"entries"})],n.prototype,"entries",void 0),a([s({type:Array,attribute:"form-elements"})],n.prototype,"formElements",void 0),a([s({type:String,attribute:"label-label"})],n.prototype,"labelLabel",void 0),a([s({type:String,attribute:"label-value"})],n.prototype,"labelValue",void 0),a([s({type:String,attribute:"label-selected"})],n.prototype,"labelSelected",void 0),a([s({type:String,attribute:"label-add"})],n.prototype,"labelAdd",void 0),a([s({type:String,attribute:"label-remove"})],n.prototype,"labelRemove",void 0),a([s({type:String,attribute:"label-move"})],n.prototype,"labelMove",void 0),a([s({type:Boolean})],n.prototype,"enableAddRow",void 0),a([s({type:Boolean})],n.prototype,"enableDeleteRow",void 0),a([s({type:Boolean})],n.prototype,"enableSelection",void 0),a([s({type:Boolean})],n.prototype,"enableMultiSelection",void 0),a([s({type:Boolean})],n.prototype,"enableSorting",void 0),a([s({type:Boolean})],n.prototype,"enableLabelAsFallbackValue",void 0),a([s({type:Boolean})],n.prototype,"enableLabelFormElementSelectionButton",void 0),a([s({type:Boolean})],n.prototype,"enableValueFormElementSelectionButton",void 0),a([u()],n.prototype,"draggedEntry",void 0),a([u()],n.prototype,"movedEntry",void 0),n=a([y("typo3-form-property-grid-editor")],n);export{n as PropertyGridEditor,m as PropertyGridEditorUpdateEvent};
