/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import t from"jquery";import*as A from"@typo3/form/backend/form-editor/helper.js";import v from"@typo3/backend/icons.js";import Y from"sortablejs";import"@typo3/form/backend/form-editor/component/form-element-stage-item.js";import"@typo3/form/backend/form-editor/component/page-stage-item.js";const Z={domElementClassNames:{formElementIsComposit:"formeditor-element-composit",formElementIsTopLevel:"formeditor-element-toplevel",noNesting:"no-nesting",selected:"selected",sortable:"sortable",previewViewPreviewElement:"formeditor-element-preview"},domElementDataAttributeNames:{abstractType:"data-element-abstract-type",noSorting:"data-no-sorting"},domElementDataAttributeValues:{abstractViewToolbar:"elementToolbar",abstractViewToolbarNewElement:"stageElementToolbarNewElement",abstractViewToolbarNewElementSplitButton:"stageElementToolbarNewElementSplitButton",abstractViewToolbarNewElementSplitButtonAfter:"stageElementToolbarNewElementSplitButtonAfter",abstractViewToolbarNewElementSplitButtonInside:"stageElementToolbarNewElementSplitButtonInside",abstractViewToolbarRemoveElement:"stageElementToolbarRemoveElement",buttonHeaderRedo:"redoButton",buttonHeaderUndo:"undoButton",buttonPaginationPrevious:"buttonPaginationPrevious",buttonPaginationNext:"buttonPaginationNext","FormElement-_ElementToolbar":"FormElement-_ElementToolbar","FormElement-_UnknownElement":"FormElement-_UnknownElement",formElementIcon:"elementIcon",iconValidator:"form-validator",multiValueContainer:"multiValueContainer",paginationTitle:"paginationTitle",stageHeadline:"formDefinitionLabel",stagePanel:"stagePanel",validatorsContainer:"validatorsContainer",validatorIcon:"validatorIcon"},isSortable:!0};let _=null,k=null,E=null;function c(){return k}function i(e){return p().isUndefinedOrNull(e)?A.setConfiguration(_):A.setConfiguration(e)}function p(){return c().getUtility()}function b(){return c().getViewModel()}function D(e,n,o){return c().assert(e,n,o)}function N(){return c().getRootFormElement()}function B(){return c().getCurrentlySelectedFormElement()}function y(){return c().getPublisherSubscriber()}function f(e,n){return c().getFormElementDefinition(e,n)}function ee(e,n){p().isNonEmptyString(n)&&t(e).text(n)}function te(e,n){y().publish("view/stage/abstract/render/template/perform",[e,n])}function j(e){let n,o;const a=t("<li></li>");f(e,"_isCompositeFormElement")||a.addClass(i().getDomElementClassName("noNesting")),f(e,"_isTopLevelFormElement")&&a.addClass(i().getDomElementClassName("formElementIsTopLevel")),f(e,"_isCompositeFormElement")&&a.addClass(i().getDomElementClassName("formElementIsComposit"));try{o=i().getTemplate("FormElement-"+e.get("type")).clone()}catch{o=i().getTemplate("FormElement-_UnknownElement").clone(),D(o.length>0,'No template found for element "'+e.get("__identifierPath")+'"',1478987818)}o=t("<div></div>").attr(i().getDomElementDataAttribute("elementIdentifier"),e.get("__identifierPath")).append(t(o.html()));const l=f(e,"_isCompositeFormElement");l&&o.attr(i().getDomElementDataAttribute("abstractType"),"isCompositeFormElement");const s=f(e,"_isTopLevelFormElement");s?o.attr(i().getDomElementDataAttribute("abstractType"),"isTopLevelFormElement"):o.addClass("formeditor-element"),e.get("renderingOptions.enabled")===!1&&o.addClass("formeditor-element-hidden"),a.append(o);const r=i().getTemplate("FormElement-"+e.get("type")).length===0;if(s&&r?$(e,o):r?G(e,o):te(e,o),s||l){n=t("<ol></ol>"),n.addClass(i().getDomElementClassName("sortable")),n.addClass("formeditor-list");const m=e.get("renderables");if(t.type(m)==="array")for(let h=0,u=m.length;h<u;++h)n.append(j(m[h]));a.append(n)}return a}function ne(){const e=E.get(0).querySelectorAll("ol."+i().getDomElementClassName("sortable")),n="li:not("+i().getDomElementDataAttribute("noSorting","bracesWithKey")+")",o="div"+i().getDomElementDataAttribute("elementIdentifier","bracesWithKey");e.forEach(function(a){a.querySelectorAll(o).forEach(function(l){l.classList.add("formeditor-sortable-handle")}),new Y(a,{group:"stage-nodes",handle:o,draggable:n,animation:200,swapThreshold:.6,dragClass:"formeditor-sortable-drag",ghostClass:"formeditor-sortable-ghost",onStart:function(l){y().publish("view/stage/abstract/dnd/start",[t(l.item),t(l.item)])},onChange:function(l){let s;const r=M(t(l.item));r&&(s=c().findEnclosingCompositeFormElementWhichIsNotOnTopLevel(r)),y().publish("view/stage/abstract/dnd/change",[t(l.item),r,s])},onEnd:function(l){const s=V(t(l.item)),r=x(t(l.item),"prev"),m=x(t(l.item),"next");y().publish("view/stage/abstract/dnd/update",[t(l.item),s,r,m]),y().publish("view/stage/abstract/dnd/stop",[V(t(l.item))])}})})}function ie(){return E}function W(e){p().isUndefinedOrNull(e)&&(e=N()),D(t.type(e)==="object",'Invalid parameter "formElement"',1479037151);const n=document.createElement("span");return n.textContent=e.get("label")?e.get("label"):e.get("identifier"),n}function oe(e){p().isUndefinedOrNull(e)&&(e=W().textContent),t(i().getDomElementDataIdentifierSelector("stageHeadline")).text(e)}function le(){return t(i().getDomElementDataIdentifierSelector("stagePanel"))}function ae(){const e=N().get("renderables").length;b().enableButton(t(i().getDomElementDataIdentifierSelector("buttonPaginationPrevious"))),b().enableButton(t(i().getDomElementDataIdentifierSelector("buttonPaginationNext"))),c().getCurrentlySelectedPageIndex()===0&&b().disableButton(t(i().getDomElementDataIdentifierSelector("buttonPaginationPrevious"))),(e===1||c().getCurrentlySelectedPageIndex()===e-1)&&b().disableButton(t(i().getDomElementDataIdentifierSelector("buttonPaginationNext")));const n=c().getCurrentlySelectedPageIndex()+1;t(i().getDomElementDataIdentifierSelector("paginationTitle")).text(f(N(),"paginationTitle").replace("{0}",n.toString()).replace("{1}",e))}function re(){b().enableButton(t(i().getDomElementDataIdentifierSelector("buttonHeaderUndo"))),b().enableButton(t(i().getDomElementDataIdentifierSelector("buttonHeaderRedo"))),c().getCurrentApplicationStatePosition()+1>=c().getCurrentApplicationStates()&&b().disableButton(t(i().getDomElementDataIdentifierSelector("buttonHeaderUndo"))),c().getCurrentApplicationStatePosition()===0&&b().disableButton(t(i().getDomElementDataIdentifierSelector("buttonHeaderRedo")))}function K(){return t(i().getDomElementDataAttribute("elementIdentifier","bracesWithKey"),E)}function R(e){return D(t.type(e)==="number",'Invalid parameter "pageIndex"',1478721208),t("<ol></ol>").addClass("formeditor-list").append(j(N().get("renderables")[e]))}function H(e){return t(e).parent().closest("li").find(i().getDomElementDataAttribute("elementIdentifier","bracesWithKey")).first()}function M(e){return H(e).attr(i().getDomElementDataAttribute("elementIdentifier"))}function q(e){return t(e).find(i().getDomElementDataAttribute("elementIdentifier","bracesWithKey")).first()}function V(e){return q(t(e)).attr(i().getDomElementDataAttribute("elementIdentifier"))}function x(e,n){p().isUndefinedOrNull(n)&&(n="prev");const o=V(e);return e=n==="prev"?t(e).prev("li"):t(e).next("li"),e.find(i().getDomElementDataAttribute("elementIdentifier","bracesWithKey")).not(i().getDomElementDataAttribute("elementIdentifier","bracesWithKeyValue",[o])).first().attr(i().getDomElementDataAttribute("elementIdentifier"))}function se(e){let n;return typeof e=="string"?n=e:p().isUndefinedOrNull(e)?n=B().get("__identifierPath"):n=e.get("__identifierPath"),t(i().getDomElementDataAttribute("elementIdentifier","bracesWithKeyValue",[n]),E)}function me(){t(i().getDomElementDataIdentifierSelector("abstractViewToolbar"),E).off().empty().remove(),z()}function L(e){let n;D(t.type(e)==="object",'Invalid parameter "formElement"',1479035778);const o=f(e,void 0);return o._isTopLevelFormElement?t():(n=i().getTemplate("FormElement-_ElementToolbar").clone(),n.length?(n=t(t(n.html())),i().getTemplatePropertyDomElement("_type",n).text(f(e,"label")),i().getTemplatePropertyDomElement("_identifier",n).text(e.get("identifier")),o._isCompositeFormElement?(b().hideComponent(t(i().getDomElementDataIdentifierSelector("abstractViewToolbarNewElement"),n)),t(i().getDomElementDataIdentifierSelector("abstractViewToolbarNewElementSplitButtonAfter"),n).on("click",function(){y().publish("view/stage/abstract/elementToolbar/button/newElement/clicked",["view/insertElements/perform/after",{disableElementTypes:[],onlyEnableElementTypes:[]}])}),t(i().getDomElementDataIdentifierSelector("abstractViewToolbarNewElementSplitButtonInside"),n).on("click",function(){y().publish("view/stage/abstract/elementToolbar/button/newElement/clicked",["view/insertElements/perform/inside",{disableElementTypes:[],onlyEnableElementTypes:[]}])})):(b().hideComponent(t(i().getDomElementDataIdentifierSelector("abstractViewToolbarNewElementSplitButton"),n)),t(i().getDomElementDataIdentifierSelector("abstractViewToolbarNewElement"),n).on("click",function(){y().publish("view/stage/abstract/elementToolbar/button/newElement/clicked",["view/insertElements/perform/after",{disableElementTypes:[]}])})),t(i().getDomElementDataIdentifierSelector("abstractViewToolbarRemoveElement"),n).on("click",function(){b().showRemoveFormElementModal()}),n):t())}function de(e,n,o){p().isUndefinedOrNull(n)&&(n=B());const a=e.find("typo3-form-form-element-stage-item")[0];if(a&&a.toolbarConfig){a.toolbarConfig={...a.toolbarConfig,showToolbar:!0};return}o?L(n).fadeOut(0,function(){e.prepend(t(this)),t(i().getDomElementDataIdentifierSelector("abstractViewToolbar"),e).fadeIn("fast")}):e.prepend(L(n))}function z(){document.querySelectorAll("typo3-form-form-element-stage-item").forEach(n=>{const o=n;o.toolbarConfig&&(o.toolbarConfig={...o.toolbarConfig,showToolbar:!1})})}function ce(e,n){p().isUndefinedOrNull(e)&&(e=c().getCurrentlySelectedPageIndex()),E.off().empty().append(R(e)),E.on("click",function(o){const a=t(o.target).closest(i().getDomElementDataAttribute("elementIdentifier","bracesWithKey")).attr(i().getDomElementDataAttribute("elementIdentifier"));p().isUndefinedOrNull(a)||!p().isNonEmptyString(a)||y().publish("view/stage/element/clicked",[a])}),_.isSortable&&ne(),t.type(n)==="function"&&n()}function fe(e){D(p().isNonEmptyString(e),'Invalid parameter "html"',1475424409),E.off().empty().html(e),t(":input",E).prop("disabled","disabled").on("click dblclick select focus keydown keypress keyup mousedown mouseup",function(n){return n.preventDefault()}),t("form",E).submit(function(n){return n.preventDefault()}),K().each(function(){const n=c().getFormElementByIdentifierPath(t(this).data("elementIdentifierPath"));f(n,"_isTopLevelFormElement")||t(this).attr("title","identifier: "+n.get("identifier")+" (type: "+n.get("type")+")"),f(n,"_isTopLevelFormElement")&&t(this).addClass(i().getDomElementClassName("formElementIsTopLevel")),f(n,"_isCompositeFormElement")&&t(this).addClass(i().getDomElementClassName("formElementIsComposit"))})}function $(e,n){D(t.type(e)==="object",'Invalid parameter "formElement"',1768924251);const o=document.createElement("typo3-form-page-stage-item");o.pageTitle=e.get("label")||"",n.empty().append(o)}function G(e,n){D(t.type(e)==="object",'Invalid parameter "formElement"',1768924252);const o=document.createElement("typo3-form-form-element-stage-item");o.elementType=f(e,"label"),o.elementIdentifier=e.get("identifier"),o.elementLabel=e.get("label")||e.get("identifier"),o.elementIconIdentifier=f(e,"iconIdentifier"),o.isHidden=e.get("renderingOptions.enabled")===!1;const a=e.get("validators"),l=[];let s=!1;if(t.type(a)==="array"&&a.length>0)for(let d=0,g=a.length;d<g;++d){if(a[d].identifier==="NotEmpty"){s=!0;continue}const I=c().getFormEditorDefinition("validators",a[d].identifier);l.push({identifier:a[d].identifier,label:I.label})}o.validators=l,o.isRequired=s;const r=e.get("properties.text");r&&p().isNonEmptyString(r)&&(o.content=r);const m=e.get("properties.contentElementUid");m&&p().isNonEmptyString(m)&&(o.content=m);const u=e.get("properties.options"),C=[];if(u){let d=e.get("defaultValue");if(c().getUtility().isUndefinedOrNull(d)?d={}:t.type(d)==="string"&&(d={0:d}),t.type(u)==="object")for(const g of Object.keys(u)){let I=!1;for(const w of Object.keys(d))if(d[w]===g){I=!0;break}C.push({label:u[g],value:g,selected:I})}else if(t.type(u)==="array")for(const g of Object.keys(u)){let I,w;p().isUndefinedOrNull(u[g]._label)?(I=u[g],w=g):(I=u[g]._label,w=u[g]._value);let U=!1;for(const X of Object.keys(d))if(d[X]===w){U=!0;break}C.push({label:I,value:w,selected:U})}}o.options=C;const T=e.get("properties.allowedMimeTypes"),P=[];if(T){if(t.type(T)==="object")for(const d of Object.keys(T))isNaN(Number(d))||P.push(T[d]);else if(t.type(T)==="array")for(let d=0,g=T.length;d<g;++d)P.push(T[d])}P.length>0&&(o.allowedMimeTypes=P),o.isHidden&&o.classList.add("formeditor-element-hidden");const Q=f(e,void 0);o.toolbarConfig={showToolbar:!1,isCompositeElement:Q._isCompositeFormElement||!1,elementTypeLabel:f(e,"label"),elementIdentifier:e.get("identifier")},o.addEventListener("toolbar-new-element-after",()=>{y().publish("view/stage/abstract/elementToolbar/button/newElement/clicked",["view/insertElements/perform/after",{disableElementTypes:[]}])}),o.addEventListener("toolbar-new-element-inside",()=>{y().publish("view/stage/abstract/elementToolbar/button/newElement/clicked",["view/insertElements/perform/inside",{disableElementTypes:[],onlyEnableElementTypes:[]}])}),o.addEventListener("toolbar-remove-element",()=>{b().showRemoveFormElementModal()}),n.empty().append(o)}function O(e,n,o){t(i().getDomElementDataAttribute("templateProperty","bracesWithKey"),n).each(function(a,l){const s=t(l).attr(i().getDomElementDataAttribute("templateProperty")),r=e.get(s);t.type(o)==="function"&&o(s,r,l)})}function ue(e,n){F(e,n),O(e,n,function(o,a,l){(t.type(a)==="boolean"&&a||a==="true"||a===1||a==="1")&&t(l).addClass(i().getDomElementClassName("noNesting"))})}function J(e,n){D(t.type(e)==="object",'Invalid parameter "formElement"',1479035696),O(e,n,(a,l,s)=>{ee(s,l)});const o=e.get("renderingOptions.enabled")===!1?"overlay-hidden":null;v.getIcon(f(e,"iconIdentifier"),v.sizes.small,o,v.states.default,v.markupIdentifiers.inline).then(function(a){t(i().getDomElementDataIdentifierSelector("formElementIcon"),n).append(t(a).addClass(i().getDomElementClassName("icon")))}),i().getTemplatePropertyDomElement("_type",n).append(document.createTextNode(f(e,"label"))),i().getTemplatePropertyDomElement("_identifier",n).append(document.createTextNode(e.get("identifier")))}function F(e,n){D(t.type(e)==="object",'Invalid parameter "formElement"',1479035674),J(e,n);const o=t(i().getDomElementDataIdentifierSelector("validatorsContainer"),t(n)).clone();t(i().getDomElementDataIdentifierSelector("validatorsContainer"),t(n)).empty();const a=e.get("validators");if(t.type(a)==="array"){let l=0;if(a.length>0){for(let s=0,r=a.length;s<r;++s){if(a[s].identifier==="NotEmpty"){i().getTemplatePropertyDomElement("_required",n).text("*");continue}l++;const m=c().getFormEditorDefinition("validators",a[s].identifier),h=t(t(o).clone());i().getTemplatePropertyDomElement("_label",h).append(document.createTextNode(m.label)),t(i().getDomElementDataIdentifierSelector("validatorsContainer"),t(n)).append(h.html())}l>0&&v.getIcon(i().getDomElementDataAttributeValue("iconValidator"),v.sizes.small,null,v.states.default,v.markupIdentifiers.inline).then(function(s){t(i().getDomElementDataIdentifierSelector("validatorIcon"),t(n)).append(t(s).addClass(i().getDomElementClassName("icon")))})}}}function pe(e,n){const o=t(i().getDomElementDataIdentifierSelector("multiValueContainer"),t(n)).clone();t(i().getDomElementDataIdentifierSelector("multiValueContainer"),t(n)).empty(),F(e,n);const a=t(i().getDomElementDataIdentifierSelector("multiValueContainer"),t(n)).attr(i().getDomElementDataAttribute("templateProperty")),l=e.get(a),s=(m,h,u)=>{let C=!1;const S=t(t(o).clone());for(const T of Object.keys(u))if(u[T]===h){C=!0;break}i().getTemplatePropertyDomElement("_label",S).append(document.createTextNode(m)),C&&i().getTemplatePropertyDomElement("_label",S).addClass(i().getDomElementClassName("selected")),t(i().getDomElementDataIdentifierSelector("multiValueContainer"),t(n)).append(S.html())};let r=e.get("defaultValue");if(c().getUtility().isUndefinedOrNull(r)?r={}:t.type(r)==="string"&&(r={0:r}),t.type(l)==="object")for(const m of Object.keys(l))s(l[m],m,r);else if(t.type(l)==="array")for(const m of Object.keys(l))p().isUndefinedOrNull(l[m]._label)?s(l[m],m,r):s(l[m]._label,l[m]._value,r)}function ge(e,n){const o=t(i().getDomElementDataIdentifierSelector("multiValueContainer"),t(n)).clone();t(i().getDomElementDataIdentifierSelector("multiValueContainer"),t(n)).empty(),F(e,n);const a=t(i().getDomElementDataIdentifierSelector("multiValueContainer"),t(n)).attr(i().getDomElementDataAttribute("templateProperty")),l=e.get(a),s=function(r){const m=t(t(o).clone());i().getTemplatePropertyDomElement("_value",m).append(r),t(i().getDomElementDataIdentifierSelector("multiValueContainer"),t(n)).append(m.html())};if(t.type(l)==="object")for(const r of Object.keys(l))s(l[r]);else if(t.type(l)==="array")for(let r=0,m=l.length;r<m;++r)s(l[r])}function be(e,n,o){return k=e,D(t.type(n)==="object",'Invalid parameter "appendToDomElement"',1478992119),E=t(n),_=t.extend(!0,Z,o||{}),A.bootstrap(k),this}export{be as bootstrap,W as buildTitleByFormElement,L as createAbstractViewFormElementToolbar,de as createAndAddAbstractViewFormElementToolbar,O as eachTemplateProperty,se as getAbstractViewFormElementDomElement,V as getAbstractViewFormElementIdentifierPathWithinDomElement,q as getAbstractViewFormElementWithinDomElement,M as getAbstractViewParentFormElementIdentifierPathWithinDomElement,H as getAbstractViewParentFormElementWithinDomElement,x as getAbstractViewSiblingFormElementIdentifierPathWithinDomElement,K as getAllFormElementDomElements,ie as getStageDomElement,le as getStagePanelDomElement,z as hideFormElementStageItemToolbar,me as removeAllStageToolbars,ce as renderAbstractStageArea,ue as renderCheckboxTemplate,ge as renderFileUploadTemplates,R as renderFormDefinitionPageAsSortableList,G as renderFormElementStageItem,ae as renderPagination,fe as renderPreviewStageArea,pe as renderSelectTemplates,J as renderSimpleTemplate,F as renderSimpleTemplateWithValidators,$ as renderTopLevelStageItem,re as renderUndoRedo,oe as setStageHeadline};
