/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import t from"jquery";import*as S from"@typo3/form/backend/form-editor/helper.js";import E from"@typo3/backend/icons.js";import M from"sortablejs";const G={domElementClassNames:{formElementIsComposit:"formeditor-element-composit",formElementIsTopLevel:"formeditor-element-toplevel",noNesting:"no-nesting",selected:"selected",sortable:"sortable",previewViewPreviewElement:"formeditor-element-preview"},domElementDataAttributeNames:{abstractType:"data-element-abstract-type",noSorting:"data-no-sorting"},domElementDataAttributeValues:{abstractViewToolbar:"elementToolbar",abstractViewToolbarNewElement:"stageElementToolbarNewElement",abstractViewToolbarNewElementSplitButton:"stageElementToolbarNewElementSplitButton",abstractViewToolbarNewElementSplitButtonAfter:"stageElementToolbarNewElementSplitButtonAfter",abstractViewToolbarNewElementSplitButtonInside:"stageElementToolbarNewElementSplitButtonInside",abstractViewToolbarRemoveElement:"stageElementToolbarRemoveElement",buttonHeaderRedo:"redoButton",buttonHeaderUndo:"undoButton",buttonPaginationPrevious:"buttonPaginationPrevious",buttonPaginationNext:"buttonPaginationNext","FormElement-_ElementToolbar":"FormElement-_ElementToolbar","FormElement-_UnknownElement":"FormElement-_UnknownElement","FormElement-AdvancedPassword":"FormElement-AdvancedPassword","FormElement-Checkbox":"FormElement-Checkbox","FormElement-ContentElement":"FormElement-ContentElement","FormElement-CountrySelect":"FormElement-CountrySelect","FormElement-DatePicker":"FormElement-DatePicker","FormElement-Fieldset":"FormElement-Fieldset","FormElement-GridColumn":"FormElement-GridColumn","FormElement-GridRow":"FormElement-GridRow","FormElement-FileUpload":"FormElement-FileUpload","FormElement-Hidden":"FormElement-Hidden","FormElement-ImageUpload":"FormElement-ImageUpload","FormElement-MultiCheckbox":"FormElement-MultiCheckbox","FormElement-MultiSelect":"FormElement-MultiSelect","FormElement-Page":"FormElement-Page","FormElement-Password":"FormElement-Password","FormElement-RadioButton":"FormElement-RadioButton","FormElement-SingleSelect":"FormElement-SingleSelect","FormElement-StaticText":"FormElement-StaticText","FormElement-SummaryPage":"FormElement-SummaryPage","FormElement-Text":"FormElement-Text","FormElement-Textarea":"FormElement-Textarea","FormElement-Email":"FormElement-Email","FormElement-Url":"FormElement-Url","FormElement-Telephone":"FormElement-Telephone","FormElement-Number":"FormElement-Number","FormElement-Date":"FormElement-Date",formElementIcon:"elementIcon",iconValidator:"form-validator",multiValueContainer:"multiValueContainer",paginationTitle:"paginationTitle",stageHeadline:"formDefinitionLabel",stagePanel:"stagePanel",validatorsContainer:"validatorsContainer",validatorIcon:"validatorIcon"},isSortable:!0};let C=null,I=null,f=null;function d(){return I}function o(e){return u().isUndefinedOrNull(e)?S.setConfiguration(C):S.setConfiguration(e)}function u(){return d().getUtility()}function p(){return d().getViewModel()}function b(e,n,r){return d().assert(e,n,r)}function h(){return d().getRootFormElement()}function x(){return d().getCurrentlySelectedFormElement()}function g(){return d().getPublisherSubscriber()}function c(e,n){return d().getFormElementDefinition(e,n)}function q(e,n){u().isNonEmptyString(n)&&t(e).text(n)}function z(e,n){switch(e.get("type")){case"Checkbox":L(e,n);break;case"FileUpload":case"ImageUpload":K(e,n);break;case"CountrySelect":case"SingleSelect":case"RadioButton":case"MultiSelect":case"MultiCheckbox":H(e,n);break;case"Textarea":case"AdvancedPassword":case"Password":case"Text":case"Email":case"Url":case"Telephone":case"Number":case"DatePicker":case"Date":y(e,n);break;case"Fieldset":case"GridColumn":case"GridRow":case"SummaryPage":case"Page":case"StaticText":case"Hidden":case"ContentElement":N(e,n);break;default:break}g().publish("view/stage/abstract/render/template/perform",[e,n])}function k(e){let n,r;const a=t("<li></li>");c(e,"_isCompositeFormElement")||a.addClass(o().getDomElementClassName("noNesting")),c(e,"_isTopLevelFormElement")&&a.addClass(o().getDomElementClassName("formElementIsTopLevel")),c(e,"_isCompositeFormElement")&&a.addClass(o().getDomElementClassName("formElementIsComposit"));try{r=o().getTemplate("FormElement-"+e.get("type")).clone()}catch{r=o().getTemplate("FormElement-_UnknownElement").clone(),b(r.length>0,'No template found for element "'+e.get("__identifierPath")+'"',1478987818)}r=t("<div></div>").attr(o().getDomElementDataAttribute("elementIdentifier"),e.get("__identifierPath")).append(t(r.html()));const i=c(e,"_isCompositeFormElement");i&&r.attr(o().getDomElementDataAttribute("abstractType"),"isCompositeFormElement");const m=c(e,"_isTopLevelFormElement");if(m?r.attr(o().getDomElementDataAttribute("abstractType"),"isTopLevelFormElement"):r.addClass("formeditor-element"),e.get("renderingOptions.enabled")===!1&&r.addClass("formeditor-element-hidden"),a.append(r),z(e,r),m||i){n=t("<ol></ol>"),n.addClass(o().getDomElementClassName("sortable")),n.addClass("formeditor-list");const l=e.get("renderables");if(t.type(l)==="array")for(let s=0,D=l.length;s<D;++s)n.append(k(l[s]));a.append(n)}return a}function $(){const e=f.get(0).querySelectorAll("ol."+o().getDomElementClassName("sortable")),n="li:not("+o().getDomElementDataAttribute("noSorting","bracesWithKey")+")",r="div"+o().getDomElementDataAttribute("elementIdentifier","bracesWithKey");e.forEach(function(a){a.querySelectorAll(r).forEach(function(i){i.classList.add("formeditor-sortable-handle")}),new M(a,{group:"stage-nodes",handle:r,draggable:n,animation:200,swapThreshold:.6,dragClass:"formeditor-sortable-drag",ghostClass:"formeditor-sortable-ghost",onStart:function(i){g().publish("view/stage/abstract/dnd/start",[t(i.item),t(i.item)])},onChange:function(i){let m;const l=W(t(i.item));l&&(m=d().findEnclosingCompositeFormElementWhichIsNotOnTopLevel(l)),g().publish("view/stage/abstract/dnd/change",[t(i.item),l,m])},onEnd:function(i){const m=F(t(i.item)),l=P(t(i.item),"prev"),s=P(t(i.item),"next");g().publish("view/stage/abstract/dnd/update",[t(i.item),m,l,s]),g().publish("view/stage/abstract/dnd/stop",[F(t(i.item))])}})})}function J(){return f}function _(e){u().isUndefinedOrNull(e)&&(e=h()),b(t.type(e)==="object",'Invalid parameter "formElement"',1479037151);const n=document.createElement("span");return n.textContent=e.get("label")?e.get("label"):e.get("identifier"),n}function Q(e){u().isUndefinedOrNull(e)&&(e=_().textContent),t(o().getDomElementDataIdentifierSelector("stageHeadline")).text(e)}function X(){return t(o().getDomElementDataIdentifierSelector("stagePanel"))}function Y(){const e=h().get("renderables").length;p().enableButton(t(o().getDomElementDataIdentifierSelector("buttonPaginationPrevious"))),p().enableButton(t(o().getDomElementDataIdentifierSelector("buttonPaginationNext"))),d().getCurrentlySelectedPageIndex()===0&&p().disableButton(t(o().getDomElementDataIdentifierSelector("buttonPaginationPrevious"))),(e===1||d().getCurrentlySelectedPageIndex()===e-1)&&p().disableButton(t(o().getDomElementDataIdentifierSelector("buttonPaginationNext")));const n=d().getCurrentlySelectedPageIndex()+1;t(o().getDomElementDataIdentifierSelector("paginationTitle")).text(c(h(),"paginationTitle").replace("{0}",n.toString()).replace("{1}",e))}function Z(){p().enableButton(t(o().getDomElementDataIdentifierSelector("buttonHeaderUndo"))),p().enableButton(t(o().getDomElementDataIdentifierSelector("buttonHeaderRedo"))),d().getCurrentApplicationStatePosition()+1>=d().getCurrentApplicationStates()&&p().disableButton(t(o().getDomElementDataIdentifierSelector("buttonHeaderUndo"))),d().getCurrentApplicationStatePosition()===0&&p().disableButton(t(o().getDomElementDataIdentifierSelector("buttonHeaderRedo")))}function U(){return t(o().getDomElementDataAttribute("elementIdentifier","bracesWithKey"),f)}function B(e){return b(t.type(e)==="number",'Invalid parameter "pageIndex"',1478721208),t("<ol></ol>").addClass("formeditor-list").append(k(h().get("renderables")[e]))}function O(e){return t(e).parent().closest("li").find(o().getDomElementDataAttribute("elementIdentifier","bracesWithKey")).first()}function W(e){return O(e).attr(o().getDomElementDataAttribute("elementIdentifier"))}function R(e){return t(e).find(o().getDomElementDataAttribute("elementIdentifier","bracesWithKey")).first()}function F(e){return R(t(e)).attr(o().getDomElementDataAttribute("elementIdentifier"))}function P(e,n){u().isUndefinedOrNull(n)&&(n="prev");const r=F(e);return e=n==="prev"?t(e).prev("li"):t(e).next("li"),e.find(o().getDomElementDataAttribute("elementIdentifier","bracesWithKey")).not(o().getDomElementDataAttribute("elementIdentifier","bracesWithKeyValue",[r])).first().attr(o().getDomElementDataAttribute("elementIdentifier"))}function ee(e){let n;return typeof e=="string"?n=e:u().isUndefinedOrNull(e)?n=x().get("__identifierPath"):n=e.get("__identifierPath"),t(o().getDomElementDataAttribute("elementIdentifier","bracesWithKeyValue",[n]),f)}function te(){t(o().getDomElementDataIdentifierSelector("abstractViewToolbar"),f).off().empty().remove()}function v(e){let n;b(t.type(e)==="object",'Invalid parameter "formElement"',1479035778);const r=c(e,void 0);return r._isTopLevelFormElement?t():(n=o().getTemplate("FormElement-_ElementToolbar").clone(),n.length?(n=t(t(n.html())),o().getTemplatePropertyDomElement("_type",n).text(c(e,"label")),o().getTemplatePropertyDomElement("_identifier",n).text(e.get("identifier")),r._isCompositeFormElement?(p().hideComponent(t(o().getDomElementDataIdentifierSelector("abstractViewToolbarNewElement"),n)),t(o().getDomElementDataIdentifierSelector("abstractViewToolbarNewElementSplitButtonAfter"),n).on("click",function(){g().publish("view/stage/abstract/elementToolbar/button/newElement/clicked",["view/insertElements/perform/after",{disableElementTypes:[],onlyEnableElementTypes:[]}])}),t(o().getDomElementDataIdentifierSelector("abstractViewToolbarNewElementSplitButtonInside"),n).on("click",function(){g().publish("view/stage/abstract/elementToolbar/button/newElement/clicked",["view/insertElements/perform/inside",{disableElementTypes:[],onlyEnableElementTypes:[]}])})):(p().hideComponent(t(o().getDomElementDataIdentifierSelector("abstractViewToolbarNewElementSplitButton"),n)),t(o().getDomElementDataIdentifierSelector("abstractViewToolbarNewElement"),n).on("click",function(){g().publish("view/stage/abstract/elementToolbar/button/newElement/clicked",["view/insertElements/perform/after",{disableElementTypes:[]}])})),t(o().getDomElementDataIdentifierSelector("abstractViewToolbarRemoveElement"),n).on("click",function(){p().showRemoveFormElementModal()}),n):t())}function ne(e,n,r){u().isUndefinedOrNull(n)&&(n=x()),r?v(n).fadeOut(0,function(){e.prepend(t(this)),t(o().getDomElementDataIdentifierSelector("abstractViewToolbar"),e).fadeIn("fast")}):e.prepend(v(n))}function oe(e,n){u().isUndefinedOrNull(e)&&(e=d().getCurrentlySelectedPageIndex()),f.off().empty().append(B(e)),f.on("click",function(r){const a=t(r.target).closest(o().getDomElementDataAttribute("elementIdentifier","bracesWithKey")).attr(o().getDomElementDataAttribute("elementIdentifier"));u().isUndefinedOrNull(a)||!u().isNonEmptyString(a)||g().publish("view/stage/element/clicked",[a])}),C.isSortable&&$(),t.type(n)==="function"&&n()}function ie(e){b(u().isNonEmptyString(e),'Invalid parameter "html"',1475424409),f.off().empty().html(e),t(":input",f).prop("disabled","disabled").on("click dblclick select focus keydown keypress keyup mousedown mouseup",function(n){return n.preventDefault()}),t("form",f).submit(function(n){return n.preventDefault()}),U().each(function(){const n=d().getFormElementByIdentifierPath(t(this).data("elementIdentifierPath"));c(n,"_isTopLevelFormElement")||t(this).attr("title","identifier: "+n.get("identifier")+" (type: "+n.get("type")+")"),c(n,"_isTopLevelFormElement")&&t(this).addClass(o().getDomElementClassName("formElementIsTopLevel")),c(n,"_isCompositeFormElement")&&t(this).addClass(o().getDomElementClassName("formElementIsComposit"))})}function w(e,n,r){t(o().getDomElementDataAttribute("templateProperty","bracesWithKey"),n).each(function(a,i){const m=t(i).attr(o().getDomElementDataAttribute("templateProperty")),l=e.get(m);t.type(r)==="function"&&r(m,l,i)})}function L(e,n){y(e,n),w(e,n,function(r,a,i){(t.type(a)==="boolean"&&a||a==="true"||a===1||a==="1")&&t(i).addClass(o().getDomElementClassName("noNesting"))})}function N(e,n){b(t.type(e)==="object",'Invalid parameter "formElement"',1479035696),w(e,n,(a,i,m)=>{q(m,i)});const r=e.get("renderingOptions.enabled")===!1?"overlay-hidden":null;E.getIcon(c(e,"iconIdentifier"),E.sizes.small,r,E.states.default,E.markupIdentifiers.inline).then(function(a){t(o().getDomElementDataIdentifierSelector("formElementIcon"),n).append(t(a).addClass(o().getDomElementClassName("icon")))}),o().getTemplatePropertyDomElement("_type",n).append(document.createTextNode(c(e,"label"))),o().getTemplatePropertyDomElement("_identifier",n).append(document.createTextNode(e.get("identifier")))}function y(e,n){b(t.type(e)==="object",'Invalid parameter "formElement"',1479035674),N(e,n);const r=t(o().getDomElementDataIdentifierSelector("validatorsContainer"),t(n)).clone();t(o().getDomElementDataIdentifierSelector("validatorsContainer"),t(n)).empty();const a=e.get("validators");if(t.type(a)==="array"){let i=0;if(a.length>0){for(let m=0,l=a.length;m<l;++m){if(a[m].identifier==="NotEmpty"){o().getTemplatePropertyDomElement("_required",n).text("*");continue}i++;const s=d().getFormEditorDefinition("validators",a[m].identifier),D=t(t(r).clone());o().getTemplatePropertyDomElement("_label",D).append(document.createTextNode(s.label)),t(o().getDomElementDataIdentifierSelector("validatorsContainer"),t(n)).append(D.html())}i>0&&E.getIcon(o().getDomElementDataAttributeValue("iconValidator"),E.sizes.small,null,E.states.default,E.markupIdentifiers.inline).then(function(m){t(o().getDomElementDataIdentifierSelector("validatorIcon"),t(n)).append(t(m).addClass(o().getDomElementClassName("icon")))})}}}function H(e,n){const r=t(o().getDomElementDataIdentifierSelector("multiValueContainer"),t(n)).clone();t(o().getDomElementDataIdentifierSelector("multiValueContainer"),t(n)).empty(),y(e,n);const a=t(o().getDomElementDataIdentifierSelector("multiValueContainer"),t(n)).attr(o().getDomElementDataAttribute("templateProperty")),i=e.get(a),m=(s,D,A)=>{let V=!1;const T=t(t(r).clone());for(const j of Object.keys(A))if(A[j]===D){V=!0;break}o().getTemplatePropertyDomElement("_label",T).append(document.createTextNode(s)),V&&o().getTemplatePropertyDomElement("_label",T).addClass(o().getDomElementClassName("selected")),t(o().getDomElementDataIdentifierSelector("multiValueContainer"),t(n)).append(T.html())};let l=e.get("defaultValue");if(d().getUtility().isUndefinedOrNull(l)?l={}:t.type(l)==="string"&&(l={0:l}),t.type(i)==="object")for(const s of Object.keys(i))m(i[s],s,l);else if(t.type(i)==="array")for(const s of Object.keys(i))u().isUndefinedOrNull(i[s]._label)?m(i[s],s,l):m(i[s]._label,i[s]._value,l)}function K(e,n){const r=t(o().getDomElementDataIdentifierSelector("multiValueContainer"),t(n)).clone();t(o().getDomElementDataIdentifierSelector("multiValueContainer"),t(n)).empty(),y(e,n);const a=t(o().getDomElementDataIdentifierSelector("multiValueContainer"),t(n)).attr(o().getDomElementDataAttribute("templateProperty")),i=e.get(a),m=function(l){const s=t(t(r).clone());o().getTemplatePropertyDomElement("_value",s).append(l),t(o().getDomElementDataIdentifierSelector("multiValueContainer"),t(n)).append(s.html())};if(t.type(i)==="object")for(const l of Object.keys(i))m(i[l]);else if(t.type(i)==="array")for(let l=0,s=i.length;l<s;++l)m(i[l])}function re(e,n,r){return I=e,b(t.type(n)==="object",'Invalid parameter "appendToDomElement"',1478992119),f=t(n),C=t.extend(!0,G,r||{}),S.bootstrap(I),this}export{re as bootstrap,_ as buildTitleByFormElement,v as createAbstractViewFormElementToolbar,ne as createAndAddAbstractViewFormElementToolbar,w as eachTemplateProperty,ee as getAbstractViewFormElementDomElement,F as getAbstractViewFormElementIdentifierPathWithinDomElement,R as getAbstractViewFormElementWithinDomElement,W as getAbstractViewParentFormElementIdentifierPathWithinDomElement,O as getAbstractViewParentFormElementWithinDomElement,P as getAbstractViewSiblingFormElementIdentifierPathWithinDomElement,U as getAllFormElementDomElements,J as getStageDomElement,X as getStagePanelDomElement,te as removeAllStageToolbars,oe as renderAbstractStageArea,L as renderCheckboxTemplate,K as renderFileUploadTemplates,B as renderFormDefinitionPageAsSortableList,Y as renderPagination,ie as renderPreviewStageArea,H as renderSelectTemplates,N as renderSimpleTemplate,y as renderSimpleTemplateWithValidators,Z as renderUndoRedo,Q as setStageHeadline};
