/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import e from"jquery";import N from"@typo3/backend/modal.js";import M from"@typo3/backend/severity.js";import t from"@typo3/backend/multi-step-wizard.js";import m from"@typo3/backend/icons.js";import P from"@typo3/backend/notification.js";import x from"@typo3/core/security-utility.js";import{selector as z}from"@typo3/core/literals.js";import o from"~labels/form.form_manager_javascript";import k from"~labels/core.wizard";const h=new x;var l;(function(s){s.newFormModalTrigger='[data-identifier="newForm"]',s.duplicateFormModalTrigger='[data-identifier="duplicateForm"]',s.removeFormModalTrigger='[data-identifier="removeForm"]',s.newFormModeButton='[data-identifier="newFormModeButton"]',s.newFormName='[data-identifier="newFormName"]',s.newFormSavePath='[data-identifier="newFormSavePath"]',s.newFormPrototypeName='[data-identifier="newFormPrototypeName"]',s.newFormTemplate='[data-identifier="newFormTemplate"]',s.duplicateFormName='[data-identifier="duplicateFormName"]',s.duplicateFormSavePath='[data-identifier="duplicateFormSavePath"]',s.showReferences='[data-identifier="showReferences"]',s.referenceLink='[data-identifier="referenceLink"]',s.moduleBody=".module-body.t3js-module-body",s.t3Logo=".t3-message-page-logo",s.t3Footer="#t3-footer",s.formsTable="#forms"})(l||(l={}));function _(s){e(l.newFormModalTrigger).on("click",function(w){w.preventDefault(),t.addSlide("new-form-step-1",o.get("formManager.newFormWizard.step1.title"),"",M.notice,o.get("formManager.newFormWizard.step1.progressLabel"),async function(d){const r=await m.getIcon("actions-plus",m.sizes.small),n=await m.getIcon("form-page",m.sizes.large),c=await m.getIcon("apps-pagetree-page-default",m.sizes.large);let a;const g=t.setup.$carousel.closest(".modal"),f=g.find(".modal-footer").find('button[name="next"]');t.blurCancelStep(),t.lockNextStep(),t.lockPrevStep(),s.getAccessibleFormStorageFolders().length===0&&(a='<h5 class="form-section-headline">'+o.get("formManager.newFormWizard.step1.noStorages")+"</h5>",d.html(a),s.assert(!1,"No accessible form storage folders",1477506500)),a='<div class="card-container"><div class="card card-size-medium"><div class="card-header"><div class="card-icon">'+c+'</div><div class="card-header-body"><h2 class="card-title">'+o.get("formManager.blankForm.label")+'</h2><span class="card-subtitle">'+o.get("formManager.blankForm.subtitle")+'</span></div></div><div class="card-body"><p class="card-text">'+o.get("formManager.blankForm.description")+'</p></div><div class="card-footer"><button type="button" class="btn btn-default" data-inline="1" value="blank" data-identifier="newFormModeButton">'+r+" "+o.get("formManager.blankForm.label")+'</button></div></div><div class="card card-size-medium"><div class="card-header"><div class="card-icon">'+n+'</div><div class="card-header-body"><h2 class="card-title">'+o.get("formManager.predefinedForm.label")+'</h2><span class="card-subtitle">'+o.get("formManager.predefinedForm.subtitle")+'</span></div></div><div class="card-body"><p class="card-text">'+o.get("formManager.predefinedForm.description")+'</p></div><div class="card-footer"><button type="button" class="btn btn-default" data-inline="1" value="predefined" data-identifier="newFormModeButton">'+r+" "+o.get("formManager.predefinedForm.label")+"</button></div></div></div>",d.html(a),e(l.newFormModeButton,g).on("click",function(u){t.set("newFormMode",e(u.currentTarget).val()),t.next()}),f.on("click",async function(){d.html(e("<div />",{class:"text-center"}).append(await m.getIcon("spinner-circle",m.sizes.default,null,null)).prop("outerHTML"))})}),t.addSlide("new-form-step-2",o.get("formManager.newFormWizard.step2.title"),"",M.notice,k.get("wizard.progressStep.configure"),function(d,r){let n,c;t.lockNextStep(),t.unlockPrevStep();const a=t.setup.$carousel.closest(".modal"),g=a.find(".modal-footer").find('button[name="next"]'),f=s.getAccessibleFormStorageFolders();if(r.savePath||(t.set("savePath",f[0].value),t.set("savePathName",f[0].label)),f.length>1){c=e('<select class="new-form-save-path form-select" id="new-form-save-path" data-identifier="newFormSavePath" />');for(let p=0,b=f.length;p<b;++p){const F=new Option(f[p].label,f[p].value);e(c).append(F)}}const i=s.getPrototypes();s.assert(i.length>0,"No prototypes available",1477506501),r.prototypeName||(t.set("prototypeName",i[0].value),t.set("prototypeNameName",i[0].label));const u=e('<select class="new-form-prototype-name form-select" id="new-form-prototype-name" data-identifier="newFormPrototypeName" />');for(let p=0,b=i.length;p<b;++p){const F=new Option(i[p].label,i[p].value);e(u).append(F)}let v=s.getTemplatesForPrototype(i[0].value);s.assert(v.length>0,"No templates available",1477506502),r.templatePath||(t.set("templatePath",v[0].value),t.set("templatePathName",v[0].label));const y=e('<select class="new-form-template form-select" id="new-form-template" data-identifier="newFormTemplate" />');for(let p=0,b=v.length;p<b;++p){const F=new Option(v[p].label,v[p].value);e(y).append(F)}n="",r.newFormMode==="blank"?(n+='<h5 class="form-section-headline">'+o.get("formManager.blankForm.label")+"</h5>",t.set("templatePath","EXT:form/Resources/Private/Backend/Templates/FormEditor/Yaml/NewForms/BlankForm.yaml"),t.set("templatePathName",o.get("formManager.blankForm.label"))):(n+='<h5 class="form-section-headline">'+o.get("formManager.predefinedForm.label")+"</h5>",i.length>1&&(n+='<div class="form-group"><label class="form-label" for="new-form-prototype-name">'+o.get("formManager.form_prototype")+"</label>"+e(u)[0].outerHTML+"</div>"),v.length>1&&(n+='<div class="form-group"><label class="form-label" for="new-form-template">'+o.get("formManager.form_template")+'</label><div class="form-description">'+o.get("formManager.form_template_description")+"</div>"+e(y)[0].outerHTML+"</div>")),n+='<div class="form-group"><label class="form-label" for="new-form-name">'+o.get("formManager.form_name")+'</label><div class="form-description">'+o.get("formManager.form_name_description")+"</div>",r.formName?(n+='<input class="form-control" id="new-form-name" data-identifier="newFormName" value="'+h.encodeHtml(r.formName)+'" />',setTimeout(function(){t.unlockNextStep()},200)):n+='<input class="form-control has-error" id="new-form-name" data-identifier="newFormName" />',n+="</div>",c&&(n+='<div class="form-group"><label class="form-label" for="new-form-save-path">'+o.get("formManager.form_save_path")+'</label><div class="form-description">'+o.get("formManager.form_save_path_description")+"</div>"+e(c)[0].outerHTML+"</div>"),d.html(n),r.savePath&&e(l.newFormSavePath,a).val(r.savePath),r.templatePath&&e(l.newFormTemplate,a).val(r.templatePath),i.length>1?e(l.newFormPrototypeName,a).focus():v.length>1&&e(l.newFormTemplate,a).focus();const S=function(){e(l.newFormTemplate,a).on("change",function(){t.set("templatePath",e(l.newFormTemplate+" option:selected",a).val()),t.set("templatePathName",e(l.newFormTemplate+" option:selected",a).text()),t.set("templatePathOnPrev",e(l.newFormTemplate+" option:selected",a).val())})};e(l.newFormPrototypeName,a).on("change",function(p){t.set("prototypeName",e(l.newFormPrototypeName+" option:selected",a).val()),t.set("prototypeNameName",e(l.newFormPrototypeName+" option:selected",a).text()),v=s.getTemplatesForPrototype(e(p.currentTarget).val()),e(l.newFormTemplate,a).off().empty();for(let b=0,F=v.length;b<F;++b){const T=new Option(v[b].label,v[b].value);e(l.newFormTemplate,a).append(T),t.set("templatePath",v[0].value),t.set("templatePathName",v[0].label)}S()}),S(),r.prototypeName&&(e(l.newFormPrototypeName,a).val(r.prototypeName),e(l.newFormPrototypeName,a).trigger("change"),r.templatePathOnPrev&&(e(l.newFormTemplate,a).find(z`option[value="${r.templatePathOnPrev}"]`).prop("selected",!0),e(l.newFormTemplate,a).trigger("change"))),e(l.newFormName,a).focus(),e(l.newFormName,a).on("keyup paste",function(p){e(p.currentTarget).val().length>0?(e(p.currentTarget).removeClass("has-error"),t.unlockNextStep(),t.set("formName",e(p.currentTarget).val()),"code"in p&&p.code==="Enter"&&t.triggerStepButton("next")):(e(p.currentTarget).addClass("has-error"),t.lockNextStep())}),e(l.newFormSavePath,a).on("change",function(){t.set("savePath",e(l.newFormSavePath+" option:selected",a).val()),t.set("savePathName",e(l.newFormSavePath+" option:selected",a).text())}),r.newFormMode!=="blank"&&!r.templatePathName&&t.set("templatePathName",e(l.newFormTemplate+" option:selected",a).text()),g.on("click",async function(){t.setup.forceSelection=!1,d.html(e("<div />",{class:"text-center"}).append(await m.getIcon("spinner-circle",m.sizes.default,null,null)).prop("outerHTML"))})}),t.addSlide("new-form-step-3",o.get("formManager.newFormWizard.step3.title"),"",M.notice,o.get("formManager.newFormWizard.step3.progressLabel"),async function(d,r){const n=await m.getIcon("actions-cog",m.sizes.small),c=await m.getIcon("actions-file-t3d",m.sizes.small),a=await m.getIcon("actions-tag",m.sizes.small),g=await m.getIcon("actions-database",m.sizes.small),i=t.setup.$carousel.closest(".modal").find(".modal-footer").find('button[name="next"]');let u='<h5 class="form-section-headline">'+o.get("formManager.newFormWizard.step3.check")+"</h5><p>"+o.get("formManager.newFormWizard.step3.message")+'</p><div class="alert alert-notice">';r.prototypeNameName&&(u+='<div class="row my-1"><div class="col col-sm-6">'+n+" "+o.get("formManager.form_prototype")+'</div><div class="col">'+h.encodeHtml(r.prototypeNameName)+"</div></div>"),r.templatePathName&&(u+='<div class="row my-1"><div class="col col-sm-6">'+c+" "+o.get("formManager.form_template")+'</div><div class="col">'+h.encodeHtml(r.templatePathName)+"</div></div>"),u+='<div class="row my-1"><div class="col col-sm-6">'+a+" "+o.get("formManager.form_name")+'</div><div class="col">'+h.encodeHtml(r.formName)+'</div></div><div class="row my-1"><div class="col col-sm-6">'+g+" "+o.get("formManager.form_save_path")+'</div><div class="col">'+h.encodeHtml(r.savePathName)+"</div></div></div>",d.html(u),i.focus(),i.on("click",async function(){t.setup.forceSelection=!1,d.html(e("<div />",{class:"text-center"}).append(await m.getIcon("spinner-circle",m.sizes.default,null,null)).prop("outerHTML"))})}),t.addFinalProcessingSlide(function(){e.post(s.getAjaxEndpoint("create"),{formName:t.setup.settings.formName,templatePath:t.setup.settings.templatePath,prototypeName:t.setup.settings.prototypeName,savePath:t.setup.settings.savePath},function(d){d.status==="success"?document.location=d.url:P.error(o.get("formManager.newFormWizard.step4.errorTitle"),o.get("formManager.newFormWizard.step4.errorMessage")+" "+d.message),t.dismiss()}).fail(function(d,r,n){const c=new DOMParser,a=c.parseFromString(d.responseText,"text/html"),g=e(a.body);P.error(r,n,2),t.dismiss(),e(l.t3Logo,g).remove(),e(l.t3Footer,g).remove(),e(l.moduleBody).html(g.html())})}).then(function(){t.show()})})}function H(s){e(l.removeFormModalTrigger).on("click",function(w){const d=[];w.preventDefault();const r=e(w.currentTarget);d.push({text:o.get("formManager.cancel"),active:!0,btnClass:"btn-default",name:"cancel",trigger:function(n,c){c.hideModal()}}),d.push({text:o.get("formManager.remove_form"),active:!0,btnClass:"btn-danger",name:"createform",trigger:function(n,c){e.post(s.getAjaxEndpoint("delete"),{formPersistenceIdentifier:r.data("formPersistenceIdentifier")},function(a){a.status==="success"?document.location=a.url:P.error(a.title,a.message),c.hideModal()})}}),N.show(o.get("formManager.remove_form_title"),o.get("formManager.remove_form_message").replace("{0}",r.data("formName")),M.error,d)})}function I(s){e(l.duplicateFormModalTrigger).on("click",function(w){w.preventDefault();const d=e(w.currentTarget);t.addSlide("duplicate-form-step-1",o.get("formManager.duplicateFormWizard.step1.title").replace("{0}",d.data("formName")),"",M.notice,k.get("wizard.progressStep.configure"),function(r){let n,c;t.lockPrevStep(),t.lockNextStep();const a=t.setup.$carousel.closest(".modal"),g=a.find(".modal-footer").find('button[name="next"]'),f=s.getAccessibleFormStorageFolders();if(s.assert(f.length>0,"No accessible form storage folders",1477649539),t.set("formPersistenceIdentifier",d.data("formPersistenceIdentifier")),t.set("savePath",f[0].value),f.length>1){c=e('<select id="duplicate-form-save-path" class="form-select" data-identifier="duplicateFormSavePath" />');for(let i=0,u=f.length;i<u;++i){const v=new Option(f[i].label,f[i].value);e(c).append(v)}}n='<div class="duplicate-form-modal"><h2 class="h3 form-section-headline">'+o.get("formManager.new_form_name")+'</h2><div class="form-group"><label class="form-label for="duplicate-form-name">'+o.get("formManager.form_name")+'</label><div class="form-description">'+o.get("formManager.form_name_description")+'</div><div class="formengine-field-item t3js-formengine-field-item"><input id="duplicate-form-name" class="form-control has-error" data-identifier="duplicateFormName" /></div></div>',c&&(n+='<div class="form-group"><label class="form-label" for="duplicate-form-save-path">'+o.get("formManager.form_save_path")+'</label><div class="form-description">'+o.get("formManager.form_save_path_description")+'</div><div class="formengine-field-item t3js-formengine-field-item">'+e(c)[0].outerHTML+"</div></div>"),n+="</div>",r.html(n),e(l.duplicateFormName,a).focus(),e(l.duplicateFormName,a).on("keyup paste",function(i){const u=e(event.currentTarget);u.val().length>0?(u.removeClass("has-error"),t.unlockNextStep(),t.set("formName",u.val()),"code"in i&&i.code==="Enter"&&t.triggerStepButton("next")):(u.addClass("has-error"),t.lockNextStep())}),g.on("click",async function(){t.setup.forceSelection=!1,t.set("confirmationDuplicateFormName",d.data("formName")),f.length>1?(t.set("savePath",e(l.duplicateFormSavePath+" option:selected",a).val()),t.set("confirmationDuplicateFormSavePath",e(l.duplicateFormSavePath+" option:selected",a).text())):(t.set("savePath",f[0].value),t.set("confirmationDuplicateFormSavePath",f[0].label)),r.html(e("<div />",{class:"text-center"}).append(await m.getIcon("spinner-circle",m.sizes.default,null,null)).prop("outerHTML"))})}),t.addSlide("duplicate-form-step-2",o.get("formManager.duplicateFormWizard.step2.title"),"",M.notice,o.get("formManager.duplicateFormWizard.step2.progressLabel"),async function(r,n){const c=await m.getIcon("actions-file-t3d",m.sizes.small),a=await m.getIcon("actions-tag",m.sizes.small),g=await m.getIcon("actions-database",m.sizes.small);t.unlockPrevStep(),t.unlockNextStep();const i=t.setup.$carousel.closest(".modal").find(".modal-footer").find('button[name="next"]'),u='<h5 class="form-section-headline">'+o.get("formManager.duplicateFormWizard.step2.check")+"</h5><p>"+o.get("formManager.newFormWizard.step3.message")+'</p><div class="alert alert-notice"><div class="dropdown-table-row"><div class="dropdown-table-column dropdown-table-icon">'+c+'</div><div class="dropdown-table-column dropdown-table-title">'+o.get("formManager.form_copied")+'</div><div class="dropdown-table-column dropdown-table-value">'+h.encodeHtml(n.confirmationDuplicateFormName)+'</div></div><div class="dropdown-table-row"><div class="dropdown-table-column dropdown-table-icon">'+a+'</div><div class="dropdown-table-column dropdown-table-title">'+o.get("formManager.form_name")+'</div><div class="dropdown-table-column dropdown-table-value">'+h.encodeHtml(n.formName)+'</div></div><div class="dropdown-table-row"><div class="dropdown-table-column dropdown-table-icon">'+g+'</div><div class="dropdown-table-column dropdown-table-title">'+o.get("formManager.form_save_path")+'</div><div class="dropdown-table-column dropdown-table-value">'+h.encodeHtml(n.confirmationDuplicateFormSavePath)+"</div></div></div></div>";r.html(u),i.focus(),i.on("click",async function(){t.setup.forceSelection=!1,r.html(e("<div />",{class:"text-center"}).append(await m.getIcon("spinner-circle",m.sizes.default,null,null)).prop("outerHTML"))})}),t.addFinalProcessingSlide(function(){e.post(s.getAjaxEndpoint("duplicate"),{formName:t.setup.settings.formName,formPersistenceIdentifier:t.setup.settings.formPersistenceIdentifier,savePath:t.setup.settings.savePath},function(r){r.status==="success"?document.location=r.url:P.error(o.get("formManager.duplicateFormWizard.step3.errorTitle"),o.get("formManager.duplicateFormWizard.step3.errorMessage")+" "+r.message),t.dismiss()}).fail(function(r,n,c){const a=new DOMParser,g=a.parseFromString(r.responseText,"text/html"),f=e(g.body);P.error(n,c,2),t.dismiss(),e(l.t3Logo,f).remove(),e(l.t3Footer,f).remove(),e(l.moduleBody).html(f.html())})}).then(function(){t.show()})})}function L(s){e(l.showReferences).on("click",w=>{w.preventDefault();const d=e(w.currentTarget),r=s.getAjaxEndpoint("references")+"&formPersistenceIdentifier="+d.data("formPersistenceIdentifier");e.get(r,async function(n){let c;const a=[];a.push({text:o.get("formManager.cancel"),active:!0,btnClass:"btn-default",name:"cancel",trigger:function(i,u){u.hideModal()}});const g=n.references.length,f=await m.getIcon("actions-open",m.sizes.small);if(g>0){c='<h2 class="h3">'+o.get("formManager.references.headline").replace("{0}",h.encodeHtml(d.data("formName")))+'</h2><div class="table-fit"><table id="forms" class="table table-striped table-hover"><thead><tr><th class="col-icon"></th><th class="col-recordtitle">'+o.get("formManager.table.field.title")+"</th><th>"+o.get("formManager.table.field.uid")+'</th><th class="col-control nowrap"><span class="visually-hidden">'+o.get("formManager.table.field.control")+"</span></th></tr></thead><tbody>";for(let i=0,u=n.references.length;i<u;++i)c+='<tr><td class="col-icon">'+n.references[i].recordIcon+'</td><td class="col-recordtitle"><a href="'+h.encodeHtml(n.references[i].recordEditUrl)+'" data-identifier="referenceLink">'+h.encodeHtml(n.references[i].recordTitle)+"</a></td><td>"+h.encodeHtml(n.references[i].recordUid)+'</td><td class="col-control"><div class="btn-group" role="group"><a href="'+h.encodeHtml(n.references[i].recordEditUrl)+'" data-identifier="referenceLink" class="btn btn-default" title="'+o.get("formManager.btn.edit.title")+'">'+f+"</a></div></td></tr>";c+="</tbody></table></div>"}else c="<div><h1>"+o.get("formManager.references.title").replace("{0}",h.encodeHtml(n.formPersistenceIdentifier))+"</h1></div><div>"+o.get("formManager.no_references")+"</div>";c=e(c),e(l.referenceLink,c).on("click",function(i){i.preventDefault(),N.currentModal.hideModal(),document.location=e(i.currentTarget).prop("href")}),N.show(o.get("formManager.references.title").replace("{0}",d.data("formName")),c,M.notice,a)}).fail(function(n,c,a){n.status!==0&&P.error(c,a,2)})})}function B(s){H(s),_(s),I(s),L(s)}export{B as bootstrap};
