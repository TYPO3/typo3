/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import"@typo3/backend/element/progress-bar-element.js";import o from"@typo3/backend/modal.js";import l from"@typo3/backend/notification.js";import d from"@typo3/backend/severity.js";import c from"@typo3/backend/sortable-table.js";import"@typo3/backend/input/clearable.js";import g from"@typo3/core/ajax/ajax-request.js";import p from"@typo3/core/event/regular-event.js";class u{constructor(){this.getDependencies=async s=>{const e=await s.resolve(),t=document.createElement("div");t.innerHTML=e.message,this.progressBar?.done(),e.hasDependencies?o.confirm(e.title,t,d.info,[{text:TYPO3.lang["button.cancel"],active:!0,btnClass:"btn-default",trigger:()=>{o.dismiss()}},{text:TYPO3.lang["button.resolveDependencies"],btnClass:"btn-primary",trigger:()=>{this.getResolveDependenciesAndInstallResult(e.url),o.dismiss()}}]):e.hasErrors?l.error(e.title,e.message,15):this.getResolveDependenciesAndInstallResult(e.url)}}initDom(){const s=document.getElementById("terVersionTable"),e=document.getElementById("terSearchTable");s instanceof HTMLTableElement&&new c(s),e instanceof HTMLTableElement&&new c(e),this.bindDownload(),this.bindSearchFieldResetter()}bindDownload(){new p("click",(s,e)=>{s.preventDefault();const i=e.closest("form").dataset.href;this.getProgress().start(),new g(i).get().then(this.getDependencies)}).delegateTo(document,".downloadFromTer form.download button[type=submit]")}getResolveDependenciesAndInstallResult(s){this.getProgress().start(),new g(s).post({}).then(async e=>{try{const t=await e.raw().json(),i=document.createElement("div");if(i.innerHTML=t.errorMessage,t.errorCount>0){const n=o.confirm(t.errorTitle,i,d.error,[{text:TYPO3.lang["button.cancel"],active:!0,btnClass:"btn-default",trigger:()=>{o.dismiss()}},{text:TYPO3.lang["button.resolveDependenciesIgnore"],btnClass:"btn-danger disabled t3js-dependencies",trigger:r=>{r.currentTarget.classList.contains("disabled")||(this.getResolveDependenciesAndInstallResult(t.skipDependencyUri),o.dismiss())}}]);n.addEventListener("typo3-modal-shown",()=>{const r=n.querySelector(".t3js-dependencies");n.querySelector('input[name="unlockDependencyIgnoreButton"]').addEventListener("change",a=>{a.currentTarget.checked?r?.classList.remove("disabled"):r?.classList.add("disabled")})})}else{let n=TYPO3.lang["extensionList.dependenciesResolveDownloadSuccess.message"+t.installationTypeLanguageKey].replace(/\{0\}/g,t.extension);n+=`
`+TYPO3.lang["extensionList.dependenciesResolveDownloadSuccess.header"]+": ";for(const[r,a]of Object.entries(t.result)){n+=`

`+TYPO3.lang["extensionList.dependenciesResolveDownloadSuccess.item"]+" "+r+": ";for(const m of Object.keys(a))n+=`
* `+m}l.info(TYPO3.lang["extensionList.dependenciesResolveFlashMessage.title"+t.installationTypeLanguageKey].replace(/\{0\}/g,t.extension),n,15),top.TYPO3.ModuleMenu.App.refreshMenu()}}catch{l.error(TYPO3.lang["extensionList.dependenciesResolveInstallError.title"]||"Install error",TYPO3.lang["extensionList.dependenciesResolveInstallError.message"]||"Your installation failed while resolving dependencies.")}},()=>{l.error(TYPO3.lang["extensionList.dependenciesResolveInstallError.title"]||"Install error",TYPO3.lang["extensionList.dependenciesResolveInstallError.message"]||"Your installation failed while resolving dependencies.")}).finally(()=>{this.progressBar?.done()})}getProgress(){return(!this.progressBar||!this.progressBar.isConnected)&&(this.progressBar=document.createElement("typo3-backend-progress-bar"),document.querySelector(".module-loading-indicator").appendChild(this.progressBar)),this.progressBar}bindSearchFieldResetter(){let s;if((s=document.querySelector('.typo3-extensionmanager-searchTerForm input[type="text"]'))!==null){const e=s.value!=="";s.clearable({onClear:t=>{e&&t.closest("form").submit()}})}}}export{u as default};
