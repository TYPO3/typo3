/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import"@typo3/backend/element/progress-bar-element.js";import i from"@typo3/backend/modal.js";import l from"@typo3/backend/notification.js";import c from"@typo3/backend/severity.js";import g from"@typo3/backend/sortable-table.js";import m from"@typo3/core/ajax/ajax-request.js";import p from"@typo3/core/event/regular-event.js";import n from"~labels/extensionmanager.messages";import u from"~labels/core.common";class h{constructor(){this.getDependencies=async t=>{const e=await t.resolve(),s=document.createElement("div");s.innerHTML=e.message,this.progressBar?.done(),e.hasDependencies?i.confirm(e.title,s,c.info,[{text:u.get("cancel"),active:!0,btnClass:"btn-default",trigger:()=>{i.dismiss()}},{text:n.get("button.resolveDependencies"),btnClass:"btn-primary",trigger:()=>{this.getResolveDependenciesAndInstallResult(e.url),i.dismiss()}}]):e.hasErrors?l.error(e.title,e.message,15):this.getResolveDependenciesAndInstallResult(e.url)}}initDom(){const t=document.getElementById("terVersionTable"),e=document.getElementById("terSearchTable");t instanceof HTMLTableElement&&new g(t),e instanceof HTMLTableElement&&new g(e),this.bindDownload(),this.bindSearchFieldResetter()}bindDownload(){new p("click",(t,e)=>{t.preventDefault();const a=e.closest("form").dataset.href;this.getProgress().start(),new m(a).get().then(this.getDependencies)}).delegateTo(document,".downloadFromTer form.download button[type=submit]")}getResolveDependenciesAndInstallResult(t){this.getProgress().start(),new m(t).post({}).then(async e=>{try{const s=await e.raw().json(),a=document.createElement("div");if(a.innerHTML=s.errorMessage,s.errorCount>0){const o=i.confirm(s.errorTitle,a,c.error,[{text:u.get("cancel"),active:!0,btnClass:"btn-default",trigger:()=>{i.dismiss()}},{text:n.get("button.resolveDependenciesIgnore"),btnClass:"btn-danger disabled t3js-dependencies",trigger:r=>{r.currentTarget.classList.contains("disabled")||(this.getResolveDependenciesAndInstallResult(s.skipDependencyUri),i.dismiss())}}]);o.addEventListener("typo3-modal-shown",()=>{const r=o.querySelector(".t3js-dependencies");o.querySelector('input[name="unlockDependencyIgnoreButton"]').addEventListener("change",d=>{d.currentTarget.checked?r?.classList.remove("disabled"):r?.classList.add("disabled")})})}else{let o=(s.isAutomaticInstallationEnabled?n.get("extensionList.dependenciesResolveDownloadSuccess.message"):n.get("extensionList.dependenciesResolveDownloadSuccess.message.downloadOnly")).replace(/\{0\}/g,s.extension);o+=`
`+n.get("extensionList.dependenciesResolveDownloadSuccess.header")+": ";for(const[r,d]of Object.entries(s.result)){o+=`

`+n.get("extensionList.dependenciesResolveDownloadSuccess.item")+" "+r+": ";for(const f of Object.keys(d))o+=`
* `+f}l.info((s.isAutomaticInstallationEnabled?n.get("extensionList.dependenciesResolveFlashMessage.title"):n.get("extensionList.dependenciesResolveFlashMessage.title.downloadOnly")).replace(/\{0\}/g,s.extension),o,15),top.TYPO3.ModuleMenu.App.refreshMenu()}}catch{l.error(n.get("extensionList.dependenciesResolveInstallError.title"),n.get("extensionList.dependenciesResolveInstallError.message"))}},()=>{l.error(n.get("extensionList.dependenciesResolveInstallError.title"),n.get("extensionList.dependenciesResolveInstallError.message"))}).finally(()=>{this.progressBar?.done()})}getProgress(){return(!this.progressBar||!this.progressBar.isConnected)&&(this.progressBar=document.createElement("typo3-backend-progress-bar"),document.querySelector(".module-loading-indicator").appendChild(this.progressBar)),this.progressBar}bindSearchFieldResetter(){let t;if((t=document.querySelector('.typo3-extensionmanager-searchTerForm input[type="search"]'))!==null){const e=t.value!=="";new p("search",()=>{t.value===""&&e&&t.closest("form").submit()}).bindTo(t)}}}export{h as default};
