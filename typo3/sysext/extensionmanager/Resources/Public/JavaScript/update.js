/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import"@typo3/backend/element/progress-bar-element.js";import c from"@typo3/backend/notification.js";import d from"@typo3/core/ajax/ajax-request.js";import p from"@typo3/core/event/regular-event.js";var e;(function(r){r.extensionTable="#terTable",r.terUpdateAction=".update-from-ter",r.pagination=".pagination-wrap",r.splashscreen=".splash-receivedata",r.terTableWrapper="#terTableWrapper .table"})(e||(e={}));class u{initializeEvents(){const s=document.querySelector(e.terUpdateAction);s!==null&&(new p("submit",n=>{n.preventDefault(),this.updateFromTer(n.target.action,!0)}).bindTo(s),this.updateFromTer(s.action,!1))}updateFromTer(s,n){n&&(s=s+"&forceUpdateCheck=1"),document.querySelector(e.terUpdateAction)?.classList.add("extensionmanager-is-hidden");const o=document.querySelector(e.extensionTable);o&&(o.style.display="none"),document.querySelector(e.splashscreen)?.classList.add("extensionmanager-is-shown"),document.querySelector(e.terTableWrapper)?.classList.add("extensionmanager-is-loading"),document.querySelector(e.pagination)?.classList.add("extensionmanager-is-loading");let i=!1;this.getProgress().start(),new d(s).post({}).then(async t=>{const a=await t.resolve();a.errorMessage.length&&c.error(TYPO3.lang["extensionList.updateFromTerFlashMessage.title"],a.errorMessage,10);const l=document.querySelector(e.terUpdateAction+" .extension-list-last-updated");l.innerText=a.timeSinceLastUpdate,l.setAttribute("title",TYPO3.lang["extensionList.updateFromTer.lastUpdate.timeOfLastUpdate"]+a.lastUpdateTime),a.updated&&(i=!0,window.location.replace(window.location.href))},async t=>{const a=t.response.statusText+"("+t.response.status+"): "+await t.response.text();c.warning(TYPO3.lang["extensionList.updateFromTerFlashMessage.title"],a,10)}).finally(()=>{if(this.progressBar?.done(),!i){document.querySelector(e.splashscreen)?.classList.remove("extensionmanager-is-shown"),document.querySelector(e.terTableWrapper)?.classList.remove("extensionmanager-is-loading"),document.querySelector(e.pagination)?.classList.remove("extensionmanager-is-loading"),document.querySelector(e.terUpdateAction)?.classList.remove("extensionmanager-is-hidden");const t=document.querySelector(e.extensionTable);t&&(t.style.display="block")}})}getProgress(){return(!this.progressBar||!this.progressBar.isConnected)&&(this.progressBar=document.createElement("typo3-backend-progress-bar"),document.querySelector(".module-loading-indicator").appendChild(this.progressBar)),this.progressBar}}export{u as default};
