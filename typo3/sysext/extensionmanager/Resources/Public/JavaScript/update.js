/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import NProgress from"nprogress";import Notification from"@typo3/backend/notification.js";import AjaxRequest from"@typo3/core/ajax/ajax-request.js";import RegularEvent from"@typo3/core/event/regular-event.js";var ExtensionManagerUpdateIdentifier;!function(e){e.extensionTable="#terTable",e.terUpdateAction=".update-from-ter",e.pagination=".pagination-wrap",e.splashscreen=".splash-receivedata",e.terTableWrapper="#terTableWrapper .table"}(ExtensionManagerUpdateIdentifier||(ExtensionManagerUpdateIdentifier={}));class ExtensionManagerUpdate{initializeEvents(){const e=document.querySelector(ExtensionManagerUpdateIdentifier.terUpdateAction);null!==e&&(new RegularEvent("submit",(e=>{e.preventDefault(),this.updateFromTer(e.target.action,!0)})).bindTo(e),this.updateFromTer(e.action,!1))}updateFromTer(e,t){t&&(e+="&forceUpdateCheck=1"),document.querySelector(ExtensionManagerUpdateIdentifier.terUpdateAction)?.classList.add("extensionmanager-is-hidden");const n=document.querySelector(ExtensionManagerUpdateIdentifier.extensionTable);n&&(n.style.display="none"),document.querySelector(ExtensionManagerUpdateIdentifier.splashscreen)?.classList.add("extensionmanager-is-shown"),document.querySelector(ExtensionManagerUpdateIdentifier.terTableWrapper)?.classList.add("extensionmanager-is-loading"),document.querySelector(ExtensionManagerUpdateIdentifier.pagination)?.classList.add("extensionmanager-is-loading");let a=!1;NProgress.start(),new AjaxRequest(e).get().then((async e=>{const t=await e.resolve();t.errorMessage.length&&Notification.error(TYPO3.lang["extensionList.updateFromTerFlashMessage.title"],t.errorMessage,10);const n=document.querySelector(ExtensionManagerUpdateIdentifier.terUpdateAction+" .extension-list-last-updated");n.innerText=t.timeSinceLastUpdate,n.setAttribute("title",TYPO3.lang["extensionList.updateFromTer.lastUpdate.timeOfLastUpdate"]+t.lastUpdateTime),t.updated&&(a=!0,window.location.replace(window.location.href))}),(async e=>{const t=e.response.statusText+"("+e.response.status+"): "+await e.response.text();Notification.warning(TYPO3.lang["extensionList.updateFromTerFlashMessage.title"],t,10)})).finally((()=>{if(NProgress.done(),!a){document.querySelector(ExtensionManagerUpdateIdentifier.splashscreen)?.classList.remove("extensionmanager-is-shown"),document.querySelector(ExtensionManagerUpdateIdentifier.terTableWrapper)?.classList.remove("extensionmanager-is-loading"),document.querySelector(ExtensionManagerUpdateIdentifier.pagination)?.classList.remove("extensionmanager-is-loading"),document.querySelector(ExtensionManagerUpdateIdentifier.terUpdateAction)?.classList.remove("extensionmanager-is-hidden");const e=document.querySelector(ExtensionManagerUpdateIdentifier.extensionTable);e&&(e.style.display="block")}}))}}export default ExtensionManagerUpdate;