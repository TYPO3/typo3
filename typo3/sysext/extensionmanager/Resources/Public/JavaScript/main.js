/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import T from"@typo3/core/document-service.js";import f from"@typo3/backend/storage/browser-session.js";import"@typo3/backend/element/progress-bar-element.js";import l from"@typo3/backend/modal.js";import b from"@typo3/backend/severity.js";import w from"@typo3/core/security-utility.js";import C from"@typo3/extensionmanager/repository.js";import k from"@typo3/extensionmanager/update.js";import B from"@typo3/extensionmanager/upload-form.js";import p from"@typo3/core/ajax/ajax-request.js";import O from"@typo3/core/event/debounce-event.js";import a from"@typo3/core/event/regular-event.js";import M from"@typo3/backend/sortable-table.js";const y=new w;var u;(function(g){g.extensionlist="typo3-extension-list",g.searchField="#Tx_Extensionmanager_extensionkey"})(u||(u={}));class S{constructor(){this.searchFilterSessionKey="tx-extensionmanager-local-filter",this.progressBar=null,T.ready().then(()=>{this.Update=new k,this.UploadForm=new B,this.Repository=new C;const r=document.getElementById(u.extensionlist);r!==null&&(r instanceof HTMLTableElement&&new M(r),new a("click",(t,o)=>{t.preventDefault(),l.confirm(TYPO3.lang["extensionList.removalConfirmation.title"],TYPO3.lang["extensionList.removalConfirmation.question"],b.error,[{text:TYPO3.lang["button.cancel"],active:!0,btnClass:"btn-default",trigger:()=>{l.dismiss()}},{text:TYPO3.lang["button.remove"],btnClass:"btn-danger",trigger:()=>{this.removeExtensionFromDisk(o),l.dismiss()}}])}).delegateTo(r,".removeExtension"),new a("click",(t,o)=>{t.preventDefault(),l.confirm(TYPO3.lang["extensionList.databaseReload.title"],TYPO3.lang["extensionList.databaseReload.message"],b.warning,[{text:TYPO3.lang["button.cancel"],active:!0,btnClass:"btn-default",trigger:()=>{l.dismiss()}},{text:TYPO3.lang["button.reimport"],btnClass:"btn-warning",trigger:()=>{const e=document.createElement("typo3-backend-progress-bar");document.body.appendChild(e),e.start(),new p(o.href).post({}).then(()=>{location.reload()}).finally(()=>{e.done(),l.dismiss()})}}])}).delegateTo(r,".reloadSqlData")),new a("click",()=>{this.progressBar=document.createElement("typo3-backend-progress-bar"),document.body.appendChild(this.progressBar),this.progressBar.start()}).delegateTo(document,".onClickMaskExtensionManager"),new a("click",(t,o)=>{t.preventDefault(),this.progressBar=document.createElement("typo3-backend-progress-bar"),document.body.appendChild(this.progressBar),this.progressBar.start(),new p(o.href).get().then(e=>this.updateExtension(e))}).delegateTo(document,"a[data-action=update-extension]"),new a("change",(t,o)=>{const e=document.querySelector(".t3js-dependencies");o.checked?e.classList.remove("disabled"):e.classList.add("disabled")}).delegateTo(document,"input[name=unlockDependencyIgnoreButton]"),new a("click",()=>{this.progressBar=document.createElement("typo3-backend-progress-bar"),document.body.appendChild(this.progressBar),this.progressBar.start()}).delegateTo(document,".t3-button-action-installdistribution");let n;if((n=document.querySelector(u.searchField))!==null){const t=f.get(this.searchFilterSessionKey);t!==null&&(n.value=t,this.filterExtensions(t)),new a("submit",o=>{o.preventDefault()}).bindTo(n.closest("form")),new O("input",o=>{const e=o.target;f.set(this.searchFilterSessionKey,e.value),this.filterExtensions(e.value)},100).bindTo(n),new a("search",()=>{n.value===""&&(f.unset(this.searchFilterSessionKey),this.filterExtensions(""))}).bindTo(n)}this.Repository.initDom(),this.Update.initializeEvents(),this.UploadForm.initializeEvents()})}filterExtensions(r){const n=document.querySelectorAll("[data-filterable]"),t=[];n.forEach(e=>{const c=Array.from(e.parentElement.children);t.push(c.indexOf(e))}),document.querySelectorAll("#typo3-extension-list tbody tr").forEach(e=>{const c=t.map(s=>e.children.item(s)),m=[];c.forEach(s=>{m.push(s.textContent.trim().replace(/\s+/g," "))}),e.classList.toggle("hidden",r!==""&&!RegExp(r,"i").test(m.join(":")))})}removeExtensionFromDisk(r){const n=document.createElement("typo3-backend-progress-bar");document.body.appendChild(n),n.start(),new p(r.href).post({}).then(()=>{location.reload()}).finally(()=>{n.done()})}async updateExtension(r){let n=0;const t=await r.resolve(),o=document.createElement("form");for(const[s,d]of Object.entries(t.updateComments)){const i=document.createElement("input");i.setAttribute("type","radio"),i.setAttribute("name","version"),i.value=s,n===0&&i.setAttribute("checked","checked");const h=document.createElement("h3");h.innerHTML=y.encodeHtml(s),h.prepend(i);const x=document.createElement("div");x.innerHTML=d.replace(/(\r\n|\n\r|\r|\n)/g,`
`).split(/\n/).map(v=>y.encodeHtml(v)).join("<br>"),o.append(h,x),n++}const e=document.createElement("h1");e.textContent=TYPO3.lang["extensionList.updateConfirmation.title"];const c=document.createElement("h2");c.textContent=TYPO3.lang["extensionList.updateConfirmation.message"];const m=document.createElement("div");m.append(e,c,o),this.progressBar&&this.progressBar.done(),l.confirm(TYPO3.lang["extensionList.updateConfirmation.questionVersionComments"],m,b.warning,[{text:TYPO3.lang["button.cancel"],active:!0,btnClass:"btn-default",trigger:(s,d)=>d.hideModal()},{text:TYPO3.lang["button.updateExtension"],btnClass:"btn-warning",trigger:(s,d)=>{const i=document.createElement("typo3-backend-progress-bar");document.body.appendChild(i),i.start(),new p(t.url).post({version:d.querySelector('input[name="version"]:checked')?.value}).finally(()=>{location.reload()}),d.hideModal()}}])}}const E=new S;typeof TYPO3.ExtensionManager>"u"&&(TYPO3.ExtensionManager=E);export{E as default};
