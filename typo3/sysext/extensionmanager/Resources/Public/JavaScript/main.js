/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import w from"@typo3/core/document-service.js";import b from"@typo3/backend/storage/browser-session.js";import"@typo3/backend/element/progress-bar-element.js";import d from"@typo3/backend/modal.js";import y from"@typo3/backend/severity.js";import C from"@typo3/core/security-utility.js";import T from"@typo3/extensionmanager/repository.js";import B from"@typo3/extensionmanager/update.js";import L from"@typo3/extensionmanager/upload-form.js";import p from"@typo3/core/ajax/ajax-request.js";import S from"@typo3/core/event/debounce-event.js";import i from"@typo3/core/event/regular-event.js";import M from"@typo3/backend/sortable-table.js";import x from"~labels/core.common";const F=new C;var u;(function(g){g.extensionlist="typo3-extension-list",g.searchField="#Tx_Extensionmanager_extensionkey"})(u||(u={}));class O{constructor(){this.searchFilterSessionKey="tx-extensionmanager-local-filter",this.progressBar=null,w.ready().then(()=>{this.Update=new B,this.UploadForm=new L,this.Repository=new T;const s=document.getElementById(u.extensionlist);s!==null&&(s instanceof HTMLTableElement&&new M(s),new i("click",(n,o)=>{n.preventDefault(),d.confirm(TYPO3.lang["extensionList.removalConfirmation.title"],TYPO3.lang["extensionList.removalConfirmation.question"],y.error,[{text:x.get("cancel"),active:!0,btnClass:"btn-default",trigger:()=>{d.dismiss()}},{text:TYPO3.lang["button.remove"],btnClass:"btn-danger",trigger:()=>{this.removeExtensionFromDisk(o),d.dismiss()}}])}).delegateTo(s,".removeExtension"),new i("click",(n,o)=>{n.preventDefault(),d.confirm(TYPO3.lang["extensionList.databaseReload.title"],TYPO3.lang["extensionList.databaseReload.message"],y.warning,[{text:x.get("cancel"),active:!0,btnClass:"btn-default",trigger:()=>{d.dismiss()}},{text:TYPO3.lang["button.reimport"],btnClass:"btn-warning",trigger:()=>{const e=document.createElement("typo3-backend-progress-bar");document.body.appendChild(e),e.start(),new p(o.href).post({}).then(()=>{location.reload()}).finally(()=>{e.done(),d.dismiss()})}}])}).delegateTo(s,".reloadSqlData")),new i("click",()=>{this.progressBar=document.createElement("typo3-backend-progress-bar"),document.body.appendChild(this.progressBar),this.progressBar.start()}).delegateTo(document,".onClickMaskExtensionManager"),new i("click",(n,o)=>{n.preventDefault(),this.progressBar=document.createElement("typo3-backend-progress-bar"),document.body.appendChild(this.progressBar),this.progressBar.start(),new p(o.href).get().then(e=>this.updateExtension(e))}).delegateTo(document,"a[data-action=update-extension]"),new i("change",(n,o)=>{const e=document.querySelector(".t3js-dependencies");o.checked?e.classList.remove("disabled"):e.classList.add("disabled")}).delegateTo(document,"input[name=unlockDependencyIgnoreButton]"),new i("click",()=>{this.progressBar=document.createElement("typo3-backend-progress-bar"),document.body.appendChild(this.progressBar),this.progressBar.start()}).delegateTo(document,".t3-button-action-installdistribution");let t;if((t=document.querySelector(u.searchField))!==null){const n=b.get(this.searchFilterSessionKey);n!==null&&(t.value=n,this.filterExtensions(n)),new i("submit",o=>{o.preventDefault()}).bindTo(t.closest("form")),new S("input",o=>{const e=o.target;b.set(this.searchFilterSessionKey,e.value),this.filterExtensions(e.value)},100).bindTo(t),new i("search",()=>{t.value===""&&(b.unset(this.searchFilterSessionKey),this.filterExtensions(""))}).bindTo(t)}this.Repository.initDom(),this.Update.initializeEvents(),this.UploadForm.initializeEvents()})}filterExtensions(s){const t=document.querySelectorAll("[data-filterable]"),n=[];t.forEach(e=>{const r=Array.from(e.parentElement.children);n.push(r.indexOf(e))}),document.querySelectorAll("#typo3-extension-list tbody tr").forEach(e=>{const r=n.map(l=>e.children.item(l)),a=[];r.forEach(l=>{a.push(l.textContent.trim().replace(/\s+/g," "))}),e.classList.toggle("hidden",s!==""&&!RegExp(s,"i").test(a.join(":")))})}removeExtensionFromDisk(s){const t=document.createElement("typo3-backend-progress-bar");document.body.appendChild(t),t.start(),new p(s.href).post({}).then(()=>{location.reload()}).finally(()=>{t.done()})}async updateExtension(s){const t=await s.resolve(),n=Object.entries(t.updateComments),o=document.createElement("form");n.forEach(([e,r],a)=>{const l=document.createElement("div");l.classList.add("form-check","form-check-type-card","mb-2");const E="version-"+e.replace(/\./g,"-"),c=document.createElement("input");c.classList.add("form-check-input"),c.type="radio",c.name="version",c.id=E,c.value=e,a===0&&(c.checked=!0);const m=document.createElement("label");m.classList.add("form-check-label"),m.setAttribute("for",E);const h=document.createElement("span");if(h.classList.add("form-check-label-header"),h.textContent=e,m.append(h),r){const f=document.createElement("span");f.classList.add("form-check-label-body"),f.innerHTML=r.replace(/(\r\n|\n\r|\r|\n)/g,`
`).split(/\n/).map(k=>F.encodeHtml(k)).join("<br>"),m.append(f)}l.append(c,m),o.append(l)}),this.progressBar&&this.progressBar.done(),d.confirm(TYPO3.lang["extensionList.updateConfirmation.questionVersionComments"],o,y.notice,[{text:x.get("cancel"),active:!0,btnClass:"btn-default",trigger:(e,r)=>r.hideModal()},{text:TYPO3.lang["button.updateExtension"],btnClass:"btn-warning",trigger:(e,r)=>{const a=document.createElement("typo3-backend-progress-bar");document.body.appendChild(a),a.start(),new p(t.url).post({version:r.querySelector('input[name="version"]:checked')?.value}).finally(()=>{location.reload()}),r.hideModal()}}])}}const v=new O;typeof TYPO3.ExtensionManager>"u"&&(TYPO3.ExtensionManager=v);export{v as default};
