import{throttle as b,isElement as g,cloneDeepWith as w}from"lodash-es";/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class l{constructor(t){if(this.crashes=[],this.state="initializing",this._now=Date.now,this.crashes=[],this._crashNumberLimit=typeof t.crashNumberLimit=="number"?t.crashNumberLimit:3,this._minimumNonErrorTimePeriod=typeof t.minimumNonErrorTimePeriod=="number"?t.minimumNonErrorTimePeriod:5e3,this._boundErrorHandler=e=>{const s="error"in e?e.error:e.reason;s instanceof Error&&this._handleError(s,e)},this._listeners={},!this._restart)throw new Error("The Watchdog class was split into the abstract `Watchdog` class and the `EditorWatchdog` class. Please, use `EditorWatchdog` if you have used the `Watchdog` class previously.")}destroy(){this._stopErrorHandling(),this._listeners={}}on(t,e){this._listeners[t]||(this._listeners[t]=[]),this._listeners[t].push(e)}off(t,e){this._listeners[t]=this._listeners[t].filter(s=>s!==e)}_fire(t,...e){const s=this._listeners[t]||[];for(const r of s)r.apply(this,[null,...e])}_startErrorHandling(){window.addEventListener("error",this._boundErrorHandler),window.addEventListener("unhandledrejection",this._boundErrorHandler)}_stopErrorHandling(){window.removeEventListener("error",this._boundErrorHandler),window.removeEventListener("unhandledrejection",this._boundErrorHandler)}_handleError(t,e){if(this._shouldReactToError(t)){this.crashes.push({message:t.message,stack:t.stack,filename:e instanceof ErrorEvent?e.filename:void 0,lineno:e instanceof ErrorEvent?e.lineno:void 0,colno:e instanceof ErrorEvent?e.colno:void 0,date:this._now()});const s=this._shouldRestart();this.state="crashed",this._fire("stateChange"),this._fire("error",{error:t,causesRestart:s}),s?this._restart():(this.state="crashedPermanently",this._fire("stateChange"))}}_shouldReactToError(t){return t.is&&t.is("CKEditorError")&&t.context!==void 0&&t.context!==null&&this.state==="ready"&&this._isErrorComingFromThisItem(t)}_shouldRestart(){if(this.crashes.length<=this._crashNumberLimit)return!0;const t=this.crashes[this.crashes.length-1].date,e=this.crashes[this.crashes.length-1-this._crashNumberLimit].date;return(t-e)/this._crashNumberLimit>this._minimumNonErrorTimePeriod}}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/function _(n,t=new Set){const e=[n],s=new Set;let r=0;for(;e.length>r;){const i=e[r++];if(!(s.has(i)||!P(i)||t.has(i)))if(s.add(i),Symbol.iterator in i)try{for(const o of i)e.push(o)}catch{}else for(const o in i)o!=="defaultValue"&&e.push(i[o])}return s}function P(n){const t=Object.prototype.toString.call(n),e=typeof n;return!(e==="number"||e==="boolean"||e==="string"||e==="symbol"||e==="function"||t==="[object Date]"||t==="[object RegExp]"||t==="[object Module]"||n===void 0||n===null||n._watchdogExcluded||n instanceof EventTarget||n instanceof Event)}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/function f(n,t,e=new Set){if(n===t&&x(n))return!0;const s=_(n,e),r=_(t,e);for(const i of s)if(r.has(i))return!0;return!1}function x(n){return typeof n=="object"&&n!==null}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class m extends l{constructor(t,e={}){super(e),this._editor=null,this._lifecyclePromise=null,this._initUsingData=!0,this._editables={},this._throttledSave=b(this._save.bind(this),typeof e.saveInterval=="number"?e.saveInterval:5e3),t&&(this._creator=(s,r)=>t.create(s,r)),this._destructor=s=>s.destroy()}get editor(){return this._editor}get _item(){return this._editor}setCreator(t){this._creator=t}setDestructor(t){this._destructor=t}_restart(){return Promise.resolve().then(()=>(this.state="initializing",this._fire("stateChange"),this._destroy())).catch(t=>{console.error("An error happened during the editor destroying.",t)}).then(()=>{const t={},e=[],s=this._config.rootsAttributes||{},r={};for(const[o,a]of Object.entries(this._data.roots))a.isLoaded?(t[o]="",r[o]=s[o]||{}):e.push(o);const i={...this._config,extraPlugins:this._config.extraPlugins||[],lazyRoots:e,rootsAttributes:r,_watchdogInitialData:this._data};return delete i.initialData,i.extraPlugins.push(C),this._initUsingData?this.create(t,i,i.context):g(this._elementOrData)?this.create(this._elementOrData,i,i.context):this.create(this._editables,i,i.context)}).then(()=>{this._fire("restart")})}create(t=this._elementOrData,e=this._config,s){return this._lifecyclePromise=Promise.resolve(this._lifecyclePromise).then(()=>(super._startErrorHandling(),this._elementOrData=t,this._initUsingData=typeof t=="string"||Object.keys(t).length>0&&typeof Object.values(t)[0]=="string",this._config=this._cloneEditorConfiguration(e)||{},this._config.context=s,this._creator(t,this._config))).then(r=>{this._editor=r,r.model.document.on("change:data",this._throttledSave),this._lastDocumentVersion=r.model.document.version,this._data=this._getData(),this._initUsingData||(this._editables=this._getEditables()),this.state="ready",this._fire("stateChange")}).finally(()=>{this._lifecyclePromise=null}),this._lifecyclePromise}destroy(){return this._lifecyclePromise=Promise.resolve(this._lifecyclePromise).then(()=>(this.state="destroyed",this._fire("stateChange"),super.destroy(),this._destroy())).finally(()=>{this._lifecyclePromise=null}),this._lifecyclePromise}_destroy(){return Promise.resolve().then(()=>{this._stopErrorHandling(),this._throttledSave.cancel();const t=this._editor;return this._editor=null,t.model.document.off("change:data",this._throttledSave),this._destructor(t)})}_save(){const t=this._editor.model.document.version;try{this._data=this._getData(),this._initUsingData||(this._editables=this._getEditables()),this._lastDocumentVersion=t}catch(e){console.error(e,"An error happened during restoring editor data. Editor will be restored from the previously saved data.")}}_setExcludedProperties(t){this._excludedProps=t}_getData(){const t=this._editor,e=t.model.document.roots.filter(a=>a.isAttached()&&a.rootName!="$graveyard"),{plugins:s}=t,r=s.has("CommentsRepository")&&s.get("CommentsRepository"),i=s.has("TrackChanges")&&s.get("TrackChanges"),o={roots:{},markers:{},commentThreads:JSON.stringify([]),suggestions:JSON.stringify([])};e.forEach(a=>{o.roots[a.rootName]={content:JSON.stringify(Array.from(a.getChildren())),attributes:JSON.stringify(Array.from(a.getAttributes())),isLoaded:a._isLoaded}});for(const a of t.model.markers)a._affectsData&&(o.markers[a.name]={rangeJSON:a.getRange().toJSON(),usingOperation:a._managedUsingOperations,affectsData:a._affectsData});return r&&(o.commentThreads=JSON.stringify(r.getCommentThreads({toJSON:!0,skipNotAttached:!0}))),i&&(o.suggestions=JSON.stringify(i.getSuggestions({toJSON:!0,skipNotAttached:!0}))),o}_getEditables(){const t={};for(const e of this.editor.model.document.getRootNames()){const s=this.editor.ui.getEditableElement(e);s&&(t[e]=s)}return t}_isErrorComingFromThisItem(t){return f(this._editor,t.context,this._excludedProps)}_cloneEditorConfiguration(t){return w(t,(e,s)=>{if(g(e)||s==="context")return e})}}class C{constructor(t){this.editor=t,this._data=t.config.get("_watchdogInitialData")}init(){this.editor.data.on("init",t=>{t.stop(),this.editor.model.enqueueChange({isUndoable:!1},e=>{this._restoreCollaborationData(),this._restoreEditorData(e)}),this.editor.data.fire("ready")},{priority:999})}_createNode(t,e){if("name"in e){const s=t.createElement(e.name,e.attributes);if(e.children)for(const r of e.children)s._appendChild(this._createNode(t,r));return s}else return t.createText(e.data,e.attributes)}_restoreEditorData(t){const e=this.editor;Object.entries(this._data.roots).forEach(([s,{content:r,attributes:i}])=>{const o=JSON.parse(r),a=JSON.parse(i),c=e.model.document.getRoot(s);for(const[h,d]of a)t.setAttribute(h,d,c);for(const h of o){const d=this._createNode(t,h);t.insert(d,c,"end")}}),Object.entries(this._data.markers).forEach(([s,r])=>{const{document:i}=e.model,{rangeJSON:{start:o,end:a},...c}=r,h=i.getRoot(o.root),d=t.createPositionFromPath(h,o.path,o.stickiness),y=t.createPositionFromPath(h,a.path,a.stickiness),E=t.createRange(d,y);t.addMarker(s,{range:E,...c})})}_restoreCollaborationData(){const t=JSON.parse(this._data.commentThreads),e=JSON.parse(this._data.suggestions);t.forEach(s=>{const r=this.editor.config.get("collaboration.channelId"),i=this.editor.plugins.get("CommentsRepository");i.hasCommentThread(s.threadId)&&i.getCommentThread(s.threadId).remove(),i.addCommentThread({channelId:r,...s})}),e.forEach(s=>{const r=this.editor.plugins.get("TrackChangesEditing");if(r.hasSuggestion(s.id)){const i=r.getSuggestion(s.id);i.attributes=s.attributes}else r.addSuggestionData(s)})}}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/const u=Symbol("MainQueueId");class v extends l{constructor(t,e={}){super(e),this._watchdogs=new Map,this._context=null,this._contextProps=new Set,this._actionQueues=new N,this._watchdogConfig=e,this._creator=s=>t.create(s),this._destructor=s=>s.destroy(),this._actionQueues.onEmpty(()=>{this.state==="initializing"&&(this.state="ready",this._fire("stateChange"))})}setCreator(t){this._creator=t}setDestructor(t){this._destructor=t}get context(){return this._context}create(t={}){return this._actionQueues.enqueue(u,()=>(this._contextConfig=t,this._create()))}getItem(t){return this._getWatchdog(t)._item}getItemState(t){return this._getWatchdog(t).state}add(t){const e=p(t);return Promise.all(e.map(s=>this._actionQueues.enqueue(s.id,()=>{if(this.state==="destroyed")throw new Error("Cannot add items to destroyed watchdog.");if(!this._context)throw new Error("Context was not created yet. You should call the `ContextWatchdog#create()` method first.");let r;if(this._watchdogs.has(s.id))throw new Error(`Item with the given id is already added: '${s.id}'.`);if(s.type==="editor")return r=new m(null,this._watchdogConfig),r.setCreator(s.creator),r._setExcludedProperties(this._contextProps),s.destructor&&r.setDestructor(s.destructor),this._watchdogs.set(s.id,r),r.on("error",(i,{error:o,causesRestart:a})=>{this._fire("itemError",{itemId:s.id,error:o}),a&&this._actionQueues.enqueue(s.id,()=>new Promise(c=>{const h=()=>{r.off("restart",h),this._fire("itemRestart",{itemId:s.id}),c()};r.on("restart",h)}))}),r.create(s.sourceElementOrData,s.config,this._context);throw new Error(`Not supported item type: '${s.type}'.`)})))}remove(t){const e=p(t);return Promise.all(e.map(s=>this._actionQueues.enqueue(s,()=>{const r=this._getWatchdog(s);return this._watchdogs.delete(s),r.destroy()})))}destroy(){return this._actionQueues.enqueue(u,()=>(this.state="destroyed",this._fire("stateChange"),super.destroy(),this._destroy()))}_restart(){return this._actionQueues.enqueue(u,()=>(this.state="initializing",this._fire("stateChange"),this._destroy().catch(t=>{console.error("An error happened during destroying the context or items.",t)}).then(()=>this._create()).then(()=>this._fire("restart"))))}_create(){return Promise.resolve().then(()=>(this._startErrorHandling(),this._creator(this._contextConfig))).then(t=>(this._context=t,this._contextProps=_(this._context),Promise.all(Array.from(this._watchdogs.values()).map(e=>(e._setExcludedProperties(this._contextProps),e.create(void 0,void 0,this._context))))))}_destroy(){return Promise.resolve().then(()=>{this._stopErrorHandling();const t=this._context;return this._context=null,this._contextProps=new Set,Promise.all(Array.from(this._watchdogs.values()).map(e=>e.destroy())).then(()=>this._destructor(t))})}_getWatchdog(t){const e=this._watchdogs.get(t);if(!e)throw new Error(`Item with the given id was not registered: ${t}.`);return e}_isErrorComingFromThisItem(t){for(const e of this._watchdogs.values())if(e._isErrorComingFromThisItem(t))return!1;return f(this._context,t.context)}}class N{constructor(){this._onEmptyCallbacks=[],this._queues=new Map,this._activeActions=0}onEmpty(t){this._onEmptyCallbacks.push(t)}enqueue(t,e){const s=t===u;this._activeActions++,this._queues.get(t)||this._queues.set(t,Promise.resolve());const i=(s?Promise.all(this._queues.values()):Promise.all([this._queues.get(u),this._queues.get(t)])).then(e),o=i.catch(()=>{});return this._queues.set(t,o),i.finally(()=>{this._activeActions--,this._queues.get(t)===o&&this._activeActions===0&&this._onEmptyCallbacks.forEach(a=>a())})}}function p(n){return Array.isArray(n)?n:[n]}export{v as ContextWatchdog,m as EditorWatchdog,l as Watchdog};
