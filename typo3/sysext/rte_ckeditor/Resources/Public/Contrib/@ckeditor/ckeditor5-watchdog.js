/**
 * @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
 */class p{crashes=[];state="initializing";_crashNumberLimit;_now=Date.now;_minimumNonErrorTimePeriod;_boundErrorHandler;_listeners;constructor(e){if(this.crashes=[],this._crashNumberLimit=typeof e.crashNumberLimit=="number"?e.crashNumberLimit:3,this._minimumNonErrorTimePeriod=typeof e.minimumNonErrorTimePeriod=="number"?e.minimumNonErrorTimePeriod:5e3,this._boundErrorHandler=r=>{const s="error"in r?r.error:r.reason;s instanceof Error&&this._handleError(s,r)},this._listeners={},!this._restart)throw new Error("The Watchdog class was split into the abstract `Watchdog` class and the `EditorWatchdog` class. Please, use `EditorWatchdog` if you have used the `Watchdog` class previously.")}destroy(){this._stopErrorHandling(),this._listeners={}}on(e,r){this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push(r)}off(e,r){this._listeners[e]=this._listeners[e].filter(s=>s!==r)}_fire(e,...r){const s=this._listeners[e]||[];for(const n of s)n.apply(this,[null,...r])}_startErrorHandling(){window.addEventListener("error",this._boundErrorHandler),window.addEventListener("unhandledrejection",this._boundErrorHandler)}_stopErrorHandling(){window.removeEventListener("error",this._boundErrorHandler),window.removeEventListener("unhandledrejection",this._boundErrorHandler)}_handleError(e,r){if(this._shouldReactToError(e)){this.crashes.push({message:e.message,stack:e.stack,filename:r instanceof ErrorEvent?r.filename:void 0,lineno:r instanceof ErrorEvent?r.lineno:void 0,colno:r instanceof ErrorEvent?r.colno:void 0,date:this._now()});const s=this._shouldRestart();this.state="crashed",this._fire("stateChange"),this._fire("error",{error:e,causesRestart:s}),s?this._restart():(this.state="crashedPermanently",this._fire("stateChange"))}}_shouldReactToError(e){return e.is&&e.is("CKEditorError")&&e.context!==void 0&&e.context!==null&&this.state==="ready"&&this._isErrorComingFromThisItem(e)}_shouldRestart(){if(this.crashes.length<=this._crashNumberLimit)return!0;const e=this.crashes[this.crashes.length-1].date,r=this.crashes[this.crashes.length-1-this._crashNumberLimit].date;return(e-r)/this._crashNumberLimit>this._minimumNonErrorTimePeriod}}function I(t){return t==null||typeof t!="object"&&typeof t!="function"}function W(t){return ArrayBuffer.isView(t)&&!(t instanceof DataView)}function L(t){return typeof t=="object"&&t!==null}function J(t){return Object.getOwnPropertySymbols(t).filter(e=>Object.prototype.propertyIsEnumerable.call(t,e))}function k(t){return t==null?t===void 0?"[object Undefined]":"[object Null]":Object.prototype.toString.call(t)}const B="[object RegExp]",E="[object String]",w="[object Number]",P="[object Boolean]",O="[object Arguments]",H="[object Symbol]",q="[object Date]",F="[object Map]",Q="[object Set]",U="[object Array]",M="[object ArrayBuffer]",$="[object Object]",z="[object DataView]",K="[object Uint8Array]",V="[object Uint8ClampedArray]",Y="[object Uint16Array]",G="[object Uint32Array]",X="[object Int8Array]",Z="[object Int16Array]",T="[object Int32Array]",C="[object Float32Array]",v="[object Float64Array]";function tt(t,e){return _(t,void 0,t,new Map,e)}function _(t,e,r,s=new Map,n=void 0){const a=n?.(t,e,r,s);if(a!=null)return a;if(I(t))return t;if(s.has(t))return s.get(t);if(Array.isArray(t)){const i=new Array(t.length);s.set(t,i);for(let o=0;o<t.length;o++)i[o]=_(t[o],o,r,s,n);return Object.hasOwn(t,"index")&&(i.index=t.index),Object.hasOwn(t,"input")&&(i.input=t.input),i}if(t instanceof Date)return new Date(t.getTime());if(t instanceof RegExp){const i=new RegExp(t.source,t.flags);return i.lastIndex=t.lastIndex,i}if(t instanceof Map){const i=new Map;s.set(t,i);for(const[o,c]of t)i.set(o,_(c,o,r,s,n));return i}if(t instanceof Set){const i=new Set;s.set(t,i);for(const o of t)i.add(_(o,void 0,r,s,n));return i}if(typeof Buffer<"u"&&Buffer.isBuffer(t))return t.subarray();if(W(t)){const i=new(Object.getPrototypeOf(t)).constructor(t.length);s.set(t,i);for(let o=0;o<t.length;o++)i[o]=_(t[o],o,r,s,n);return i}if(t instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&t instanceof SharedArrayBuffer)return t.slice(0);if(t instanceof DataView){const i=new DataView(t.buffer.slice(0),t.byteOffset,t.byteLength);return s.set(t,i),l(i,t,r,s,n),i}if(typeof File<"u"&&t instanceof File){const i=new File([t],t.name,{type:t.type});return s.set(t,i),l(i,t,r,s,n),i}if(t instanceof Blob){const i=new Blob([t],{type:t.type});return s.set(t,i),l(i,t,r,s,n),i}if(t instanceof Error){const i=new t.constructor;return s.set(t,i),i.message=t.message,i.name=t.name,i.stack=t.stack,i.cause=t.cause,l(i,t,r,s,n),i}if(typeof t=="object"&&et(t)){const i=Object.create(Object.getPrototypeOf(t));return s.set(t,i),l(i,t,r,s,n),i}return t}function l(t,e,r=t,s,n){const a=[...Object.keys(e),...J(e)];for(let i=0;i<a.length;i++){const o=a[i],c=Object.getOwnPropertyDescriptor(t,o);(c==null||c.writable)&&(t[o]=_(e[o],o,r,s,n))}}function et(t){switch(k(t)){case O:case U:case M:case z:case P:case q:case C:case v:case X:case Z:case T:case F:case w:case $:case B:case Q:case E:case H:case K:case V:case Y:case G:return!0;default:return!1}}function rt(t,e){return tt(t,(r,s,n,a)=>{const i=e?.(r,s,n,a);if(i!=null)return i;if(typeof t=="object")switch(Object.prototype.toString.call(t)){case w:case E:case P:{const o=new t.constructor(t?.valueOf());return l(o,t),o}case O:{const o={};return l(o,t),o.length=t.length,o[Symbol.iterator]=t[Symbol.iterator],o}default:return}})}function st(t,e,{signal:r,edges:s}={}){let n,a=null;const i=s!=null&&s.includes("leading"),o=s==null||s.includes("trailing"),c=()=>{a!==null&&(t.apply(n,a),n=void 0,a=null)},d=()=>{o&&c(),f()};let h=null;const u=()=>{h!=null&&clearTimeout(h),h=setTimeout(()=>{h=null,d()},e)},g=()=>{h!==null&&(clearTimeout(h),h=null)},f=()=>{g(),n=void 0,a=null},N=()=>{g(),c()},y=function(...j){if(r?.aborted)return;n=this,a=j;const R=h==null;u(),i&&R&&c()};return y.schedule=u,y.cancel=f,y.flush=N,r?.addEventListener("abort",f,{once:!0}),y}function it(t,e=0,r={}){typeof r!="object"&&(r={});const{signal:s,leading:n=!1,trailing:a=!0,maxWait:i}=r,o=Array(2);n&&(o[0]="leading"),a&&(o[1]="trailing");let c,d=null;const h=st(function(...f){c=t.apply(this,f),d=null},e,{signal:s,edges:o}),u=function(...f){if(i!=null){if(d===null)d=Date.now();else if(Date.now()-d>=i)return c=t.apply(this,f),d=Date.now(),h.cancel(),h.schedule(),c}return h.apply(this,f),c},g=()=>(h.flush(),c);return u.cancel=h.cancel,u.flush=g,u}function nt(t,e=0,r={}){typeof r!="object"&&(r={});const{leading:s=!0,trailing:n=!0,signal:a}=r;return it(t,e,{leading:s,trailing:n,signal:a,maxWait:e})}function ot(t){if(typeof t!="object"||t==null)return!1;if(Object.getPrototypeOf(t)===null)return!0;if(Object.prototype.toString.call(t)!=="[object Object]"){const r=t[Symbol.toStringTag];return r==null||!Object.getOwnPropertyDescriptor(t,Symbol.toStringTag)?.writable?!1:t.toString()===`[object ${r}]`}let e=t;for(;Object.getPrototypeOf(e)!==null;)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(t)===e}function x(t){return L(t)&&t.nodeType===1&&!ot(t)}/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/function b(t,e=new Set){const r=[t],s=new Set;let n=0;for(;r.length>n;){const a=r[n++];if(!(s.has(a)||!at(a)||e.has(a)))if(s.add(a),Symbol.iterator in a)try{for(const i of a)r.push(i)}catch{}else for(const i in a)i!=="defaultValue"&&r.push(a[i])}return s}function at(t){const e=Object.prototype.toString.call(t),r=typeof t;return!(r==="number"||r==="boolean"||r==="string"||r==="symbol"||r==="function"||e==="[object Date]"||e==="[object RegExp]"||e==="[object Module]"||t===void 0||t===null||t._watchdogExcluded||t instanceof EventTarget||t instanceof Event)}/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/function A(t,e,r=new Set){if(t===e&&ct(t))return!0;const s=b(t,r),n=b(e,r);for(const a of s)if(n.has(a))return!0;return!1}function ct(t){return typeof t=="object"&&t!==null}/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class S extends p{_editor=null;_lifecyclePromise=null;_throttledSave;_data;_lastDocumentVersion;_elementOrData;_initUsingData=!0;_editables={};_config;_excludedProps;constructor(e,r={}){super(r),this._throttledSave=nt(this._save.bind(this),typeof r.saveInterval=="number"?r.saveInterval:5e3),e&&(this._creator=(s,n)=>e.create(s,n)),this._destructor=s=>s.destroy()}get editor(){return this._editor}get _item(){return this._editor}setCreator(e){this._creator=e}setDestructor(e){this._destructor=e}_restart(){return Promise.resolve().then(()=>(this.state="initializing",this._fire("stateChange"),this._destroy())).catch(e=>{console.error("An error happened during the editor destroying.",e)}).then(()=>{const e={},r=[],s=this._config.rootsAttributes||{},n={};for(const[i,o]of Object.entries(this._data.roots))o.isLoaded?(e[i]="",n[i]=s[i]||{}):r.push(i);const a={...this._config,extraPlugins:this._config.extraPlugins||[],lazyRoots:r,rootsAttributes:n,_watchdogInitialData:this._data};return delete a.initialData,a.extraPlugins.push(ht),this._initUsingData?this.create(e,a,a.context):x(this._elementOrData)?this.create(this._elementOrData,a,a.context):this.create(this._editables,a,a.context)}).then(()=>{this._fire("restart")})}create(e=this._elementOrData,r=this._config,s){return this._lifecyclePromise=Promise.resolve(this._lifecyclePromise).then(()=>(super._startErrorHandling(),this._elementOrData=e,this._initUsingData=typeof e=="string"||Object.keys(e).length>0&&typeof Object.values(e)[0]=="string",this._config=this._cloneEditorConfiguration(r)||{},this._config.context=s,this._creator(e,this._config))).then(n=>{this._editor=n,n.model.document.on("change:data",this._throttledSave),this._lastDocumentVersion=n.model.document.version,this._data=this._getData(),this._initUsingData||(this._editables=this._getEditables()),this.state="ready",this._fire("stateChange")}).finally(()=>{this._lifecyclePromise=null}),this._lifecyclePromise}destroy(){return this._lifecyclePromise=Promise.resolve(this._lifecyclePromise).then(()=>(this.state="destroyed",this._fire("stateChange"),super.destroy(),this._destroy())).finally(()=>{this._lifecyclePromise=null}),this._lifecyclePromise}_destroy(){return Promise.resolve().then(()=>{this._stopErrorHandling(),this._throttledSave.cancel();const e=this._editor;return this._editor=null,e.model.document.off("change:data",this._throttledSave),this._destructor(e)})}_save(){const e=this._editor.model.document.version;try{this._data=this._getData(),this._initUsingData||(this._editables=this._getEditables()),this._lastDocumentVersion=e}catch(r){console.error(r,"An error happened during restoring editor data. Editor will be restored from the previously saved data.")}}_setExcludedProperties(e){this._excludedProps=e}_getData(){const e=this._editor,r=e.model.document.roots.filter(o=>o.isAttached()&&o.rootName!="$graveyard"),{plugins:s}=e,n=s.has("CommentsRepository")&&s.get("CommentsRepository"),a=s.has("TrackChanges")&&s.get("TrackChanges"),i={roots:{},markers:{},commentThreads:JSON.stringify([]),suggestions:JSON.stringify([])};r.forEach(o=>{i.roots[o.rootName]={content:JSON.stringify(Array.from(o.getChildren())),attributes:JSON.stringify(Array.from(o.getAttributes())),isLoaded:o._isLoaded}});for(const o of e.model.markers)o._affectsData&&(i.markers[o.name]={rangeJSON:o.getRange().toJSON(),usingOperation:o._managedUsingOperations,affectsData:o._affectsData});return n&&(i.commentThreads=JSON.stringify(n.getCommentThreads({toJSON:!0,skipNotAttached:!0}))),a&&(i.suggestions=JSON.stringify(a.getSuggestions({toJSON:!0,skipNotAttached:!0}))),i}_getEditables(){const e={};for(const r of this.editor.model.document.getRootNames()){const s=this.editor.ui.getEditableElement(r);s&&(e[r]=s)}return e}_isErrorComingFromThisItem(e){return A(this._editor,e.context,this._excludedProps)}_cloneEditorConfiguration(e){return rt(e,(r,s)=>{if(x(r)||s==="context")return r})}}class ht{editor;_data;constructor(e){this.editor=e,this._data=e.config.get("_watchdogInitialData")}init(){this.editor.data.on("init",e=>{e.stop(),this.editor.model.enqueueChange({isUndoable:!1},r=>{this._restoreCollaborationData(),this._restoreEditorData(r)}),this.editor.data.fire("ready")},{priority:999})}_createNode(e,r){if("name"in r){const s=e.createElement(r.name,r.attributes);if(r.children)for(const n of r.children)s._appendChild(this._createNode(e,n));return s}else return e.createText(r.data,r.attributes)}_restoreEditorData(e){const r=this.editor;Object.entries(this._data.roots).forEach(([s,{content:n,attributes:a}])=>{const i=JSON.parse(n),o=JSON.parse(a),c=r.model.document.getRoot(s);for(const[d,h]of o)e.setAttribute(d,h,c);for(const d of i){const h=this._createNode(e,d);e.insert(h,c,"end")}}),Object.entries(this._data.markers).forEach(([s,n])=>{const{document:a}=r.model,{rangeJSON:{start:i,end:o},...c}=n,d=a.getRoot(i.root),h=e.createPositionFromPath(d,i.path,i.stickiness),u=e.createPositionFromPath(d,o.path,o.stickiness),g=e.createRange(h,u);e.addMarker(s,{range:g,...c})})}_restoreCollaborationData(){const e=JSON.parse(this._data.commentThreads),r=JSON.parse(this._data.suggestions);e.forEach(s=>{const n=this.editor.config.get("collaboration.channelId"),a=this.editor.plugins.get("CommentsRepository");a.hasCommentThread(s.threadId)&&a.getCommentThread(s.threadId).remove(),a.addCommentThread({channelId:n,...s})}),r.forEach(s=>{const n=this.editor.plugins.get("TrackChangesEditing");if(n.hasSuggestion(s.id)){const a=n.getSuggestion(s.id);a.attributes=s.attributes}else n.addSuggestionData(s)})}}/**
* @license Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/const m=Symbol("MainQueueId");class dt extends p{_watchdogs=new Map;_watchdogConfig;_context=null;_contextProps=new Set;_actionQueues=new ut;_contextConfig;_item;constructor(e,r={}){super(r),this._watchdogConfig=r,this._creator=s=>e.create(s),this._destructor=s=>s.destroy(),this._actionQueues.onEmpty(()=>{this.state==="initializing"&&(this.state="ready",this._fire("stateChange"))})}setCreator(e){this._creator=e}setDestructor(e){this._destructor=e}get context(){return this._context}create(e={}){return this._actionQueues.enqueue(m,()=>(this._contextConfig=e,this._create()))}getItem(e){return this._getWatchdog(e)._item}getItemState(e){return this._getWatchdog(e).state}add(e){const r=D(e);return Promise.all(r.map(s=>this._actionQueues.enqueue(s.id,()=>{if(this.state==="destroyed")throw new Error("Cannot add items to destroyed watchdog.");if(!this._context)throw new Error("Context was not created yet. You should call the `ContextWatchdog#create()` method first.");let n;if(this._watchdogs.has(s.id))throw new Error(`Item with the given id is already added: '${s.id}'.`);if(s.type==="editor")return n=new S(null,this._watchdogConfig),n.setCreator(s.creator),n._setExcludedProperties(this._contextProps),s.destructor&&n.setDestructor(s.destructor),this._watchdogs.set(s.id,n),n.on("error",(a,{error:i,causesRestart:o})=>{this._fire("itemError",{itemId:s.id,error:i}),o&&this._actionQueues.enqueue(s.id,()=>new Promise(c=>{const d=()=>{n.off("restart",d),this._fire("itemRestart",{itemId:s.id}),c()};n.on("restart",d)}))}),n.create(s.sourceElementOrData,s.config,this._context);throw new Error(`Not supported item type: '${s.type}'.`)})))}remove(e){const r=D(e);return Promise.all(r.map(s=>this._actionQueues.enqueue(s,()=>{const n=this._getWatchdog(s);return this._watchdogs.delete(s),n.destroy()})))}destroy(){return this._actionQueues.enqueue(m,()=>(this.state="destroyed",this._fire("stateChange"),super.destroy(),this._destroy()))}_restart(){return this._actionQueues.enqueue(m,()=>(this.state="initializing",this._fire("stateChange"),this._destroy().catch(e=>{console.error("An error happened during destroying the context or items.",e)}).then(()=>this._create()).then(()=>this._fire("restart"))))}_create(){return Promise.resolve().then(()=>(this._startErrorHandling(),this._creator(this._contextConfig))).then(e=>(this._context=e,this._contextProps=b(this._context),Promise.all(Array.from(this._watchdogs.values()).map(r=>(r._setExcludedProperties(this._contextProps),r.create(void 0,void 0,this._context))))))}_destroy(){return Promise.resolve().then(()=>{this._stopErrorHandling();const e=this._context;return this._context=null,this._contextProps=new Set,Promise.all(Array.from(this._watchdogs.values()).map(r=>r.destroy())).then(()=>this._destructor(e))})}_getWatchdog(e){const r=this._watchdogs.get(e);if(!r)throw new Error(`Item with the given id was not registered: ${e}.`);return r}_isErrorComingFromThisItem(e){for(const r of this._watchdogs.values())if(r._isErrorComingFromThisItem(e))return!1;return A(this._context,e.context)}}class ut{_onEmptyCallbacks=[];_queues=new Map;_activeActions=0;onEmpty(e){this._onEmptyCallbacks.push(e)}enqueue(e,r){const s=e===m;this._activeActions++,this._queues.get(e)||this._queues.set(e,Promise.resolve());const a=(s?Promise.all(this._queues.values()):Promise.all([this._queues.get(m),this._queues.get(e)])).then(r),i=a.catch(()=>{});return this._queues.set(e,i),a.finally(()=>{this._activeActions--,this._queues.get(e)===i&&this._activeActions===0&&this._onEmptyCallbacks.forEach(o=>o())})}}function D(t){return Array.isArray(t)?t:[t]}export{dt as ContextWatchdog,S as EditorWatchdog,p as Watchdog};
