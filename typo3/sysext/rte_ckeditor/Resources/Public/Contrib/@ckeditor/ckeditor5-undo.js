import{Command as t,Plugin as e,icons as s}from"@ckeditor/ckeditor5-core";import{transformSets as o,NoOperation as i}from"@ckeditor/ckeditor5-engine";import{ButtonView as n,MenuBarMenuListItemButtonView as a}from"@ckeditor/ckeditor5-ui";
/**
 * @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class r extends t{constructor(t){super(t),this._stack=[],this._createdBatches=new WeakSet,this.refresh(),this._isEnabledBasedOnSelection=!1,this.listenTo(t.data,"set",((t,e)=>{e[1]={...e[1]};const s=e[1];s.batchType||(s.batchType={isUndoable:!1})}),{priority:"high"}),this.listenTo(t.data,"set",((t,e)=>{e[1].batchType.isUndoable||this.clearStack()}))}refresh(){this.isEnabled=this._stack.length>0}get createdBatches(){return this._createdBatches}addBatch(t){const e=this.editor.model.document.selection,s={ranges:e.hasOwnRange?Array.from(e.getRanges()):[],isBackward:e.isBackward};this._stack.push({batch:t,selection:s}),this.refresh()}clearStack(){this._stack=[],this.refresh()}_restoreSelection(t,e,s){const o=this.editor.model,i=o.document,n=[],a=t.map((t=>t.getTransformedByOperations(s))),r=a.flat();for(const t of a){const e=t.filter((t=>t.root!=i.graveyard)).filter((t=>!c(t,r)));e.length&&(d(e),n.push(e[0]))}n.length&&o.change((t=>{t.setSelection(n,{backward:e})}))}_undo(t,e){const s=this.editor.model,n=s.document;this._createdBatches.add(e);const a=t.operations.slice().filter((t=>t.isDocumentOperation));a.reverse();for(const t of a){const a=t.baseVersion+1,r=Array.from(n.history.getOperations(a)),d=o([t.getReversed()],r,{useRelations:!0,document:this.editor.model.document,padWithNoOps:!1,forceWeakRemove:!0}).operationsA;for(let o of d){const a=o.affectedSelectable;a&&!s.canEditAt(a)&&(o=new i(o.baseVersion)),e.addOperation(o),s.applyOperation(o),n.history.setOperationAsUndone(t,o)}}}}function d(t){t.sort(((t,e)=>t.start.isBefore(e.start)?-1:1));for(let e=1;e<t.length;e++){const s=t[e-1].getJoined(t[e],!0);s&&(e--,t.splice(e,2,s))}}function c(t,e){return e.some((e=>e!==t&&e.containsRange(t,!0)))}
/**
 * @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class h extends r{execute(t=null){const e=t?this._stack.findIndex((e=>e.batch==t)):this._stack.length-1,s=this._stack.splice(e,1)[0],o=this.editor.model.createBatch({isUndo:!0});this.editor.model.enqueueChange(o,(()=>{this._undo(s.batch,o);const t=this.editor.model.document.history.getOperations(s.batch.baseVersion);this._restoreSelection(s.selection.ranges,s.selection.isBackward,t)})),this.fire("revert",s.batch,o),this.refresh()}}
/**
 * @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class l extends r{execute(){const t=this._stack.pop(),e=this.editor.model.createBatch({isUndo:!0});this.editor.model.enqueueChange(e,(()=>{const s=t.batch.operations[t.batch.operations.length-1].baseVersion+1,o=this.editor.model.document.history.getOperations(s);this._restoreSelection(t.selection.ranges,t.selection.isBackward,o),this._undo(t.batch,e)})),this.refresh()}}
/**
 * @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class u extends e{constructor(){super(...arguments),this._batchRegistry=new WeakSet}static get pluginName(){return"UndoEditing"}init(){const t=this.editor,e=t.t;this._undoCommand=new h(t),this._redoCommand=new l(t),t.commands.add("undo",this._undoCommand),t.commands.add("redo",this._redoCommand),this.listenTo(t.model,"applyOperation",((t,e)=>{const s=e[0];if(!s.isDocumentOperation)return;const o=s.batch,i=this._redoCommand.createdBatches.has(o),n=this._undoCommand.createdBatches.has(o);this._batchRegistry.has(o)||(this._batchRegistry.add(o),o.isUndoable&&(i?this._undoCommand.addBatch(o):n||(this._undoCommand.addBatch(o),this._redoCommand.clearStack())))}),{priority:"highest"}),this.listenTo(this._undoCommand,"revert",((t,e,s)=>{this._redoCommand.addBatch(s)})),t.keystrokes.set("CTRL+Z","undo"),t.keystrokes.set("CTRL+Y","redo"),t.keystrokes.set("CTRL+SHIFT+Z","redo"),t.accessibility.addKeystrokeInfos({keystrokes:[{label:e("Undo"),keystroke:"CTRL+Z"},{label:e("Redo"),keystroke:[["CTRL+Y"],["CTRL+SHIFT+Z"]]}]})}}
/**
 * @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class m extends e{static get pluginName(){return"UndoUI"}init(){const t=this.editor,e=t.locale,o=t.t,i="ltr"==e.uiLanguageDirection?s.undo:s.redo,n="ltr"==e.uiLanguageDirection?s.redo:s.undo;this._addButtonsToFactory("undo",o("Undo"),"CTRL+Z",i),this._addButtonsToFactory("redo",o("Redo"),"CTRL+Y",n)}_addButtonsToFactory(t,e,s,o){const i=this.editor;i.ui.componentFactory.add(t,(()=>{const i=this._createButton(n,t,e,s,o);return i.set({tooltip:!0}),i})),i.ui.componentFactory.add("menuBar:"+t,(()=>this._createButton(a,t,e,s,o)))}_createButton(t,e,s,o,i){const n=this.editor,a=n.locale,r=n.commands.get(e),d=new t(a);return d.set({label:s,icon:i,keystroke:o}),d.bind("isEnabled").to(r,"isEnabled"),this.listenTo(d,"execute",(()=>{n.execute(e),n.editing.view.focus()})),d}}
/**
 * @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class g extends e{static get requires(){return[u,m]}static get pluginName(){return"Undo"}}export{g as Undo,u as UndoEditing,m as UndoUI};