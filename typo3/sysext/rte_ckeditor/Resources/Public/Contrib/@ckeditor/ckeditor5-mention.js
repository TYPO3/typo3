import{Command as O,Plugin as A}from"@ckeditor/ckeditor5-core";import{CKEditorError as v,toMap as q,uid as K,Rect as y,keyCodes as f,Collection as W,logWarning as H,env as j}from"@ckeditor/ckeditor5-utils";import{ListView as G,View as z,ListItemView as J,ContextualBalloon as C,clickOutsideHandler as Q,ButtonView as X}from"@ckeditor/ckeditor5-ui";import{TextWatcher as Y}from"@ckeditor/ckeditor5-typing";import{debounce as Z}from"lodash-es";/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/const V={"(":")","[":"]","{":"}"};class ee extends O{constructor(e){super(e),this._isEnabledBasedOnSelection=!1}refresh(){const e=this.editor.model,t=e.document;this.isEnabled=e.schema.checkAttributeInSelection(t.selection,"mention")}execute(e){const t=this.editor.model,n=t.document.selection,r=typeof e.mention=="string"?{id:e.mention}:e.mention,s=r.id,c=e.range||n.getFirstRange();if(!t.canEditAt(c))return;const a=e.text||s,l=P({_text:a,id:s},r);if(e.marker.length!=1)throw new v("mentioncommand-incorrect-marker",this);if(s.charAt(0)!=e.marker)throw new v("mentioncommand-incorrect-id",this);t.change(d=>{const u=q(n.getAttributes()),m=new Map(u.entries());m.set("mention",l);const x=t.insertContent(d.createText(a,m),c),w=x.start.nodeBefore,h=x.end.nodeAfter,_=h&&h.is("$text")&&h.data.startsWith(" ");let p=!1;if(w&&h&&w.is("$text")&&h.is("$text")){const b=w.data.slice(-1),I=b in V,U=I&&h.data.startsWith(V[b]);p=I&&U}!p&&!_&&t.insertContent(d.createText(" ",u),c.start.getShiftedBy(a.length))})}}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class R extends A{static get pluginName(){return"MentionEditing"}static get isOfficialPlugin(){return!0}init(){const e=this.editor,t=e.model,i=t.document;t.schema.extend("$text",{allowAttributes:"mention"}),e.conversion.for("upcast").elementToAttribute({view:{name:"span",key:"data-mention",classes:"mention"},model:{key:"mention",value:n=>E(n)}}),e.conversion.for("downcast").attributeToElement({model:"mention",view:ne}),e.conversion.for("downcast").add(te),i.registerPostFixer(n=>se(n,i,t.schema)),i.registerPostFixer(n=>re(n,i)),i.registerPostFixer(n=>ie(n,i)),e.commands.add("mention",new ee(e))}}function P(o,e){return Object.assign({uid:K()},o,e||{})}function E(o,e){const t=o.getAttribute("data-mention"),i=o.getChild(0);if(!i)return;const n={id:t,_text:i.data};return P(n,e)}function te(o){o.on("attribute:mention",(e,t,i)=>{const n=t.attributeNewValue;if(!t.item.is("$textProxy")||!n)return;const r=t.range.start;(r.textNode||r.nodeAfter).data!=n._text&&i.consumable.consume(t.item,e.name)},{priority:"highest"})}function ne(o,{writer:e}){if(!o)return;const t={class:"mention","data-mention":o.id},i={id:o.uid,priority:20};return e.createAttributeElement("span",t,i)}function ie(o,e){const t=e.selection,i=t.focus;return t.isCollapsed&&t.hasAttribute("mention")&&oe(i)?(o.removeSelectionAttribute("mention"),!0):!1}function oe(o){const e=o.isAtStart;return o.nodeBefore&&o.nodeBefore.is("$text")||e}function se(o,e,t){const i=e.differ.getChanges();let n=!1;for(const r of i){if(r.type=="attribute")continue;const s=r.position;if(r.name=="$text"){const c=s.textNode&&s.textNode.nextSibling;n=g(s.textNode,o)||n,n=g(c,o)||n,n=g(s.nodeBefore,o)||n,n=g(s.nodeAfter,o)||n}if(r.name!="$text"&&r.type=="insert"){const c=s.nodeAfter;for(const a of o.createRangeIn(c).getItems())n=g(a,o)||n}if(r.type=="insert"&&t.isInline(r.name)){const c=s.nodeAfter&&s.nodeAfter.nextSibling;n=g(s.nodeBefore,o)||n,n=g(c,o)||n}}return n}function re(o,e){const t=e.differ.getChanges();let i=!1;for(const n of t)if(n.type==="attribute"&&n.attributeKey!="mention"){const r=n.range.start.nodeBefore,s=n.range.end.nodeAfter;for(const c of[r,s])B(c)&&c.getAttribute(n.attributeKey)!=n.attributeNewValue&&(o.setAttribute(n.attributeKey,n.attributeNewValue,c),i=!0)}return i}function B(o){if(!o||!(o.is("$text")||o.is("$textProxy"))||!o.hasAttribute("mention"))return!1;const e=o.data,i=o.getAttribute("mention")._text;return e!=i}function g(o,e){return B(o)?(e.removeAttribute("mention",o),!0):!1}function T(o,{insertAt:e}={}){if(!o||typeof document>"u")return;const t=document.head||document.getElementsByTagName("head")[0],i=document.createElement("style");i.type="text/css",window.litNonce&&i.setAttribute("nonce",window.litNonce),e==="top"&&t.firstChild?t.insertBefore(i,t.firstChild):t.appendChild(i),i.styleSheet?i.styleSheet.cssText=o:i.appendChild(document.createTextNode(o))}T(":root{--ck-mention-list-max-height:300px}.ck.ck-mentions{max-height:var(--ck-mention-list-max-height);overflow-x:hidden;overflow-y:auto;overscroll-behavior:contain}.ck.ck-mentions>.ck-list__item{flex-shrink:0;overflow:hidden}");/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class F extends G{constructor(e){super(e),this.extendTemplate({attributes:{class:["ck-mentions"],tabindex:"-1"}})}selectFirst(){this.select(0)}selectNext(){const e=this.selected,t=this.items.getIndex(e);this.select(t+1)}selectPrevious(){const e=this.selected,t=this.items.getIndex(e);this.select(t-1)}select(e){let t=0;e>0&&e<this.items.length?t=e:e<0&&(t=this.items.length-1);const i=this.items.get(t);this.selected!==i&&(this.selected&&this.selected.removeHighlight(),i.highlight(),this.selected=i,this._isItemVisibleInScrolledArea(i)||(this.element.scrollTop=i.element.offsetTop))}executeSelected(){this.selected.fire("execute")}_isItemVisibleInScrolledArea(e){return new y(this.element).contains(new y(e.element))}}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class N extends z{constructor(e,t){super(e),this.template=void 0,this.domElement=t,this.domElement.classList.add("ck-button"),this.set("isOn",!1),this.on("change:isOn",(i,n,r)=>{r?(this.domElement.classList.add("ck-on"),this.domElement.classList.remove("ck-off")):(this.domElement.classList.add("ck-off"),this.domElement.classList.remove("ck-on"))}),this.listenTo(this.domElement,"click",()=>{this.fire("execute")})}render(){super.render(),this.element=this.domElement}focus(){this.domElement.focus()}}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class S extends J{highlight(){const e=this.children.first;e.isOn=!0}removeHighlight(){const e=this.children.first;e.isOn=!1}}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/const k=3,ce=[f.arrowup,f.arrowdown,f.esc],ae=[f.enter,f.tab];class D extends A{static get pluginName(){return"MentionUI"}static get isOfficialPlugin(){return!0}static get requires(){return[C]}constructor(e){super(e),this._items=new W,this._mentionsView=this._createMentionView(),this._mentionsConfigurations=new Map,this._requestFeedDebounced=Z(this._requestFeed,100),e.config.define("mention",{feeds:[]})}init(){const e=this.editor,t=e.config.get("mention.commitKeys")||ae,i=ce.concat(t);this._balloon=e.plugins.get(C),e.editing.view.document.on("keydown",(s,c)=>{r(c.keyCode)&&this._isUIVisible&&(c.preventDefault(),s.stop(),c.keyCode==f.arrowdown&&this._mentionsView.selectNext(),c.keyCode==f.arrowup&&this._mentionsView.selectPrevious(),t.includes(c.keyCode)&&this._mentionsView.executeSelected(),c.keyCode==f.esc&&this._hideUIAndRemoveMarker())},{priority:"highest"}),Q({emitter:this._mentionsView,activator:()=>this._isUIVisible,contextElements:()=>[this._balloon.view.element],callback:()=>this._hideUIAndRemoveMarker()});const n=e.config.get("mention.feeds");for(const s of n){const{feed:c,marker:a,dropdownLimit:l}=s;if(!ge(a))throw new v("mentionconfig-incorrect-marker",null,{marker:a});const d=typeof c=="function"?c.bind(this.editor):ue(c),u=s.itemRenderer,m={marker:a,feedCallback:d,itemRenderer:u,dropdownLimit:l};this._mentionsConfigurations.set(a,m)}this._setupTextWatcher(n),this.listenTo(e,"change:isReadOnly",()=>{this._hideUIAndRemoveMarker()}),this.on("requestFeed:response",(s,c)=>this._handleFeedResponse(c)),this.on("requestFeed:error",()=>this._hideUIAndRemoveMarker());function r(s){return i.includes(s)}}destroy(){super.destroy(),this._mentionsView.destroy()}get _isUIVisible(){return this._balloon.visibleView===this._mentionsView}_createMentionView(){const e=this.editor.locale,t=new F(e);return t.items.bindTo(this._items).using(i=>{const{item:n,marker:r}=i,{dropdownLimit:s}=this._mentionsConfigurations.get(r),c=s||this.editor.config.get("mention.dropdownLimit")||10;if(t.items.length>=c)return null;const a=new S(e),l=this._renderItem(n,r);return l.delegate("execute").to(a),a.children.add(l),a.item=n,a.marker=r,a.on("execute",()=>{t.fire("execute",{item:n,marker:r})}),a}),t.on("execute",(i,n)=>{const r=this.editor,s=r.model,c=n.item,a=n.marker,l=r.model.markers.get("mention"),d=s.createPositionAt(s.document.selection.focus),u=s.createPositionAt(l.getStart()),m=s.createRange(u,d);this._hideUIAndRemoveMarker(),r.execute("mention",{mention:c,text:c.text,marker:a,range:m}),r.editing.view.focus()}),t}_getItemRenderer(e){const{itemRenderer:t}=this._mentionsConfigurations.get(e);return t}_requestFeed(e,t){this._lastRequested=t;const{feedCallback:i}=this._mentionsConfigurations.get(e),n=i(t);if(!(n instanceof Promise)){this.fire("requestFeed:response",{feed:n,marker:e,feedText:t});return}n.then(s=>{this._lastRequested==t?this.fire("requestFeed:response",{feed:s,marker:e,feedText:t}):this.fire("requestFeed:discarded",{feed:s,marker:e,feedText:t})}).catch(s=>{this.fire("requestFeed:error",{error:s}),H("mention-feed-callback-error",{marker:e})})}_setupTextWatcher(e){const t=this.editor,i=e.map(s=>({...s,pattern:$(s.marker,s.minimumCharacters||0)})),n=new Y(t.model,le(i));n.on("matched",(s,c)=>{const a=L(i,c.text),d=t.model.document.selection.focus,u=t.model.createPositionAt(d.parent,a.position);if(he(d)||fe(u)){this._hideUIAndRemoveMarker();return}const m=me(a,c.text),x=a.marker.length+m.length,w=d.getShiftedBy(-x),h=d.getShiftedBy(-m.length),_=t.model.createRange(w,h);if(M(t)){const p=t.model.markers.get("mention");t.model.change(b=>{b.updateMarker(p,{range:_})})}else t.model.change(p=>{p.addMarker("mention",{range:_,usingOperation:!1,affectsData:!1})});this._requestFeedDebounced(a.marker,m)}),n.on("unmatched",()=>{this._hideUIAndRemoveMarker()});const r=t.commands.get("mention");return n.bind("isEnabled").to(r),n}_handleFeedResponse(e){const{feed:t,marker:i}=e;if(!M(this.editor))return;this._items.clear();for(const r of t){const s=typeof r!="object"?{id:r,text:r}:r;this._items.add({item:s,marker:i})}const n=this.editor.model.markers.get("mention");this._items.length?this._showOrUpdateUI(n):this._hideUIAndRemoveMarker()}_showOrUpdateUI(e){this._isUIVisible?this._balloon.updatePosition(this._getBalloonPanelPositionData(e,this._mentionsView.position)):this._balloon.add({view:this._mentionsView,position:this._getBalloonPanelPositionData(e,this._mentionsView.position),singleViewMode:!0}),this._mentionsView.position=this._balloon.view.position,this._mentionsView.selectFirst()}_hideUIAndRemoveMarker(){this._balloon.hasView(this._mentionsView)&&this._balloon.remove(this._mentionsView),M(this.editor)&&this.editor.model.change(e=>e.removeMarker("mention")),this._mentionsView.position=void 0}_renderItem(e,t){const i=this.editor;let n,r=e.id;const s=this._getItemRenderer(t);if(s){const c=s(e);typeof c!="string"?n=new N(i.locale,c):r=c}if(!n){const c=new X(i.locale);c.label=r,c.withText=!0,n=c}return n}_getBalloonPanelPositionData(e,t){const i=this.editor,n=i.editing,r=n.view.domConverter,s=n.mapper,c=i.locale.uiLanguageDirection;return{target:()=>{let a=e.getRange();a.start.root.rootName=="$graveyard"&&(a=i.model.document.selection.getFirstRange());const l=s.toViewRange(a);return y.getDomRangeRects(r.viewRangeToDom(l)).pop()},limiter:()=>{const a=this.editor.editing.view,d=a.document.selection.editableElement;return d?a.domConverter.mapViewToDom(d.root):null},positions:de(t,c)}}}function de(o,e){const t={caret_se:i=>({top:i.bottom+k,left:i.right,name:"caret_se",config:{withArrow:!1}}),caret_ne:(i,n)=>({top:i.top-n.height-k,left:i.right,name:"caret_ne",config:{withArrow:!1}}),caret_sw:(i,n)=>({top:i.bottom+k,left:i.right-n.width,name:"caret_sw",config:{withArrow:!1}}),caret_nw:(i,n)=>({top:i.top-n.height-k,left:i.right-n.width,name:"caret_nw",config:{withArrow:!1}})};return Object.prototype.hasOwnProperty.call(t,o)?[t[o]]:e!=="rtl"?[t.caret_se,t.caret_sw,t.caret_ne,t.caret_nw]:[t.caret_sw,t.caret_se,t.caret_nw,t.caret_ne]}function L(o,e){let t;for(const i of o){const n=e.lastIndexOf(i.marker);n>0&&!e.substring(n-1).match(i.pattern)||(!t||n>=t.position)&&(t={marker:i.marker,position:n,minimumCharacters:i.minimumCharacters,pattern:i.pattern})}return t}function $(o,e){const t=e==0?"*":`{${e},}`,i=j.features.isRegExpUnicodePropertySupported?`\\p{Ps}\\p{Pi}"'`:`\\(\\[{"'`,n=".";o=o.replace(/[.*+?^${}()\-|[\]\\]/g,"\\$&");const r=`(?:^|[ ${i}])([${o}])(${n}${t})$`;return new RegExp(r,"u")}function le(o){return t=>{const i=L(o,t);if(!i)return!1;let n=0;i.position!==0&&(n=i.position-1);const r=t.substring(n);return i.pattern.test(r)}}function me(o,e){let t=0;o.position!==0&&(t=o.position-1);const i=$(o.marker,0);return e.substring(t).match(i)[2]}function ue(o){return e=>o.filter(i=>(typeof i=="string"?i:String(i.id)).toLowerCase().includes(e.toLowerCase()))}function he(o){const e=o.textNode&&o.textNode.hasAttribute("mention"),t=o.nodeBefore;return e||t&&t.is("$text")&&t.hasAttribute("mention")}function fe(o){const e=o.nodeAfter;return e&&e.is("$text")&&e.hasAttribute("mention")}function ge(o){return o&&o.length==1}function M(o){return o.model.markers.has("mention")}T(":root{--ck-color-mention-background:rgba(153,0,48,.1);--ck-color-mention-text:#990030}.ck-content .mention{background:var(--ck-color-mention-background);color:var(--ck-color-mention-text)}");/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class pe extends A{toMentionAttribute(e,t){return E(e,t)}static get pluginName(){return"Mention"}static get isOfficialPlugin(){return!0}static get requires(){return[R,D]}}export{N as DomWrapperView,pe as Mention,R as MentionEditing,S as MentionListItemView,D as MentionUI,F as MentionsView};
