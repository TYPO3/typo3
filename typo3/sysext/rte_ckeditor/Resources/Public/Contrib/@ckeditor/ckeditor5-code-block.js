import{Command as b,Plugin as B,icons as A}from"@ckeditor/ckeditor5-core";import{ShiftEnter as N}from"@ckeditor/ckeditor5-enter";import{UpcastWriter as R}from"@ckeditor/ckeditor5-engine";import{ClipboardPipeline as M}from"@ckeditor/ckeditor5-clipboard";import{first as v,Collection as q}from"@ckeditor/ckeditor5-utils";import{createDropdown as F,SplitButtonView as $,addListToDropdown as z,MenuBarMenuView as W,MenuBarMenuListView as j,MenuBarMenuListItemView as U,MenuBarMenuListItemButtonView as H,ViewModel as J}from"@ckeditor/ckeditor5-ui";/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/function h(i){const e=i.t,n=i.config.get("codeBlock.languages");for(const o of n)o.label==="Plain text"&&(o.label=e("Plain text")),o.class===void 0&&(o.class=`language-${o.language}`);return n}function k(i,e,n){const o={};for(const s of i)if(e==="class"){const c=s[e].split(" ").shift();o[c]=s[n]}else o[s[e]]=s[n];return o}function C(i){return i.data.match(/^(\s*)/)[0]}function K(i,e){const n=i.createDocumentFragment(),o=e.split(`
`),s=o.reduce((c,t,r)=>(c.push(t),r<o.length-1&&c.push(i.createElement("br")),c),[]);return i.appendChild(s,n),n}function x(i){const e=i.document.selection,n=[];if(e.isCollapsed)return[e.anchor];const o=e.getFirstRange().getWalker({ignoreElementEnd:!0,direction:"backward"});for(const{item:s}of o){let c=s.is("$textProxy")?s.textNode:s;const t=c.parent;if(!t.is("element","codeBlock")||c.is("element","softBreak"))continue;for(;c.previousSibling&&!c.previousSibling.is("element","softBreak");)c=c.previousSibling;const r=c.is("$text")?c.startOffset+C(c).length:c.startOffset,a=i.createPositionAt(t,r);n.every(l=>!l.isEqual(a))&&n.push(a)}return n}function L(i){const e=v(i.getSelectedBlocks());return!!e&&e.is("element","codeBlock")}function E(i,e){return e.is("rootElement")||i.isLimit(e)?!1:i.checkChild(e.parent,"codeBlock")}function P(i,e,n,o){const s=k(e,"language","label"),c=n.getAttribute("language");if(c in s){const t=s[c];return i(o==="enter"?"Entering %0 code snippet":"Leaving %0 code snippet",t)}return i(o==="enter"?"Entering code snippet":"Leaving code snippet")}function T(i,e){for(i.textNode&&(i=e.createPositionBefore(i.textNode));i.nodeBefore&&!i.nodeBefore.is("element","softBreak");)i=e.createPositionBefore(i.nodeBefore);const n=i.nodeAfter;return n&&n.is("$text")?n:null}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class X extends b{constructor(e){super(e),this._lastLanguage=null}refresh(){this.value=this._getValue(),this.isEnabled=this._checkEnabled()}execute(e={}){const n=this.editor,o=n.model,s=o.document.selection,t=h(n)[0],r=Array.from(s.getSelectedBlocks()),a=e.forceValue==null?!this.value:e.forceValue,l=G(e,this._lastLanguage,t.language);o.change(d=>{a?this._applyCodeBlock(d,r,l):this._removeCodeBlock(d,r)})}_getValue(){const e=this.editor.model.document.selection,n=v(e.getSelectedBlocks());return!!(n&&n.is("element","codeBlock"))?n.getAttribute("language"):!1}_checkEnabled(){if(this.value)return!0;const e=this.editor.model.document.selection,n=this.editor.model.schema,o=v(e.getSelectedBlocks());return o?E(n,o):!1}_applyCodeBlock(e,n,o){this._lastLanguage=o;const s=this.editor.model.schema,c=n.filter(t=>E(s,t));for(const t of c)e.rename(t,"codeBlock"),e.setAttribute("language",o,t),s.removeDisallowedAttributes([t],e),Array.from(t.getChildren()).filter(r=>!s.checkChild(t,r)).forEach(r=>e.remove(r));c.reverse().forEach((t,r)=>{const a=c[r+1];t.previousSibling===a&&(e.appendElement("softBreak",a),e.merge(e.createPositionBefore(t)))})}_removeCodeBlock(e,n){const o=n.filter(s=>s.is("element","codeBlock"));for(const s of o){const c=e.createRangeOn(s);for(const t of Array.from(c.getItems()).reverse())if(t.is("element","softBreak")&&t.parent.is("element","codeBlock")){const{position:r}=e.split(e.createPositionBefore(t)),a=r.nodeAfter;e.rename(a,"paragraph"),e.removeAttribute("language",a),e.remove(t)}e.rename(s,"paragraph"),e.removeAttribute("language",s)}}}function G(i,e,n){return i.language?i.language:i.usePreviousLanguageChoice&&e?e:n}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class Q extends b{constructor(e){super(e),this._indentSequence=e.config.get("codeBlock.indentSequence")}refresh(){this.isEnabled=this._checkEnabled()}execute(){const n=this.editor.model;n.change(o=>{const s=x(n);for(const c of s){const t=o.createText(this._indentSequence);n.insertContent(t,c)}})}_checkEnabled(){return this._indentSequence?L(this.editor.model.document.selection):!1}}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class Y extends b{constructor(e){super(e),this._indentSequence=e.config.get("codeBlock.indentSequence")}refresh(){this.isEnabled=this._checkEnabled()}execute(){const n=this.editor.model;n.change(()=>{const o=x(n);for(const s of o){const c=_(n,s,this._indentSequence);c&&n.deleteContent(n.createSelection(c))}})}_checkEnabled(){if(!this._indentSequence)return!1;const e=this.editor.model;return L(e.document.selection)?x(e).some(n=>_(e,n,this._indentSequence)):!1}}function _(i,e,n){const o=T(e,i);if(!o)return null;const s=C(o),c=s.lastIndexOf(n);if(c+n.length!==s.length||c===-1)return null;const{parent:t,startOffset:r}=o;return i.createRange(i.createPositionAt(t,r+c),i.createPositionAt(t,r+c+n.length))}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/function y(i,e,n=!1){const o=k(e,"language","class"),s=k(e,"language","label");return(c,t,r)=>{const{writer:a,mapper:l,consumable:d}=r;if(!d.consume(t.item,"insert"))return;const u=t.item.getAttribute("language"),g=l.toViewPosition(i.createPositionBefore(t.item)),m={};n&&(m["data-language"]=s[u],m.spellcheck="false");const p=o[u]?{class:o[u]}:void 0,w=a.createContainerElement("code",p),O=a.createContainerElement("pre",m,w);a.insert(g,O),l.bindElements(t.item,w)}}function Z(i){return(e,n,o)=>{if(n.item.parent.name!=="codeBlock")return;const{writer:s,mapper:c,consumable:t}=o;if(!t.consume(n.item,"insert"))return;const r=c.toViewPosition(i.createPositionBefore(n.item));s.insert(r,s.createText(`
`))}}function ee(i,e){const n=k(e,"class","language"),o=e[0].language;return(s,c,t)=>{const r=c.viewItem,a=r.parent;if(!a||!a.is("element","pre")||c.modelCursor.findAncestor("codeBlock"))return;const{consumable:l,writer:d}=t;if(!l.test(r,{name:!0}))return;const u=d.createElement("codeBlock"),g=[...r.getClassNames()];g.length||g.push("");for(const m of g){const p=n[m];if(p){d.setAttribute("language",p,u);break}}u.hasAttribute("language")||d.setAttribute("language",o,u),t.convertChildren(r,u),t.safeInsert(u,c.modelCursor)&&(l.consume(r,{name:!0}),t.updateConversionResult(u,c))}}function te(){return(i,e,{consumable:n,writer:o})=>{let s=e.modelCursor;if(!n.test(e.viewItem)||!s.findAncestor("codeBlock"))return;n.consume(e.viewItem);const t=e.viewItem.data.split(`
`).map(a=>o.createText(a)),r=t[t.length-1];for(const a of t)if(o.insert(a,s),s=s.getShiftedBy(a.offsetSize),a!==r){const l=o.createElement("softBreak");o.insert(l,s),s=o.createPositionAfter(l)}e.modelRange=o.createRange(e.modelCursor,s),e.modelCursor=s}}function ne(){return(i,e,{consumable:n})=>{const o=e.viewItem;if(o.findAncestor("pre"))return;const s=Array.from(o.getChildren()),c=s.find(t=>t.is("element","code"));if(c)for(const t of s)t===c||!t.is("$text")||n.consume(t,{name:!0})}}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/const D="paragraph";class I extends B{static get pluginName(){return"CodeBlockEditing"}static get isOfficialPlugin(){return!0}static get requires(){return[N]}constructor(e){super(e),e.config.define("codeBlock",{languages:[{language:"plaintext",label:"Plain text"},{language:"c",label:"C"},{language:"cs",label:"C#"},{language:"cpp",label:"C++"},{language:"css",label:"CSS"},{language:"diff",label:"Diff"},{language:"html",label:"HTML"},{language:"java",label:"Java"},{language:"javascript",label:"JavaScript"},{language:"php",label:"PHP"},{language:"python",label:"Python"},{language:"ruby",label:"Ruby"},{language:"typescript",label:"TypeScript"},{language:"xml",label:"XML"}],indentSequence:"	"})}init(){const e=this.editor,n=e.model.schema,o=e.model,s=e.editing.view,c=h(e);e.commands.add("codeBlock",new X(e)),e.commands.add("indentCodeBlock",new Q(e)),e.commands.add("outdentCodeBlock",new Y(e)),this.listenTo(s.document,"tab",(t,r)=>{const a=r.shiftKey?"outdentCodeBlock":"indentCodeBlock";e.commands.get(a).isEnabled&&(e.execute(a),r.stopPropagation(),r.preventDefault(),t.stop())},{context:"pre"}),n.register("codeBlock",{allowWhere:"$block",allowChildren:"$text",disallowChildren:"$inlineObject",allowAttributes:["language"],allowAttributesOf:"$listItem",isBlock:!0}),n.addAttributeCheck((t,r)=>{const a=t.getItem(t.length-2);if(n.getAttributeProperties(r).isFormatting&&a&&a.name=="codeBlock")return!1}),e.editing.downcastDispatcher.on("insert:codeBlock",y(o,c,!0)),e.data.downcastDispatcher.on("insert:codeBlock",y(o,c)),e.data.downcastDispatcher.on("insert:softBreak",Z(o),{priority:"high"}),e.data.upcastDispatcher.on("element:code",ee(s,c)),e.data.upcastDispatcher.on("text",te()),e.data.upcastDispatcher.on("element:pre",ne(),{priority:"high"}),this.listenTo(e.editing.view.document,"clipboardInput",(t,r)=>{let a=o.createRange(o.document.selection.anchor);if(r.targetRanges&&(a=e.editing.mapper.toModelRange(r.targetRanges[0])),!a.start.parent.is("element","codeBlock"))return;const l=r.dataTransfer.getData("text/plain"),d=new R(e.editing.view.document);r.content=K(d,l)}),e.plugins.has("ClipboardPipeline")&&e.plugins.get(M).on("contentInsertion",(t,r)=>{const a=e.model,l=a.document.selection;l.anchor.parent.is("element","codeBlock")&&a.change(d=>{const u=d.createRangeIn(r.content);for(const g of[...u.getItems()])g.is("node")&&!n.checkChild(l.anchor,g)&&d.remove(g)})}),this.listenTo(o,"getSelectedContent",(t,[r])=>{const a=r.anchor;r.isCollapsed||!a.parent.is("element","codeBlock")||!a.hasSameParentAs(r.focus)||o.change(l=>{const d=t.return;if(a.parent.is("element")&&(d.childCount>1||r.containsEntireContent(a.parent))){const g=l.createElement("codeBlock",a.parent.getAttributes());l.append(d,g);const m=l.createDocumentFragment();l.append(g,m),t.return=m;return}const u=d.getChild(0);n.checkAttribute(u,"code")&&l.setAttribute("code",!0,u)})})}afterInit(){const e=this.editor,n=e.commands,o=n.get("indent"),s=n.get("outdent");o&&o.registerChildCommand(n.get("indentCodeBlock"),{priority:"highest"}),s&&s.registerChildCommand(n.get("outdentCodeBlock")),this.listenTo(e.editing.view.document,"enter",(c,t)=>{e.model.document.selection.getLastPosition().parent.is("element","codeBlock")&&(!ie(e,t.isSoft)&&!ce(e,t.isSoft)&&oe(e),t.preventDefault(),c.stop())},{context:"pre"}),this._initAriaAnnouncements()}_initAriaAnnouncements(){const{model:e,ui:n,t:o}=this.editor,s=h(this.editor);let c=null;e.document.selection.on("change:range",()=>{const t=e.document.selection.focus.parent;!n||c===t||!t.is("element")||(c&&c.is("element","codeBlock")&&n.ariaLiveAnnouncer.announce(P(o,s,c,"leave")),t.is("element","codeBlock")&&n.ariaLiveAnnouncer.announce(P(o,s,t,"enter")),c=t)})}}function oe(i){const e=i.model,n=e.document,o=n.selection.getLastPosition();let s;const c=T(o,e);c&&c.is("$text")&&(s=C(c)),i.model.change(t=>{i.execute("shiftEnter"),s&&t.insertText(s,n.selection.anchor)})}function ie(i,e){const o=i.model.document,s=i.editing.view,c=o.selection.getLastPosition(),t=c.nodeAfter;return e||!o.selection.isCollapsed||!c.isAtStart||!f(t)?!1:(i.model.change(r=>{i.execute("enter");const a=o.selection.anchor.parent.previousSibling;r.rename(a,D),r.setSelection(a,"in"),i.model.schema.removeDisallowedAttributes([a],r),r.remove(t)}),s.scrollToTheSelection(),!0)}function ce(i,e){const n=i.model,o=n.document,s=i.editing.view,c=o.selection.getLastPosition(),t=c.nodeBefore;let r;if(e||!o.selection.isCollapsed||!c.isAtEnd||!t||!t.previousSibling)return!1;if(f(t)&&f(t.previousSibling))r=n.createRange(n.createPositionBefore(t.previousSibling),n.createPositionAfter(t));else if(S(t)&&f(t.previousSibling)&&f(t.previousSibling.previousSibling))r=n.createRange(n.createPositionBefore(t.previousSibling.previousSibling),n.createPositionAfter(t));else if(S(t)&&f(t.previousSibling)&&S(t.previousSibling.previousSibling)&&t.previousSibling.previousSibling&&f(t.previousSibling.previousSibling.previousSibling))r=n.createRange(n.createPositionBefore(t.previousSibling.previousSibling.previousSibling),n.createPositionAfter(t));else return!1;return i.model.change(a=>{a.remove(r),i.execute("enter");const l=o.selection.anchor.parent;a.rename(l,D),i.model.schema.removeDisallowedAttributes([l],a)}),s.scrollToTheSelection(),!0}function S(i){return i&&i.is("$text")&&!i.data.match(/\S/)}function f(i){return i&&i.is("element","softBreak")}function se(i,{insertAt:e}={}){if(typeof document>"u")return;const n=document.head||document.getElementsByTagName("head")[0],o=document.createElement("style");o.type="text/css",window.litNonce&&o.setAttribute("nonce",window.litNonce),e==="top"&&n.firstChild?n.insertBefore(o,n.firstChild):n.appendChild(o),o.styleSheet?o.styleSheet.cssText=i:o.appendChild(document.createTextNode(i))}se(".ck-content pre{background:hsla(0,0%,78%,.3);border:1px solid #c4c4c4;border-radius:2px;color:#353535;direction:ltr;font-style:normal;min-width:200px;padding:1em;tab-size:4;text-align:left;white-space:pre-wrap}.ck-content pre code{background:unset;border-radius:0;padding:0}.ck.ck-editor__editable pre{position:relative}.ck.ck-editor__editable pre[data-language]:after{content:attr(data-language);position:absolute}:root{--ck-color-code-block-label-background:#757575}.ck.ck-editor__editable pre[data-language]:after{background:var(--ck-color-code-block-label-background);color:#fff;font-family:var(--ck-font-face);font-size:10px;line-height:16px;padding:var(--ck-spacing-tiny) var(--ck-spacing-medium);right:10px;top:-1px;white-space:nowrap}.ck.ck-code-block-dropdown .ck-dropdown__panel{max-height:250px;overflow-x:hidden;overflow-y:auto}");/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class V extends B{static get pluginName(){return"CodeBlockUI"}static get isOfficialPlugin(){return!0}init(){const e=this.editor,n=e.t,o=e.ui.componentFactory,s=h(e),c=this._getLanguageListItemDefinitions(s),t=e.commands.get("codeBlock");o.add("codeBlock",r=>{const a=F(r,$),l=a.buttonView,d=n("Insert code block");return l.set({label:d,tooltip:!0,icon:A.codeBlock,isToggleable:!0}),l.bind("isOn").to(t,"value",u=>!!u),l.on("execute",()=>{e.execute("codeBlock",{usePreviousLanguageChoice:!0}),e.editing.view.focus()}),a.on("execute",u=>{e.execute("codeBlock",{language:u.source._codeBlockLanguage,forceValue:!0}),e.editing.view.focus()}),a.class="ck-code-block-dropdown",a.bind("isEnabled").to(t),z(a,c,{role:"menu",ariaLabel:d}),a}),o.add("menuBar:codeBlock",r=>{const a=new W(r);a.buttonView.set({role:"menuitem",label:n("Code block"),icon:A.codeBlock}),a.bind("isEnabled").to(t);const l=new j(r);l.set({ariaLabel:n("Insert code block")});for(const d of c){const u=new U(r,a),g=new H(r);g.bind(...Object.keys(d.model)).to(d.model),g.set({isToggleable:!0,role:"menuitemcheckbox"}),g.delegate("execute").to(a),g.on("execute",()=>{e.execute("codeBlock",{language:d.model._codeBlockLanguage,forceValue:t.value!=d.model._codeBlockLanguage}),e.editing.view.focus()}),u.children.add(g),l.items.add(u)}return a.panelView.children.add(l),a})}_getLanguageListItemDefinitions(e){const o=this.editor.commands.get("codeBlock"),s=new q;for(const c of e){const t={type:"button",model:new J({_codeBlockLanguage:c.language,label:c.label,role:"menuitemradio",withText:!0})};t.model.bind("isOn").to(o,"value",r=>r===t.model._codeBlockLanguage),s.add(t)}return s}}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class re extends B{static get requires(){return[I,V]}static get pluginName(){return"CodeBlock"}static get isOfficialPlugin(){return!0}}export{re as CodeBlock,I as CodeBlockEditing,V as CodeBlockUI};
