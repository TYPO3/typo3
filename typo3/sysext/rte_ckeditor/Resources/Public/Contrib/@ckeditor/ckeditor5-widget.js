import{Plugin as v}from"@ckeditor/ckeditor5-core";import{MouseObserver as x,TreeWalker as X}from"@ckeditor/ckeditor5-engine";import{Delete as A}from"@ckeditor/ckeditor5-typing";import{EmitterMixin as J,Rect as f,CKEditorError as R,toArray as W,isForwardArrowKeyCode as Q,env as H,keyCodes as z,getLocalizedArrowKeyCodeDirection as Z,getRangeFromMouseEvent as ee,logWarning as te,ObservableMixin as V,compareArrays as ie,global as D,DomEmitterMixin as oe}from"@ckeditor/ckeditor5-utils";import{IconView as ne,Template as E,ContextualBalloon as re,ToolbarView as se,BalloonPanelView as ce,View as de}from"@ckeditor/ckeditor5-ui";import{Enter as ae}from"@ckeditor/ckeditor5-enter";import{throttle as le}from"lodash-es";/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class he extends J(){constructor(){super(...arguments),this._stack=[]}add(e,t){const i=this._stack,o=i[0];this._insertDescriptor(e);const n=i[0];o!==n&&!S(o,n)&&this.fire("change:top",{oldDescriptor:o,newDescriptor:n,writer:t})}remove(e,t){const i=this._stack,o=i[0];this._removeDescriptor(e);const n=i[0];o!==n&&!S(o,n)&&this.fire("change:top",{oldDescriptor:o,newDescriptor:n,writer:t})}_insertDescriptor(e){const t=this._stack,i=t.findIndex(n=>n.id===e.id);if(S(e,t[i]))return;i>-1&&t.splice(i,1);let o=0;for(;t[o]&&ge(t[o],e);)o++;t.splice(o,0,e)}_removeDescriptor(e){const t=this._stack,i=t.findIndex(o=>o.id===e);i>-1&&t.splice(i,1)}}function S(r,e){return r&&e&&r.priority==e.priority&&y(r.classes)==y(e.classes)}function ge(r,e){return r.priority>e.priority?!0:r.priority<e.priority?!1:y(r.classes)>y(e.classes)}function y(r){return Array.isArray(r)?r.sort().join(","):r}var ue='<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M4 0v1H1v3H0V.5A.5.5 0 0 1 .5 0H4zm8 0h3.5a.5.5 0 0 1 .5.5V4h-1V1h-3V0zM4 16H.5a.5.5 0 0 1-.5-.5V12h1v3h3v1zm8 0v-1h3v-3h1v3.5a.5.5 0 0 1-.5.5H12z"/><path fill-opacity=".256" d="M1 1h14v14H1z"/><g class="ck-icon__selected-indicator"><path d="M7 0h2v1H7V0zM0 7h1v2H0V7zm15 0h1v2h-1V7zm-8 8h2v1H7v-1z"/><path fill-opacity=".254" d="M1 1h14v14H1z"/></g></svg>';/**
 * @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
 */const I="ck-widget",P="ck-widget_selected";function _(r){return r.is("element")?!!r.getCustomProperty("widget"):!1}function _e(r,e,t={}){if(!r.is("containerElement"))throw new R("widget-to-widget-wrong-element-type",null,{element:r});return e.setAttribute("contenteditable","false",r),e.addClass(I,r),e.setCustomProperty("widget",!0,r),r.getFillerOffset=be,e.setCustomProperty("widgetLabel",[],r),t.label&&M(r,t.label),t.hasSelectionHandle&&ve(r,e),C(r,e),r}function ke(r,e,t){if(e.classes&&t.addClass(W(e.classes),r),e.attributes)for(const i in e.attributes)t.setAttribute(i,e.attributes[i],r)}function we(r,e,t){if(e.classes&&t.removeClass(W(e.classes),r),e.attributes)for(const i in e.attributes)t.removeAttribute(i,r)}function C(r,e,t=ke,i=we){const o=new he;o.on("change:top",(c,d)=>{d.oldDescriptor&&i(r,d.oldDescriptor,d.writer),d.newDescriptor&&t(r,d.newDescriptor,d.writer)});const n=(c,d,a)=>o.add(d,a),s=(c,d,a)=>o.remove(d,a);e.setCustomProperty("addHighlight",n,r),e.setCustomProperty("removeHighlight",s,r)}function M(r,e){r.getCustomProperty("widgetLabel").push(e)}function O(r){return r.getCustomProperty("widgetLabel").reduce((t,i)=>typeof i=="function"?t?t+". "+i():i():t?t+". "+i:i,"")}function pe(r,e,t={}){return e.addClass(["ck-editor__editable","ck-editor__nested-editable"],r),e.setAttribute("role","textbox",r),e.setAttribute("tabindex","-1",r),t.label&&e.setAttribute("aria-label",t.label,r),e.setAttribute("contenteditable",r.isReadOnly?"false":"true",r),r.on("change:isReadOnly",(i,o,n)=>{e.setAttribute("contenteditable",n?"false":"true",r)}),r.on("change:isFocused",(i,o,n)=>{n?e.addClass("ck-editor__nested-editable_focused",r):e.removeClass("ck-editor__nested-editable_focused",r)}),C(r,e),r}function fe(r,e){const t=r.getSelectedElement();if(t){const i=p(r);if(i)return e.createRange(e.createPositionAt(t,i))}return e.schema.findOptimalInsertionRange(r)}function me(r,e){return(t,i)=>{const{mapper:o,viewPosition:n}=i,s=o.findMappedViewAncestor(n);if(!e(s))return;const c=o.toModelElement(s);i.modelPosition=r.createPositionAt(c,n.isAtStart?"before":"after")}}function be(){return null}function ve(r,e){const t=e.createUIElement("div",{class:"ck ck-widget__selection-handle"},function(i){const o=this.toDomElement(i),n=new ne;return n.set("content",ue),n.render(),o.appendChild(n.element),o});e.insert(e.createPositionAt(r,0),t),e.addClass(["ck-widget_with-selection-handle"],r)}function F(r){const e=c=>{const{width:d,paddingLeft:a,paddingRight:l}=c.ownerDocument.defaultView.getComputedStyle(c);return parseFloat(d)-(parseFloat(a)||0)-(parseFloat(l)||0)},t=r.parentElement;if(!t)return 0;let i=e(t);const o=5;let n=0,s=t;for(;isNaN(i);){if(s=s.parentElement,++n>o)return 0;i=e(s)}return i}function N(r,e=new f(r)){const t=F(r);return t?e.width/t*100:0}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/const w="widget-type-around";function m(r,e,t){return!!r&&_(r)&&!t.isInline(e)}function ye(r){return r.closest(".ck-widget__type-around__button")}function ze(r){return r.classList.contains("ck-widget__type-around__button_before")?"before":"after"}function Ee(r,e){const t=r.closest(".ck-widget");return e.mapDomToView(t)}function p(r){return r.getAttribute(w)}var Se='<svg viewBox="0 0 10 8" xmlns="http://www.w3.org/2000/svg"><path d="M9.055.263v3.972h-6.77M1 4.216l2-2.038m-2 2 2 2.038"/></svg>';function T(r,{insertAt:e}={}){if(!r||typeof document>"u")return;const t=document.head||document.getElementsByTagName("head")[0],i=document.createElement("style");i.type="text/css",window.litNonce&&i.setAttribute("nonce",window.litNonce),e==="top"&&t.firstChild?t.insertBefore(i,t.firstChild):t.appendChild(i),i.styleSheet?i.styleSheet.cssText=r:i.appendChild(document.createTextNode(r))}T('.ck .ck-widget .ck-widget__type-around__button{display:block;overflow:hidden;position:absolute;z-index:var(--ck-z-default)}.ck .ck-widget .ck-widget__type-around__button svg{left:50%;position:absolute;top:50%;z-index:calc(var(--ck-z-default) + 2)}.ck .ck-widget .ck-widget__type-around__button.ck-widget__type-around__button_before{left:min(10%,30px);top:calc(var(--ck-widget-outline-thickness)*-.5);transform:translateY(-50%)}.ck .ck-widget .ck-widget__type-around__button.ck-widget__type-around__button_after{bottom:calc(var(--ck-widget-outline-thickness)*-.5);right:min(10%,30px);transform:translateY(50%)}.ck .ck-widget.ck-widget_selected>.ck-widget__type-around>.ck-widget__type-around__button:after,.ck .ck-widget>.ck-widget__type-around>.ck-widget__type-around__button:hover:after{content:"";display:block;left:1px;position:absolute;top:1px;z-index:calc(var(--ck-z-default) + 1)}.ck .ck-widget>.ck-widget__type-around>.ck-widget__type-around__fake-caret{display:none;left:0;position:absolute;right:0}.ck .ck-widget:hover>.ck-widget__type-around>.ck-widget__type-around__fake-caret{left:calc(var(--ck-widget-outline-thickness)*-1);right:calc(var(--ck-widget-outline-thickness)*-1)}.ck .ck-widget.ck-widget_type-around_show-fake-caret_before>.ck-widget__type-around>.ck-widget__type-around__fake-caret{display:block;top:calc(var(--ck-widget-outline-thickness)*-1 - 1px)}.ck .ck-widget.ck-widget_type-around_show-fake-caret_after>.ck-widget__type-around>.ck-widget__type-around__fake-caret{bottom:calc(var(--ck-widget-outline-thickness)*-1 - 1px);display:block}.ck.ck-editor__editable.ck-read-only .ck-widget__type-around,.ck.ck-editor__editable.ck-restricted-editing_mode_restricted .ck-widget__type-around,.ck.ck-editor__editable.ck-widget__type-around_disabled .ck-widget__type-around{display:none}:root{--ck-widget-type-around-button-size:20px;--ck-color-widget-type-around-button-active:var(--ck-color-focus-border);--ck-color-widget-type-around-button-hover:var(--ck-color-widget-hover-border);--ck-color-widget-type-around-button-blurred-editable:var(--ck-color-widget-blurred-border);--ck-color-widget-type-around-button-radar-start-alpha:0;--ck-color-widget-type-around-button-radar-end-alpha:.3;--ck-color-widget-type-around-button-icon:var(--ck-color-base-background)}.ck .ck-widget .ck-widget__type-around__button{background:var(--ck-color-widget-type-around-button);border-radius:100px;height:var(--ck-widget-type-around-button-size);opacity:0;pointer-events:none;transition:opacity var(--ck-widget-handler-animation-duration) var(--ck-widget-handler-animation-curve),background var(--ck-widget-handler-animation-duration) var(--ck-widget-handler-animation-curve);width:var(--ck-widget-type-around-button-size)}@media (prefers-reduced-motion:reduce){.ck .ck-widget .ck-widget__type-around__button{transition:none}}.ck .ck-widget .ck-widget__type-around__button svg{height:8px;margin-top:1px;transform:translate(-50%,-50%);transition:transform .5s ease;width:10px}@media (prefers-reduced-motion:reduce){.ck .ck-widget .ck-widget__type-around__button svg{transition:none}}.ck .ck-widget .ck-widget__type-around__button svg *{stroke-dasharray:10;stroke-dashoffset:0;fill:none;stroke:var(--ck-color-widget-type-around-button-icon);stroke-width:1.5px;stroke-linecap:round;stroke-linejoin:round}.ck .ck-widget .ck-widget__type-around__button svg line{stroke-dasharray:7}.ck .ck-widget .ck-widget__type-around__button:hover{animation:ck-widget-type-around-button-sonar 1s ease infinite}.ck .ck-widget .ck-widget__type-around__button:hover svg polyline{animation:ck-widget-type-around-arrow-dash 2s linear}.ck .ck-widget .ck-widget__type-around__button:hover svg line{animation:ck-widget-type-around-arrow-tip-dash 2s linear}@media (prefers-reduced-motion:reduce){.ck .ck-widget .ck-widget__type-around__button:hover,.ck .ck-widget .ck-widget__type-around__button:hover svg line,.ck .ck-widget .ck-widget__type-around__button:hover svg polyline{animation:none}}.ck .ck-widget.ck-widget_selected>.ck-widget__type-around>.ck-widget__type-around__button,.ck .ck-widget:hover>.ck-widget__type-around>.ck-widget__type-around__button{opacity:1;pointer-events:auto}.ck .ck-widget:not(.ck-widget_selected)>.ck-widget__type-around>.ck-widget__type-around__button{background:var(--ck-color-widget-type-around-button-hover)}.ck .ck-widget.ck-widget_selected>.ck-widget__type-around>.ck-widget__type-around__button,.ck .ck-widget>.ck-widget__type-around>.ck-widget__type-around__button:hover{background:var(--ck-color-widget-type-around-button-active)}.ck .ck-widget.ck-widget_selected>.ck-widget__type-around>.ck-widget__type-around__button:after,.ck .ck-widget>.ck-widget__type-around>.ck-widget__type-around__button:hover:after{background:linear-gradient(135deg,hsla(0,0%,100%,0),hsla(0,0%,100%,.3));border-radius:100px;height:calc(var(--ck-widget-type-around-button-size) - 2px);width:calc(var(--ck-widget-type-around-button-size) - 2px)}.ck .ck-widget.ck-widget_with-selection-handle>.ck-widget__type-around>.ck-widget__type-around__button_before{margin-left:20px}.ck .ck-widget .ck-widget__type-around__fake-caret{animation:ck-widget-type-around-fake-caret-pulse 1s linear infinite normal forwards;background:var(--ck-color-base-text);height:1px;outline:1px solid hsla(0,0%,100%,.5);pointer-events:none}.ck .ck-widget.ck-widget_selected.ck-widget_type-around_show-fake-caret_after,.ck .ck-widget.ck-widget_selected.ck-widget_type-around_show-fake-caret_before{outline-color:transparent}.ck .ck-widget.ck-widget_type-around_show-fake-caret_after.ck-widget_selected:hover,.ck .ck-widget.ck-widget_type-around_show-fake-caret_before.ck-widget_selected:hover{outline-color:var(--ck-color-widget-hover-border)}.ck .ck-widget.ck-widget_type-around_show-fake-caret_after>.ck-widget__type-around>.ck-widget__type-around__button,.ck .ck-widget.ck-widget_type-around_show-fake-caret_before>.ck-widget__type-around>.ck-widget__type-around__button{opacity:0;pointer-events:none}.ck .ck-widget.ck-widget_type-around_show-fake-caret_after.ck-widget_selected.ck-widget_with-resizer>.ck-widget__resizer,.ck .ck-widget.ck-widget_type-around_show-fake-caret_after.ck-widget_with-selection-handle.ck-widget_selected:hover>.ck-widget__selection-handle,.ck .ck-widget.ck-widget_type-around_show-fake-caret_after.ck-widget_with-selection-handle.ck-widget_selected>.ck-widget__selection-handle,.ck .ck-widget.ck-widget_type-around_show-fake-caret_before.ck-widget_selected.ck-widget_with-resizer>.ck-widget__resizer,.ck .ck-widget.ck-widget_type-around_show-fake-caret_before.ck-widget_with-selection-handle.ck-widget_selected:hover>.ck-widget__selection-handle,.ck .ck-widget.ck-widget_type-around_show-fake-caret_before.ck-widget_with-selection-handle.ck-widget_selected>.ck-widget__selection-handle{opacity:0}.ck[dir=rtl] .ck-widget.ck-widget_with-selection-handle .ck-widget__type-around>.ck-widget__type-around__button_before{margin-left:0;margin-right:20px}.ck-editor__nested-editable.ck-editor__editable_selected .ck-widget.ck-widget_selected>.ck-widget__type-around>.ck-widget__type-around__button,.ck-editor__nested-editable.ck-editor__editable_selected .ck-widget:hover>.ck-widget__type-around>.ck-widget__type-around__button{opacity:0;pointer-events:none}.ck-editor__editable.ck-blurred .ck-widget.ck-widget_selected>.ck-widget__type-around>.ck-widget__type-around__button:not(:hover){background:var(--ck-color-widget-type-around-button-blurred-editable)}.ck-editor__editable.ck-blurred .ck-widget.ck-widget_selected>.ck-widget__type-around>.ck-widget__type-around__button:not(:hover) svg *{stroke:#999}@keyframes ck-widget-type-around-arrow-dash{0%{stroke-dashoffset:10}20%,to{stroke-dashoffset:0}}@keyframes ck-widget-type-around-arrow-tip-dash{0%,20%{stroke-dashoffset:7}40%,to{stroke-dashoffset:0}}@keyframes ck-widget-type-around-button-sonar{0%{box-shadow:0 0 0 0 hsla(var(--ck-color-focus-border-coordinates),var(--ck-color-widget-type-around-button-radar-start-alpha))}50%{box-shadow:0 0 0 5px hsla(var(--ck-color-focus-border-coordinates),var(--ck-color-widget-type-around-button-radar-end-alpha))}to{box-shadow:0 0 0 5px hsla(var(--ck-color-focus-border-coordinates),var(--ck-color-widget-type-around-button-radar-start-alpha))}}@keyframes ck-widget-type-around-fake-caret-pulse{0%{opacity:1}49%{opacity:1}50%{opacity:0}99%{opacity:0}to{opacity:1}}');/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/const L=["before","after"],Pe=new DOMParser().parseFromString(Se,"image/svg+xml").firstChild,B="ck-widget__type-around_disabled";class K extends v{constructor(){super(...arguments),this._currentFakeCaretModelElement=null}static get pluginName(){return"WidgetTypeAround"}static get isOfficialPlugin(){return!0}static get requires(){return[ae,A]}init(){const e=this.editor,t=e.editing.view;this.on("change:isEnabled",(i,o,n)=>{t.change(s=>{for(const c of t.document.roots)n?s.removeClass(B,c):s.addClass(B,c)}),n||e.model.change(s=>{s.removeSelectionAttribute(w)})}),this._enableTypeAroundUIInjection(),this._enableInsertingParagraphsOnButtonClick(),this._enableInsertingParagraphsOnEnterKeypress(),this._enableInsertingParagraphsOnTypingKeystroke(),this._enableTypeAroundFakeCaretActivationUsingKeyboardArrows(),this._enableDeleteIntegration(),this._enableInsertContentIntegration(),this._enableInsertObjectIntegration(),this._enableDeleteContentIntegration()}destroy(){super.destroy(),this._currentFakeCaretModelElement=null}_insertParagraph(e,t){const i=this.editor,o=i.editing.view,n=i.model.schema.getAttributesWithProperty(e,"copyOnReplace",!0);i.execute("insertParagraph",{position:i.model.createPositionAt(e,t),attributes:n}),o.focus(),o.scrollToTheSelection()}_listenToIfEnabled(e,t,i,o){this.listenTo(e,t,(...n)=>{this.isEnabled&&i(...n)},o)}_insertParagraphAccordingToFakeCaretPosition(){const i=this.editor.model.document.selection,o=p(i);if(!o)return!1;const n=i.getSelectedElement();return this._insertParagraph(n,o),!0}_enableTypeAroundUIInjection(){const e=this.editor,t=e.model.schema,i=e.locale.t,o={before:i("Insert paragraph before block"),after:i("Insert paragraph after block")};e.editing.downcastDispatcher.on("insert",(n,s,c)=>{const d=c.mapper.toViewElement(s.item);d&&m(d,s.item,t)&&(Ce(c.writer,o,d),d.getCustomProperty("widgetLabel").push(()=>this.isEnabled?i("Press Enter to type after or press Shift + Enter to type before the widget"):""))},{priority:"low"})}_enableTypeAroundFakeCaretActivationUsingKeyboardArrows(){const e=this.editor,t=e.model,i=t.document.selection,o=t.schema,n=e.editing.view;this._listenToIfEnabled(n.document,"arrowKey",(c,d)=>{this._handleArrowKeyPress(c,d)},{context:[_,"$text"],priority:"high"}),this._listenToIfEnabled(i,"change:range",(c,d)=>{d.directChange&&e.model.change(a=>{a.removeSelectionAttribute(w)})}),this._listenToIfEnabled(t.document,"change:data",()=>{const c=i.getSelectedElement();if(c){const d=e.editing.mapper.toViewElement(c);if(m(d,c,o))return}e.model.change(d=>{d.removeSelectionAttribute(w)})}),this._listenToIfEnabled(e.editing.downcastDispatcher,"selection",(c,d,a)=>{const l=a.writer;if(this._currentFakeCaretModelElement){const k=a.mapper.toViewElement(this._currentFakeCaretModelElement);k&&(l.removeClass(L.map(s),k),this._currentFakeCaretModelElement=null)}const h=d.selection.getSelectedElement();if(!h)return;const u=a.mapper.toViewElement(h);if(!m(u,h,o))return;const g=p(d.selection);g&&(l.addClass(s(g),u),this._currentFakeCaretModelElement=h)}),this._listenToIfEnabled(e.ui.focusTracker,"change:isFocused",(c,d,a)=>{a||e.model.change(l=>{l.removeSelectionAttribute(w)})});function s(c){return`ck-widget_type-around_show-fake-caret_${c}`}}_handleArrowKeyPress(e,t){const i=this.editor,o=i.model,n=o.document.selection,s=o.schema,c=i.editing.view,d=t.keyCode,a=Q(d,i.locale.contentLanguageDirection),l=c.document.selection.getSelectedElement(),h=i.editing.mapper.toModelElement(l);let u;m(l,h,s)?u=this._handleArrowKeyPressOnSelectedWidget(a):n.isCollapsed?u=this._handleArrowKeyPressWhenSelectionNextToAWidget(a):t.shiftKey||(u=this._handleArrowKeyPressWhenNonCollapsedSelection(a)),u&&(t.preventDefault(),e.stop())}_handleArrowKeyPressOnSelectedWidget(e){const i=this.editor.model,o=i.document.selection,n=p(o);return i.change(s=>{if(n){if(!(n===(e?"after":"before")))return s.removeSelectionAttribute(w),!0}else return s.setSelectionAttribute(w,e?"after":"before"),!0;return!1})}_handleArrowKeyPressWhenSelectionNextToAWidget(e){const t=this.editor,i=t.model,o=i.schema,n=t.plugins.get("Widget"),s=n._getObjectElementNextToSelection(e),c=t.editing.mapper.toViewElement(s);return m(c,s,o)?(i.change(d=>{n._setSelectionOverElement(s),d.setSelectionAttribute(w,e?"before":"after")}),!0):!1}_handleArrowKeyPressWhenNonCollapsedSelection(e){const t=this.editor,i=t.model,o=i.schema,n=t.editing.mapper,s=i.document.selection,c=e?s.getLastPosition().nodeBefore:s.getFirstPosition().nodeAfter,d=n.toViewElement(c);return m(d,c,o)?(i.change(a=>{a.setSelection(c,"on"),a.setSelectionAttribute(w,e?"after":"before")}),!0):!1}_enableInsertingParagraphsOnButtonClick(){const e=this.editor,t=e.editing.view;this._listenToIfEnabled(t.document,"mousedown",(i,o)=>{const n=ye(o.domTarget);if(!n)return;const s=ze(n),c=Ee(n,t.domConverter),d=e.editing.mapper.toModelElement(c);this._insertParagraph(d,s),o.preventDefault(),i.stop()})}_enableInsertingParagraphsOnEnterKeypress(){const e=this.editor,t=e.model.document.selection,i=e.editing.view;this._listenToIfEnabled(i.document,"enter",(o,n)=>{if(o.eventPhase!="atTarget")return;const s=t.getSelectedElement(),c=e.editing.mapper.toViewElement(s),d=e.model.schema;let a;this._insertParagraphAccordingToFakeCaretPosition()?a=!0:m(c,s,d)&&(this._insertParagraph(s,n.isSoft?"before":"after"),a=!0),a&&(n.preventDefault(),o.stop())},{context:_})}_enableInsertingParagraphsOnTypingKeystroke(){const t=this.editor.editing.view.document;this._listenToIfEnabled(t,"insertText",(i,o)=>{this._insertParagraphAccordingToFakeCaretPosition()&&(o.selection=t.selection)},{priority:"high"}),H.isAndroid?this._listenToIfEnabled(t,"keydown",(i,o)=>{o.keyCode==229&&this._insertParagraphAccordingToFakeCaretPosition()}):this._listenToIfEnabled(t,"compositionstart",()=>{this._insertParagraphAccordingToFakeCaretPosition()},{priority:"high"})}_enableDeleteIntegration(){const e=this.editor,t=e.editing.view,i=e.model,o=i.schema;this._listenToIfEnabled(t.document,"delete",(n,s)=>{if(n.eventPhase!="atTarget")return;const c=p(i.document.selection);if(!c)return;const d=s.direction,a=i.document.selection.getSelectedElement(),l=c==="before",h=d=="forward";if(l===h)e.execute("delete",{selection:i.createSelection(a,"on")});else{const g=o.getNearestSelectionRange(i.createPositionAt(a,c),d);if(g)if(!g.isCollapsed)i.change(k=>{k.setSelection(g),e.execute(h?"deleteForward":"delete")});else{const k=i.createSelection(g.start);if(i.modifySelection(k,{direction:d}),!k.focus.isEqual(g.start))i.change(b=>{b.setSelection(g),e.execute(h?"deleteForward":"delete")});else{const b=Ae(o,g.start.parent);i.deleteContent(i.createSelection(b,"on"),{doNotAutoparagraph:!0})}}}s.preventDefault(),n.stop()},{context:_})}_enableInsertContentIntegration(){const e=this.editor,t=this.editor.model,i=t.document.selection;this._listenToIfEnabled(e.model,"insertContent",(o,[n,s])=>{if(s&&!s.is("documentSelection"))return;const c=p(i);if(c)return o.stop(),t.change(d=>{const a=i.getSelectedElement(),l=t.createPositionAt(a,c),h=d.createSelection(l),u=t.insertContent(n,h);return d.setSelection(h),u})},{priority:"high"})}_enableInsertObjectIntegration(){const e=this.editor,i=this.editor.model.document.selection;this._listenToIfEnabled(e.model,"insertObject",(o,n)=>{const[,s,c={}]=n;if(s&&!s.is("documentSelection"))return;const d=p(i);d&&(c.findOptimalPosition=d,n[3]=c)},{priority:"high"})}_enableDeleteContentIntegration(){const e=this.editor,i=this.editor.model.document.selection;this._listenToIfEnabled(e.model,"deleteContent",(o,[n])=>{if(n&&!n.is("documentSelection"))return;p(i)&&o.stop()},{priority:"high"})}}function Ce(r,e,t){const i=r.createUIElement("div",{class:"ck ck-reset_all ck-widget__type-around"},function(o){const n=this.toDomElement(o);return Te(n,e),xe(n),n});r.insert(r.createPositionAt(t,"end"),i)}function Te(r,e){for(const t of L){const i=new E({tag:"div",attributes:{class:["ck","ck-widget__type-around__button",`ck-widget__type-around__button_${t}`],title:e[t],"aria-hidden":"true"},children:[r.ownerDocument.importNode(Pe,!0)]});r.appendChild(i.render())}}function xe(r){const e=new E({tag:"div",attributes:{class:["ck","ck-widget__type-around__fake-caret"]}});r.appendChild(e.render())}function Ae(r,e){let t=e;for(const i of e.getAncestors({parentFirst:!0})){if(i.childCount>1||r.isLimit(i))break;t=i}return t}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/function Re(r){const e=r.model;return(t,i)=>{const o=i.keyCode==z.arrowup,n=i.keyCode==z.arrowdown,s=i.shiftKey,c=e.document.selection;if(!o&&!n)return;const d=n;if(s&&Ve(c,d))return;const a=We(r,c,d);if(a){if(a.isCollapsed){if(c.isCollapsed)return;if(s)return}(a.isCollapsed||He(r,a,d))&&(e.change(l=>{const h=d?a.end:a.start;if(s){const u=e.createSelection(c.anchor);u.setFocus(h),l.setSelection(u)}else l.setSelection(h)}),t.stop(),i.preventDefault(),i.stopPropagation())}}}function We(r,e,t){const i=r.model;if(t){const o=e.isCollapsed?e.focus:e.getLastPosition(),n=j(i,o,"forward");if(!n)return null;const s=i.createRange(o,n),c=$(i.schema,s,"backward");return c?i.createRange(o,c):null}else{const o=e.isCollapsed?e.focus:e.getFirstPosition(),n=j(i,o,"backward");if(!n)return null;const s=i.createRange(n,o),c=$(i.schema,s,"forward");return c?i.createRange(c,o):null}}function j(r,e,t){const i=r.schema,o=r.createRangeIn(e.root),n=t=="forward"?"elementStart":"elementEnd";for(const{previousPosition:s,item:c,type:d}of o.getWalker({startPosition:e,direction:t})){if(i.isLimit(c)&&!i.isInline(c))return s;if(d==n&&i.isBlock(c))return null}return null}function $(r,e,t){const i=t=="backward"?e.end:e.start;if(r.checkChild(i,"$text"))return i;for(const{nextPosition:o}of e.getWalker({direction:t}))if(r.checkChild(o,"$text"))return o;return null}function He(r,e,t){const i=r.model,o=r.view.domConverter;if(t){const a=i.createSelection(e.start);i.modifySelection(a),!a.focus.isAtEnd&&!e.start.isEqual(a.focus)&&(e=i.createRange(a.focus,e.end))}const n=r.mapper.toViewRange(e),s=o.viewRangeToDom(n),c=f.getDomRangeRects(s);let d;for(const a of c){if(d===void 0){d=Math.round(a.bottom);continue}if(Math.round(a.top)>=d)return!1;d=Math.max(d,Math.round(a.bottom))}return!0}function Ve(r,e){return!r.isCollapsed&&r.isBackward==e}T(":root{--ck-color-resizer:var(--ck-color-focus-border);--ck-color-resizer-tooltip-background:#262626;--ck-color-resizer-tooltip-text:#f2f2f2;--ck-resizer-border-radius:var(--ck-border-radius);--ck-resizer-tooltip-offset:10px;--ck-resizer-tooltip-height:calc(var(--ck-spacing-small)*2 + 10px)}.ck .ck-widget,.ck .ck-widget.ck-widget_with-selection-handle{position:relative}.ck .ck-widget.ck-widget_with-selection-handle .ck-widget__selection-handle{position:absolute}.ck .ck-widget.ck-widget_with-selection-handle .ck-widget__selection-handle .ck-icon{display:block}.ck .ck-widget.ck-widget_with-selection-handle.ck-widget_selected>.ck-widget__selection-handle,.ck .ck-widget.ck-widget_with-selection-handle:hover>.ck-widget__selection-handle{visibility:visible}.ck .ck-size-view{background:var(--ck-color-resizer-tooltip-background);border:1px solid var(--ck-color-resizer-tooltip-text);border-radius:var(--ck-resizer-border-radius);color:var(--ck-color-resizer-tooltip-text);display:block;font-size:var(--ck-font-size-tiny);height:var(--ck-resizer-tooltip-height);line-height:var(--ck-resizer-tooltip-height);padding:0 var(--ck-spacing-small)}.ck .ck-size-view.ck-orientation-above-center,.ck .ck-size-view.ck-orientation-bottom-left,.ck .ck-size-view.ck-orientation-bottom-right,.ck .ck-size-view.ck-orientation-top-left,.ck .ck-size-view.ck-orientation-top-right{position:absolute}.ck .ck-size-view.ck-orientation-top-left{left:var(--ck-resizer-tooltip-offset);top:var(--ck-resizer-tooltip-offset)}.ck .ck-size-view.ck-orientation-top-right{right:var(--ck-resizer-tooltip-offset);top:var(--ck-resizer-tooltip-offset)}.ck .ck-size-view.ck-orientation-bottom-right{bottom:var(--ck-resizer-tooltip-offset);right:var(--ck-resizer-tooltip-offset)}.ck .ck-size-view.ck-orientation-bottom-left{bottom:var(--ck-resizer-tooltip-offset);left:var(--ck-resizer-tooltip-offset)}.ck .ck-size-view.ck-orientation-above-center{left:50%;top:calc(var(--ck-resizer-tooltip-height)*-1);transform:translate(-50%)}:root{--ck-widget-outline-thickness:3px;--ck-widget-handler-icon-size:16px;--ck-widget-handler-animation-duration:200ms;--ck-widget-handler-animation-curve:ease;--ck-color-widget-blurred-border:#dedede;--ck-color-widget-hover-border:#ffc83d;--ck-color-widget-editable-focus-background:var(--ck-color-base-background);--ck-color-widget-drag-handler-icon-color:var(--ck-color-base-background)}.ck .ck-widget{outline-color:transparent;outline-style:solid;outline-width:var(--ck-widget-outline-thickness);transition:outline-color var(--ck-widget-handler-animation-duration) var(--ck-widget-handler-animation-curve)}@media (prefers-reduced-motion:reduce){.ck .ck-widget{transition:none}}.ck .ck-widget.ck-widget_selected,.ck .ck-widget.ck-widget_selected:hover{outline:var(--ck-widget-outline-thickness) solid var(--ck-color-focus-border)}.ck .ck-widget:hover{outline-color:var(--ck-color-widget-hover-border)}.ck .ck-editor__nested-editable{border:1px solid transparent}.ck .ck-editor__nested-editable.ck-editor__nested-editable_focused,.ck .ck-editor__nested-editable:focus{box-shadow:var(--ck-inner-shadow),0 0}@media (forced-colors:none){.ck .ck-editor__nested-editable.ck-editor__nested-editable_focused,.ck .ck-editor__nested-editable:focus{background-color:var(--ck-color-widget-editable-focus-background)}}.ck .ck-editor__nested-editable.ck-editor__nested-editable_focused:not(td,th),.ck .ck-editor__nested-editable:focus:not(td,th){border:var(--ck-focus-ring);outline:none}.ck .ck-widget.ck-widget_with-selection-handle .ck-widget__selection-handle{background-color:transparent;border-radius:var(--ck-border-radius) var(--ck-border-radius) 0 0;box-sizing:border-box;left:calc(0px - var(--ck-widget-outline-thickness));opacity:0;padding:4px;top:0;transform:translateY(-100%);transition:background-color var(--ck-widget-handler-animation-duration) var(--ck-widget-handler-animation-curve),visibility var(--ck-widget-handler-animation-duration) var(--ck-widget-handler-animation-curve),opacity var(--ck-widget-handler-animation-duration) var(--ck-widget-handler-animation-curve)}@media (prefers-reduced-motion:reduce){.ck .ck-widget.ck-widget_with-selection-handle .ck-widget__selection-handle{transition:none}}.ck .ck-widget.ck-widget_with-selection-handle .ck-widget__selection-handle .ck-icon{color:var(--ck-color-widget-drag-handler-icon-color);height:var(--ck-widget-handler-icon-size);width:var(--ck-widget-handler-icon-size)}.ck .ck-widget.ck-widget_with-selection-handle .ck-widget__selection-handle .ck-icon .ck-icon__selected-indicator{opacity:0;transition:opacity .3s var(--ck-widget-handler-animation-curve)}@media (prefers-reduced-motion:reduce){.ck .ck-widget.ck-widget_with-selection-handle .ck-widget__selection-handle .ck-icon .ck-icon__selected-indicator{transition:none}}.ck .ck-widget.ck-widget_with-selection-handle .ck-widget__selection-handle:hover .ck-icon .ck-icon__selected-indicator{opacity:1}.ck .ck-widget.ck-widget_with-selection-handle:hover>.ck-widget__selection-handle{background-color:var(--ck-color-widget-hover-border);opacity:1}.ck .ck-widget.ck-widget_with-selection-handle.ck-widget_selected:hover>.ck-widget__selection-handle,.ck .ck-widget.ck-widget_with-selection-handle.ck-widget_selected>.ck-widget__selection-handle{background-color:var(--ck-color-focus-border);opacity:1}.ck .ck-widget.ck-widget_with-selection-handle.ck-widget_selected:hover>.ck-widget__selection-handle .ck-icon .ck-icon__selected-indicator,.ck .ck-widget.ck-widget_with-selection-handle.ck-widget_selected>.ck-widget__selection-handle .ck-icon .ck-icon__selected-indicator{opacity:1}.ck[dir=rtl] .ck-widget.ck-widget_with-selection-handle .ck-widget__selection-handle{left:auto;right:calc(0px - var(--ck-widget-outline-thickness))}.ck.ck-editor__editable.ck-read-only .ck-widget{transition:none}.ck.ck-editor__editable.ck-read-only .ck-widget:not(.ck-widget_selected){--ck-widget-outline-thickness:0px}.ck.ck-editor__editable.ck-read-only .ck-widget.ck-widget_with-selection-handle .ck-widget__selection-handle,.ck.ck-editor__editable.ck-read-only .ck-widget.ck-widget_with-selection-handle .ck-widget__selection-handle:hover{background:var(--ck-color-widget-blurred-border)}.ck.ck-editor__editable.ck-blurred .ck-widget.ck-widget_selected,.ck.ck-editor__editable.ck-blurred .ck-widget.ck-widget_selected:hover{outline-color:var(--ck-color-widget-blurred-border)}.ck.ck-editor__editable.ck-blurred .ck-widget.ck-widget_selected.ck-widget_with-selection-handle:hover>.ck-widget__selection-handle,.ck.ck-editor__editable.ck-blurred .ck-widget.ck-widget_selected.ck-widget_with-selection-handle:hover>.ck-widget__selection-handle:hover,.ck.ck-editor__editable.ck-blurred .ck-widget.ck-widget_selected.ck-widget_with-selection-handle>.ck-widget__selection-handle,.ck.ck-editor__editable.ck-blurred .ck-widget.ck-widget_selected.ck-widget_with-selection-handle>.ck-widget__selection-handle:hover{background:var(--ck-color-widget-blurred-border)}.ck.ck-editor__editable blockquote>.ck-widget.ck-widget_with-selection-handle:first-child,.ck.ck-editor__editable>.ck-widget.ck-widget_with-selection-handle:first-child{margin-top:calc(1em + var(--ck-widget-handler-icon-size))}");/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class De extends v{constructor(){super(...arguments),this._previouslySelected=new Set}static get pluginName(){return"Widget"}static get isOfficialPlugin(){return!0}static get requires(){return[K,A]}init(){const e=this.editor,t=e.editing.view,i=t.document,o=e.t;this.editor.editing.downcastDispatcher.on("selection",(n,s,c)=>{const d=c.writer,a=s.selection;if(a.isCollapsed)return;const l=a.getSelectedElement();if(!l)return;const h=e.editing.mapper.toViewElement(l);_(h)&&c.consumable.consume(a,"selection")&&d.setSelection(d.createRangeOn(h),{fake:!0,label:O(h)})}),this.editor.editing.downcastDispatcher.on("selection",(n,s,c)=>{this._clearPreviouslySelectedWidgets(c.writer);const d=c.writer,a=d.document.selection;let l=null;for(const h of a.getRanges())for(const u of h){const g=u.item;_(g)&&!Oe(g,l)&&(d.addClass(P,g),this._previouslySelected.add(g),l=g)}},{priority:"low"}),t.addObserver(x),this.listenTo(i,"mousedown",(...n)=>this._onMousedown(...n)),this.listenTo(i,"arrowKey",(...n)=>{this._handleSelectionChangeOnArrowKeyPress(...n)},{context:[_,"$text"]}),this.listenTo(i,"arrowKey",(...n)=>{this._preventDefaultOnArrowKeyPress(...n)},{context:"$root"}),this.listenTo(i,"arrowKey",Re(this.editor.editing),{context:"$text"}),this.listenTo(i,"delete",(n,s)=>{this._handleDelete(s.direction=="forward")&&(s.preventDefault(),n.stop())},{context:"$root"}),this.listenTo(i,"tab",(n,s)=>{n.eventPhase=="atTarget"&&(s.shiftKey||this._selectFirstNestedEditable()&&(s.preventDefault(),n.stop()))},{context:_,priority:"low"}),this.listenTo(i,"tab",(n,s)=>{s.shiftKey&&this._selectAncestorWidget()&&(s.preventDefault(),n.stop())},{priority:"low"}),this.listenTo(i,"keydown",(n,s)=>{s.keystroke==z.esc&&this._selectAncestorWidget()&&(s.preventDefault(),n.stop())},{priority:"low"}),e.accessibility.addKeystrokeInfoGroup({id:"widget",label:o("Keystrokes that can be used when a widget is selected (for example: image, table, etc.)"),keystrokes:[{label:o("Move focus from an editable area back to the parent widget"),keystroke:"Esc"},{label:o("Insert a new paragraph directly after a widget"),keystroke:"Enter"},{label:o("Insert a new paragraph directly before a widget"),keystroke:"Shift+Enter"},{label:o("Move the caret to allow typing directly before a widget"),keystroke:[["arrowup"],["arrowleft"]]},{label:o("Move the caret to allow typing directly after a widget"),keystroke:[["arrowdown"],["arrowright"]]}]})}_onMousedown(e,t){const i=this.editor,o=i.editing.view,n=o.document;let s=t.target;if(!s)return;if(t.domEvent.detail>=3){this._selectBlockContent(s)&&t.preventDefault();return}if(!_(s)){const d=Ie(s);if(!d)return;if(_(d))s=d;else{const a=Me(o,t);if(a&&_(a))s=a;else return}}H.isAndroid&&t.preventDefault(),n.isFocused||o.focus();const c=i.editing.mapper.toModelElement(s);this._setSelectionOverElement(c)}_selectBlockContent(e){const t=this.editor,i=t.model,o=t.editing.mapper,n=i.schema,s=o.findMappedViewAncestor(this.editor.editing.view.createPositionAt(e,0)),c=Fe(o.toModelElement(s),i.schema);return c?(i.change(d=>{const a=n.isLimit(c)?null:Ne(d.createPositionAfter(c),n),l=d.createPositionAt(c,0),h=a?d.createPositionAt(a,0):d.createPositionAt(c,"end");d.setSelection(d.createRange(l,h))}),!0):!1}_handleSelectionChangeOnArrowKeyPress(e,t){const i=t.keyCode,o=this.editor.model,n=o.schema,s=o.document.selection,c=s.getSelectedElement(),d=Z(i,this.editor.locale.contentLanguageDirection),a=d=="down"||d=="right",l=d=="up"||d=="down";if(c&&n.isObject(c)){const u=a?s.getLastPosition():s.getFirstPosition(),g=n.getNearestSelectionRange(u,a?"forward":"backward");g&&(o.change(k=>{k.setSelection(g)}),t.preventDefault(),e.stop());return}if(!s.isCollapsed&&!t.shiftKey){const u=s.getFirstPosition(),g=s.getLastPosition(),k=u.nodeAfter,b=g.nodeBefore;(k&&n.isObject(k)||b&&n.isObject(b))&&(o.change(G=>{G.setSelection(a?g:u)}),t.preventDefault(),e.stop());return}if(!s.isCollapsed)return;const h=this._getObjectElementNextToSelection(a);if(h&&n.isObject(h)){if(n.isInline(h)&&l)return;this._setSelectionOverElement(h),t.preventDefault(),e.stop()}}_preventDefaultOnArrowKeyPress(e,t){const i=this.editor.model,o=i.schema,n=i.document.selection.getSelectedElement();n&&o.isObject(n)&&(t.preventDefault(),e.stop())}_handleDelete(e){const i=this.editor.model.document.selection;if(!this.editor.model.canEditAt(i)||!i.isCollapsed)return;const o=this._getObjectElementNextToSelection(e);if(o)return this.editor.model.change(n=>{let s=i.anchor.parent;for(;s.isEmpty;){const c=s;s=c.parent,n.remove(c)}this._setSelectionOverElement(o)}),!0}_setSelectionOverElement(e){this.editor.model.change(t=>{t.setSelection(t.createRangeOn(e))})}_getObjectElementNextToSelection(e){const t=this.editor.model,i=t.schema,o=t.document.selection,n=t.createSelection(o);if(t.modifySelection(n,{direction:e?"forward":"backward"}),n.isEqual(o))return null;const s=e?n.focus.nodeBefore:n.focus.nodeAfter;return s&&i.isObject(s)?s:null}_clearPreviouslySelectedWidgets(e){for(const t of this._previouslySelected)e.removeClass(P,t);this._previouslySelected.clear()}_selectFirstNestedEditable(){const e=this.editor,i=this.editor.editing.view.document;for(const o of i.selection.getFirstRange().getItems())if(o.is("editableElement")){const n=e.editing.mapper.toModelElement(o);/* istanbul ignore next -- @preserve */if(!n)continue;const s=e.model.createPositionAt(n,0),c=e.model.schema.getNearestSelectionRange(s,"forward");return e.model.change(d=>{d.setSelection(c)}),!0}return!1}_selectAncestorWidget(){const e=this.editor,t=e.editing.mapper,o=e.editing.view.document.selection.getFirstPosition().parent,s=(o.is("$text")?o.parent:o).findAncestor(_);if(!s)return!1;const c=t.toModelElement(s);/* istanbul ignore next -- @preserve */return c?(e.model.change(d=>{d.setSelection(c,"on")}),!0):!1}}function Ie(r){let e=r;for(;e;){if(e.is("editableElement")||_(e))return e;e=e.parent}return null}function Me(r,e){const t=ee(e.domEvent);let i=null;if(t?i=r.domConverter.domRangeToView(t):i=r.createRange(r.createPositionAt(e.target,0)),!i)return null;const o=i.start;if(!o.parent)return null;let n=o.parent;return o.parent.is("editableElement")&&(o.isAtEnd&&o.nodeBefore?n=o.nodeBefore:o.isAtStart&&o.nodeAfter&&(n=o.nodeAfter)),n.is("$text")?n.parent:n}function Oe(r,e){return e?Array.from(r.getAncestors()).includes(e):!1}function Fe(r,e){for(const t of r.getAncestors({includeSelf:!0,parentFirst:!0})){if(e.checkChild(t,"$text"))return t;if(e.isLimit(t)&&!e.isObject(t))break}return null}function Ne(r,e){const t=new X({startPosition:r});for(const{item:i}of t){if(e.isLimit(i)||!i.is("element"))return null;if(e.checkChild(i,"$text"))return i}return null}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class Le extends v{constructor(){super(...arguments),this._toolbarDefinitions=new Map}static get requires(){return[re]}static get pluginName(){return"WidgetToolbarRepository"}static get isOfficialPlugin(){return!0}init(){const e=this.editor;if(e.plugins.has("BalloonToolbar")){const t=e.plugins.get("BalloonToolbar");this.listenTo(t,"show",i=>{Be(e.editing.view.document.selection)&&i.stop()},{priority:"high"})}this._balloon=this.editor.plugins.get("ContextualBalloon"),this.on("change:isEnabled",()=>{this._updateToolbarsVisibility()}),this.listenTo(e.ui,"update",()=>{this._updateToolbarsVisibility()}),this.listenTo(e.ui.focusTracker,"change:isFocused",()=>{this._updateToolbarsVisibility()},{priority:"low"})}destroy(){super.destroy();for(const e of this._toolbarDefinitions.values())e.view.destroy()}register(e,{ariaLabel:t,items:i,getRelatedElement:o,balloonClassName:n="ck-toolbar-container"}){if(!i.length){te("widget-toolbar-no-items",{toolbarId:e});return}const s=this.editor,c=s.t,d=new se(s.locale);if(d.ariaLabel=t||c("Widget toolbar"),this._toolbarDefinitions.has(e))throw new R("widget-toolbar-duplicated",this,{toolbarId:e});const a={view:d,getRelatedElement:o,balloonClassName:n,itemsConfig:i,initialized:!1};s.ui.addToolbar(d,{isContextual:!0,beforeFocus:()=>{const l=o(s.editing.view.document.selection);l&&this._showToolbar(a,l)},afterBlur:()=>{this._hideToolbar(a)}}),this._toolbarDefinitions.set(e,a)}_updateToolbarsVisibility(){let e=0,t=null,i=null;for(const o of this._toolbarDefinitions.values()){const n=o.getRelatedElement(this.editor.editing.view.document.selection);if(!this.isEnabled||!n)this._isToolbarInBalloon(o)&&this._hideToolbar(o);else if(!this.editor.ui.focusTracker.isFocused)this._isToolbarVisible(o)&&this._hideToolbar(o);else{const s=n.getAncestors().length;s>e&&(e=s,t=n,i=o)}}i&&this._showToolbar(i,t)}_hideToolbar(e){this._balloon.remove(e.view),this.stopListening(this._balloon,"change:visibleView")}_showToolbar(e,t){this._isToolbarVisible(e)?U(this.editor,t):this._isToolbarInBalloon(e)||(e.initialized||(e.initialized=!0,e.view.fillFromConfig(e.itemsConfig,this.editor.ui.componentFactory)),this._balloon.add({view:e.view,position:q(this.editor,t),balloonClassName:e.balloonClassName}),this.listenTo(this._balloon,"change:visibleView",()=>{for(const i of this._toolbarDefinitions.values())if(this._isToolbarVisible(i)){const o=i.getRelatedElement(this.editor.editing.view.document.selection);U(this.editor,o)}}))}_isToolbarVisible(e){return this._balloon.visibleView===e.view}_isToolbarInBalloon(e){return this._balloon.hasView(e.view)}}function U(r,e){const t=r.plugins.get("ContextualBalloon"),i=q(r,e);t.updatePosition(i)}function q(r,e){const t=r.editing.view,i=ce.defaultPositions;return{target:t.domConverter.mapViewToDom(e),positions:[i.northArrowSouth,i.northArrowSouthWest,i.northArrowSouthEast,i.southArrowNorth,i.southArrowNorthWest,i.southArrowNorthEast,i.viewportStickyNorth]}}function Be(r){const e=r.getSelectedElement();return!!(e&&_(e))}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class Ke extends V(){constructor(e){super(),this.set("activeHandlePosition",null),this.set("proposedWidthPercents",null),this.set("proposedWidth",null),this.set("proposedHeight",null),this.set("proposedHandleHostWidth",null),this.set("proposedHandleHostHeight",null),this._options=e,this._referenceCoordinates=null}get originalWidth(){return this._originalWidth}get originalHeight(){return this._originalHeight}get originalWidthPercents(){return this._originalWidthPercents}get aspectRatio(){return this._aspectRatio}begin(e,t,i){const o=new f(t);this.activeHandlePosition=Ue(e),this._referenceCoordinates=je(t,qe(this.activeHandlePosition)),this._originalWidth=o.width,this._originalHeight=o.height,this._aspectRatio=o.width/o.height;const n=i.style.width;n&&n.match(/^\d+(\.\d*)?%$/)?this._originalWidthPercents=parseFloat(n):this._originalWidthPercents=N(i,o)}update(e){this.proposedWidth=e.width,this.proposedHeight=e.height,this.proposedWidthPercents=e.widthPercents,this.proposedHandleHostWidth=e.handleHostWidth,this.proposedHandleHostHeight=e.handleHostHeight}}function je(r,e){const t=new f(r),i=e.split("-"),o={x:i[1]=="right"?t.right:t.left,y:i[0]=="bottom"?t.bottom:t.top};return o.x+=r.ownerDocument.defaultView.scrollX,o.y+=r.ownerDocument.defaultView.scrollY,o}function $e(r){return`ck-widget__resizer__handle-${r}`}function Ue(r){const e=["top-left","top-right","bottom-right","bottom-left"];for(const t of e)if(r.classList.contains($e(t)))return t}function qe(r){const e=r.split("-"),t={top:"bottom",bottom:"top",left:"right",right:"left"};return`${t[e[0]]}-${t[e[1]]}`}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class Ye extends de{constructor(){super();const e=this.bindTemplate;this.setTemplate({tag:"div",attributes:{class:["ck","ck-size-view",e.to("_viewPosition",t=>t?`ck-orientation-${t}`:"")],style:{display:e.if("_isVisible","none",t=>!t)}},children:[{text:e.to("_label")}]})}_bindToState(e,t){this.bind("_isVisible").to(t,"proposedWidth",t,"proposedHeight",(i,o)=>i!==null&&o!==null),this.bind("_label").to(t,"proposedHandleHostWidth",t,"proposedHandleHostHeight",t,"proposedWidthPercents",(i,o,n)=>e.unit==="px"?`${i}\xD7${o}`:`${n}%`),this.bind("_viewPosition").to(t,"activeHandlePosition",t,"proposedHandleHostWidth",t,"proposedHandleHostHeight",(i,o,n)=>o<50||n<50?"above-center":i)}_dismiss(){this.unbind(),this._isVisible=!1}}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class Y extends V(){constructor(e){super(),this._viewResizerWrapper=null,this._options=e,this.set("isEnabled",!0),this.set("isSelected",!1),this.bind("isVisible").to(this,"isEnabled",this,"isSelected",(t,i)=>t&&i),this.decorate("begin"),this.decorate("cancel"),this.decorate("commit"),this.decorate("updateSize"),this.on("commit",t=>{!this.state.proposedWidth&&!this.state.proposedWidthPercents&&(this._cleanup(),t.stop())},{priority:"high"})}get state(){return this._state}show(){this._options.editor.editing.view.change(t=>{t.removeClass("ck-hidden",this._viewResizerWrapper)})}hide(){this._options.editor.editing.view.change(t=>{t.addClass("ck-hidden",this._viewResizerWrapper)})}attach(){const e=this,t=this._options.viewElement;this._options.editor.editing.view.change(o=>{const n=o.createUIElement("div",{class:"ck ck-reset_all ck-widget__resizer"},function(s){const c=this.toDomElement(s);return e._appendHandles(c),e._appendSizeUI(c),c});o.insert(o.createPositionAt(t,"end"),n),o.addClass("ck-widget_with-resizer",t),this._viewResizerWrapper=n,this.isVisible||this.hide()}),this.on("change:isVisible",()=>{this.isVisible?(this.show(),this.redraw()):this.hide()})}begin(e){this._state=new Ke(this._options),this._sizeView._bindToState(this._options,this.state),this._initialViewWidth=this._options.viewElement.getStyle("width"),this.state.begin(e,this._getHandleHost(),this._getResizeHost())}updateSize(e){const t=this._proposeNewSize(e);this._options.editor.editing.view.change(a=>{const l=this._options.unit||"%",h=(l==="%"?t.widthPercents:t.width)+l;a.setStyle("width",h,this._options.viewElement)});const o=this._getHandleHost(),n=new f(o),s=Math.round(n.width),c=Math.round(n.height),d=new f(o);t.width=Math.round(d.width),t.height=Math.round(d.height),this.redraw(n),this.state.update({...t,handleHostWidth:s,handleHostHeight:c})}commit(){const e=this._options.unit||"%",t=(e==="%"?this.state.proposedWidthPercents:this.state.proposedWidth)+e;this._options.editor.editing.view.change(()=>{this._cleanup(),this._options.onCommit(t)})}cancel(){this._cleanup()}destroy(){this.cancel()}redraw(e){const t=this._domResizerWrapper;if(!Je(t))return;const i=t.parentElement,o=this._getHandleHost(),n=this._viewResizerWrapper,s=[n.getStyle("width"),n.getStyle("height"),n.getStyle("left"),n.getStyle("top")];let c;if(i.isSameNode(o)){const d=e||new f(o);c=[d.width+"px",d.height+"px",void 0,void 0]}else c=[o.offsetWidth+"px",o.offsetHeight+"px",o.offsetLeft+"px",o.offsetTop+"px"];ie(s,c)!=="same"&&this._options.editor.editing.view.change(d=>{d.setStyle({width:c[0],height:c[1],left:c[2],top:c[3]},n)})}containsHandle(e){return this._domResizerWrapper.contains(e)}static isResizeHandle(e){return e.classList.contains("ck-widget__resizer__handle")}_cleanup(){this._sizeView._dismiss(),this._options.editor.editing.view.change(t=>{t.setStyle("width",this._initialViewWidth,this._options.viewElement)})}_proposeNewSize(e){const t=this.state,i=Xe(e),o=this._options.isCentered?this._options.isCentered(this):!0,n={x:t._referenceCoordinates.x-(i.x+t.originalWidth),y:i.y-t.originalHeight-t._referenceCoordinates.y};o&&t.activeHandlePosition.endsWith("-right")&&(n.x=i.x-(t._referenceCoordinates.x+t.originalWidth)),o&&(n.x*=2);let s=Math.abs(t.originalWidth+n.x),c=Math.abs(t.originalHeight+n.y);return(s/t.aspectRatio>c?"width":"height")=="width"?c=s/t.aspectRatio:s=c*t.aspectRatio,{width:Math.round(s),height:Math.round(c),widthPercents:Math.min(Math.round(t.originalWidthPercents/t.originalWidth*s*100)/100,100)}}_getResizeHost(){const e=this._domResizerWrapper.parentElement;return this._options.getResizeHost(e)}_getHandleHost(){const e=this._domResizerWrapper.parentElement;return this._options.getHandleHost(e)}get _domResizerWrapper(){return this._options.editor.editing.view.domConverter.mapViewToDom(this._viewResizerWrapper)}_appendHandles(e){const t=["top-left","top-right","bottom-right","bottom-left"];for(const i of t)e.appendChild(new E({tag:"div",attributes:{class:`ck-widget__resizer__handle ${Ge(i)}`}}).render())}_appendSizeUI(e){this._sizeView=new Ye,this._sizeView.render(),e.appendChild(this._sizeView.element)}}function Ge(r){return`ck-widget__resizer__handle-${r}`}function Xe(r){return{x:r.pageX,y:r.pageY}}function Je(r){return r&&r.ownerDocument&&r.ownerDocument.contains(r)}T(".ck .ck-widget_with-resizer{position:relative}.ck .ck-widget__resizer{display:none;left:0;pointer-events:none;position:absolute;top:0}.ck-focused .ck-widget_with-resizer.ck-widget_selected>.ck-widget__resizer{display:block}.ck .ck-widget__resizer__handle{pointer-events:all;position:absolute}.ck .ck-widget__resizer__handle.ck-widget__resizer__handle-bottom-right,.ck .ck-widget__resizer__handle.ck-widget__resizer__handle-top-left{cursor:nwse-resize}.ck .ck-widget__resizer__handle.ck-widget__resizer__handle-bottom-left,.ck .ck-widget__resizer__handle.ck-widget__resizer__handle-top-right{cursor:nesw-resize}:root{--ck-resizer-size:10px;--ck-resizer-offset:calc(var(--ck-resizer-size)/-2 - 2px);--ck-resizer-border-width:1px}.ck .ck-widget__resizer{outline:1px solid var(--ck-color-resizer)}.ck .ck-widget__resizer__handle{background:var(--ck-color-focus-border);border:var(--ck-resizer-border-width) solid #fff;border-radius:var(--ck-resizer-border-radius);height:var(--ck-resizer-size);width:var(--ck-resizer-size)}.ck .ck-widget__resizer__handle.ck-widget__resizer__handle-top-left{left:var(--ck-resizer-offset);top:var(--ck-resizer-offset)}.ck .ck-widget__resizer__handle.ck-widget__resizer__handle-top-right{right:var(--ck-resizer-offset);top:var(--ck-resizer-offset)}.ck .ck-widget__resizer__handle.ck-widget__resizer__handle-bottom-right{bottom:var(--ck-resizer-offset);right:var(--ck-resizer-offset)}.ck .ck-widget__resizer__handle.ck-widget__resizer__handle-bottom-left{bottom:var(--ck-resizer-offset);left:var(--ck-resizer-offset)}");/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class Qe extends v{constructor(){super(...arguments),this._resizers=new Map}static get pluginName(){return"WidgetResize"}static get isOfficialPlugin(){return!0}init(){const e=this.editor.editing,t=D.window.document;this.set("selectedResizer",null),this.set("_activeResizer",null),e.view.addObserver(x),this._observer=new(oe()),this.listenTo(e.view.document,"mousedown",this._mouseDownListener.bind(this),{priority:"high"}),this._observer.listenTo(t,"mousemove",this._mouseMoveListener.bind(this)),this._observer.listenTo(t,"mouseup",this._mouseUpListener.bind(this)),this._redrawSelectedResizerThrottled=le(()=>this.redrawSelectedResizer(),200),this.editor.ui.on("update",this._redrawSelectedResizerThrottled),this.editor.model.document.on("change",()=>{for(const[o,n]of this._resizers)o.isAttached()||(this._resizers.delete(o),n.destroy())},{priority:"lowest"}),this._observer.listenTo(D.window,"resize",this._redrawSelectedResizerThrottled);const i=this.editor.editing.view.document.selection;i.on("change",()=>{const o=i.getSelectedElement(),n=this.getResizerByViewElement(o)||null;n?this.select(n):this.deselect()})}redrawSelectedResizer(){this.selectedResizer&&this.selectedResizer.isVisible&&this.selectedResizer.redraw()}destroy(){super.destroy(),this._observer.stopListening();for(const e of this._resizers.values())e.destroy();this._redrawSelectedResizerThrottled.cancel()}select(e){this.deselect(),this.selectedResizer=e,this.selectedResizer.isSelected=!0}deselect(){this.selectedResizer&&(this.selectedResizer.isSelected=!1),this.selectedResizer=null}attachTo(e){const t=new Y(e),i=this.editor.plugins;if(t.attach(),i.has("WidgetToolbarRepository")){const s=i.get("WidgetToolbarRepository");t.on("begin",()=>{s.forceDisabled("resize")},{priority:"lowest"}),t.on("cancel",()=>{s.clearForceDisabled("resize")},{priority:"highest"}),t.on("commit",()=>{s.clearForceDisabled("resize")},{priority:"highest"})}this._resizers.set(e.viewElement,t);const n=this.editor.editing.view.document.selection.getSelectedElement();return this.getResizerByViewElement(n)==t&&this.select(t),t}getResizerByViewElement(e){return this._resizers.get(e)}_getResizerByHandle(e){for(const t of this._resizers.values())if(t.containsHandle(e))return t}_mouseDownListener(e,t){const i=t.domTarget;Y.isResizeHandle(i)&&(this._activeResizer=this._getResizerByHandle(i)||null,this._activeResizer&&(this._activeResizer.begin(i),e.stop(),t.preventDefault()))}_mouseMoveListener(e,t){this._activeResizer&&this._activeResizer.updateSize(t)}_mouseUpListener(){this._activeResizer&&(this._activeResizer.commit(),this._activeResizer=null)}}export{I as WIDGET_CLASS_NAME,P as WIDGET_SELECTED_CLASS_NAME,De as Widget,Qe as WidgetResize,Le as WidgetToolbarRepository,K as WidgetTypeAround,F as calculateResizeHostAncestorWidth,N as calculateResizeHostPercentageWidth,fe as findOptimalInsertionRange,O as getLabel,_ as isWidget,C as setHighlightHandling,M as setLabel,_e as toWidget,pe as toWidgetEditable,me as viewToModelPositionOutsideModelElement};
