import{Plugin as M}from"@ckeditor/ckeditor5-core";import{ClipboardPipeline as T}from"@ckeditor/ckeditor5-clipboard";import{UpcastWriter as h,Matcher as b,ViewDocument as x,DomConverter as v}from"@ckeditor/ckeditor5-engine";/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/function P(e,t){const s=[];for(const n of t.createRangeIn(e)){const i=n.item;i.is("element","a")&&!i.hasAttribute("href")&&(i.hasAttribute("id")||i.hasAttribute("name"))&&s.push(i)}for(const n of s){const i=n.parent.getChildIndex(n)+1,r=n.getChildren();t.insertChild(i,r,n.parent)}}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/function R(e){const t=parseFloat(e);return e.endsWith("pt")?y(t*96/72):e.endsWith("pc")?y(t*12*96/72):e.endsWith("in")?y(t*96):e.endsWith("cm")?y(t*96/2.54):e.endsWith("mm")?y(t/10*96/2.54):e}function S(e){return e!==void 0&&e.endsWith("px")}function y(e){return e.toFixed(2).replace(/\.?0+$/,"")+"px"}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/function W(e,t,s){if(!e.childCount)return;const n=new h(e.document),i=N(e,n);if(!i.length)return;const r={},l=[];for(const o of i)if(o.indent!==void 0){B(o)||(l.length=0);const a=`${o.id}:${o.indent}`,c=Math.min(o.indent-1,l.length);if(c<l.length&&l[c].id!==o.id&&(l.length=c),c<l.length-1)l.length=c+1;else{const m=D(o,t);if(c>l.length-1||l[c].listElement.name!=m.type){c==0&&m.type=="ol"&&o.id!==void 0&&r[a]&&(m.startIndex=r[a]);const d=j(m,n,s);if(S(o.marginLeft)&&(c==0||S(l[c-1].marginLeft))){let u=o.marginLeft;c>0&&(u=y(parseFloat(u)-parseFloat(l[c-1].marginLeft))),n.setStyle("padding-left",u,d)}if(l.length==0){const u=o.element.parent,g=u.getChildIndex(o.element)+1;n.insertChild(g,d,u)}else{const u=l[c-1].listItemElements;n.appendChild(d,u[u.length-1])}l[c]={...o,listElement:d,listItemElements:[]},c==0&&o.id!==void 0&&(r[a]=m.startIndex||1)}}const f=o.element.name=="li"?o.element:n.createElement("li");n.appendChild(f,l[c].listElement),l[c].listItemElements.push(f),c==0&&o.id!==void 0&&r[a]++,o.element!=f&&n.appendChild(o.element,f),_(o.element,n),n.removeStyle("text-indent",o.element),n.removeStyle("margin-left",o.element)}else{const a=l.find(c=>c.marginLeft==o.marginLeft);if(a){const c=a.listItemElements;n.appendChild(o.element,c[c.length-1]),n.removeStyle("margin-left",o.element)}else l.length=0}}function k(e,t){for(const s of t.createRangeIn(e)){const n=s.item;if(n.is("element","li")){const i=n.getChild(0);i&&i.is("element","p")&&t.unwrapElement(i)}}}function N(e,t){const s=t.createRangeIn(e),n=[],i=new Set;for(const r of s.getItems()){if(!r.is("element")||!r.name.match(/^(p|h\d+|li|div)$/))continue;let l=V(r);if(l!==void 0&&parseFloat(l)==0&&!Array.from(r.getClassNames()).find(o=>o.startsWith("MsoList"))&&(l=void 0),r.hasStyle("mso-list")||l!==void 0&&i.has(l)){const o=F(r);n.push({element:r,id:o.id,order:o.order,indent:o.indent,marginLeft:l}),l!==void 0&&i.add(l)}else i.clear()}return n}function B(e){const t=e.element.previousSibling;return I(t||e.element.parent)}function I(e){return e.is("element","ol")||e.is("element","ul")}function D(e,t){const s=new RegExp(`@list l${e.id}:level${e.indent}\\s*({[^}]*)`,"gi"),n=/mso-level-number-format:([^;]{0,100});/gi,i=/mso-level-start-at:\s{0,100}([0-9]{0,10})\s{0,100};/gi,r=new RegExp(`@list\\s+l${e.id}:level\\d\\s*{[^{]*mso-level-text:"%\\d\\\\.`,"gi"),l=new RegExp(`@list l${e.id}:level\\d\\s*{[^{]*mso-level-number-format:`,"gi"),o=r.exec(t),a=l.exec(t),c=o&&!a,f=s.exec(t);let m="decimal",d="ol",u=null;if(f&&f[1]){const g=n.exec(f[1]);if(g&&g[1]&&(m=g[1].trim(),d=m!=="bullet"&&m!=="image"?"ol":"ul"),m==="bullet"){const p=$(e.element);p&&(m=p)}else{const p=i.exec(f[1]);p&&p[1]&&(u=parseInt(p[1]))}c&&(d="ol")}return{type:d,startIndex:u,style:z(m),isLegalStyleList:c}}function $(e){if(e.name=="li"&&e.parent.name=="ul"&&e.parent.hasAttribute("type"))return e.parent.getAttribute("type");const t=O(e);if(!t)return null;const s=t._data;return s==="o"?"circle":s==="\xB7"?"disc":s==="\xA7"?"square":null}function O(e){if(e.getChild(0).is("$text"))return null;for(const t of e.getChildren()){if(!t.is("element","span"))continue;const s=t.getChild(0);if(s)return s.is("$text")?s:s.getChild(0)}/* istanbul ignore next -- @preserve */return null}function z(e){if(e.startsWith("arabic-leading-zero"))return"decimal-leading-zero";switch(e){case"alpha-upper":return"upper-alpha";case"alpha-lower":return"lower-alpha";case"roman-upper":return"upper-roman";case"roman-lower":return"lower-roman";case"circle":case"disc":case"square":return e;default:return null}}function j(e,t,s){const n=t.createElement(e.type);return e.style&&t.setStyle("list-style-type",e.style,n),e.startIndex&&e.startIndex>1&&t.setAttribute("start",e.startIndex,n),e.isLegalStyleList&&s&&t.addClass("legal-list",n),n}function F(e){const t=e.getStyle("mso-list");if(t===void 0)return{};const s=t.match(/(^|\s{1,100})l(\d+)/i),n=t.match(/\s{0,100}lfo(\d+)/i),i=t.match(/\s{0,100}level(\d+)/i);return s&&n&&i?{id:s[2],order:n[1],indent:parseInt(i[1])}:{indent:1}}function _(e,t){const s=new b({name:"span",styles:{"mso-list":"Ignore"}}),n=t.createRangeIn(e);for(const i of n)i.type==="elementStart"&&s.match(i.item)&&t.remove(i.item)}function V(e){const t=e.getStyle("margin-left");return t===void 0||t.endsWith("px")?t:R(t)}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/function q(e,t){if(!e.childCount)return;const s=new h(e.document),n=H(e,s);U(n,e,s),J(n,e,s),X(e,s);const i=K(e,s);i.length&&Y(i,Q(t),s)}function G(e){return btoa(e.match(/\w{2}/g).map(t=>String.fromCharCode(parseInt(t,16))).join(""))}function H(e,t){const s=t.createRangeIn(e),n=new b({name:/v:(.+)/}),i=[];for(const r of s){if(r.type!="elementStart")continue;const l=r.item,o=l.previousSibling,a=o&&o.is("element")?o.name:null,c=["Chart"],f=n.match(l),m=l.getAttribute("o:gfxdata"),d=a==="v:shapetype",u=m&&c.some(g=>l.getAttribute("id").includes(g));f&&m&&!d&&!u&&i.push(r.item.getAttribute("id"))}return i}function U(e,t,s){const n=s.createRangeIn(t),i=new b({name:"img"}),r=[];for(const l of n)if(l.item.is("element")&&i.match(l.item)){const o=l.item,a=o.getAttribute("v:shapes")?o.getAttribute("v:shapes").split(" "):[];a.length&&a.every(c=>e.indexOf(c)>-1)?r.push(o):o.getAttribute("src")||r.push(o)}for(const l of r)s.remove(l)}function X(e,t){const s=t.createRangeIn(e),n=new b({name:/v:(.+)/}),i=[];for(const r of s)r.type=="elementStart"&&n.match(r.item)&&i.push(r.item);for(const r of i)t.remove(r)}function J(e,t,s){const n=s.createRangeIn(t),i=[];for(const o of n)if(o.type=="elementStart"&&o.item.is("element","v:shape")){const a=o.item.getAttribute("id");if(e.includes(a))continue;r(o.item.parent.getChildren(),a)||i.push(o.item)}for(const o of i){const a={src:l(o)};o.hasAttribute("alt")&&(a.alt=o.getAttribute("alt"));const c=s.createElement("img",a);s.insertChild(o.index+1,c,o.parent)}function r(o,a){for(const c of o){/* istanbul ignore else -- @preserve */if(c.is("element")&&(c.name=="img"&&c.getAttribute("v:shapes")==a||r(c.getChildren(),a)))return!0}return!1}function l(o){for(const a of o.getChildren()){/* istanbul ignore else -- @preserve */if(a.is("element")&&a.getAttribute("src"))return a.getAttribute("src")}}}function K(e,t){const s=t.createRangeIn(e),n=new b({name:"img"}),i=[];for(const r of s)r.item.is("element")&&n.match(r.item)&&r.item.getAttribute("src").startsWith("file://")&&i.push(r.item);return i}function Q(e){if(!e)return[];const t=/{\\pict[\s\S]+?\\bliptag-?\d+(\\blipupi-?\d+)?({\\\*\\blipuid\s?[\da-fA-F]+)?[\s}]*?/,s=new RegExp("(?:("+t.source+"))([\\da-fA-F\\s]+)\\}","g"),n=e.match(s),i=[];if(n)for(const r of n){let l=!1;r.includes("\\pngblip")?l="image/png":r.includes("\\jpegblip")&&(l="image/jpeg"),l&&i.push({hex:r.replace(t,"").replace(/[^\da-fA-F]/g,""),type:l})}return i}function Y(e,t,s){if(e.length===t.length)for(let n=0;n<e.length;n++){const i=`data:${t[n].type};base64,${G(t[n].hex)}`;s.setAttribute("src",i,e[n])}}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/function Z(e){const t=[],s=new h(e.document);for(const{item:n}of s.createRangeIn(e))if(n.is("element")){for(const i of n.getClassNames())/\bmso/gi.exec(i)&&s.removeClass(i,n);for(const i of n.getStyleNames())/\bmso/gi.exec(i)&&s.removeStyle(i,n);(n.is("element","w:sdt")||n.is("element","w:sdtpr")&&n.isEmpty||n.is("element","o:p")&&n.isEmpty)&&t.push(n)}for(const n of t){const i=n.parent,r=i.getChildIndex(n);s.insertChild(r,n.getChildren(),i),s.remove(n)}}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/const ee=/<meta\s*name="?generator"?\s*content="?microsoft\s*word\s*\d+"?\/?>/i,te=/xmlns:o="urn:schemas-microsoft-com/i;class C{constructor(t,s=!1){this.document=t,this.hasMultiLevelListPlugin=s}isActive(t){return ee.test(t)||te.test(t)}execute(t){const s=new h(this.document),{body:n,stylesString:i}=t._parsedData;P(n,s),W(n,i,this.hasMultiLevelListPlugin),q(n,t.dataTransfer.getData("text/rtf")),Z(n),t.content=n}}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/function ne(e,t){for(const s of e.getChildren())if(s.is("element","b")&&s.getStyle("font-weight")==="normal"){const n=e.getChildIndex(s);t.remove(s),t.insertChild(n,s.getChildren(),e)}}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/function se(e,t){const s=new x(t.document.stylesProcessor),n=new v(s,{renderingMode:"data"}),i=n.blockElements,r=n.inlineObjectElements,l=[];for(const o of t.createRangeIn(e)){const a=o.item;if(a.is("element","br")){const c=A(a,"forward",t,{blockElements:i,inlineObjectElements:r}),f=A(a,"backward",t,{blockElements:i,inlineObjectElements:r}),m=L(c,i);(L(f,i)||m)&&l.push(a)}}for(const o of l)o.hasClass("Apple-interchange-newline")?t.remove(o):t.replace(o,t.createElement("p"))}function A(e,t,s,{blockElements:n,inlineObjectElements:i}){let r=s.createPositionAt(e,t=="forward"?"after":"before");return r=r.getLastMatchingPosition(({item:l})=>l.is("element")&&!n.includes(l.name)&&!i.includes(l.name),{direction:t}),t=="forward"?r.nodeAfter:r.nodeBefore}function L(e,t){return!!e&&e.is("element")&&t.includes(e.name)}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/const ie=/id=("|')docs-internal-guid-[-0-9a-f]+("|')/i;class oe{constructor(t){this.document=t}isActive(t){return ie.test(t)}execute(t){const s=new h(this.document),{body:n}=t._parsedData;ne(n,s),k(n,s),se(n,s),t.content=n}}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/function re(e,t){for(const s of e.getChildren())s.is("element","table")&&s.hasAttribute("xmlns")&&t.removeAttribute("xmlns",s)}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/function le(e,t){for(const s of e.getChildren())if(s.is("element","google-sheets-html-origin")){const n=e.getChildIndex(s);t.remove(s),t.insertChild(n,s.getChildren(),e)}}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/function ce(e,t){for(const s of e.getChildren())s.is("element","table")&&s.getStyle("width")==="0px"&&t.removeStyle("width",s)}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/function ae(e,t){for(const s of Array.from(e.getChildren()))s.is("element","style")&&t.remove(s)}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/const me=/<google-sheets-html-origin/i;class fe{constructor(t){this.document=t}isActive(t){return me.test(t)}execute(t){const s=new h(this.document),{body:n}=t._parsedData;le(n,s),re(n,s),ce(n,s),ae(n,s),t.content=n}}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/function ue(e){return E(E(e)).replace(/(<span\s+style=['"]mso-spacerun:yes['"]>[^\S\r\n]*?)[\r\n]+([^\S\r\n]*<\/span>)/g,"$1$2").replace(/<span\s+style=['"]mso-spacerun:yes['"]><\/span>/g,"").replace(/(<span\s+style=['"]letter-spacing:[^'"]+?['"]>)[\r\n]+(<\/span>)/g,"$1 $2").replace(/ <\//g,"\xA0</").replace(/ <o:p><\/o:p>/g,"\xA0<o:p></o:p>").replace(/<o:p>(&nbsp;|\u00A0)<\/o:p>/g,"").replace(/>([^\S\r\n]*[\r\n]\s*)</g,"><")}function de(e){e.querySelectorAll("span[style*=spacerun]").forEach(t=>{const s=t,n=s.innerText.length||0;s.innerText=Array(n+1).join("\xA0 ").substr(0,n)})}function E(e){return e.replace(/<span(?: class="Apple-converted-space"|)>(\s+)<\/span>/g,(t,s)=>s.length===1?" ":Array(s.length+1).join("\xA0 ").substr(0,s.length))}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/function w(e,t){const s=new DOMParser;e=e.replace(/<!--\[if gte vml 1]>/g,""),e=e.replace(/<o:SmartTagType(?:\s+[^\s>=]+(?:="[^"]*")?)*\s*\/?>/gi,"");const n=ue(he(e)),i=s.parseFromString(n,"text/html");de(i);const r=i.body.innerHTML,l=ge(i,t),o=pe(i);return{body:l,bodyString:r,styles:o.styles,stylesString:o.stylesString}}function ge(e,t){const s=new x(t),n=new v(s,{renderingMode:"data"}),i=e.createDocumentFragment(),r=e.body.childNodes;for(;r.length>0;)i.appendChild(r[0]);return n.domToView(i,{skipComments:!0})}function pe(e){const t=[],s=[],n=Array.from(e.getElementsByTagName("style"));for(const i of n)i.sheet&&i.sheet.cssRules&&i.sheet.cssRules.length&&(t.push(i.sheet),s.push(i.innerHTML));return{styles:t,stylesString:s.join(" ")}}function he(e){const t="</body>",s="</html>",n=e.indexOf(t);if(n<0)return e;const i=e.indexOf(s,n+t.length);return e.substring(0,n+t.length)+(i>=0?e.substring(i):"")}/**
* @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
* For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
*/class ye extends M{static get pluginName(){return"PasteFromOffice"}static get isOfficialPlugin(){return!0}static get requires(){return[T]}init(){const t=this.editor,s=t.plugins.get("ClipboardPipeline"),n=t.editing.view.document,i=[],r=this.editor.plugins.has("MultiLevelList");i.push(new C(n,r)),i.push(new oe(n)),i.push(new fe(n)),s.on("inputTransformation",(l,o)=>{if(o._isTransformedWithPasteFromOffice||t.model.document.selection.getFirstPosition().parent.is("element","codeBlock"))return;const c=o.dataTransfer.getData("text/html"),f=i.find(m=>m.isActive(c));f&&(o._parsedData||(o._parsedData=w(c,n.stylesProcessor)),f.execute(o),o._isTransformedWithPasteFromOffice=!0)},{priority:"high"})}}export{C as MSWordNormalizer,ye as PasteFromOffice,w as parseHtml};
