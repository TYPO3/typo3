import{Plugin as e}from"@ckeditor/ckeditor5-core";import{ClipboardPipeline as t}from"@ckeditor/ckeditor5-clipboard";import{UpcastWriter as n,Matcher as i,ViewDocument as s,DomConverter as r}from"@ckeditor/ckeditor5-engine";
/**
 * @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
 */function o(e){return void 0!==e&&e.endsWith("px")}function l(e){return e.toFixed(2).replace(/\.?0+$/,"")+"px"}
/**
 * @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
 */function c(e,t,i){if(!e.childCount)return;const s=new n(e.document),r=function(e,t){const n=t.createRangeIn(e),i=[],s=new Set;for(const e of n.getItems()){if(!e.is("element")||!e.name.match(/^(p|h\d+|li|div)$/))continue;let t=h(e);if(void 0===t||0!=parseFloat(t)||Array.from(e.getClassNames()).find((e=>e.startsWith("MsoList")))||(t=void 0),e.hasStyle("mso-list")||void 0!==t&&s.has(t)){const n=g(e);i.push({element:e,id:n.id,order:n.order,indent:n.indent,marginLeft:t}),void 0!==t&&s.add(t)}else s.clear()}return i}(e,s);if(!r.length)return;const c={},m=[];for(const e of r)if(void 0!==e.indent){a(e)||(m.length=0);const n=`${e.id}:${e.indent}`,r=Math.min(e.indent-1,m.length);if(r<m.length&&m[r].id!==e.id&&(m.length=r),r<m.length-1)m.length=r+1;else{const a=u(e,t);if(r>m.length-1||m[r].listElement.name!=a.type){0==r&&"ol"==a.type&&void 0!==e.id&&c[n]&&(a.startIndex=c[n]);const t=f(a,s,i);if(o(e.marginLeft)&&(0==r||o(m[r-1].marginLeft))){let n=e.marginLeft;r>0&&(n=l(parseFloat(n)-parseFloat(m[r-1].marginLeft))),s.setStyle("padding-left",n,t)}if(0==m.length){const n=e.element.parent,i=n.getChildIndex(e.element)+1;s.insertChild(i,t,n)}else{const e=m[r-1].listItemElements;s.appendChild(t,e[e.length-1])}m[r]={...e,listElement:t,listItemElements:[]},0==r&&void 0!==e.id&&(c[n]=a.startIndex||1)}}const d="li"==e.element.name?e.element:s.createElement("li");s.appendChild(d,m[r].listElement),m[r].listItemElements.push(d),0==r&&void 0!==e.id&&c[n]++,e.element!=d&&s.appendChild(e.element,d),p(e.element,s),s.removeStyle("text-indent",e.element),s.removeStyle("margin-left",e.element)}else{const t=m.find((t=>t.marginLeft==e.marginLeft));if(t){const n=t.listItemElements;s.appendChild(e.element,n[n.length-1]),s.removeStyle("margin-left",e.element)}else m.length=0}}function a(e){const t=e.element.previousSibling;return m(t||e.element.parent)}function m(e){return e.is("element","ol")||e.is("element","ul")}function u(e,t){const n=new RegExp(`@list l${e.id}:level${e.indent}\\s*({[^}]*)`,"gi"),i=/mso-level-number-format:([^;]{0,100});/gi,s=/mso-level-start-at:\s{0,100}([0-9]{0,10})\s{0,100};/gi,r=new RegExp(`@list\\s+l${e.id}:level\\d\\s*{[^{]*mso-level-text:"%\\d\\\\.`,"gi"),o=new RegExp(`@list l${e.id}:level\\d\\s*{[^{]*mso-level-number-format:`,"gi"),l=r.exec(t),c=o.exec(t),a=l&&!c,m=n.exec(t);let u="decimal",f="ol",g=null;if(m&&m[1]){const t=i.exec(m[1]);if(t&&t[1]&&(u=t[1].trim(),f="bullet"!==u&&"image"!==u?"ol":"ul"),"bullet"===u){const t=function(e){if("li"==e.name&&"ul"==e.parent.name&&e.parent.hasAttribute("type"))return e.parent.getAttribute("type");const t=function(e){if(e.getChild(0).is("$text"))return null;for(const t of e.getChildren()){if(!t.is("element","span"))continue;const e=t.getChild(0);if(e)return e.is("$text")?e:e.getChild(0)}
/* istanbul ignore next -- @preserve */return null}(e);if(!t)return null;const n=t._data;if("o"===n)return"circle";if("·"===n)return"disc";if("§"===n)return"square";return null}(e.element);t&&(u=t)}else{const e=s.exec(m[1]);e&&e[1]&&(g=parseInt(e[1]))}a&&(f="ol")}return{type:f,startIndex:g,style:d(u),isLegalStyleList:a}}function d(e){if(e.startsWith("arabic-leading-zero"))return"decimal-leading-zero";switch(e){case"alpha-upper":return"upper-alpha";case"alpha-lower":return"lower-alpha";case"roman-upper":return"upper-roman";case"roman-lower":return"lower-roman";case"circle":case"disc":case"square":return e;default:return null}}function f(e,t,n){const i=t.createElement(e.type);return e.style&&t.setStyle("list-style-type",e.style,i),e.startIndex&&e.startIndex>1&&t.setAttribute("start",e.startIndex,i),e.isLegalStyleList&&n&&t.addClass("legal-list",i),i}function g(e){const t=e.getStyle("mso-list");if(void 0===t)return{};const n=t.match(/(^|\s{1,100})l(\d+)/i),i=t.match(/\s{0,100}lfo(\d+)/i),s=t.match(/\s{0,100}level(\d+)/i);return n&&i&&s?{id:n[2],order:i[1],indent:parseInt(s[1])}:{indent:1}}function p(e,t){const n=new i({name:"span",styles:{"mso-list":"Ignore"}}),s=t.createRangeIn(e);for(const e of s)"elementStart"===e.type&&n.match(e.item)&&t.remove(e.item)}function h(e){const t=e.getStyle("margin-left");return void 0===t||t.endsWith("px")?t:
/**
 * @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
 */
function(e){const t=parseFloat(e);return e.endsWith("pt")?l(96*t/72):e.endsWith("pc")?l(12*t*96/72):e.endsWith("in")?l(96*t):e.endsWith("cm")?l(96*t/2.54):e.endsWith("mm")?l(t/10*96/2.54):e}(t)}
/**
 * @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
 */function y(e,t){if(!e.childCount)return;const s=new n(e.document),r=function(e,t){const n=t.createRangeIn(e),s=new i({name:/v:(.+)/}),r=[];for(const e of n){if("elementStart"!=e.type)continue;const t=e.item,n=t.previousSibling,i=n&&n.is("element")?n.name:null,o=["Chart"],l=s.match(t),c=t.getAttribute("o:gfxdata"),a="v:shapetype"===i,m=c&&o.some((e=>t.getAttribute("id").includes(e)));l&&c&&!a&&!m&&r.push(e.item.getAttribute("id"))}return r}(e,s);!function(e,t,n){const s=n.createRangeIn(t),r=new i({name:"img"}),o=[];for(const t of s)if(t.item.is("element")&&r.match(t.item)){const n=t.item,i=n.getAttribute("v:shapes")?n.getAttribute("v:shapes").split(" "):[];i.length&&i.every((t=>e.indexOf(t)>-1))?o.push(n):n.getAttribute("src")||o.push(n)}for(const e of o)n.remove(e)}(r,e,s),function(e,t,n){const i=n.createRangeIn(t),s=[];for(const t of i)if("elementStart"==t.type&&t.item.is("element","v:shape")){const n=t.item.getAttribute("id");if(e.includes(n))continue;r(t.item.parent.getChildren(),n)||s.push(t.item)}for(const e of s){const t={src:o(e)};e.hasAttribute("alt")&&(t.alt=e.getAttribute("alt"));const i=n.createElement("img",t);n.insertChild(e.index+1,i,e.parent)}function r(e,t){for(const n of e)
/* istanbul ignore else -- @preserve */
if(n.is("element")){if("img"==n.name&&n.getAttribute("v:shapes")==t)return!0;if(r(n.getChildren(),t))return!0}return!1}function o(e){for(const t of e.getChildren())
/* istanbul ignore else -- @preserve */
if(t.is("element")&&t.getAttribute("src"))return t.getAttribute("src")}}(r,e,s),function(e,t){const n=t.createRangeIn(e),s=new i({name:/v:(.+)/}),r=[];for(const e of n)"elementStart"==e.type&&s.match(e.item)&&r.push(e.item);for(const e of r)t.remove(e)}(e,s);const o=function(e,t){const n=t.createRangeIn(e),s=new i({name:"img"}),r=[];for(const e of n)e.item.is("element")&&s.match(e.item)&&e.item.getAttribute("src").startsWith("file://")&&r.push(e.item);return r}(e,s);o.length&&function(e,t,n){if(e.length===t.length)for(let i=0;i<e.length;i++){const s=`data:${t[i].type};base64,${b(t[i].hex)}`;n.setAttribute("src",s,e[i])}}
/**
 * @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
 */(o,function(e){if(!e)return[];const t=/{\\pict[\s\S]+?\\bliptag-?\d+(\\blipupi-?\d+)?({\\\*\\blipuid\s?[\da-fA-F]+)?[\s}]*?/,n=new RegExp("(?:("+t.source+"))([\\da-fA-F\\s]+)\\}","g"),i=e.match(n),s=[];if(i)for(const e of i){let n=!1;e.includes("\\pngblip")?n="image/png":e.includes("\\jpegblip")&&(n="image/jpeg"),n&&s.push({hex:e.replace(t,"").replace(/[^\da-fA-F]/g,""),type:n})}return s}(t),s)}function b(e){return btoa(e.match(/\w{2}/g).map((e=>String.fromCharCode(parseInt(e,16)))).join(""))}
/**
 * @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
 */
const v=/<meta\s*name="?generator"?\s*content="?microsoft\s*word\s*\d+"?\/?>/i,x=/xmlns:o="urn:schemas-microsoft-com/i;class C{constructor(e,t=!1){this.document=e,this.hasMultiLevelListPlugin=t}isActive(e){return v.test(e)||x.test(e)}execute(e){const t=new n(this.document),{body:i,stylesString:s}=e._parsedData;!function(e,t){const n=[];for(const i of t.createRangeIn(e)){const e=i.item;e.is("element","a")&&!e.hasAttribute("href")&&(e.hasAttribute("id")||e.hasAttribute("name"))&&n.push(e)}for(const e of n){const n=e.parent.getChildIndex(e)+1,i=e.getChildren();t.insertChild(n,i,e.parent)}}(i,t),c(i,s,this.hasMultiLevelListPlugin),y(i,e.dataTransfer.getData("text/rtf")),function(e){const t=[],i=new n(e.document);for(const{item:n}of i.createRangeIn(e))if(n.is("element")){for(const e of n.getClassNames())/\bmso/gi.exec(e)&&i.removeClass(e,n);for(const e of n.getStyleNames())/\bmso/gi.exec(e)&&i.removeStyle(e,n);(n.is("element","w:sdt")||n.is("element","w:sdtpr")&&n.isEmpty||n.is("element","o:p")&&n.isEmpty)&&t.push(n)}for(const e of t){const t=e.parent,n=t.getChildIndex(e);i.insertChild(n,e.getChildren(),t),i.remove(e)}}(i),e.content=i}}
/**
 * @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
 */function w(e,t,n,{blockElements:i,inlineObjectElements:s}){let r=n.createPositionAt(e,"forward"==t?"after":"before");return r=r.getLastMatchingPosition((({item:e})=>e.is("element")&&!i.includes(e.name)&&!s.includes(e.name)),{direction:t}),"forward"==t?r.nodeAfter:r.nodeBefore}function A(e,t){return!!e&&e.is("element")&&t.includes(e.name)}
/**
 * @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
 */const S=/id=("|')docs-internal-guid-[-0-9a-f]+("|')/i;class I{constructor(e){this.document=e}isActive(e){return S.test(e)}execute(e){const t=new n(this.document),{body:i}=e._parsedData;!function(e,t){for(const n of e.getChildren())if(n.is("element","b")&&"normal"===n.getStyle("font-weight")){const i=e.getChildIndex(n);t.remove(n),t.insertChild(i,n.getChildren(),e)}}
/**
 * @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
 */(i,t),function(e,t){for(const n of t.createRangeIn(e)){const e=n.item;if(e.is("element","li")){const n=e.getChild(0);n&&n.is("element","p")&&t.unwrapElement(n)}}}(i,t),function(e,t){const n=new s(t.document.stylesProcessor),i=new r(n,{renderingMode:"data"}),o=i.blockElements,l=i.inlineObjectElements,c=[];for(const n of t.createRangeIn(e)){const e=n.item;if(e.is("element","br")){const n=w(e,"forward",t,{blockElements:o,inlineObjectElements:l}),i=w(e,"backward",t,{blockElements:o,inlineObjectElements:l}),s=A(n,o);(A(i,o)||s)&&c.push(e)}}for(const e of c)e.hasClass("Apple-interchange-newline")?t.remove(e):t.replace(e,t.createElement("p"))}(i,t),e.content=i}}
/**
 * @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
 */
/**
 * @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
 */
const E=/<google-sheets-html-origin/i;class L{constructor(e){this.document=e}isActive(e){return E.test(e)}execute(e){const t=new n(this.document),{body:i}=e._parsedData;!
/**
 * @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
 */
function(e,t){for(const n of e.getChildren())if(n.is("element","google-sheets-html-origin")){const i=e.getChildIndex(n);t.remove(n),t.insertChild(i,n.getChildren(),e)}}
/**
 * @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
 */(i,t),function(e,t){for(const n of e.getChildren())n.is("element","table")&&n.hasAttribute("xmlns")&&t.removeAttribute("xmlns",n)}(i,t),function(e,t){for(const n of e.getChildren())n.is("element","table")&&"0px"===n.getStyle("width")&&t.removeStyle("width",n)}
/**
 * @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
 */(i,t),function(e,t){for(const n of Array.from(e.getChildren()))n.is("element","style")&&t.remove(n)}(i,t),e.content=i}}
/**
 * @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
 */function R(e){return e.replace(/<span(?: class="Apple-converted-space"|)>(\s+)<\/span>/g,((e,t)=>1===t.length?" ":Array(t.length+1).join("  ").substr(0,t.length)))}
/**
 * @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
 */function $(e,t){const n=new DOMParser,i=function(e){return R(R(e)).replace(/(<span\s+style=['"]mso-spacerun:yes['"]>[^\S\r\n]*?)[\r\n]+([^\S\r\n]*<\/span>)/g,"$1$2").replace(/<span\s+style=['"]mso-spacerun:yes['"]><\/span>/g,"").replace(/(<span\s+style=['"]letter-spacing:[^'"]+?['"]>)[\r\n]+(<\/span>)/g,"$1 $2").replace(/ <\//g," </").replace(/ <o:p><\/o:p>/g," <o:p></o:p>").replace(/<o:p>(&nbsp;|\u00A0)<\/o:p>/g,"").replace(/>([^\S\r\n]*[\r\n]\s*)</g,"><")}(function(e){const t="</body>",n="</html>",i=e.indexOf(t);if(i<0)return e;const s=e.indexOf(n,i+t.length);return e.substring(0,i+t.length)+(s>=0?e.substring(s):"")}
/**
 * @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-licensing-options
 */(e=(e=e.replace(/<!--\[if gte vml 1]>/g,"")).replace(/<o:SmartTagType(?:\s+[^\s>=]+(?:="[^"]*")?)*\s*\/?>/gi,""))),o=n.parseFromString(i,"text/html");!function(e){e.querySelectorAll("span[style*=spacerun]").forEach((e=>{const t=e,n=t.innerText.length||0;t.innerText=Array(n+1).join("  ").substr(0,n)}))}(o);const l=o.body.innerHTML,c=function(e,t){const n=new s(t),i=new r(n,{renderingMode:"data"}),o=e.createDocumentFragment(),l=e.body.childNodes;for(;l.length>0;)o.appendChild(l[0]);return i.domToView(o,{skipComments:!0})}(o,t),a=function(e){const t=[],n=[],i=Array.from(e.getElementsByTagName("style"));for(const e of i)e.sheet&&e.sheet.cssRules&&e.sheet.cssRules.length&&(t.push(e.sheet),n.push(e.innerHTML));return{styles:t,stylesString:n.join(" ")}}(o);return{body:c,bodyString:l,styles:a.styles,stylesString:a.stylesString}}class F extends e{static get pluginName(){return"PasteFromOffice"}static get isOfficialPlugin(){return!0}static get requires(){return[t]}init(){const e=this.editor,t=e.plugins.get("ClipboardPipeline"),n=e.editing.view.document,i=[],s=this.editor.plugins.has("MultiLevelList");i.push(new C(n,s)),i.push(new I(n)),i.push(new L(n)),t.on("inputTransformation",((t,s)=>{if(s._isTransformedWithPasteFromOffice)return;if(e.model.document.selection.getFirstPosition().parent.is("element","codeBlock"))return;const r=s.dataTransfer.getData("text/html"),o=i.find((e=>e.isActive(r)));o&&(s._parsedData||(s._parsedData=$(r,n.stylesProcessor)),o.execute(s),s._isTransformedWithPasteFromOffice=!0)}),{priority:"high"})}}export{C as MSWordNormalizer,F as PasteFromOffice,$ as parseHtml};