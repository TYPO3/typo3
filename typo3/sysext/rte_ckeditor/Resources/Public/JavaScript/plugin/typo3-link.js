/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import*as d from"@ckeditor/ckeditor5-ui";import*as k from"@ckeditor/ckeditor5-core";import*as I from"@ckeditor/ckeditor5-engine";import*as p from"@ckeditor/ckeditor5-typing";import*as P from"@ckeditor/ckeditor5-widget";import*as v from"@ckeditor/ckeditor5-utils";import*as b from"@ckeditor/ckeditor5-link";import{LinkUtils as h}from"@ckeditor/ckeditor5-link";import f from"@typo3/backend/modal.js";import{IconLink as y,IconUnlink as R,IconPencil as V}from"@ckeditor/ckeditor5-icons";const C=["href","title","class","target","rel"];function x(c){return"link"+(c.charAt(0).toUpperCase()+c.slice(1))}function A(c){return c.startsWith("link")&&c.length>=5?c.charAt(4).toLowerCase()+c.slice(5):c}class E extends k.Command{constructor(){super(...arguments),this.attrs={}}refresh(){const e=this.editor.model,n=e.document.selection,i=n.getSelectedElement()||v.first(n.getSelectedBlocks()),o=h.isLinkableElement(i,e.schema)?i:n;o===i?(this.value=i.getAttribute("linkHref"),this.isEnabled=e.schema.checkAttribute(i,"linkHref")):(this.value=n.getAttribute("linkHref"),this.isEnabled=e.schema.checkAttributeInSelection(n,"linkHref"));const r=this.editor.plugins.get("GeneralHtmlSupport").getGhsAttributeNameForElement("a"),s={};for(const a of this.getLinkAttributesAllowedOnText(e.schema))if(a!=="linkHref")if(a===r){const l=o.getAttribute(a);l?.classes&&l.classes.length!==0&&(s.class=l.classes.join(" "))}else{const l=o.getAttribute(a);l!==void 0&&(s[A(a)]=l)}this.attrs=s}execute(e,n={}){const i=this.editor.model,o=i.document.selection;i.change(t=>{if(o.isCollapsed){const r=o.getFirstPosition();if(o.hasAttribute("linkHref")){const s=p.findAttributeRange(r,"linkHref",o.getAttribute("linkHref"),i);t.setAttribute("linkHref",e,s);for(const[a,l]of Object.entries(this.composeLinkAttributes(n)))l!==null?t.setAttribute(a,l,s):t.removeAttribute(a,s);t.setSelection(t.createPositionAfter(s.end.nodeBefore))}else if(e!==""){const s=v.toMap(o.getAttributes());s.set("linkHref",e);for(const[l,m]of Object.entries(this.composeLinkAttributes(n)))m!==null&&s.set(l,m);const{end:a}=i.insertContent(t.createText(e,s),r);t.setSelection(a)}this.removeLinkAttributesFromSelection(t,this.getLinkAttributesAllowedOnText(i.schema))}else{const r=i.schema.getValidRanges(o.getRanges(),"linkHref"),s=[];for(const l of o.getSelectedBlocks())i.schema.checkAttribute(l,"linkHref")&&s.push(t.createRangeOn(l));const a=s.slice();for(const l of r)this.isRangeToUpdate(l,s)&&a.push(l);for(const l of a){t.setAttribute("linkHref",e,l);for(const[m,g]of Object.entries(this.composeLinkAttributes(n)))g!==null?t.setAttribute(m,g,l):t.removeAttribute(m,l)}}})}getLinkAttributesAllowedOnText(e){return e.getDefinition("$text").allowAttributes.filter(i=>i.startsWith("link")||i==="htmlA")}removeLinkAttributesFromSelection(e,n){e.removeSelectionAttribute("linkHref");for(const i of n)e.removeSelectionAttribute(i)}composeLinkAttributes(e){const n={};for(const[i,o]of Object.entries(e.attrs))if(i==="linkClass"){const r=this.editor.plugins.get("GeneralHtmlSupport").getGhsAttributeNameForElement("a"),s=this.editor.model.document.selection;let a;s.hasAttribute(r)?a={...s.getAttribute(r)}:a={};const l=o.replace(/\s+/g," ").trim();l!==""?a.classes=l.split(" "):"classes"in a&&delete a.classes,n[r]=Object.keys(a).length!==0?a:null}else n[i]=o!==""?o:null;return n}isRangeToUpdate(e,n){for(const i of n)if(i.containsRange(e))return!1;return!0}}class T extends k.Command{refresh(){const e=this.editor.model,n=e.document.selection,i=n.getSelectedElement();h.isLinkableElement(i,e.schema)?this.isEnabled=e.schema.checkAttribute(i,"linkHref"):this.isEnabled=e.schema.checkAttributeInSelection(n,"linkHref")}execute(){const e=this.editor.model,n=e.document.selection;e.change(i=>{const o=n.isCollapsed?[p.findAttributeRange(n.getFirstPosition(),"linkHref",n.getAttribute("linkHref"),e)]:e.schema.getValidRanges(n.getRanges(),"linkHref");for(const t of o)i.removeAttribute("linkHref",t),i.removeAttribute("linkTarget",t),i.removeAttribute("linkTitle",t),i.removeAttribute("linkRel",t)})}}class w extends k.Plugin{static{this.pluginName="Typo3LinkEditing"}init(){const e=this.editor;window.editor=e,e.model.schema.extend("$text",{allowAttributes:["linkTitle","linkTarget","linkRel","linkDataRteError"]}),e.plugins.get("DataFilter").loadAllowedConfig([{name:"a",classes:!0}]),e.conversion.for("downcast").attributeToElement({model:"linkDataRteError",view:(i,{writer:o})=>{const t=o.createAttributeElement("a",{"data-rte-error":i},{priority:5});return o.setCustomProperty("linkDataRteError",!0,t),t}}),e.conversion.for("upcast").elementToAttribute({view:{name:"a",attributes:{"data-rte-error":!0}},model:{key:"linkDataRteError",value:i=>i.getAttribute("data-rte-error")}}),e.conversion.for("downcast").attributeToElement({model:"linkTitle",view:(i,{writer:o})=>{const t=o.createAttributeElement("a",{title:i},{priority:5});return o.setCustomProperty("linkTitle",!0,t),t}}),e.conversion.for("upcast").elementToAttribute({view:{name:"a",attributes:{title:!0}},model:{key:"linkTitle",value:i=>i.getAttribute("title")}}),e.conversion.for("downcast").attributeToElement({model:"linkTarget",view:(i,{writer:o})=>{const t=o.createAttributeElement("a",{target:i},{priority:5});return o.setCustomProperty("linkTarget",!0,t),t}}),e.conversion.for("upcast").elementToAttribute({view:{name:"a",attributes:{target:!0}},model:{key:"linkTarget",value:i=>i.getAttribute("target")}}),e.conversion.for("downcast").attributeToElement({model:"linkRel",view:(i,{writer:o})=>{const t=o.createAttributeElement("a",{rel:i},{priority:5});return o.setCustomProperty("linkRel",!0,t),t}}),e.conversion.for("upcast").elementToAttribute({view:{name:"a",attributes:{rel:!0}},model:{key:"linkRel",value:i=>i.getAttribute("rel")}}),e.commands.add("link",new E(e)),e.commands.add("unlink",new T(e))}}class L extends d.ButtonView{constructor(e){super(e);const n=this.bindTemplate;this.set({href:void 0,withText:!0}),this.setTemplate({tag:"span",attributes:{class:["ck-link-toolbar__preview"],title:n.to("href")},children:[{text:n.to("href")}]})}}const u="link-ui";class S extends k.Plugin{static get requires(){return[d.ContextualBalloon,b.LinkEditing]}static get pluginName(){return"Typo3LinkUI"}init(){const e=this.editor;e.editing.view.addObserver(I.ClickObserver),this.balloon=e.plugins.get(d.ContextualBalloon),this.createToolbarLinkButtons(),this.enableUserBalloonInteractions(),e.conversion.for("editingDowncast").markerToHighlight({model:u,view:{classes:["ck-fake-link-selection"]}}),e.conversion.for("editingDowncast").markerToElement({model:u,view:{name:"span",classes:["ck-fake-link-selection","ck-fake-link-selection_collapsed"]}})}createToolbarView(){const e=this.editor,n=new d.ToolbarView(e.locale),i=e.config.get("link.toolbar");return n.fillFromConfig(i,e.ui.componentFactory),n.keystrokes.set("Esc",(o,t)=>{this.hideUI(),t()}),e.ui.addToolbar(n,{isContextual:!0,beforeFocus:()=>{this.getSelectedLinkElement()&&!this.isToolbarVisible()&&this.showUI()},afterBlur:()=>{this.hideUI()}}),n}createToolbarLinkButtons(){const e=this.editor,n=e.commands.get("link"),i=e.t;e.keystrokes.set(h.LINK_KEYSTROKE,(o,t)=>{t(),n.isEnabled&&this.showUI()}),e.ui.componentFactory.add("link",o=>{const t=new d.ButtonView(o);return t.isEnabled=!0,t.label=i("Link"),t.icon=y,t.keystroke=h.LINK_KEYSTROKE,t.tooltip=!0,t.isToggleable=!0,t.bind("isEnabled").to(n,"isEnabled"),t.bind("isOn").to(n,"value",r=>!!r),this.listenTo(t,"execute",()=>this.showUI()),t}),e.ui.componentFactory.add("linkPreview",o=>{const t=new L(o),r=e.config.get("link.allowedProtocols"),s=e.commands.get("link");t.bind("isEnabled").to(s,"value",l=>!!l),t.bind("href").to(s,"value",l=>l&&h.ensureSafeUrl(l,r)),t.icon=void 0;const a=l=>{if(!l){t.label=void 0;return}t.label=l};return a(s.value),this.listenTo(s,"change:value",(l,m,g)=>{a(g)}),t}),e.ui.componentFactory.add("unlink",o=>{const t=e.commands.get("unlink"),r=new d.ButtonView(o),s=o.t;return r.set({label:s("Unlink"),icon:R,tooltip:!0}),r.bind("isEnabled").to(t),this.listenTo(r,"execute",()=>{e.execute("unlink"),this.hideUI()}),r}),e.ui.componentFactory.add("editLink",o=>{const t=e.commands.get("link"),r=new d.ButtonView(o),s=o.t;return r.set({label:s("Edit link"),icon:V,tooltip:!0}),r.bind("isEnabled").to(t),this.listenTo(r,"execute",()=>{this.openLinkBrowser(e)}),r})}enableUserBalloonInteractions(){const e=this.editor.editing.view.document;this.listenTo(e,"click",()=>{this.getSelectedLinkElement()&&this.showUI()}),this.editor.keystrokes.set("Esc",(n,i)=>{this.isUIVisible()&&(this.hideUI(),i())})}addToolbarView(){this.toolbarView||(this.toolbarView=this.createToolbarView()),!this.isToolbarInPanel()&&this.balloon.add({view:this.toolbarView,position:this.getBalloonPositionData(),balloonClassName:"ck-toolbar-container"})}hideUI(e=!0){const n=this.editor;this.stopListening(n.ui,"update"),this.stopListening(this.balloon,"change:visibleView"),e&&n.editing.view.focus(),this.isToolbarInPanel()&&this.balloon.remove(this.toolbarView),this.hideFakeVisualSelection()}showUI(){this.getSelectedLinkElement()?(this.addToolbarView(),this.balloon.showStack("main")):(this.showFakeVisualSelection(),this.openLinkBrowser(this.editor)),this.startUpdatingUI()}startUpdatingUI(){const e=this.editor,n=e.editing.view.document;let i=this.getSelectedLinkElement(),o=r();const t=()=>{const s=this.getSelectedLinkElement(),a=r();i&&!s||!i&&a!==o?this.hideUI():this.isUIVisible()&&this.balloon.updatePosition(this.getBalloonPositionData()),i=s,o=a};function r(){return n.selection.focus.getAncestors().reverse().find(s=>s.is("element"))}this.listenTo(e.ui,"update",t),this.listenTo(this.balloon,"change:visibleView",t)}isToolbarInPanel(){return!!this.toolbarView&&this.balloon.hasView(this.toolbarView)}isToolbarVisible(){return!!this.toolbarView&&this.balloon.visibleView===this.toolbarView}isUIVisible(){return this.isToolbarVisible()}getBalloonPositionData(){const e=this.editor.editing.view,n=this.editor.model,i=e.document;let o=null;if(n.markers.has(u)){const t=Array.from(this.editor.editing.mapper.markerNameToElements(u)),r=e.createRange(e.createPositionBefore(t[0]),e.createPositionAfter(t[t.length-1]));o=e.domConverter.viewRangeToDom(r)}else o=()=>{const t=this.getSelectedLinkElement();return t?e.domConverter.mapViewToDom(t):e.domConverter.viewRangeToDom(i.selection.getFirstRange())};return{target:o}}getSelectedLinkElement(){const e=this.editor.editing.view,n=e.document.selection,i=n.getSelectedElement();if(n.isCollapsed||i&&P.isWidget(i))return this.findLinkElementAncestor(n.getFirstPosition());{const o=n.getFirstRange().getTrimmed(),t=this.findLinkElementAncestor(o.start),r=this.findLinkElementAncestor(o.end);return!t||t!=r?null:e.createRangeIn(t).getTrimmed().isEqual(o)?t:null}}showFakeVisualSelection(){const e=this.editor.model;e.change(n=>{const i=e.document.selection.getFirstRange();if(e.markers.has(u))n.updateMarker(u,{range:i});else if(i.start.isAtEnd){const o=i.start.getLastMatchingPosition(({item:t})=>!e.schema.isContent(t),{startPosition:null,boundaries:i});n.addMarker(u,{usingOperation:!1,affectsData:!1,range:n.createRange(o,i.end)})}else n.addMarker(u,{usingOperation:!1,affectsData:!1,range:i})})}hideFakeVisualSelection(){const e=this.editor.model;e.markers.has(u)&&e.change(n=>{n.removeMarker(u)})}findLinkElementAncestor(e){return e.getAncestors().find(n=>h.isLinkElement(n))}openLinkBrowser(e){const n=e.commands.get("link");let i="";if(n.value){i+="&P[curUrl][url]="+encodeURIComponent(n.value);for(const[o,t]of Object.entries(n.attrs))i+="&P[curUrl]["+encodeURIComponent(o)+"]="+encodeURIComponent(t)}this.openElementBrowser(e,"Link",this.makeUrlFromModulePath(e,e.config.get("typo3link")?.routeUrl,i))}makeUrlFromModulePath(e,n,i){return n+(n.indexOf("?")===-1?"?":"&")+"&contentsLanguage=en&editorId=123"+(i||"")}openElementBrowser(e,n,i){f.advanced({type:f.types.iframe,title:n,content:i,size:f.sizes.large,callback:t=>{t.userData.editor=e,t.userData.selectionStartPosition=e.model.document.selection.getFirstPosition(),t.userData.selectionEndPosition=e.model.document.selection.getLastPosition(),t.querySelector(".t3js-modal-body")?.setAttribute("id","123")}}).addEventListener("typo3-modal-hide",()=>{this.hideUI(!1)})}}class U extends k.Plugin{static{this.overrides=[b.Link]}static get requires(){return["GeneralHtmlSupport",b.LinkEditing,b.AutoLink,w,S]}static get pluginName(){return"Typo3Link"}}export{C as LINK_ALLOWED_ATTRIBUTES,U as Typo3Link,E as Typo3LinkCommand,w as Typo3LinkEditing,L as Typo3LinkPreviewButtonView,S as Typo3LinkUI,T as Typo3UnlinkCommand,x as addLinkPrefix,U as default,A as removeLinkPrefix};
