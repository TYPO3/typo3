/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import*as k from"@ckeditor/ckeditor5-ui";import*as m from"@ckeditor/ckeditor5-core";import*as P from"@ckeditor/ckeditor5-engine";import*as p from"@ckeditor/ckeditor5-typing";import*as R from"@ckeditor/ckeditor5-widget";import*as A from"@ckeditor/ckeditor5-utils";import*as g from"@ckeditor/ckeditor5-link";import{LinkUtils as h,LinkActionsView as x}from"@ckeditor/ckeditor5-link";import f from"@typo3/backend/modal.js";const y='<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="m11.077 15 .991-1.416a.75.75 0 1 1 1.229.86l-1.148 1.64a.748.748 0 0 1-.217.206 5.251 5.251 0 0 1-8.503-5.955.741.741 0 0 1 .12-.274l1.147-1.639a.75.75 0 1 1 1.228.86L4.933 10.7l.006.003a3.75 3.75 0 0 0 6.132 4.294l.006.004zm5.494-5.335a.748.748 0 0 1-.12.274l-1.147 1.639a.75.75 0 1 1-1.228-.86l.86-1.23a3.75 3.75 0 0 0-6.144-4.301l-.86 1.229a.75.75 0 0 1-1.229-.86l1.148-1.64a.748.748 0 0 1 .217-.206 5.251 5.251 0 0 1 8.503 5.955zm-4.563-2.532a.75.75 0 0 1 .184 1.045l-3.155 4.505a.75.75 0 1 1-1.229-.86l3.155-4.506a.75.75 0 0 1 1.045-.184z"/></svg>',V=["href","title","class","target","rel"];function C(c){return"link"+(c.charAt(0).toUpperCase()+c.slice(1))}function v(c){return c.startsWith("link")&&c.length>=5?c.charAt(4).toLowerCase()+c.slice(5):c}class E extends k.View{constructor(e){super(e),this.set("text",void 0);const i=this.bindTemplate;this.setTemplate({tag:"span",attributes:{class:["ck","ck-linktext"],title:i.to("text")},children:[{text:i.to("text")}]})}}class w extends m.Command{constructor(){super(...arguments),this.attrs={}}refresh(){const e=this.editor.model,i=e.document.selection,t=i.getSelectedElement()||A.first(i.getSelectedBlocks()),s=h.isLinkableElement(t,e.schema)?t:i;s===t?(this.value=t.getAttribute("linkHref"),this.isEnabled=e.schema.checkAttribute(t,"linkHref")):(this.value=i.getAttribute("linkHref"),this.isEnabled=e.schema.checkAttributeInSelection(i,"linkHref"));const a=this.editor.plugins.get("GeneralHtmlSupport").getGhsAttributeNameForElement("a"),o={};for(const l of this.getLinkAttributesAllowedOnText(e.schema))if(l!=="linkHref")if(l===a){const r=s.getAttribute(l);r?.classes&&r.classes.length!==0&&(o.class=r.classes.join(" "))}else{const r=s.getAttribute(l);r!==void 0&&(o[v(l)]=r)}this.attrs=o}execute(e,i={}){const t=this.editor.model,s=t.document.selection;t.change(n=>{if(s.isCollapsed){const a=s.getFirstPosition();if(s.hasAttribute("linkHref")){const o=p.findAttributeRange(a,"linkHref",s.getAttribute("linkHref"),t);n.setAttribute("linkHref",e,o);for(const[l,r]of Object.entries(this.composeLinkAttributes(i)))r!==null?n.setAttribute(l,r,o):n.removeAttribute(l,o);n.setSelection(n.createPositionAfter(o.end.nodeBefore))}else if(e!==""){const o=A.toMap(s.getAttributes());o.set("linkHref",e);for(const[r,u]of Object.entries(this.composeLinkAttributes(i)))u!==null&&o.set(r,u);const{end:l}=t.insertContent(n.createText(e,o),a);n.setSelection(l)}this.removeLinkAttributesFromSelection(n,this.getLinkAttributesAllowedOnText(t.schema))}else{const a=t.schema.getValidRanges(s.getRanges(),"linkHref"),o=[];for(const r of s.getSelectedBlocks())t.schema.checkAttribute(r,"linkHref")&&o.push(n.createRangeOn(r));const l=o.slice();for(const r of a)this.isRangeToUpdate(r,o)&&l.push(r);for(const r of l){n.setAttribute("linkHref",e,r);for(const[u,b]of Object.entries(this.composeLinkAttributes(i)))b!==null?n.setAttribute(u,b,r):n.removeAttribute(u,r)}}})}getLinkAttributesAllowedOnText(e){return e.getDefinition("$text").allowAttributes.filter(t=>t.startsWith("link")||t==="htmlA")}removeLinkAttributesFromSelection(e,i){e.removeSelectionAttribute("linkHref");for(const t of i)e.removeSelectionAttribute(t)}composeLinkAttributes(e){const i={};for(const[t,s]of Object.entries(e.attrs))if(t==="linkClass"){const a=this.editor.plugins.get("GeneralHtmlSupport").getGhsAttributeNameForElement("a"),o=this.editor.model.document.selection;let l;o.hasAttribute(a)?l={...o.getAttribute(a)}:l={};const r=s.replace(/\s+/g," ").trim();r!==""?l.classes=r.split(" "):"classes"in l&&delete l.classes,i[a]=Object.keys(l).length!==0?l:null}else i[t]=s!==""?s:null;return i}isRangeToUpdate(e,i){for(const t of i)if(t.containsRange(e))return!1;return!0}}class L extends m.Command{refresh(){const e=this.editor.model,i=e.document.selection,t=i.getSelectedElement();h.isLinkableElement(t,e.schema)?this.isEnabled=e.schema.checkAttribute(t,"linkHref"):this.isEnabled=e.schema.checkAttributeInSelection(i,"linkHref")}execute(){const e=this.editor.model,i=e.document.selection;e.change(t=>{const s=i.isCollapsed?[p.findAttributeRange(i.getFirstPosition(),"linkHref",i.getAttribute("linkHref"),e)]:e.schema.getValidRanges(i.getRanges(),"linkHref");for(const n of s)t.removeAttribute("linkHref",n),t.removeAttribute("linkTarget",n),t.removeAttribute("linkTitle",n),t.removeAttribute("linkRel",n)})}}class T extends m.Plugin{static{this.pluginName="Typo3LinkEditing"}init(){const e=this.editor;window.editor=e,e.model.schema.extend("$text",{allowAttributes:["linkTitle","linkTarget","linkRel","linkDataRteError"]}),e.plugins.get("DataFilter").loadAllowedConfig([{name:"a",classes:!0}]),e.conversion.for("downcast").attributeToElement({model:"linkDataRteError",view:(t,{writer:s})=>{const n=s.createAttributeElement("a",{"data-rte-error":t},{priority:5});return s.setCustomProperty("linkDataRteError",!0,n),n}}),e.conversion.for("upcast").elementToAttribute({view:{name:"a",attributes:{"data-rte-error":!0}},model:{key:"linkDataRteError",value:t=>t.getAttribute("data-rte-error")}}),e.conversion.for("downcast").attributeToElement({model:"linkTitle",view:(t,{writer:s})=>{const n=s.createAttributeElement("a",{title:t},{priority:5});return s.setCustomProperty("linkTitle",!0,n),n}}),e.conversion.for("upcast").elementToAttribute({view:{name:"a",attributes:{title:!0}},model:{key:"linkTitle",value:t=>t.getAttribute("title")}}),e.conversion.for("downcast").attributeToElement({model:"linkTarget",view:(t,{writer:s})=>{const n=s.createAttributeElement("a",{target:t},{priority:5});return s.setCustomProperty("linkTarget",!0,n),n}}),e.conversion.for("upcast").elementToAttribute({view:{name:"a",attributes:{target:!0}},model:{key:"linkTarget",value:t=>t.getAttribute("target")}}),e.conversion.for("downcast").attributeToElement({model:"linkRel",view:(t,{writer:s})=>{const n=s.createAttributeElement("a",{rel:t},{priority:5});return s.setCustomProperty("linkRel",!0,n),n}}),e.conversion.for("upcast").elementToAttribute({view:{name:"a",attributes:{rel:!0}},model:{key:"linkRel",value:t=>t.getAttribute("rel")}}),e.commands.add("link",new w(e)),e.commands.add("unlink",new L(e))}}class S extends x{_createPreviewButton(){const e=new E(this.locale),i=this.t;return e.bind("text").to(this,"href",t=>t||i("This link has no URL")),e}}const d="link-ui";class U extends m.Plugin{static{this.pluginName="Typo3LinkUI"}static{this.requires=[k.ContextualBalloon]}init(){const e=this.editor;e.editing.view.addObserver(P.ClickObserver),this.actionsView=this.createActionsView(),this.balloon=e.plugins.get(k.ContextualBalloon),this.createToolbarLinkButtons(),this.enableUserBalloonInteractions(),e.conversion.for("editingDowncast").markerToHighlight({model:d,view:{classes:["ck-fake-link-selection"]}}),e.conversion.for("editingDowncast").markerToElement({model:d,view:{name:"span",classes:["ck-fake-link-selection","ck-fake-link-selection_collapsed"]}})}createActionsView(){const e=this.editor,i=new S(e.locale),t=e.commands.get("link"),s=e.commands.get("unlink");return i.bind("href").to(t,"value"),i.editButtonView.bind("isEnabled").to(t),i.unlinkButtonView.bind("isEnabled").to(s),this.listenTo(i,"edit",()=>{this.openLinkBrowser(e)}),this.listenTo(i,"unlink",()=>{e.execute("unlink"),this.hideUI()}),i.keystrokes.set("Esc",(n,a)=>{this.hideUI(),a()}),i}createToolbarLinkButtons(){const e=this.editor,i=e.commands.get("link"),t=e.t;e.keystrokes.set(h.LINK_KEYSTROKE,(s,n)=>{n(),i.isEnabled&&this.showUI()}),e.ui.componentFactory.add("link",s=>{const n=new k.ButtonView(s);return n.isEnabled=!0,n.label=t("Link"),n.icon=y,n.keystroke=h.LINK_KEYSTROKE,n.tooltip=!0,n.isToggleable=!0,n.bind("isEnabled").to(i,"isEnabled"),n.bind("isOn").to(i,"value",a=>!!a),this.listenTo(n,"execute",()=>this.showUI()),n})}enableUserBalloonInteractions(){const e=this.editor.editing.view.document;this.listenTo(e,"click",()=>{this.getSelectedLinkElement()&&this.showUI()}),this.editor.keystrokes.set("Esc",(i,t)=>{this.isUIVisible()&&(this.hideUI(),t())})}addActionsView(){this.areActionsInPanel()||this.balloon.add({view:this.actionsView,position:this.getBalloonPositionData()})}hideUI(){if(!this.isUIInPanel())return;const e=this.editor;this.stopListening(e.ui,"update"),this.stopListening(this.balloon,"change:visibleView"),e.editing.view.focus(),this.balloon.remove(this.actionsView),this.hideFakeVisualSelection()}showUI(){this.getSelectedLinkElement()?(this.addActionsView(),this.balloon.showStack("main")):(this.showFakeVisualSelection(),this.openLinkBrowser(this.editor)),this.startUpdatingUI()}startUpdatingUI(){const e=this.editor,i=e.editing.view.document;let t=this.getSelectedLinkElement(),s=a();const n=()=>{const o=this.getSelectedLinkElement(),l=a();t&&!o||!t&&l!==s?this.hideUI():this.isUIVisible()&&this.balloon.updatePosition(this.getBalloonPositionData()),t=o,s=l};function a(){return i.selection.focus.getAncestors().reverse().find(o=>o.is("element"))}this.listenTo(e.ui,"update",n),this.listenTo(this.balloon,"change:visibleView",n)}areActionsInPanel(){return this.balloon.hasView(this.actionsView)}areActionsVisible(){return this.balloon.visibleView===this.actionsView}isUIInPanel(){return this.areActionsInPanel()}isUIVisible(){return this.areActionsVisible()}getBalloonPositionData(){const e=this.editor.editing.view,i=this.editor.model,t=e.document;let s=null;if(i.markers.has(d)){const n=Array.from(this.editor.editing.mapper.markerNameToElements(d)),a=e.createRange(e.createPositionBefore(n[0]),e.createPositionAfter(n[n.length-1]));s=e.domConverter.viewRangeToDom(a)}else s=()=>{const n=this.getSelectedLinkElement();return n?e.domConverter.mapViewToDom(n):e.domConverter.viewRangeToDom(t.selection.getFirstRange())};return{target:s}}getSelectedLinkElement(){const e=this.editor.editing.view,i=e.document.selection,t=i.getSelectedElement();if(i.isCollapsed||t&&R.isWidget(t))return this.findLinkElementAncestor(i.getFirstPosition());{const s=i.getFirstRange().getTrimmed(),n=this.findLinkElementAncestor(s.start),a=this.findLinkElementAncestor(s.end);return!n||n!=a?null:e.createRangeIn(n).getTrimmed().isEqual(s)?n:null}}showFakeVisualSelection(){const e=this.editor.model;e.change(i=>{const t=e.document.selection.getFirstRange();if(e.markers.has(d))i.updateMarker(d,{range:t});else if(t.start.isAtEnd){const s=t.start.getLastMatchingPosition(({item:n})=>!e.schema.isContent(n),{startPosition:null,boundaries:t});i.addMarker(d,{usingOperation:!1,affectsData:!1,range:i.createRange(s,t.end)})}else i.addMarker(d,{usingOperation:!1,affectsData:!1,range:t})})}hideFakeVisualSelection(){const e=this.editor.model;e.markers.has(d)&&e.change(i=>{i.removeMarker(d)})}findLinkElementAncestor(e){return e.getAncestors().find(i=>h.isLinkElement(i))}openLinkBrowser(e){const i=e.commands.get("link");let t="";if(i.value){t+="&P[curUrl][url]="+encodeURIComponent(i.value);for(const[s,n]of Object.entries(i.attrs))t+="&P[curUrl]["+encodeURIComponent(s)+"]="+encodeURIComponent(n)}this.openElementBrowser(e,"Link",this.makeUrlFromModulePath(e,e.config.get("typo3link")?.routeUrl,t))}makeUrlFromModulePath(e,i,t){return i+(i.indexOf("?")===-1?"?":"&")+"&contentsLanguage=en&editorId=123"+(t||"")}openElementBrowser(e,i,t){f.advanced({type:f.types.iframe,title:i,content:t,size:f.sizes.large,callback:s=>{s.userData.editor=e,s.userData.selectionStartPosition=e.model.document.selection.getFirstPosition(),s.userData.selectionEndPosition=e.model.document.selection.getLastPosition(),s.querySelector(".t3js-modal-body")?.setAttribute("id","123")}})}}class I extends m.Plugin{static{this.pluginName="Typo3Link"}static{this.requires=["GeneralHtmlSupport",g.LinkEditing,g.AutoLink,T,U]}static{this.overrides=[g.Link]}}export{V as LINK_ALLOWED_ATTRIBUTES,I as Typo3Link,S as Typo3LinkActionsView,w as Typo3LinkCommand,T as Typo3LinkEditing,U as Typo3LinkUI,E as Typo3TextView,L as Typo3UnlinkCommand,C as addLinkPrefix,I as default,v as removeLinkPrefix};
