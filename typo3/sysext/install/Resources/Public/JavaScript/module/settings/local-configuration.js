/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{Collapse as w}from"bootstrap";import"@typo3/install/renderable/clearable.js";import{AbstractInteractableModule as C}from"@typo3/install/module/abstract-interactable-module.js";import T from"@typo3/backend/modal.js";import m from"@typo3/backend/notification.js";import v from"@typo3/core/ajax/ajax-request.js";import h from"@typo3/install/router.js";import g from"@typo3/core/event/regular-event.js";import{KeyTypesEnum as A}from"@typo3/backend/enum/key-types.js";var i;(function(c){c.item=".t3js-localConfiguration-item",c.toggleAllTrigger=".t3js-localConfiguration-toggleAll",c.writeTrigger=".t3js-localConfiguration-write",c.searchTrigger=".t3js-localConfiguration-search",c.createRowTrigger=".t3js-localConfiguration-createRow",c.removeRowTrigger=".t3js-localConfiguration-removeRow",c.configurationItem=".t3js-localConfiguration-configuration-item"})(i||(i={}));class S extends C{initialize(r){super.initialize(r),this.getContent(),new g("click",t=>{t.preventDefault(),this.write()}).delegateTo(r,i.writeTrigger),new g("click",()=>{const o=this.getModalBody().querySelectorAll(".panel-collapse");o.forEach(a=>{const l=o[0].classList.contains("show")?"hide":"show";w.getOrCreateInstance(a)[l]()})}).delegateTo(r,i.toggleAllTrigger),new g("keydown",t=>{const o=r.querySelector(i.searchTrigger);t.ctrlKey||t.metaKey?(t.key==="f"||t.key==="F")&&(t.preventDefault(),o.focus()):t.key===A.ESCAPE&&(t.preventDefault(),o.value="",o.focus())}).bindTo(r),new g("input",(t,o)=>{const a=o.value;this.search(a)}).delegateTo(r,i.searchTrigger),new g("change",(t,o)=>{const a=o.value;this.search(a)}).delegateTo(r,i.searchTrigger),new g("click",(t,o)=>{t.preventDefault(),o.closest(i.configurationItem)?.remove()}).delegateTo(r,i.removeRowTrigger),new g("click",(t,o)=>{t.preventDefault();const a=o.closest(".t3js-configuration-list");if(a===null)return;const l=f=>{const n=a.querySelectorAll(f);return n.item(n.length-1)},e=a.querySelectorAll(i.configurationItem);for(const f of e){const n=f.querySelectorAll('input[type="text"]');let p,d;if(a.dataset.type==="map")p=n.item(0).value.trim(),d=n.item(1).value.trim();else if(a.dataset.type==="element-list")p=void 0,d=n[0].value.trim();else return;if(p===""||d===""){for(const y of n)if(y.value===""){y.focus();return}}}const s=a.querySelector("#"+a.dataset.namespace).content.cloneNode(!0);a.querySelector(".configuration-map-item-collection").append(s),l(i.configurationItem).querySelector('input[type="text"]')?.focus()}).delegateTo(r,i.createRowTrigger)}search(r){this.currentModal.querySelectorAll(i.item).forEach(t=>{t.textContent.toLowerCase().trim().includes(r.toLowerCase())?(t.classList.remove("hidden"),t.classList.add("searchhit")):(t.classList.remove("searchhit"),t.classList.add("hidden"))}),this.currentModal.querySelectorAll(".searchhit").forEach(t=>{const o=t.closest(".panel-collapse");w.getOrCreateInstance(o).show()})}getContent(){const r=this.getModalBody();new v(h.getUrl("localConfigurationGetContent")).get({cache:"no-cache"}).then(async t=>{const o=await t.resolve();o.success===!0&&(r.innerHTML=o.html,T.setButtons(o.buttons),this.searchInput=r.querySelector(i.searchTrigger),this.searchInput.clearable())},t=>{h.handleAjaxError(t,r)})}write(){this.setModalButtonsState(!1);const r=this.getModalBody(),t=this.getModuleContent().dataset.localConfigurationWriteToken,o={},a={},l={};this.currentModal.querySelectorAll(".t3js-localConfiguration-pathValue").forEach(e=>{if(e.type==="checkbox")e.checked?o[e.dataset.path]="1":o[e.dataset.path]="0";else if(e.dataset.valuetype==="map"||e.dataset.valuetype==="element-list"){if(e.dataset.path.includes("/key[]")&&e.value!==""){const s=e.dataset.path.replace("/key[]","");a[s]===void 0&&(a[s]=[]),a[s].push(e.value)}else if(e.dataset.path.includes("/value[]")&&e.value!==""){const s=e.dataset.path.replace("/value[]","");l[s]===void 0&&(l[s]=[]),l[s].push(e.value)}}else o[e.dataset.path]=e.value});for(const e in l)if(Object.prototype.hasOwnProperty.call(l,e)){o[e]===void 0&&(o[e]={});const s=o[e];l[e].forEach((u,f)=>{if(u!=="")if(a[e]&&a[e][f]!==void 0&&a[e][f]!==""){const n=a[e][f];s[n]=u}else s[f]=u})}new v(h.getUrl()).post({install:{action:"localConfigurationWrite",token:t,configurationValues:o}}).then(async e=>{const s=await e.resolve();s.success===!0&&Array.isArray(s.status)?s.status.forEach(u=>{m.showMessage(u.title,u.message,u.severity)}):m.error("Something went wrong","The request was not processed successfully. Please check the browser's console and TYPO3's log.")},e=>{h.handleAjaxError(e,r)}).finally(()=>{this.setModalButtonsState(!0)})}}var k=new S;export{k as default};
