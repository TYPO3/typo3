/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{Collapse as d}from"bootstrap";import"@typo3/install/renderable/clearable.js";import{AbstractInteractableModule as w}from"@typo3/install/module/abstract-interactable-module.js";import m from"@typo3/backend/modal.js";import p from"@typo3/backend/notification.js";import y from"@typo3/core/ajax/ajax-request.js";import h from"@typo3/install/router.js";import g from"@typo3/core/event/regular-event.js";import{KeyTypesEnum as v}from"@typo3/backend/enum/key-types.js";var l;(function(c){c.item=".t3js-localConfiguration-item",c.toggleAllTrigger=".t3js-localConfiguration-toggleAll",c.writeTrigger=".t3js-localConfiguration-write",c.searchTrigger=".t3js-localConfiguration-search",c.cloneRowTrigger=".t3js-localConfiguration-cloneRow",c.removeRowTrigger=".t3js-localConfiguration-removeRow",c.arrayRowTrigger=".t3js-localConfiguration-array-clone"})(l||(l={}));class T extends w{initialize(s){super.initialize(s),this.getContent(),new g("click",t=>{t.preventDefault(),this.write()}).delegateTo(s,l.writeTrigger),new g("click",()=>{const o=this.getModalBody().querySelectorAll(".panel-collapse");o.forEach(a=>{const i=o[0].classList.contains("show")?"hide":"show";d.getOrCreateInstance(a)[i]()})}).delegateTo(s,l.toggleAllTrigger),new g("keydown",t=>{const o=s.querySelector(l.searchTrigger);t.ctrlKey||t.metaKey?(t.key==="f"||t.key==="F")&&(t.preventDefault(),o.focus()):t.key===v.ESCAPE&&(t.preventDefault(),o.value="",o.focus())}).bindTo(s),new g("input",(t,o)=>{const a=o.value;this.search(a)}).delegateTo(s,l.searchTrigger),new g("change",(t,o)=>{const a=o.value;this.search(a)}).delegateTo(s,l.searchTrigger),new g("click",(t,o)=>{t.preventDefault();const a=o.closest(l.arrayRowTrigger);a&&a.parentNode?.removeChild(a)}).delegateTo(s,l.removeRowTrigger),new g("click",(t,o)=>{t.preventDefault();const a=o.closest(l.arrayRowTrigger);if(!a)return;const i=Array.from(a.querySelectorAll("input"));let e,r;if(a.dataset.valuetype==="map")e=i[0].value.trim(),r=i[1].value.trim();else if(a.dataset.valuetype==="element-list")r=i[0].value.trim(),e="empty";else return;if(!e||!r){a.style.animation="record-pulse 0.5s ease-in-out 5",setTimeout(()=>{a.style.animation=""},2500);return}const n=a.cloneNode(!0);a.parentNode?.insertBefore(n,a),i.forEach(f=>{f.value=""});const u=n.querySelector(l.cloneRowTrigger);u&&(u.classList.add("d-none"),n.querySelector(l.removeRowTrigger)?.classList.remove("d-none"))}).delegateTo(s,l.cloneRowTrigger)}search(s){this.currentModal.querySelectorAll(l.item).forEach(t=>{t.textContent.toLowerCase().trim().includes(s.toLowerCase())?(t.classList.remove("hidden"),t.classList.add("searchhit")):(t.classList.remove("searchhit"),t.classList.add("hidden"))}),this.currentModal.querySelectorAll(".searchhit").forEach(t=>{const o=t.closest(".panel-collapse");d.getOrCreateInstance(o).show()})}getContent(){const s=this.getModalBody();new y(h.getUrl("localConfigurationGetContent")).get({cache:"no-cache"}).then(async t=>{const o=await t.resolve();o.success===!0&&(s.innerHTML=o.html,m.setButtons(o.buttons),this.searchInput=s.querySelector(l.searchTrigger),this.searchInput.clearable())},t=>{h.handleAjaxError(t,s)})}write(){this.setModalButtonsState(!1);const s=this.getModalBody(),t=this.getModuleContent().dataset.localConfigurationWriteToken,o={},a={},i={};this.currentModal.querySelectorAll(".t3js-localConfiguration-pathValue").forEach(e=>{if(e.type==="checkbox")e.checked?o[e.dataset.path]="1":o[e.dataset.path]="0";else if(e.dataset.valuetype==="map"||e.dataset.valuetype==="element-list"){if(e.dataset.path.includes("/key[]")&&e.value!==""){const r=e.dataset.path.replace("/key[]","");a[r]===void 0&&(a[r]=[]),a[r].push(e.value)}else if(e.dataset.path.includes("/value[]")&&e.value!==""){const r=e.dataset.path.replace("/value[]","");i[r]===void 0&&(i[r]=[]),i[r].push(e.value)}}else o[e.dataset.path]=e.value});for(const e in i)if(Object.prototype.hasOwnProperty.call(i,e)){o[e]===void 0&&(o[e]={});const r=o[e];i[e].forEach((n,u)=>{if(n!=="")if(a[e]&&a[e][u]!==void 0&&a[e][u]!==""){const f=a[e][u];r[f]=n}else r[u]=n})}new y(h.getUrl()).post({install:{action:"localConfigurationWrite",token:t,configurationValues:o}}).then(async e=>{const r=await e.resolve();r.success===!0&&Array.isArray(r.status)?r.status.forEach(n=>{p.showMessage(n.title,n.message,n.severity)}):p.error("Something went wrong","The request was not processed successfully. Please check the browser's console and TYPO3's log.")},e=>{h.handleAjaxError(e,s)}).finally(()=>{this.setModalButtonsState(!0)})}}var C=new T;export{C as default};
