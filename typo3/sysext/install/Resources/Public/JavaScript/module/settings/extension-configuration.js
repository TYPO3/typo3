/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{Collapse as h}from"bootstrap";import"@typo3/install/renderable/clearable.js";import"@typo3/install/renderable/wrap-group.js";import"@typo3/install/renderable/offset-group.js";import{AbstractInteractableModule as w}from"@typo3/install/module/abstract-interactable-module.js";import y from"@typo3/backend/module-menu.js";import d from"@typo3/backend/notification.js";import p from"@typo3/core/ajax/ajax-request.js";import l from"@typo3/install/router.js";import{topLevelModuleImport as u}from"@typo3/backend/utility/top-level-module-import.js";import c from"@typo3/core/event/regular-event.js";import g from"@typo3/core/event/debounce-event.js";import{KeyTypesEnum as m}from"@typo3/backend/enum/key-types.js";var n;(function(f){f.formListener=".t3js-extensionConfiguration-form",f.searchInput=".t3js-extensionConfiguration-search"})(n||(n={}));class C extends w{initialize(o){super.initialize(o),this.getContent(),new c("keydown",e=>{const t=o.querySelector(n.searchInput);e.ctrlKey||e.metaKey?(e.key==="f"||e.key==="F")&&(e.preventDefault(),t.focus()):e.key===m.ESCAPE&&t.value.trim()!==""&&(e.preventDefault(),t.value="",t.focus())}).bindTo(o),new g("input",(e,t)=>{const r=t.value;this.search(r)},100).delegateTo(o,n.searchInput),new c("change",(e,t)=>{const r=t.value;this.search(r)}).delegateTo(o,n.searchInput),new c("submit",(e,t)=>{e.preventDefault(),this.write(t)}).delegateTo(o,n.formListener)}search(o){this.currentModal.querySelectorAll(".search-item").forEach(e=>{o===""||e.textContent.toLowerCase().trim().includes(o.toLowerCase())?(e.classList.add("searchhit"),e.classList.remove("hidden")):(e.classList.remove("searchhit"),e.classList.add("hidden"))}),this.currentModal.querySelectorAll(".searchhit").forEach(e=>{h.getOrCreateInstance(e).show()})}getContent(){const o=this.getModalBody();new p(l.getUrl("extensionConfigurationGetContent")).get({cache:"no-cache"}).then(async e=>{const t=await e.resolve();t.success===!0&&(o.innerHTML=t.html,o.querySelector(n.searchInput).clearable(),this.initializeWrap(),this.initializeColorPicker())},e=>{l.handleAjaxError(e,o)})}initializeColorPicker(){window.location!==window.parent.location?u("@typo3/backend/color-picker.js"):import("@typo3/backend/color-picker.js")}write(o){const e=this.getModalBody(),t=this.getModuleContent().dataset.extensionConfigurationWriteToken,r={};for(const[s,i]of new FormData(o))r[s]=i.toString();new p(l.getUrl()).post({install:{token:t,action:"extensionConfigurationWrite",extensionKey:o.dataset.extensionKey,extensionConfiguration:r}}).then(async s=>{const i=await s.resolve();i.success===!0&&Array.isArray(i.status)?(i.status.forEach(a=>{d.showMessage(a.title,a.message,a.severity)}),document.body.dataset.context==="backend"&&y.App.refreshMenu()):d.error("Something went wrong","The request was not processed successfully. Please check the browser's console and TYPO3's log.")},s=>{l.handleAjaxError(s,e)})}initializeWrap(){window.location!==window.parent.location&&(u("@typo3/install/renderable/wrap-group.js"),u("@typo3/install/renderable/offset-group.js")),this.currentModal.querySelectorAll(".t3js-emconf-offset").forEach(e=>{const t=e.parentElement;e.setAttribute("data-offsetfield-x","#"+e.id+"_offset_x"),e.setAttribute("data-offsetfield-y","#"+e.id+"_offset_y"),e.classList.add("hidden");const r=t.ownerDocument.createElement("typo3-install-offset-group");r.offsetId=e.id,r.values=e.value.split(","),t.appendChild(r),t.querySelectorAll(".t3js-emconf-offsetfield").forEach(s=>{new c("keyup",i=>{const a=t.querySelector(i.currentTarget.dataset.target);a.value=t.querySelector(a.dataset.offsetfieldX).value+","+t.querySelector(a.dataset.offsetfieldY).value}).bindTo(s)})}),this.currentModal.querySelectorAll(".t3js-emconf-wrap").forEach(e=>{const t=e.parentElement;e.setAttribute("data-wrapfield-start","#"+e.id+"_wrap_start"),e.setAttribute("data-wrapfield-end","#"+e.id+"_wrap_end"),e.classList.add("hidden");const r=t.ownerDocument.createElement("typo3-install-wrap-group");r.wrapId=e.id,r.values=e.value.split("|"),t.appendChild(r),t.querySelectorAll(".t3js-emconf-wrapfield").forEach(s=>{new c("keyup",i=>{const a=t.querySelector(i.currentTarget.dataset.target);a.value=t.querySelector(a.dataset.wrapfieldStart).value+"|"+t.querySelector(a.dataset.wrapfieldEnd).value}).bindTo(s)})})}}var v=new C;export{v as default};
