/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import T from"@typo3/core/document-service.js";import c from"jquery";import q from"@typo3/backend/form-engine-validation.js";import f from"@typo3/backend/modal.js";import*as D from"@typo3/backend/utility/message-utility.js";import v from"@typo3/backend/severity.js";import*as P from"@typo3/backend/backend-exception.js";import j from"@typo3/backend/event/interaction-request-map.js";import A from"@typo3/backend/utility.js";import{selector as p}from"@typo3/core/literals.js";import"@typo3/backend/form-engine/element/extra/char-counter.js";import S,{ModifierKeys as O}from"@typo3/backend/hotkeys.js";import b from"@typo3/core/event/regular-event.js";import l from"~labels/backend.alt_doc";import _ from"~labels/core.core";var H=function(){function L(t,n){n?e.interactionRequestMap.resolveFor(t):e.interactionRequestMap.rejectFor(t)}const E=new Map;E.set("typo3-backend-form-update-value",t=>{const n=document.querySelector(p`[name="${t.elementName}"]`),o=document.querySelector(p`[data-formengine-input-name="${t.elementName}"]`);e.Validation.updateInputField(t.elementName),n!==null&&(e.markFieldAsChanged(n),e.Validation.validateField(n)),o!==null&&o!==n&&e.Validation.validateField(o)}),E.set("typo3-backend-form-reload",t=>{const n=()=>{e.Validation.suspend(),e.saveDocument(),e.Validation.resume()};if(!t.confirmation){n();return}const o=f.advanced({title:_.get("mess.refreshRequired.title"),content:_.get("mess.refreshRequired.content"),severity:v.warning,staticBackdrop:!0,buttons:[{text:_.get("mess.refreshRequired.cancel"),active:!0,btnClass:"btn-default",name:"cancel",trigger:()=>{o.hideModal()}},{text:_.get("mess.refreshRequired.confirm"),btnClass:"btn-"+v.getCssClass(v.warning),name:"ok",trigger:()=>{e.disableDocHeaderButtons(),e.closeModalsRecursive(),n()}}]})}),E.set("typo3-backend-form-update-bitmask",(t,n)=>{const o=n.target,a=e.formElement[t.elementName],i=o.checked!==t.invert,r=Math.pow(2,t.position),d=Math.pow(2,t.total)-r-1;a.value=i?a.value|r:a.value&d,a.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0}))});let F=!1,N=null;const e={consumeTypes:["typo3.setUrl","typo3.beforeSetUrl","typo3.refresh"],Validation:q,interactionRequestMap:j,formName:TYPO3.settings.FormEngine.formName,formElement:void 0,openedPopupWindow:null,browserUrl:"",doSaveFieldName:""};return Object.defineProperty(e,"formElement",{get:()=>document.forms.namedItem(e.formName),enumerable:!0,configurable:!1}),e.ready=async function(){return N??(N=async function(){F||await new Promise(n=>e.formElement.addEventListener("typo3:form-engine:ready",()=>n(),{once:!0}))}())},e.openPopupWindow=function(t,n,o){const a={mode:t,bparams:n};return o&&(t==="db"?a.expandPage=o:a.expandFolder=o),f.advanced({type:f.types.iframe,content:e.browserUrl+"&"+new URLSearchParams(a).toString(),size:f.sizes.large})},e.setSelectOptionFromExternalSource=function(t,n,o,a,i=[],r=void 0){let d,s,u=!1,h=!1;s=e.getFieldElement(t),d=s.get(0);const m=s.get(0);if(m===null||n==="--div--"||m instanceof HTMLOptGroupElement)return;const k=e.getFieldElement(t,"_list",!0);if(k.length>0&&(s=k,d=s.get(0),u=s.prop("multiple")&&s.prop("size")!="1",h=!0),u||h){const w=e.getFieldElement(t,"_avail"),C=w.get(0);if(!u){for(const g of d.querySelectorAll("option")){const y=w.find(p`option[value="${c(g).attr("value")}"]`);y.length&&(y.removeClass("hidden").prop("disabled",!1),e.enableOptGroup(y.get(0)))}s.empty()}if(i.length>0){let g=!1;(i.includes(n)||s.find("option").length==1&&i.includes(s.find("option").prop("value")))&&(s.empty(),g=!0),g&&typeof r<"u"&&r.closest("select").querySelectorAll("[disabled]").forEach(function(y){y.classList.remove("hidden"),y.disabled=!1,e.enableOptGroup(y)})}let M=!0;const x=e.getFieldElement(t,"_mul",!0);if(x.length==0||x.val()==0){for(const g of d.querySelectorAll("option"))if(g.value==n){M=!1;break}if(M&&typeof r<"u"){r.classList.add("hidden"),r.disabled=!0;const g=r.parentElement;g instanceof HTMLOptGroupElement&&g.querySelectorAll("option:not([disabled]):not([hidden]):not(.hidden)").length===0&&(g.disabled=!0,g.classList.add("hidden"))}}if(M){const g=c("<option></option>");g.attr({value:n,title:a}).text(o),g.appendTo(s),e.updateHiddenFieldValueFromSelect(d,m),e.markFieldAsChanged(m),e.Validation.validateField(d),e.Validation.validateField(C)}}else{const w=/_(\d+)$/,C=n.toString().match(w);C!=null&&(n=C[1]),s.val(n),e.Validation.validateField(d)}},e.updateHiddenFieldValueFromSelect=function(t,n){const o=Array.from(t.options).map(a=>a.value);n.value=o.join(","),n.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0}))},e.getFieldElement=function(t,n,o){if(n){let a;switch(n){case"_list":a=c(p`:input[data-formengine-input-name="${t}"]:not([type=hidden])`,e.formElement);break;case"_avail":a=c(p`:input[data-relatedfieldname="${t}"]`,e.formElement);break;case"_mul":a=c(p`:input[type=hidden][data-formengine-input-name="${t}"]`,e.formElement);break;default:a=null;break}if(a&&a.length>0||o===!0)return a}return c(e.formElement.elements.namedItem(t))},e.initializeEvents=function(){top.TYPO3&&typeof top.TYPO3.Backend<"u"&&(top.TYPO3.Backend.consumerScope.attach(e),window.addEventListener("pagehide",()=>top.TYPO3.Backend.consumerScope.detach(e),{once:!0})),new b("click",t=>{t.preventDefault(),e.preventExitIfNotSaved(e.preventExitIfNotSavedCallback)}).delegateTo(document,".t3js-editform-close"),new b("click",t=>{t.preventDefault(),e.previewAction(t,e.previewActionCallback)}).delegateTo(document,".t3js-editform-view"),new b("click",t=>{t.preventDefault(),e.newAction(t,e.newActionCallback)}).delegateTo(document,".t3js-editform-new"),new b("click",t=>{t.preventDefault(),e.duplicateAction(t,e.duplicateActionCallback)}).delegateTo(document,".t3js-editform-duplicate"),new b("click",t=>{t.preventDefault(),e.deleteAction(t,e.deleteActionCallback)}).delegateTo(document,".t3js-editform-delete-record"),new b("change",(t,n)=>{n.closest(".t3js-formengine-field-item").classList.toggle("disabled")}).delegateTo(document,'.t3-form-field-eval-null-checkbox input[type="checkbox"]'),new b("change",(t,n)=>{e.toggleCheckboxField(n),e.markFieldAsChanged(n)}).delegateTo(document,'.t3js-form-field-eval-null-placeholder-checkbox input[type="checkbox"]'),new b("click",(t,n)=>{t.preventDefault(),t.stopPropagation();const o=n.dataset.mode,a=n.dataset.params,i=n.dataset.entryPoint;e.openPopupWindow(o,a,i)}).delegateTo(document,".t3js-element-browser"),new b("click",(t,n)=>{const o=JSON.parse(n.dataset.formengineFieldChangeItems);e.processOnFieldChange(o,t)}).delegateTo(document,'[data-formengine-field-change-event="click"]'),new b("change",(t,n)=>{const o=JSON.parse(n.dataset.formengineFieldChangeItems);e.processOnFieldChange(o,t)}).delegateTo(document,'[data-formengine-field-change-event="change"]'),e.formElement.addEventListener("submit",function(t){const n=t.target;if(n.closeDoc?.value==="0"&&t.submitter!==null&&(t.submitter.tagName==="A"||t.submitter.hasAttribute("form"))&&!t.defaultPrevented){const o=n.querySelector(p`input[name="${e.doSaveFieldName}"]`);o!==null&&(o.value="1")}}),window.addEventListener("message",e.handlePostMessage)},e.consume=function(t){if(!t)throw new P.BackendException("No interaction request given",1496589980);let n;const o=new Promise((a,i)=>{n={resolve:a,reject:i}});if(t.concernsTypes(e.consumeTypes)){const a=t.outerMostRequest;e.interactionRequestMap.attachFor(a,n),a.isProcessed()?L(a,a.getProcessedData().response):e.hasChange()||e.isNew()?e.preventExitIfNotSaved(function(i){a.setProcessedData({response:i}),L(a,i)}):e.interactionRequestMap.resolveFor(a)}return o},e.handlePostMessage=function(t){if(!D.MessageUtility.verifyOrigin(t.origin))throw"Denied message sent by "+t.origin;if(t.data.actionName==="typo3:elementBrowser:elementAdded"){if(typeof t.data.fieldName>"u")throw"fieldName not defined in message";if(typeof t.data.value>"u")throw"value not defined in message";const n=t.data.label||t.data.value,o=t.data.title||n,a=A.trimExplode(",",t.data?.exclusiveValues??"");e.setSelectOptionFromExternalSource(t.data.fieldName,t.data.value,n,o,a)}},e.initializeRemainingCharacterViews=function(){document.querySelectorAll('[maxlength]:not([data-input-type="datetimepicker"]):not(.t3js-color-picker)').forEach(n=>{const o=n.closest(".t3js-formengine-field-item");if(o!==null&&o.querySelector("typo3-backend-formengine-char-counter")===null){const a=document.createElement("typo3-backend-formengine-char-counter");a.setAttribute("target",`[data-formengine-input-name="${p`${n.dataset.formengineInputName}`}"]`),o.append(a)}})},e.initializeMinimumCharactersLeftViews=function(){const t=(a,i)=>{const r=i.currentTarget.closest(".t3js-formengine-field-item"),d=r.querySelector(".t3js-charcounter-min"),s=_.get("labels.remainingCharacters",a);if(d)d.querySelector("span").innerHTML=s;else{const u=document.createElement("div");u.classList.add("t3js-charcounter-min");const h=document.createElement("span");h.classList.add("badge","badge-danger"),h.innerHTML=s,u.append(h);let m=r.querySelector(".t3js-charcounter-wrapper");m||(m=document.createElement("div"),m.classList.add("t3js-charcounter-wrapper"),r.append(m)),m.prepend(u)}},n=a=>{const r=a.currentTarget.closest(".t3js-formengine-field-item").querySelector(".t3js-charcounter-min");r&&r.remove()};document.querySelectorAll('[minlength]:not([data-input-type="datetimepicker"]):not(.t3js-charcounter-min-initialized)').forEach(a=>{a.addEventListener("focus",i=>{const r=e.getMinCharacterLeftCount(a);r>0&&t(r,i)}),a.addEventListener("blur",n),a.addEventListener("keyup",i=>{const r=e.getMinCharacterLeftCount(a);r>0?t(r,i):n(i)})})},e.getMinCharacterLeftCount=function(t){const n=t.value,o=t.minLength,a=n.length;if(a===0)return 0;const i=(n.match(/\n/g)||[]).length;return o-a-i},e.initializeNullNoPlaceholderCheckboxes=function(){document.querySelectorAll(".t3-form-field-eval-null-checkbox").forEach(t=>{const n=t.querySelector('input[type="checkbox"]'),o=t.closest(".t3js-formengine-field-item");n.checked||o.classList.add("disabled")})},e.initializeNullWithPlaceholderCheckboxes=function(){document.querySelectorAll(".t3js-form-field-eval-null-placeholder-checkbox").forEach(t=>{e.toggleCheckboxField(t.querySelector('input[type="checkbox"]'),!1)})},e.toggleCheckboxField=function(t,n=!0){const o=t.closest(".t3js-formengine-field-item"),a=o.querySelector(".t3js-formengine-placeholder-placeholder"),i=o.querySelector(".t3js-formengine-placeholder-formfield");t.checked?(a.hidden=!0,i.hidden=!1,n&&i.querySelector("input,select,textarea")?.focus()):(a.hidden=!1,i.hidden=!0)},e.reinitialize=function(){const t=document.querySelectorAll(".t3js-clearable");t.length>0&&import("@typo3/backend/input/clearable.js").then(function(){t.forEach(n=>n.clearable())}),e.initializeNullNoPlaceholderCheckboxes(),e.initializeNullWithPlaceholderCheckboxes(),e.initializeLocalizationStateSelector(),e.initializeMinimumCharactersLeftViews(),e.initializeRemainingCharacterViews()},e.initializeLocalizationStateSelector=function(){document.querySelectorAll(".t3js-l10n-state-container").forEach(t=>{const n=t.closest(".t3js-formengine-field-item")?.querySelector("[data-formengine-input-name]");if(n==null)return;const o=t.querySelector('input[type="radio"]:checked')?.value;o===void 0&&console.warn("The localization state of the field "+n.dataset.formengineInputName+" cannot be determined. This smells like a DataHandler bug."),(o==="parent"||o==="source")&&(n.disabled=!0)})},e.hasChange=function(){const t=c(p`form[name="${e.formName}"] .has-change`).length>0,n=c('[name^="data["].has-change').length>0;return t||n},e.isNew=function(){return document.querySelector('form[name="'+e.formName+'"] .typo3-TCEforms.is-new')!==null},e.markFieldAsChanged=function(t){t.classList.add("has-change");const n=t.closest(".t3js-formengine-palette-field")?.querySelector(".t3js-formengine-label");n!==null&&n.classList.add("has-change")},e.preventExitIfNotSavedCallback=()=>{e.closeDocument()},e.preventFollowLinkIfNotSaved=function(t){return e.preventExitIfNotSaved(function(){window.location.href=t}),!1},e.preventExitIfNotSaved=function(t){if(t=t||e.preventExitIfNotSavedCallback,e.hasChange()||e.isNew()){const n=l.get("label.confirm.close_without_save.title"),o=l.get("label.confirm.close_without_save.content"),a=[{text:l.get("buttons.confirm.close_without_save.no"),btnClass:"btn-default",name:"no"},{text:l.get("buttons.confirm.close_without_save.yes"),btnClass:"btn-default",name:"yes"}];c(".has-error").length===0&&a.push({text:l.get("buttons.confirm.save_and_close"),btnClass:"btn-primary",name:"save",active:!0});const i=f.confirm(n,o,v.warning,a);i.addEventListener("button.clicked",function(r){r.target.name==="no"?i.hideModal():r.target.name==="yes"?(i.hideModal(),t.call(null,!0)):r.target.name==="save"&&(i.hideModal(),e.saveAndCloseDocument())})}else t.call(null,!0)},e.preventSaveIfHasErrors=function(){if(c(".has-error").length>0){const t=TYPO3.lang["label.alert.save_with_error.title"]||"You have errors in your form!",n=TYPO3.lang["label.alert.save_with_error.content"]||"Please check the form, there is at least one error in your form.",o=f.confirm(t,n,v.error,[{text:TYPO3.lang["buttons.alert.save_with_error.ok"]||"OK",btnClass:"btn-danger",name:"ok"}]);return o.addEventListener("button.clicked",function(a){a.target.name==="ok"&&o.hideModal()}),!1}return!0},e.processOnFieldChange=function(t,n){t.forEach(o=>{const a=E.get(o.name);a instanceof Function&&a.call(null,o.data||null,n)})},e.registerOnFieldChangeHandler=function(t,n){E.has(t)&&console.warn("Handler for onFieldChange name `"+t+"` has been overridden."),E.set(t,n)},e.closeModalsRecursive=function(){typeof f.currentModal<"u"&&f.currentModal!==null&&(f.currentModal.addEventListener("typo3-modal-hidden",function(){e.closeModalsRecursive()}),f.currentModal.hideModal())},e.disableDocHeaderButtons=function(){const t=document.querySelector(".t3js-module-docheader-buttons");t&&t.querySelectorAll('button, a, input[type="submit"]').forEach(n=>{n instanceof HTMLButtonElement||n instanceof HTMLInputElement?n.disabled=!0:n instanceof HTMLAnchorElement&&(n.classList.add("disabled"),n.setAttribute("aria-disabled","true"))})},e.enableDocHeaderButtons=function(){const t=document.querySelector(".t3js-module-docheader-buttons");t&&t.querySelectorAll('button, a, input[type="submit"]').forEach(n=>{n instanceof HTMLButtonElement||n instanceof HTMLInputElement?n.disabled=!1:n instanceof HTMLAnchorElement&&(n.classList.remove("disabled"),n.removeAttribute("aria-disabled"))})},e.previewAction=function(t,n){n=n||e.previewActionCallback;const o=t.target.href,a="isNew"in t.target.dataset,i=c("<input />").attr("type","hidden").attr("name","_savedokview").attr("value","1");e.hasChange()||e.isNew()?e.showPreviewModal(o,a,i,n):(c(p`form[name="${e.formName}"]`).append(i),window.open("","newTYPO3frontendWindow"),e.formElement.submit())},e.previewActionCallback=function(t,n,o){switch(f.dismiss(),t){case"discard":const a=window.open(n,"newTYPO3frontendWindow");a.focus(),A.urlsPointToSameServerSideResource(a.location.href,n)&&a.location.reload();break;case"save":c(p`form[name="${e.formName}"]`).append(c(o)),window.open("","newTYPO3frontendWindow"),e.saveDocument();break;default:break}},e.showPreviewModal=function(t,n,o,a){const i=l.get("label.confirm.view_record_changed.title"),r={text:l.get("buttons.confirm.view_record_changed.cancel"),btnClass:"btn-default",name:"cancel"},d={text:l.get("buttons.confirm.view_record_changed.no-save"),btnClass:"btn-default",name:"discard"},s={text:l.get("buttons.confirm.view_record_changed.save"),btnClass:"btn-primary",name:"save",active:!0};let u=[],h=[];if(n){if(!e.Validation.isValid()){e.Validation.showErrorModal();return}u=[r,s],h=[l.get("label.confirm.view_record_changed.content.is-new-page")]}else u=[r,d],h=[l.get("label.confirm.view_record_changed.content")],e.Validation.isValid()?u.push(s):h.push(l.get("label.confirm.view_record_changed.invalid_form"));const m=document.createElement("p");h.forEach((w,C)=>{m.append(w),C!==h.length-1&&m.append(document.createElement("br"))});const k=f.confirm(i,m,v.info,u);k.addEventListener("button.clicked",function(w){a(w.target.name,t,o,k)})},e.newAction=function(t,n){n=n||e.newActionCallback;const o=c("<input />").attr("type","hidden").attr("name","_savedoknew").attr("value","1"),a="isNew"in t.target.dataset;e.hasChange()||e.isNew()?e.showNewModal(a,o,n):(c(p`form[name="${e.formName}"]`).append(o),e.formElement.submit())},e.newActionCallback=function(t,n){const o=c(p`form[name="${e.formName}"]`);switch(f.dismiss(),t){case"no":o.append(n),e.formElement.submit();break;case"yes":o.append(n),e.saveDocument();break;default:break}},e.showNewModal=function(t,n,o){const a=l.get("label.confirm.new_record_changed.title"),i=l.get("label.confirm.new_record_changed.content");let r=[];const d={text:l.get("buttons.confirm.new_record_changed.cancel"),btnClass:"btn-default",name:"cancel"},s={text:l.get("buttons.confirm.new_record_changed.no"),btnClass:"btn-default",name:"no"},u={text:l.get("buttons.confirm.new_record_changed.yes"),btnClass:"btn-primary",name:"yes",active:!0};t?r=[d,u]:r=[d,s,u],f.confirm(a,i,v.info,r).addEventListener("button.clicked",function(m){o(m.target.name,n)})},e.duplicateAction=function(t,n){n=n||e.duplicateActionCallback;const o=c("<input />").attr("type","hidden").attr("name","_duplicatedoc").attr("value","1"),a="isNew"in t.target.dataset;e.hasChange()||e.isNew()?e.showDuplicateModal(a,o,n):(c(p`form[name="${e.formName}"]`).append(o),e.formElement.submit())},e.duplicateActionCallback=function(t,n){const o=c(p`form[name="${e.formName}"]`);switch(f.dismiss(),t){case"no":o.append(n),e.formElement.submit();break;case"yes":o.append(n),e.saveDocument();break;default:break}},e.showDuplicateModal=function(t,n,o){const a=l.get("label.confirm.duplicate_record_changed.title"),i=l.get("label.confirm.duplicate_record_changed.content");let r=[];const d={text:l.get("buttons.confirm.duplicate_record_changed.cancel"),btnClass:"btn-default",name:"cancel"},s={text:l.get("button.confirm.duplicate_record_changed.no"),btnClass:"btn-default",name:"no"},u={text:l.get("buttons.confirm.duplicate_record_changed.yes"),btnClass:"btn-primary",name:"yes",active:!0};t?r=[d,u]:r=[d,s,u],f.confirm(a,i,v.info,r).addEventListener("button.clicked",function(m){o(m.target.name,n)})},e.deleteAction=function(t,n){n=n||e.deleteActionCallback;const o=c(t.target);e.showDeleteModal(o,n)},e.deleteActionCallback=function(t,n){f.dismiss(),t==="yes"&&e.invokeRecordDeletion(n)},e.showDeleteModal=function(t,n){const o=l.get("label.confirm.delete_record.title");let a=l.get("label.confirm.delete_record.content");t.data("reference-count-message")&&(a+=`
`+t.data("reference-count-message")),t.data("translation-count-message")&&(a+=`
`+t.data("translation-count-message")),f.confirm(o,a,v.warning,[{text:l.get("buttons.confirm.delete_record.no"),btnClass:"btn-default",name:"no"},{text:l.get("buttons.confirm.delete_record.yes"),btnClass:"btn-warning",name:"yes",active:!0}]).addEventListener("button.clicked",function(r){n(r.target.name,t)})},e.enableOptGroup=function(t){const n=t.parentElement;n instanceof HTMLOptGroupElement&&n.querySelectorAll("option:not([hidden]):not([disabled]):not(.hidden)").length&&(n.hidden=!1,n.disabled=!1,n.classList.remove("hidden"))},e.closeDocument=function(){e.formElement.closeDoc.value=1,e.formElement.submit()},e.saveDocument=function(){const t=document.activeElement;(t instanceof HTMLInputElement||t instanceof HTMLSelectElement||t instanceof HTMLTextAreaElement)&&t.blur();const n=e.formElement.querySelector(p`input[name="${e.doSaveFieldName}"]`);n!==null&&(n.value="1"),e.formElement.requestSubmit()},e.saveAndCloseDocument=function(){const t=document.createElement("input");t.type="hidden",t.name="_saveandclosedok",t.value="1",document.querySelector(p`form[name="${e.formName}"]`).append(t),e.saveDocument()},e.initialize=function(t,n){e.browserUrl=t,e.doSaveFieldName=n||"doSave",T.ready().then(()=>{e.initializeEvents(),e.Validation.initialize(this),e.reinitialize(),c("#t3js-ui-block").remove(),e.enableDocHeaderButtons(),e.formElement.dispatchEvent(new Event("typo3:form-engine:ready")),F=!0,S.setScope("backend/form-engine"),S.register([S.normalizedCtrlModifierKey,"s"],o=>{o.preventDefault(),e.saveDocument()},{scope:"backend/form-engine",allowOnEditables:!0,bindElement:e.formElement._savedok}),S.register([S.normalizedCtrlModifierKey,O.SHIFT,"s"],o=>{o.preventDefault(),e.saveAndCloseDocument()},{scope:"backend/form-engine",allowOnEditables:!0})})},e.invokeRecordDeletion=function(t){window.location.href=t.attr("href")},TYPO3.FormEngine=e,e}();export{H as default};
