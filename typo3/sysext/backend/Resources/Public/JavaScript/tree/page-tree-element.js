/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{LitElement as k,html as c,nothing as w}from"lit";import{customElement as b,property as y,query as _}from"lit/decorators.js";import{until as I}from"lit/directives/until.js";import{lll as d}from"@typo3/core/lit-helper.js";import T from"@typo3/core/ajax/ajax-request.js";import C from"@typo3/backend/storage/persistent.js";import{ModuleUtility as M}from"@typo3/backend/module.js";import O from"@typo3/backend/context-menu.js";import{PageTree as $}from"@typo3/backend/tree/page-tree.js";import{TreeNodePositionEnum as p,TreeNodeCommandEnum as i}from"@typo3/backend/tree/tree-node.js";import{TreeToolbar as x}from"@typo3/backend/tree/tree-toolbar.js";import{TreeModuleState as D}from"@typo3/backend/tree/tree-module-state.js";import P from"@typo3/backend/modal.js";import E from"@typo3/backend/severity.js";import{UrlFactory as S}from"@typo3/core/factory/url-factory.js";import{ModuleStateStorage as N}from"@typo3/backend/storage/module-state-storage.js";import{DataTransferTypes as u}from"@typo3/backend/enum/data-transfer-types.js";import"@typo3/backend/viewport/content-navigation-toggle.js";import"bootstrap";var r=function(l,e,t,n){var o=arguments.length,a=o<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")a=Reflect.decorate(l,e,t,n);else for(var h=l.length-1;h>=0;h--)(s=l[h])&&(a=(o<3?s(a):o>3?s(e,t,a):s(e,t))||a);return o>3&&a&&Object.defineProperty(e,t,a),a};const F="typo3-backend-navigation-component-pagetree";let g=class extends ${constructor(){super(...arguments),this.allowNodeEdit=!0,this.allowNodeDrag=!0,this.allowNodeSorting=!0}sendChangeCommand(e){let t="",n="0";if(e.target)if(n=e.target.identifier,e.position===p.BEFORE){const o=this.getPreviousNode(e.target);n=(o.depth===e.target.depth?"-":"")+o.identifier}else e.position===p.AFTER&&(n="-"+n);if(e.command===i.NEW){const o=e;t="&data[pages]["+e.node.identifier+"][pid]="+encodeURIComponent(n)+"&data[pages]["+e.node.identifier+"][title]="+encodeURIComponent(o.title)+"&data[pages]["+e.node.identifier+"][doktype]="+encodeURIComponent(o.doktype)}else if(e.command===i.EDIT)t="&data[pages]["+e.node.identifier+"][title]="+encodeURIComponent(e.title);else if(e.command===i.DELETE){const o=N.current("web");e.node.identifier===o.identifier&&this.selectFirstNode(),t="&cmd[pages]["+e.node.identifier+"][delete]=1"}else t="cmd[pages]["+e.node.identifier+"]["+e.command+"]="+n;this.requestTreeUpdate(t).then(o=>{if(o&&o.hasErrors)this.errorNotification(o.messages);else if(e.command===i.NEW){const a=this.getParentNode(e.node);a.loaded=!1,this.loadChildren(a)}else this.refreshOrFilterTree()})}initializeDragForNode(){throw new Error("unused")}async handleNodeEdit(e,t){if(e.__loading=!0,e.identifier.startsWith("NEW")){const n=this.getPreviousNode(e),o=e.depth===n.depth?p.AFTER:p.INSIDE,a={command:i.NEW,node:e,title:t,position:o,target:n,doktype:e.doktype};await this.sendChangeCommand(a)}else{const n={command:i.EDIT,node:e,title:t};await this.sendChangeCommand(n)}e.__loading=!1}createDataTransferItemsFromNode(e){return[{type:u.treenode,data:this.getNodeTreeIdentifier(e)},{type:u.pages,data:JSON.stringify({records:[{identifier:e.identifier,tablename:"pages"}]})}]}async handleNodeAdd(e,t,n){this.updateComplete.then(()=>{this.editNode(e)})}handleNodeDelete(e){const t={node:e,command:i.DELETE};this.settings.displayDeleteConfirmation?P.confirm(TYPO3.lang["mess.delete.title"],TYPO3.lang["mess.delete"].replace("%s",t.node.name),E.warning,[{text:TYPO3.lang["labels.cancel"]||"Cancel",active:!0,btnClass:"btn-default",name:"cancel"},{text:TYPO3.lang.delete||"Delete",btnClass:"btn-warning",name:"delete"}]).addEventListener("button.clicked",o=>{o.target.name==="delete"&&this.sendChangeCommand(t),P.dismiss()}):this.sendChangeCommand(t)}handleNodeMove(e,t,n){const o={node:e,target:t,position:n,command:i.MOVE};let a="";switch(n){case p.BEFORE:a=TYPO3.lang["mess.move_before"];break;case p.AFTER:a=TYPO3.lang["mess.move_after"];break;default:a=TYPO3.lang["mess.move_into"];break}a=a.replace("%s",e.name).replace("%s",t.name);const s=P.confirm(TYPO3.lang.move_page,a,E.warning,[{text:TYPO3.lang["labels.cancel"]||"Cancel",active:!0,btnClass:"btn-default",name:"cancel"},{text:TYPO3.lang["cm.copy"]||"Copy",btnClass:"btn-warning",name:"copy"},{text:TYPO3.lang["labels.move"]||"Move",btnClass:"btn-warning",name:"move"}]);s.addEventListener("button.clicked",h=>{const v=h.target;v.name==="move"?(o.command=i.MOVE,this.sendChangeCommand(o)):v.name==="copy"&&(o.command=i.COPY,this.sendChangeCommand(o)),s.hideModal()})}requestTreeUpdate(e){return new T(top.TYPO3.settings.ajaxUrls.record_process).post(e,{headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"}}).then(t=>t.resolve()).catch(t=>{this.errorNotification(t),this.loadData()})}};g=r([b("typo3-backend-navigation-component-pagetree-tree")],g);let m=class extends D(k){constructor(){super(...arguments),this.mountPointPath=null,this.moduleStateType="web",this.configuration=null,this.refresh=()=>{this.tree.refreshOrFilterTree()},this.setMountPoint=e=>{this.setTemporaryMountPoint(e.detail.pageId)},this.selectFirstNode=()=>{this.tree.selectFirstNode()},this.loadContent=e=>{const t=e.detail.node;if(!t?.checked||(N.updateWithTreeIdentifier("web",t.identifier,t.__treeIdentifier),e.detail.propagate===!1))return;const n=top.TYPO3.ModuleMenu.App,o=S.createUrl(M.getFromName(n.getCurrentModule()).link,{id:t.identifier});top.TYPO3.Backend.ContentContainer.setUrl(o)},this.showContextMenu=e=>{const t=e.detail.node;t&&O.show(t.recordType,t.identifier,"tree","","",this.tree.getElementFromNode(t),e.detail.originalEvent)}}connectedCallback(){super.connectedCallback(),document.addEventListener("typo3:pagetree:refresh",this.refresh),document.addEventListener("typo3:pagetree:mountPoint",this.setMountPoint),document.addEventListener("typo3:pagetree:selectFirstNode",this.selectFirstNode)}disconnectedCallback(){document.removeEventListener("typo3:pagetree:refresh",this.refresh),document.removeEventListener("typo3:pagetree:mountPoint",this.setMountPoint),document.removeEventListener("typo3:pagetree:selectFirstNode",this.selectFirstNode),super.disconnectedCallback()}createRenderRoot(){return this}render(){return c`${I(this.renderTree(),"")}`}getConfiguration(){if(this.configuration!==null)return Promise.resolve(this.configuration);const e=top.TYPO3.settings.ajaxUrls.page_tree_configuration;return new T(e).get().then(async t=>{const n=await t.resolve("json");return this.configuration=n,this.mountPointPath=n.temporaryMountPoint||null,n})}async renderTree(){const e=await this.getConfiguration();return c`<typo3-backend-navigation-component-pagetree-toolbar id=typo3-pagetree-toolbar .tree=${this.tree}></typo3-backend-navigation-component-pagetree-toolbar>${this.renderMountPoint()}<typo3-backend-navigation-component-pagetree-tree id=typo3-pagetree-tree .setup=${e} @tree:initialized=${()=>{this.toolbar.tree=this.tree,this.fetchActiveNodeIfMissing()}} @typo3:tree:node-selected=${this.loadContent} @typo3:tree:node-context=${this.showContextMenu} @typo3:tree:nodes-prepared=${this.selectActiveNodeInLoadedNodes}></typo3-backend-navigation-component-pagetree-tree>`}unsetTemporaryMountPoint(){C.unset("pageTree_temporaryMountPoint").then(()=>{this.mountPointPath=null})}renderMountPoint(){return this.mountPointPath===null?w:c`<div class=node-mount-point><div class=node-mount-point__icon><typo3-backend-icon identifier=actions-info-circle size=small></typo3-backend-icon></div><div class=node-mount-point__text>${this.mountPointPath}</div><div class="node-mount-point__icon mountpoint-close" @click=${()=>this.unsetTemporaryMountPoint()} title=${d("labels.temporaryPageTreeEntryPoints")}><typo3-backend-icon identifier=actions-close size=small></typo3-backend-icon></div></div>`}setTemporaryMountPoint(e){new T(this.configuration.setTemporaryMountPointUrl).post("pid="+e,{headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"}}).then(t=>t.resolve()).then(t=>{t&&t.hasErrors?(this.tree.errorNotification(t.message),this.tree.loadData()):this.mountPointPath=t.mountPointPath}).catch(t=>{this.tree.errorNotification(t),this.tree.loadData()})}};r([y({type:String})],m.prototype,"mountPointPath",void 0),r([_("typo3-backend-navigation-component-pagetree-tree")],m.prototype,"tree",void 0),r([_("typo3-backend-navigation-component-pagetree-toolbar")],m.prototype,"toolbar",void 0),m=r([b("typo3-backend-navigation-component-pagetree")],m);let f=class extends x{constructor(){super(...arguments),this.tree=null,this.searchInTranslatedPages=!1}updated(e){super.updated(e),e.has("tree")&&this.tree?.settings?.searchInTranslatedPagesEnabled!==void 0&&(this.searchInTranslatedPages=this.tree.settings.searchInTranslatedPagesEnabled)}render(){return c`<div class=tree-toolbar><div class=tree-toolbar__menu><div class=tree-toolbar__search><label for=toolbarSearch class=visually-hidden>${d("labels.label.searchString")}</label> <input type=search id=toolbarSearch class="form-control form-control-sm search-input" placeholder=${d("tree.searchPageTree")}></div><button type=button class="btn btn-sm btn-icon btn-default btn-borderless" data-bs-toggle=dropdown data-bs-boundary=window aria-expanded=false aria-label=${d("labels.openPageTreeOptionsMenu")}><typo3-backend-icon identifier=actions-menu-alternative size=small></typo3-backend-icon></button><ul class="dropdown-menu dropdown-menu-end"><li><button class=dropdown-item @click=${()=>this.refreshTree()}><span class=dropdown-item-columns> <span class="dropdown-item-column dropdown-item-column-icon" aria-hidden=true><typo3-backend-icon identifier=actions-refresh size=small></typo3-backend-icon> </span> <span class="dropdown-item-column dropdown-item-column-title">${d("labels.refresh")} </span> </span></button></li><li><button class=dropdown-item @click=${e=>this.collapseAll(e)}><span class=dropdown-item-columns> <span class="dropdown-item-column dropdown-item-column-icon" aria-hidden=true><typo3-backend-icon identifier=apps-pagetree-category-collapse-all size=small></typo3-backend-icon> </span> <span class="dropdown-item-column dropdown-item-column-title">${d("labels.collapse")} </span> </span></button></li>${this.tree?.settings?.searchInTranslatedPagesAvailable?c`<li><hr class=dropdown-divider></li><li><button class=dropdown-item @click=${()=>this.toggleTranslationSearch()}><span class=dropdown-item-columns> <span class="dropdown-item-column dropdown-item-column-icon" aria-hidden=true><typo3-backend-icon identifier=${this.searchInTranslatedPages?"actions-check-square":"actions-selection"} size=small></typo3-backend-icon> </span> <span class="dropdown-item-column dropdown-item-column-title">${d("tree.search_in_translated_pages")} </span> </span></button></li>`:w}</ul><typo3-backend-content-navigation-toggle class="btn btn-sm btn-icon btn-default btn-borderless" action=collapse></typo3-backend-content-navigation-toggle></div><div class=tree-toolbar__submenu>${this.tree?.settings?.doktypes?.length?this.tree.settings.doktypes.map(e=>c`<div class="tree-toolbar__menuitem tree-toolbar__drag-node" title=${e.title} draggable=true data-tree-icon=${e.icon} data-node-type=${e.nodeType} aria-hidden=true @dragstart=${t=>{this.handleDragStart(t,e)}}><typo3-backend-icon identifier=${e.icon} size=small></typo3-backend-icon></div>`):""}</div></div>`}async toggleTranslationSearch(){const e=!this.searchInTranslatedPages;try{await C.set("pageTree_searchInTranslatedPages",e?"1":"0"),this.searchInTranslatedPages=e,this.tree?.settings&&(this.tree.settings.searchInTranslatedPagesEnabled=e);const t=this.querySelector(".search-input");t&&t.value.trim()!==""&&this.refreshTree()}catch(t){console.error("Failed to toggle translation search:",t)}}handleDragStart(e,t){const n={__hidden:!1,__expanded:!1,__indeterminate:!1,__loading:!1,__processed:!1,__treeDragAction:"",__treeIdentifier:"",__treeParents:[""],__parents:[""],__x:0,__y:0,deletable:!1,depth:0,editable:!0,hasChildren:!1,icon:t.icon,overlayIcon:"",identifier:"NEW"+Math.floor(Math.random()*1e9).toString(16),loaded:!1,name:"",note:"",parentIdentifier:"",prefix:"",recordType:"pages",suffix:"",tooltip:"",type:"PageTreeItem",doktype:t.nodeType,statusInformation:[],labels:[]};this.tree.draggingNode=n,this.tree.nodeDragMode=i.NEW,e.dataTransfer.clearData();const o={statusIconIdentifier:this.tree.getNodeDragStatusIcon(),tooltipIconIdentifier:t.icon,tooltipLabel:t.title};e.dataTransfer.setData(u.dragTooltip,JSON.stringify(o)),e.dataTransfer.setData(u.newTreenode,JSON.stringify(n)),e.dataTransfer.effectAllowed="move"}};r([y({type:g})],f.prototype,"tree",void 0),r([y({type:Boolean})],f.prototype,"searchInTranslatedPages",void 0),f=r([b("typo3-backend-navigation-component-pagetree-toolbar")],f);export{g as EditablePageTree,m as PageTreeNavigationComponent,F as navigationComponentName};
