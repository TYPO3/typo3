/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import $ from"jquery";import{DateTime}from"luxon";import Md5 from"@typo3/backend/hashing/md5.js";import Modal from"@typo3/backend/modal.js";import Severity from"@typo3/backend/severity.js";import Utility from"@typo3/backend/utility.js";import RegularEvent from"@typo3/core/event/regular-event.js";import DomHelper from"@typo3/backend/utility/dom-helper.js";import{selector}from"@typo3/core/literals.js";import SubmitInterceptor from"@typo3/backend/form/submit-interceptor.js";import{FormEngineReview}from"@typo3/backend/form-engine-review.js";let formEngineFormElement,validationSuspended=!1;const customEvaluations=new Map;class FormEngineValidation{static{this.rulesSelector="[data-formengine-validation-rules]"}static{this.inputSelector="[data-formengine-input-params]"}static{this.markerSelector=".t3js-formengine-validation-marker"}static{this.labelSelector=".t3js-formengine-label"}static{this.errorClass="has-error"}static{this.validationErrorClass="has-validation-error"}static{this.passwordDummy="********"}static initialize(t){formEngineFormElement=t,formEngineFormElement.querySelectorAll("."+FormEngineValidation.errorClass).forEach(e=>e.classList.remove(FormEngineValidation.errorClass)),FormEngineValidation.initializeInputFields(),new FormEngineReview(t),new RegularEvent("change",(e,a)=>{FormEngineValidation.validateField(a),FormEngineValidation.markFieldAsChanged(a)}).delegateTo(formEngineFormElement,FormEngineValidation.rulesSelector),FormEngineValidation.registerSubmitCallback(),FormEngineValidation.validate()}static initializeInputFields(){formEngineFormElement.querySelectorAll(FormEngineValidation.inputSelector).forEach(t=>{const a=JSON.parse(t.dataset.formengineInputParams).field,n=formEngineFormElement.querySelector(selector`[name="${a}"]`);"formengineInputInitialized"in t.dataset||(n.dataset.config=t.dataset.formengineInputParams,FormEngineValidation.initializeInputField(a))})}static initializeInputField(t){const e=formEngineFormElement.querySelector(selector`[name="${t}"]`),a=formEngineFormElement.querySelector(selector`[data-formengine-input-name="${t}"]`);if(e.dataset.config!==void 0){const n=JSON.parse(e.dataset.config),i=FormEngineValidation.formatByEvals(n,e.value);i.length&&(a.value=i)}new RegularEvent("change",()=>{FormEngineValidation.updateInputField(a.dataset.formengineInputName)}).bindTo(a),a.dataset.formengineInputInitialized="true"}static registerCustomEvaluation(t,e){customEvaluations.has(t)||customEvaluations.set(t,e)}static formatByEvals(t,e){if(t.evalList!==void 0){const a=Utility.trimExplode(",",t.evalList);for(const n of a)e=FormEngineValidation.formatValue(n,e)}return e}static formatValue(t,e){switch(t){case"date":case"datetime":case"time":case"timesec":if(e==="")return"";const a=DateTime.fromISO(String(e),{zone:"utc"});if(!a.isValid)throw new Error("Invalid ISO8601 DateTime string: "+e);return a.toISO({suppressMilliseconds:!0});case"password":return e?FormEngineValidation.passwordDummy:"";default:return e.toString()}}static updateInputField(t){const e=formEngineFormElement.querySelector(selector`[name="${t}"]`),a=formEngineFormElement.querySelector(selector`[data-formengine-input-name="${t}"]`);if(e.dataset.config!==void 0){const n=JSON.parse(e.dataset.config),i=FormEngineValidation.processByEvals(n,a.value),l=FormEngineValidation.formatByEvals(n,i);e.value!==i&&(e.disabled&&e.dataset.enableOnModification&&(e.disabled=!1),e.value=i,e.dispatchEvent(new Event("change"))),a.value!==l&&(a.value=l)}}static validateField(t,e){if(t instanceof $&&(console.warn("Passing a jQuery element to FormEngineValidation.validateField() is deprecated and will be removed in TYPO3 v14."),console.trace(),t=t.get(0)),!(t instanceof HTMLElement)||(e=e||t.value||"",typeof t.dataset.formengineValidationRules>"u"))return e;const a=JSON.parse(t.dataset.formengineValidationRules);let n=!1,i=0;const l=e;let s,o,m;Array.isArray(e)||(e=e.trimStart());for(const r of a){if(n)break;switch(r.type){case"required":e===""&&(n=!0,t.classList.add(FormEngineValidation.errorClass),t.closest(FormEngineValidation.markerSelector)?.querySelector(FormEngineValidation.labelSelector)?.classList.add(FormEngineValidation.errorClass));break;case"range":if(e!==""){if((r.minItems||r.maxItems)&&(s=formEngineFormElement.querySelector(selector`[name="${t.dataset.relatedfieldname}"]`),s!==null?i=Utility.trimExplode(",",s.value).length:i=parseInt(t.value,10),r.minItems!==void 0&&(o=r.minItems*1,!isNaN(o)&&i<o&&(n=!0)),r.maxItems!==void 0&&(m=r.maxItems*1,!isNaN(m)&&i>m&&(n=!0))),r.lower!==void 0)if(t.dataset.inputType==="datetimepicker"){const c=DateTime.fromISO(e,{zone:"utc"}),u=DateTime.fromISO(r.lower,{zone:"utc"});(!c.isValid||c<u.minus(u.second*1e3))&&(n=!0)}else{const c=r.lower*1;!isNaN(c)&&parseInt(e,10)<c&&(n=!0)}if(r.upper!==void 0)if(t.dataset.inputType==="datetimepicker"){const c=DateTime.fromISO(e,{zone:"utc"}),u=DateTime.fromISO(r.upper,{zone:"utc"});(!c.isValid||c>u.plus((59-u.second)*1e3))&&(n=!0)}else{const c=r.upper*1;!isNaN(c)&&parseInt(e,10)>c&&(n=!0)}}break;case"select":case"category":(r.minItems||r.maxItems)&&(s=formEngineFormElement.querySelector(selector`[name="${t.dataset.relatedfieldname}"]`),s!==null?i=Utility.trimExplode(",",s.value).length:t instanceof HTMLSelectElement?i=t.querySelectorAll("option:checked").length:i=t.querySelectorAll("input[value]:checked").length,r.minItems!==void 0&&(o=r.minItems*1,!isNaN(o)&&i<o&&(n=!0)),r.maxItems!==void 0&&(m=r.maxItems*1,!isNaN(m)&&i>m&&(n=!0)));break;case"group":case"folder":(r.minItems||r.maxItems)&&(i=Utility.trimExplode(",",t.value).length,r.minItems!==void 0&&(o=r.minItems*1,!isNaN(o)&&i<o&&(n=!0)),r.maxItems!==void 0&&(m=r.maxItems*1,!isNaN(m)&&i>m&&(n=!0)));break;case"inline":(r.minItems||r.maxItems)&&(i=Utility.trimExplode(",",t.value).length,r.minItems!==void 0&&(o=r.minItems*1,!isNaN(o)&&i<o&&(n=!0)),r.maxItems!==void 0&&(m=r.maxItems*1,!isNaN(m)&&i>m&&(n=!0)));break;case"min":(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement)&&t.value.length>0&&t.value.length<t.minLength&&(n=!0);break;case"null":break;default:break}}const d=!n;return t.classList.toggle(FormEngineValidation.errorClass,!d),t.closest(FormEngineValidation.markerSelector)?.querySelector(FormEngineValidation.labelSelector)?.classList.toggle(FormEngineValidation.errorClass,!d),FormEngineValidation.markParentTab(t,d),formEngineFormElement.dispatchEvent(new CustomEvent("t3-formengine-postfieldvalidation",{detail:{field:t,isValid:d},cancelable:!1,bubbles:!0})),l}static processByEvals(t,e){if(t.evalList!==void 0){const a=Utility.trimExplode(",",t.evalList);for(const n of a)e=FormEngineValidation.processValue(n,e,t)}return e}static processValue(t,e,a){let n="",i="",l=0,s=e;switch(t){case"alpha":case"num":case"alphanum":case"alphanum_x":for(n="",l=0;l<e.length;l++){const o=e.substr(l,1);let m=o==="_"||o==="-",d=o>="a"&&o<="z"||o>="A"&&o<="Z",r=o>="0"&&o<="9";switch(t){case"alphanum":m=!1;break;case"alpha":r=!1,m=!1;break;case"num":d=!1,m=!1;break;default:break}(d||r||m)&&(n+=o)}n!==e&&(s=n);break;case"is_in":if(a.is_in){i=""+e,a.is_in=a.is_in.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");const o=new RegExp("[^"+a.is_in+"]+","g");n=i.replace(o,"")}else n=i;s=n;break;case"nospace":s=(""+e).replace(/ /g,"");break;case"md5":e!==""&&(s=Md5.hash(e));break;case"upper":s=e.toUpperCase();break;case"lower":s=e.toLowerCase();break;case"integer":e!==""&&(s=FormEngineValidation.parseInt(e).toString());break;case"decimal":e!==""&&(s=FormEngineValidation.parseDouble(e));break;case"trim":s=String(e).trim();break;case"time":case"timesec":e!==""&&(s=DateTime.fromISO(e,{zone:"utc"}).set({year:1970,month:1,day:1}).toISO({suppressMilliseconds:!0}));break;case"year":if(e!==""){let o=parseInt(e,10);isNaN(o)&&(o=new Date().getUTCFullYear()),s=o.toString(10)}break;case"null":break;case"password":break;default:customEvaluations.has(t)?s=customEvaluations.get(t).call(null,e):typeof TBE_EDITOR=="object"&&TBE_EDITOR.customEvalFunctions!==void 0&&typeof TBE_EDITOR.customEvalFunctions[t]=="function"&&(s=TBE_EDITOR.customEvalFunctions[t](e))}return s}static validate(t){(typeof t>"u"||t instanceof Document)&&formEngineFormElement.querySelectorAll(FormEngineValidation.markerSelector+", .t3js-tabmenu-item").forEach(a=>{a.classList.remove(FormEngineValidation.validationErrorClass)});const e=t||document;for(const a of e.querySelectorAll(FormEngineValidation.rulesSelector))if(a.closest(".t3js-flex-section-deleted, .t3js-inline-record-deleted, .t3js-file-reference-deleted")===null){let n=!1;const i=a.value,l=FormEngineValidation.validateField(a,i);if(Array.isArray(l)&&Array.isArray(i)){if(l.length!==i.length)n=!0;else for(let s=0;s<l.length;s++)if(l[s]!==i[s]){n=!0;break}}else l.length&&i!==l&&(n=!0);n&&(a.disabled&&a.dataset.enableOnModification&&(a.disabled=!1),a.value=l)}}static markFieldAsChanged(t){if(t instanceof $&&(console.warn("Passing a jQuery element to FormEngineValidation.markFieldAsChanged() is deprecated and will be removed in TYPO3 v14."),console.trace(),t=t.get(0)),!(t instanceof HTMLElement))return;t.classList.add("has-change");const e=t.closest(".t3js-formengine-palette-field")?.querySelector(".t3js-formengine-label");e!==null&&e.classList.add("has-change")}static parseInt(t){const e=""+t;if(!t)return 0;const a=parseInt(e,10);return isNaN(a)?0:a}static parseDouble(t,e=2){let a=""+t;a=a.replace(/[^0-9,.-]/g,"");const n=a.startsWith("-");a=a.replace(/-/g,""),a=a.replace(/,/g,"."),a.indexOf(".")===-1&&(a+=".0");const i=a.split("."),l=i.pop();let s=+(i.join("")+"."+l);return n&&(s*=-1),a=s.toFixed(e),a}static pol(foreign,value){return eval((foreign=="-"?"-":"")+value)}static markParentTab(t,e){DomHelper.parents(t,".tab-pane").forEach(n=>{e&&(e=n.querySelector(".has-error")===null);const i=n.id;formEngineFormElement.querySelector('[data-bs-target="#'+i+'"]').closest(".t3js-tabmenu-item").classList.toggle(FormEngineValidation.validationErrorClass,!e)})}static suspend(){validationSuspended=!0}static resume(){validationSuspended=!1}static registerSubmitCallback(){new SubmitInterceptor(formEngineFormElement).addPreSubmitCallback(()=>{if(validationSuspended||document.querySelector("."+FormEngineValidation.errorClass)===null)return!0;const e=Modal.confirm(TYPO3.lang.alert||"Alert",TYPO3.lang["FormEngine.fieldsMissing"],Severity.error,[{text:TYPO3.lang["button.ok"]||"OK",active:!0,btnClass:"btn-default",name:"ok"}]);return e.addEventListener("button.clicked",()=>e.hideModal()),!1})}}export{FormEngineValidation as default};
