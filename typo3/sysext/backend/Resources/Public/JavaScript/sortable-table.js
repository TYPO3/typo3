/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import Tablesort from"tablesort";import"tablesort.dotsep.js";import"tablesort.number.js";import{IconElement}from"@typo3/backend/element/icon-element.js";import{Sizes}from"@typo3/backend/enum/icon-types.js";class TablesortWithButtons extends Tablesort{init(t,e){let o,n;if(this.table=t,this.thead=!1,this.options=e,t.rows&&t.rows.length>0)if(t.tHead&&t.tHead.rows.length>0){for(let e=0;e<t.tHead.rows.length;e++)if("thead"===t.tHead.rows[e].getAttribute("data-sort-method")){o=t.tHead.rows[e];break}o||(o=t.tHead.rows[t.tHead.rows.length-1]),this.thead=!0}else o=t.rows[0];if(!o)return;const r=t=>{t.preventDefault(),t.stopImmediatePropagation();const e=t.currentTarget.dataset.sortDirection,o=t.currentTarget.closest("th, td");this.current===o&&this.current.ariaSort===e||(o.ariaSort="ascending"===e?"descending":"ascending",this.current&&this.current!==o&&this.current.removeAttribute("aria-sort"),this.current=o,this.sortTable(o))};for(let t=0;t<o.cells.length;t++){const e=o.cells[t];if(e.setAttribute("role","columnheader"),"none"!==e.getAttribute("data-sort-method")){const t=document.createElement("button");t.classList.add("dropdown-toggle","dropdown-toggle-link"),t.dataset.bsToggle="dropdown",t.dataset.sortingToggle="true",t.type="button",t.ariaExpanded="false",t.textContent=e.textContent;const o=new IconElement;o.identifier="empty-empty",o.size=Sizes.small;const d=document.createElement("div");d.appendChild(o),t.appendChild(d),e.replaceChildren(t);const a=document.createElement("div");a.classList.add("dropdown-menu");const s=top.TYPO3.lang["labels.sorting.asc"]||"Sort ascending",i=document.createElement("button");i.classList.add("dropdown-item"),i.type="button",i.title=s,i.ariaLabel=s,i.dataset.sortDirection="ascending",i.addEventListener("click",r,!1);const l=document.createElement("span");l.classList.add("dropdown-item-columns"),i.appendChild(l);const c=document.createElement("span");c.classList.add("dropdown-item-column","dropdown-item-column-icon","text-primary"),l.appendChild(c);const p=new IconElement;p.identifier="empty-empty",p.size=Sizes.small,c.appendChild(p);const m=document.createElement("span");m.classList.add("dropdown-item-column","dropdown-item-column-title"),m.textContent=s,l.appendChild(m),a.appendChild(i);const u=top.TYPO3.lang["labels.sorting.desc"]||"Sort descending",g=document.createElement("button");g.classList.add("dropdown-item"),g.type="button",g.title=u,g.ariaLabel=u,g.dataset.sortDirection="descending",g.addEventListener("click",r,!1);const h=document.createElement("span");h.classList.add("dropdown-item-columns"),g.appendChild(h);const w=document.createElement("span");w.classList.add("dropdown-item-column","dropdown-item-column-icon","text-primary"),h.appendChild(w);const y=new IconElement;y.identifier="empty-empty",y.size=Sizes.small,w.appendChild(y);const b=document.createElement("span");b.classList.add("dropdown-item-column","dropdown-item-column-title"),b.textContent=u,h.appendChild(b),a.appendChild(g),e.appendChild(a),null!==e.getAttribute("data-sort-default")&&(n=e)}}n&&(this.current=n,this.sortTable(n))}}export default class SortableTable{constructor(t){t.addEventListener("afterSort",(t=>{const e=t.target;e.tHead.querySelectorAll(".dropdown-toggle[data-sorting-toggle]").forEach((t=>{t.querySelector(":scope > div").classList.remove("text-primary");const e=t.querySelector("typo3-backend-icon");e.identifier="empty-empty",e.classList.remove("text-primary")}));e.tHead.querySelectorAll(".dropdown-toggle[data-sorting-toggle] + .dropdown-menu typo3-backend-icon").forEach((t=>{t.identifier="empty-empty"}));const o=e.tHead.querySelector("th[aria-sort]"),n=o.querySelector(".dropdown-toggle[data-sorting-toggle]");n.querySelector(":scope > div").classList.add("text-primary");const r=n.querySelector("typo3-backend-icon"),d=o.querySelector(".dropdown-menu");"ascending"===o.ariaSort?r.identifier="actions-sort-amount-up":r.identifier="actions-sort-amount-down";d.querySelectorAll(".dropdown-item").forEach((t=>{const e=t.dataset.sortDirection,n=t.querySelector("typo3-backend-icon");e===o.ariaSort?n.identifier="actions-dot":n.identifier="empty-empty"}))})),new TablesortWithButtons(t)}}