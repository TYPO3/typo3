/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{html as u}from"lit";import{unsafeHTML as b}from"lit/directives/unsafe-html.js";import{styleMap as g}from"lit/directives/style-map.js";import V from"@typo3/core/ajax/ajax-request.js";import l from"@typo3/core/event/regular-event.js";import S from"@typo3/backend/form-engine-validation.js";import C from"cropperjs";import f from"@typo3/backend/modal.js";import"@typo3/backend/element/spinner-element.js";import{renderNodes as O}from"@typo3/core/lit-helper.js";import{Offset as x}from"@typo3/backend/element/draggable-resizable-element.js";class o{constructor(){this.initialized=!1,this.triggerListener=null,this.cropImageSelector="#t3js-crop-image",this.coverAreaSelector=".t3js-cropper-cover-area",this.cropInfoSelector=".t3js-cropper-info-crop",this.focusAreaSelector="#t3js-cropper-focus-area",this.defaultFocusArea={height:1/3,width:1/3,x:0,y:0},this.defaultOpts={autoCrop:!0,autoCropArea:.7,dragMode:"crop",guides:!0,responsive:!0,viewMode:1,zoomable:!1,checkCrossOrigin:!1},this.cropBuiltHandler=()=>{this.initialized=!0;const t=this.cropper.getImageData(),r=this.currentModal.querySelector(this.cropImageSelector);this.currentModal.querySelector(".cropper-canvas img")?.classList.remove("cropper-hide"),this.imageOriginalSizeFactor=parseInt(r.dataset.originalWidth,10)/t.naturalWidth,this.cropVariantTriggers.forEach(e=>{const i=e.dataset.cropVariantId,a=this.convertRelativeToAbsoluteCropArea(this.data[i].cropArea,t),s=Object.assign({},this.data[i],{cropArea:a});this.updatePreviewThumbnail(s,e),this.currentModal.querySelector(`[data-crop-variant-container="${s.id}"]`)?.querySelector(`[data-bs-option="${s.selectedRatio}"]`)?.classList.add("active")}),this.currentCropVariant.cropArea=this.convertRelativeToAbsoluteCropArea(this.currentCropVariant.cropArea,t),this.cropBox=this.currentModal.querySelector(".cropper-crop-box"),this.setCropArea(this.currentCropVariant.cropArea),this.currentCropVariant.coverAreas&&this.initCoverAreas(this.cropBox,this.currentCropVariant.coverAreas),this.currentCropVariant.focusArea&&(o.isEmptyObject(this.currentCropVariant.focusArea)&&(this.currentCropVariant.focusArea=Object.assign({},this.defaultFocusArea)),this.focusAreaEl?.remove(),this.initFocusArea(this.cropBox)),this.currentCropVariant.selectedRatio&&this.currentModal.querySelector(`[data-bs-option='${this.currentCropVariant.selectedRatio}']`)?.classList.add("active")},this.cropMoveHandler=t=>{if(!this.initialized)return;const r=15,e=15;let i=Math.floor(t.detail.width),a=Math.floor(t.detail.height);(i<r||a<e)&&(i=Math.max(e,a),a=Math.max(r,i),this.cropper.setData({width:i,height:a})),this.currentCropVariant.cropArea=Object.assign({},this.currentCropVariant.cropArea,{width:Math.floor(i),height:Math.floor(a),x:Math.floor(t.detail.x),y:Math.floor(t.detail.y)}),this.focusAreaEl&&this.currentCropVariant?.focusArea&&(this.focusAreaEl.offset=this.convertAreaToOffset(this.currentCropVariant.focusArea,this.cropBox)),this.updatePreviewThumbnail(this.currentCropVariant,this.activeCropVariantTrigger),this.updateCropVariantData(this.currentCropVariant);const s=Math.round(this.currentCropVariant.cropArea.width*this.imageOriginalSizeFactor),n=Math.round(this.currentCropVariant.cropArea.height*this.imageOriginalSizeFactor);this.cropInfo.innerText=`${s}\xD7${n} px`}}static wait(t,r){window.setTimeout(t,r)}static toCssPercent(t){return`${t*100}%`}static serializeCropVariants(t){return JSON.stringify(t,(e,i)=>e==="id"||e==="title"||e==="allowedAspectRatios"||e==="coverAreas"?void 0:i)}static isEmptyObject(t){return!t||typeof t!="object"||Object.keys(t).length===0||JSON.stringify(t)==="{}"}static resolvePointerEventNames(){const t=typeof window<"u"&&typeof window.document<"u",r=t&&window.document.documentElement?"ontouchstart"in window.document.documentElement:!1,e=t?"PointerEvent"in window:!1,i=r?["touchmove"]:["mousemove"],a=r?["touchstart"]:["mousedown"],s=r?["touchend","touchcancel"]:["mouseup"];return{touchStart:a,touchMove:i,touchEnd:s,pointerDown:e?["pointerdown"]:a,pointerMove:e?["pointermove"]:i,pointerUp:e?["pointerup","pointercancel"]:s}}initializeTrigger(){this.triggerListener||(this.triggerListener=new l("click",(t,r)=>{t.preventDefault(),this.trigger=r,this.show()}),this.triggerListener.delegateTo(document,".t3js-image-manipulation-trigger"))}async initializeCropperModal(){const t=this.currentModal.querySelector(this.cropImageSelector);await new Promise(r=>{t.complete?r():t.addEventListener("load",()=>r())}),this.init()}show(){const t=this.trigger.dataset,r=t.modalTitle,e=t.buttonPreviewText,i=t.buttonDismissText,a=t.buttonSaveText,s=t.url,n=JSON.parse(t.payload);this.currentModal=f.advanced({additionalCssClasses:["modal-image-manipulation","cropper"],buttons:[{btnClass:"btn-default float-start",name:"preview",icon:"actions-view",text:e},{btnClass:"btn-default",name:"dismiss",icon:"actions-close",text:i},{btnClass:"btn-primary",name:"save",icon:"actions-document-save",text:a}],content:u`<div class=modal-loading><typo3-backend-spinner size=large></typo3-backend-spinner></div>`,size:f.sizes.full,style:f.styles.dark,title:r,staticBackdrop:!0}),this.currentModal.addEventListener("typo3-modal-shown",()=>{new V(s).post(n).then(async c=>{const h=await c.resolve();this.currentModal.templateResultContent=u`${b(h)}`,this.currentModal.updateComplete.then(()=>this.initializeCropperModal())})}),this.currentModal.addEventListener("typo3-modal-hide",()=>{this.destroy()})}init(){const t=this.currentModal.querySelector(this.cropImageSelector),r=this.trigger.dataset.cropVariants;if(!r)throw new TypeError("ImageManipulation: No cropVariants data found for image");this.data=o.isEmptyObject(this.data)?JSON.parse(r):this.data,this.cropVariantTriggers=this.currentModal.querySelectorAll(".t3js-crop-variant-trigger"),this.activeCropVariantTrigger=this.currentModal.querySelector(".t3js-crop-variant-trigger.is-active"),this.cropInfo=this.currentModal.querySelector(this.cropInfoSelector),this.currentCropVariant=this.data[this.activeCropVariantTrigger.dataset.cropVariantId],this.cropVariantTriggers.forEach(e=>e.addEventListener("click",i=>{if(i.currentTarget.classList.contains("is-active")){i.stopPropagation(),i.preventDefault();return}this.activeCropVariantTrigger.classList.remove("is-active"),i.currentTarget.classList.add("is-active"),this.activeCropVariantTrigger=i.currentTarget;const a=this.data[this.activeCropVariantTrigger.dataset.cropVariantId],s=this.cropper.getImageData();a.cropArea=this.convertRelativeToAbsoluteCropArea(a.cropArea,s),this.currentCropVariant=Object.assign({},a),this.update(a)})),new l("click",(e,i)=>{const a=i.dataset.bsOption;this.handleAspectRatioChange(a)}).delegateTo(this.currentModal,"label[data-method=setAspectRatio]"),new l("keydown",(e,i)=>{if(!["Enter","Space"].includes(e.code))return;e.preventDefault(),e.stopImmediatePropagation();const a=i.closest('label[data-method="setAspectRatio"]'),s=a.dataset.bsOption;a.querySelector("input").checked=!0,this.handleAspectRatioChange(s)}).delegateTo(this.currentModal,'label[data-method="setAspectRatio"] input[type="radio"]'),new l("click",()=>this.save(this.data)).delegateTo(this.currentModal,"button[name=save]"),this.trigger.dataset.previewUrl?new l("click",()=>this.openPreview(this.data)).delegateTo(this.currentModal,"button[name=preview]"):this.currentModal.querySelectorAll("button[name=preview]").forEach(e=>e.style.display="none"),new l("click",()=>this.currentModal.hideModal()).delegateTo(this.currentModal,"button[name=dismiss]"),new l("click",(e,i)=>{const a=this.cropper.getImageData(),s=i.dataset.cropVariant;if(e.preventDefault(),e.stopPropagation(),!s)throw new TypeError("TYPO3 Cropper: No cropVariant data attribute found on reset element.");const n=JSON.parse(s),c=this.convertRelativeToAbsoluteCropArea(n.cropArea,a);this.currentCropVariant=Object.assign({},n,{cropArea:c}),this.update(this.currentCropVariant)}).delegateTo(this.currentModal,"button[name=reset]"),o.isEmptyObject(this.currentCropVariant.cropArea)&&(this.defaultOpts=Object.assign({autoCropArea:1},this.defaultOpts)),this.cropper=new C(t,Object.assign({},this.defaultOpts,{ready:()=>{this.cropBuiltHandler(),this.update(this.currentCropVariant)},crop:this.cropMoveHandler.bind(this),data:this.currentCropVariant.cropArea}))}handleAspectRatioChange(t){const r=Object.assign({},this.currentCropVariant),e=r.allowedAspectRatios[t];this.setAspectRatio(e),this.setCropArea(r.cropArea),this.currentCropVariant=Object.assign({},r,{selectedRatio:t}),this.update(this.currentCropVariant)}update(t){const r=Object.assign({},t),e=t.allowedAspectRatios[t.selectedRatio];this.cropInfo=this.currentModal.querySelector(`[data-crop-variant-container="${t.id}"]`)?.querySelector(this.cropInfoSelector),this.currentModal.querySelector(`[data-crop-variant-container="${t.id}"]`)?.querySelector("[data-bs-option].active")?.classList.remove("active"),this.currentModal.querySelector(`[data-crop-variant-container="${t.id}"]`)?.querySelector(`[data-bs-option="${t.selectedRatio}"]`)?.classList.add("active"),this.setAspectRatio(e),this.setCropArea(r.cropArea),this.currentCropVariant=Object.assign({},r,t),this.cropBox?.querySelectorAll(this.coverAreaSelector)?.forEach(i=>i.remove()),this.cropBox?.querySelectorAll(this.focusAreaSelector)?.length>0&&this.focusAreaEl.remove(),t.focusArea&&(o.isEmptyObject(t.focusArea)&&(this.currentCropVariant.focusArea=Object.assign({},this.defaultFocusArea)),this.focusAreaEl?.remove(),this.initFocusArea(this.cropBox)),t.coverAreas&&this.initCoverAreas(this.cropBox,this.currentCropVariant.coverAreas),this.updatePreviewThumbnail(this.currentCropVariant,this.activeCropVariantTrigger)}initFocusArea(t){this.focusAreaEl=document.createElement("typo3-backend-draggable-resizable"),this.focusAreaEl.window=this.currentModal.ownerDocument.defaultView,this.focusAreaEl.offset=this.convertAreaToOffset(this.currentCropVariant.focusArea,t),this.focusAreaEl.container=t,this.focusAreaEl.pointerEventNames=o.resolvePointerEventNames(),this.focusAreaEl.addEventListener("draggable-resizable-started",()=>{this.cropper.disable()}),this.focusAreaEl.addEventListener("draggable-resizable-updated",()=>{const r=this.currentCropVariant.coverAreas,e=this.convertOffsetToArea(this.focusAreaEl.offset,t),i=this.focusAreaEl.querySelector(this.focusAreaSelector);this.checkFocusAndCoverAreasCollision(e,r)?i.classList.add("has-nodrop"):i.classList.remove("has-nodrop")}),this.focusAreaEl.addEventListener("draggable-resizable-finished",r=>{const e=this.currentCropVariant.coverAreas,i=this.convertOffsetToArea(this.focusAreaEl.offset,t);this.checkFocusAndCoverAreasCollision(i,e)?this.focusAreaEl.revert(r.detail.originOffset):this.scaleAndMoveFocusArea(i),this.focusAreaEl.querySelector(this.focusAreaSelector).classList.remove("has-nodrop"),this.cropper.enable()}),t.appendChild(this.focusAreaEl),this.scaleAndMoveFocusArea(this.currentCropVariant.focusArea)}initCoverAreas(t,r){r.forEach(e=>{const i={height:o.toCssPercent(e.height),left:o.toCssPercent(e.x),top:o.toCssPercent(e.y),width:o.toCssPercent(e.width)},a=u`<div class="cropper-cover-area t3js-cropper-cover-area" style=${g(i)}></div>`;this.renderElements(a,t)})}updatePreviewThumbnail(t,r){const e=r.querySelector(".t3js-cropper-preview-thumbnail-crop-area"),i=r.querySelector(".t3js-cropper-preview-thumbnail-crop-image"),a=r.querySelector(".t3js-cropper-preview-thumbnail-focus-area"),s=this.cropper.getImageData();Object.assign(e.style,{height:o.toCssPercent(t.cropArea.height/s.naturalHeight),left:o.toCssPercent(t.cropArea.x/s.naturalWidth),top:o.toCssPercent(t.cropArea.y/s.naturalHeight),width:o.toCssPercent(t.cropArea.width/s.naturalWidth)}),t.focusArea&&Object.assign(a.style,{height:o.toCssPercent(t.focusArea.height),left:o.toCssPercent(t.focusArea.x),top:o.toCssPercent(t.focusArea.y),width:o.toCssPercent(t.focusArea.width)});const n=getComputedStyle(e),c={width:n.getPropertyValue("width"),height:n.getPropertyValue("height"),left:n.getPropertyValue("left"),top:n.getPropertyValue("top")};Object.assign(i.style,{height:`${parseFloat(c.height)*(1/(t.cropArea.height/s.naturalHeight))}px`,margin:`${-1*parseFloat(c.left)}px`,marginTop:`${-1*parseFloat(c.top)}px`,width:`${parseFloat(c.width)*(1/(t.cropArea.width/s.naturalWidth))}px`})}scaleAndMoveFocusArea(t){this.currentCropVariant.focusArea=t,this.updatePreviewThumbnail(this.currentCropVariant,this.activeCropVariantTrigger),this.updateCropVariantData(this.currentCropVariant)}updateCropVariantData(t){const r=this.cropper.getImageData(),e=this.convertAbsoluteToRelativeCropArea(t.cropArea,r);this.data[t.id]=Object.assign({},t,{cropArea:e})}setAspectRatio(t){this.cropper.setAspectRatio(t.value)}setCropArea(t){const r=this.currentCropVariant.allowedAspectRatios[this.currentCropVariant.selectedRatio];r.value===0?this.cropper.setData({height:t.height,width:t.width,x:t.x,y:t.y}):this.cropper.setData({height:t.height,width:t.height*r.value,x:t.x,y:t.y})}checkFocusAndCoverAreasCollision(t,r){return r?r.some(e=>t.x<e.x+e.width&&e.x<t.x+t.width&&t.y<e.y+e.height&&e.y<t.height+t.y):!1}convertAbsoluteToRelativeCropArea(t,r){const{height:e,width:i,x:a,y:s}=t;return{height:e/r.naturalHeight,width:i/r.naturalWidth,x:a/r.naturalWidth,y:s/r.naturalHeight}}convertRelativeToAbsoluteCropArea(t,r){const{height:e,width:i,x:a,y:s}=t;return{height:e*r.naturalHeight,width:i*r.naturalWidth,x:a*r.naturalWidth,y:s*r.naturalHeight}}setPreviewImages(t){const r=this.cropper.image,e=this.cropper.getImageData();Object.keys(t).forEach(i=>{const a=t[i],s=this.convertRelativeToAbsoluteCropArea(a.cropArea,e),n=this.trigger.closest(".form-group").querySelector(`.t3js-image-manipulation-preview[data-crop-variant-id="${i}"]`),c=this.trigger.closest(".form-group").querySelector(`.t3js-image-manipulation-selected-ratio[data-crop-variant-id="${i}"]`);if(!(n instanceof HTMLElement))return;let h=n.getBoundingClientRect().width,p=parseInt(n.dataset.previewHeight,10);const m=s.width/s.height,v=h/m;v>p?h=p*m:p=v,h>s.width&&(h=s.width,p=s.height);const d=h/s.width,w={height:`${e.naturalHeight*d}px`,left:`${-s.x*d}px`,top:`${-s.y*d}px`,width:`${e.naturalWidth*d}px`},y={width:`${h}px`,height:`${p}px`},E=u`<span class="thumbnail thumbnail-status"> <div class=cropper-preview-container style=${g(y)}><img src=${r.src} style=${g(w)}></div> </span>`;for(;n.firstChild;)n.removeChild(n.firstChild);this.renderElements(E,n);const T=this.currentModal.ownerDocument.defaultView,A=this.currentModal.querySelector(`.t3-js-ratio-title[data-ratio-id="${a.id}${a.selectedRatio}"]`);c instanceof HTMLElement&&A instanceof T.HTMLElement&&(c.innerText=A.innerText)})}openPreview(t){const r=o.serializeCropVariants(t);let e=this.trigger.dataset.previewUrl;e=e+(e.includes("?")?"&":"?")+"cropVariants="+encodeURIComponent(r),window.open(e,"TYPO3ImageManipulationPreview")}save(t){const r=o.serializeCropVariants(t),e=document.querySelector(`#${this.trigger.dataset.field}`);this.trigger.dataset.cropVariants=JSON.stringify(t),this.setPreviewImages(t),e.value=r,S.markFieldAsChanged(e),this.currentModal.hideModal()}destroy(){this.currentModal&&(this.cropper instanceof C&&this.cropper.destroy(),this.initialized=!1,this.cropper=null,this.currentModal=null,this.data=null)}convertAreaToOffset(t,r){const e=r.getBoundingClientRect();return new x(t.x*e.width,t.y*e.height,t.width*e.width,t.height*e.height)}convertOffsetToArea(t,r){const e=r.getBoundingClientRect();return{x:t.left/e.width,y:t.top/e.height,width:t.width/e.width,height:t.height/e.height}}renderElements(t,r,e){const i=O(t);return Array.from(i).filter(s=>s instanceof HTMLElement).forEach(s=>r.appendChild(s)),e?r.querySelector(e):null}}var R=new o;export{R as default};
