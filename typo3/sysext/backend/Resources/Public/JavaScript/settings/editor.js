/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{LitElement as y,html as n,nothing as l}from"lit";import{property as h,state as f,customElement as v}from"lit/decorators.js";import{live as $}from"lit/directives/live.js";import"@typo3/backend/element/spinner-element.js";import"@typo3/backend/element/icon-element.js";import S from"@typo3/backend/notification.js";import g from"@typo3/backend/utility/dom-helper.js";import T from"@typo3/core/ajax/ajax-request.js";import{copyToClipboard as k}from"@typo3/backend/copy-to-clipboard.js";import{lll as m}from"@typo3/core/lit-helper.js";import{markdown as C}from"@typo3/core/directive/markdown.js";import"@typo3/backend/settings/editor/editable-setting.js";import{SettingsMode as R,sanitizeSettingsMode as _}from"@typo3/backend/settings/enum/settings-mode.enum.js";import"@typo3/backend/settings/type/bool.js";import"@typo3/backend/settings/type/int.js";import"@typo3/backend/settings/type/number.js";import"@typo3/backend/settings/type/string.js";import"@typo3/backend/settings/type/stringlist.js";var d=function(p,i,e,t){var s=arguments.length,r=s<3?i:t===null?t=Object.getOwnPropertyDescriptor(i,e):t,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(p,i,e,t);else for(var o=p.length-1;o>=0;o--)(a=p[o])&&(r=(s<3?a(r):s>3?a(i,e,r):a(i,e))||r);return s>3&&r&&Object.defineProperty(i,e,r),r};class u extends Event{static{this.eventName="typo3:settings-editor:submit"}constructor(i,e){super(u.eventName,{bubbles:!0,composed:!0,cancelable:!1}),this.originalEvent=i,this.formData=e}}let c=class extends y{constructor(){super(...arguments),this.formName="settings_form",this.customFormData={},this.mode=R.basic,this.searchTerm="",this.activeCategory="",this.visibleCategories={},this.observer=null}createRenderRoot(){return this}adjustNavigationSize(){const i=g.scrollableParent(this),e=this.querySelector(".settings-navigation-inner");if(e){const t=i.getBoundingClientRect(),s=this.querySelector(".settings-search").getBoundingClientRect(),r=this.querySelector(".settings-navigation").getBoundingClientRect();e.style.maxHeight=`${t.bottom-Math.max(0,t.bottom-r.bottom)-s.bottom}px`}}firstUpdated(){g.scrollableParent(this).addEventListener("scroll",()=>{this.adjustNavigationSize()}),this.observer=new IntersectionObserver(e=>{e.forEach(r=>{const a=r.target.dataset.key;this.visibleCategories[a]=r.isIntersecting});const t=r=>r.reduce((a,o)=>[...a,o.key,...t(o.categories)],[]),s=t(this.categories).filter(r=>this.visibleCategories[r])[0]||"";s&&(this.activeCategory=s)},{root:document.querySelector(".module"),threshold:.1,rootMargin:`-${getComputedStyle(document.querySelector(".settings-navigation-inner")).getPropertyValue("top")} 0px 0px 0px`})}updated(i){if([...this.renderRoot.querySelectorAll(".settings-category")].map(e=>this.observer?.observe(e)),this.adjustNavigationSize(),i.has("activeCategory")){const e=this.querySelector(".settings-navigation-inner"),t=this.querySelector(".settings-navigation-item.active");if(e&&t){const s=e.scrollTop,r=e.getBoundingClientRect().height,a=t.getBoundingClientRect().height,o=t.offsetTop>=s,b=t.offsetTop+a<=s+r;o?b||this.querySelector(".settings-navigation-inner").scrollTo({top:Math.max(0,t.offsetTop+a),behavior:"auto"}):this.querySelector(".settings-navigation-inner").scrollTo({top:Math.max(0,t.offsetTop-a),behavior:"auto"})}}}renderCategoryTree(i,e){const t=g.isRTL()?"actions-chevron-left":"actions-chevron-right";return n`<ul data-level=${e}>${i.map(s=>n`<li ?hidden=${s.__hidden}><button type=button @click=${r=>{r.preventDefault(),this.selectCategory(s)}} class="settings-navigation-item ${this.activeCategory===s.key?"active":""}"><span class=settings-navigation-item-icon> <typo3-backend-icon identifier=${s.icon?s.icon:t} size=small></typo3-backend-icon> </span><span class=settings-navigation-item-label>${s.label}</span></button> ${s.categories.length===0?l:n`${this.renderCategoryTree(s.categories,e+1)}`}</li>`)}</ul>`}renderSettings(i,e){return i.map(t=>n`<div class=settings-category-list data-key=${t.key}><div class=settings-category data-key=${t.key} ?hidden=${t.__hidden}>${this.renderHeadline(Math.min(e+1,6),`category-headline-${t.key}`,t.icon,n`${t.label}`)}<div class=settings-category-description>${t.description?C(t.description,"minimal"):l}</div></div>${t.settings.map(s=>n`<typo3-backend-editable-setting ?hidden=${s.__hidden} .setting=${s} .dumpuri=${this.dumpUrl} .mode=${this.mode}></typo3-backend-editable-setting>`)}</div>${t.categories.length===0?l:n`${this.renderSettings(t.categories,e+1)}`}`)}renderHeadline(i,e,t,s){switch(i){case 1:return n`<h1 class=settings-category-headline id=${e}>${t?n`<typo3-backend-icon identifier=${t}></typo3-backend-icon>`:l}${s}</h1>`;case 2:return n`<h2 class=settings-category-headline id=${e}>${t?n`<typo3-backend-icon identifier=${t}></typo3-backend-icon>`:l}${s}</h2>`;case 3:return n`<h3 class=settings-category-headline id=${e}>${t?n`<typo3-backend-icon identifier=${t}></typo3-backend-icon>`:l}${s}</h3>`;case 4:return n`<h4 class=settings-category-headline id=${e}>${t?n`<typo3-backend-icon identifier=${t}></typo3-backend-icon>`:l}${s}</h4>`;case 5:return n`<h5 class=settings-category-headline id=${e}>${t?n`<typo3-backend-icon identifier=${t}></typo3-backend-icon>`:l}${s}</h5>`;case 6:return n`<h6 class=settings-category-headline id=${e}>${t?n`<typo3-backend-icon identifier=${t}></typo3-backend-icon>`:l}${s}</h6>`;default:throw new Error(`Invalid header level: ${i}`)}}selectCategory(i){const e=`#category-headline-${i.key}`,t=this.renderRoot.querySelector(e.replaceAll(".","\\.")),s=g.scrollableParent(this),r=this.renderRoot.querySelector(".settings-search").offsetHeight,a=parseInt(window.getComputedStyle(this.renderRoot.querySelector(".settings-body-inner")).paddingTop,10),o=t.offsetTop-r-a;s.scrollTo({top:o,behavior:"smooth"}),this.activeCategory=i.key}async onSubmit(i){const e=i.target,t=new FormData(e),s={settings:{}};if(t.forEach((r,a)=>{const o=a.match(/^settings\[(.+?)\]$/);o?s.settings[o[1]]=typeof r=="string"?r:r.name:s[a]=typeof r=="string"?r:r.name}),this.dispatchEvent(new u(i,s)),!i.defaultPrevented&&i.submitter?.value==="export"){i.preventDefault();const r=new FormData(e),o=await(await new T(this.dumpUrl).post(r)).resolve();typeof o.yaml=="string"?k(o.yaml):(console.warn("Value can not be copied to clipboard.",typeof o.yaml),S.error(m("copyToClipboard.error")))}}async onSearch(i){i.preventDefault(),this.searchTerm=i.currentTarget.value}render(){const i=this.filterCategories(),e=i.filter(t=>!t.__hidden).length>0;return n`<form class=settings-container id=${this.formName} name=${this.formName} action=${this.actionUrl} method=post @submit=${t=>this.onSubmit(t)}>${Object.entries(this.customFormData).map(([t,s])=>n`<input type=hidden name=${t} value=${s}>`)}<div class=settings><div class=settings-search><label for=settings-search class=visually-hidden>${m("edit.searchTermVisuallyHiddenLabel")}</label> <input type=search id=settings-search class=form-control placeholder=${m("edit.searchTermPlaceholder")} .value=${$(this.searchTerm)} @change=${t=>this.onSearch(t)} @input=${t=>this.onSearch(t)}></div><div class=settings-navigation ?hidden=${!e}><div class=settings-navigation-inner @transitionend=${()=>this.adjustNavigationSize()}>${this.renderCategoryTree(i??[],1)}</div></div><div class=settings-body ?hidden=${!e}><div class=settings-body-inner>${this.renderSettings(i??[],1)}</div></div></div>${e?l:n`<div class="callout callout-info mt-3"><div class=callout-icon><span class=icon-emphasized> <typo3-backend-icon identifier=actions-info size=small></typo3-backend-icon> </span></div><div class=callout-content><div class=callout-title>${m("edit.search.noResultsTitle")}</div><div class=callout-body><p>${m("edit.search.noResultsMessage")}</p><button type=button class="btn btn-default" @click=${()=>this.searchTerm=""}>${m("edit.search.noResultsResetButtonLabel")}</button></div></div></div>`}</form>`}filterCategories(i=null){return i??=this.categories,i.map(e=>{const t=this.filterSettings(e.settings),s=this.filterCategories(e.categories),r=t.filter(o=>!o.__hidden).length>0,a=s.filter(o=>!o.__hidden).length>0;return{...e,settings:t,categories:s,__hidden:!r&&!a}})}filterSettings(i){return i.map(e=>({...e,__hidden:!(this.matchesSearchTerm(e.definition.key)||this.matchesSearchTerm(e.definition.label)||this.matchesSearchTerm(e.definition.description??"")||this.valueMatchesSearchTerm(e.value)||e.definition.tags.filter(t=>this.matchesSearchTerm(t)).length>0)}))}matchesSearchTerm(i){return this.searchTerm===""?!0:this.matchesSubstring(i,this.searchTerm)}valueMatchesSearchTerm(i){return typeof i=="string"?this.matchesSearchTerm(i):Array.isArray(i)?i.filter(e=>typeof e=="string"&&this.matchesSearchTerm(e)).length>0:!1}matchesSubstring(i,e){return i.toLowerCase().includes(e.toLowerCase())}};d([h({type:Array})],c.prototype,"categories",void 0),d([h({type:String,attribute:"form-name"})],c.prototype,"formName",void 0),d([h({type:String,attribute:"action-url"})],c.prototype,"actionUrl",void 0),d([h({type:String,attribute:"dump-url"})],c.prototype,"dumpUrl",void 0),d([h({type:Object,attribute:"custom-form-data"})],c.prototype,"customFormData",void 0),d([h({type:String,converter:_})],c.prototype,"mode",void 0),d([f()],c.prototype,"searchTerm",void 0),d([f()],c.prototype,"activeCategory",void 0),c=d([v("typo3-backend-settings-editor")],c);export{c as SettingsEditorElement,u as SettingsEditorSubmitEvent};
