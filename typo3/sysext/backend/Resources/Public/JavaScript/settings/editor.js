/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{LitElement as g,html as a,nothing as p}from"lit";import{property as h,state as u,customElement as f}from"lit/decorators.js";import{live as v}from"lit/directives/live.js";import"@typo3/backend/element/spinner-element.js";import"@typo3/backend/element/icon-element.js";import b from"@typo3/backend/notification.js";import $ from"@typo3/core/ajax/ajax-request.js";import{copyToClipboard as y}from"@typo3/backend/copy-to-clipboard.js";import{lll as d}from"@typo3/core/lit-helper.js";import{markdown as S}from"@typo3/core/directive/markdown.js";import"@typo3/backend/settings/editor/editable-setting.js";import"@typo3/backend/settings/type/bool.js";import"@typo3/backend/settings/type/int.js";import"@typo3/backend/settings/type/number.js";import"@typo3/backend/settings/type/string.js";import"@typo3/backend/settings/type/stringlist.js";var l=function(m,t,i,e){var r=arguments.length,s=r<3?t:e===null?e=Object.getOwnPropertyDescriptor(t,i):e,n;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(m,t,i,e);else for(var c=m.length-1;c>=0;c--)(n=m[c])&&(s=(r<3?n(s):r>3?n(t,i,s):n(t,i))||s);return r>3&&s&&Object.defineProperty(t,i,s),s};let o=class extends g{constructor(){super(...arguments),this.customFormData={},this.debug=!1,this.searchTerm="",this.activeCategory="",this.visibleCategories={},this.observer=null}createRenderRoot(){return this}firstUpdated(){this.observer=new IntersectionObserver(t=>{t.forEach(r=>{const s=r.target.dataset.key;this.visibleCategories[s]=r.isIntersecting});const i=r=>r.reduce((s,n)=>[...s,n.key,...i(n.categories)],[]),e=i(this.categories).filter(r=>this.visibleCategories[r])[0]||"";e&&(this.activeCategory=e)},{root:document.querySelector(".module"),threshold:.1,rootMargin:`-${getComputedStyle(document.querySelector(".module-docheader")).getPropertyValue("min-height")} 0px 0px 0px`})}updated(){[...this.renderRoot.querySelectorAll(".settings-category")].map(t=>this.observer?.observe(t))}renderCategoryTree(t,i){return a`<ul data-level=${i}>${t.map(e=>a`<li ?hidden=${e.__hidden}><a href=${`#category-headline-${e.key}`} @click=${()=>this.activeCategory=e.key} class="settings-navigation-item ${this.activeCategory===e.key?"active":""}"> <span class=settings-navigation-item-icon><typo3-backend-icon identifier=${e.icon?e.icon:"actions-dot"} size=small></typo3-backend-icon> </span> <span class=settings-navigation-item-label>${e.label}</span> </a>${e.categories.length===0?p:a`${this.renderCategoryTree(e.categories,i+1)}`}</li>`)}</ul>`}renderSettings(t,i){return t.map(e=>a`<div class=settings-category-list data-key=${e.key}><div class=settings-category data-key=${e.key} ?hidden=${e.__hidden}>${this.renderHeadline(Math.min(i+1,6),`category-headline-${e.key}`,a`${e.label}`)}<div class=settings-category-description>${e.description?S(e.description,"minimal"):p}</div></div>${e.settings.map(r=>a`<typo3-backend-editable-setting ?hidden=${r.__hidden} .setting=${r} .dumpuri=${this.dumpUrl} ?debug=${this.debug}></typo3-backend-editable-setting>`)}</div>${e.categories.length===0?p:a`${this.renderSettings(e.categories,i+1)}`}`)}renderHeadline(t,i,e){switch(t){case 1:return a`<h1 id=${i}>${e}</h1>`;case 2:return a`<h2 id=${i}>${e}</h2>`;case 3:return a`<h3 id=${i}>${e}</h3>`;case 4:return a`<h4 id=${i}>${e}</h4>`;case 5:return a`<h5 id=${i}>${e}</h5>`;case 6:return a`<h6 id=${i}>${e}</h6>`;default:throw new Error(`Invalid header level: ${t}`)}}async onSubmit(t){const i=t.target;if(t.submitter?.value==="export"){t.preventDefault();const e=new FormData(i),s=await(await new $(this.dumpUrl).post(e)).resolve();typeof s.yaml=="string"?y(s.yaml):(console.warn("Value can not be copied to clipboard.",typeof s.yaml),b.error(d("copyToClipboard.error")))}}async onSearch(t){t.preventDefault(),this.searchTerm=t.currentTarget.value}render(){const t=this.filterCategories(),i=t.filter(e=>!e.__hidden).length>0;return a`<form class=settings-container id=sitesettings_form name=sitesettings_form action=${this.actionUrl} method=post @submit=${e=>this.onSubmit(e)}>${Object.entries(this.customFormData).map(([e,r])=>a`<input type=hidden name=${e} value=${r}>`)}<div class="settings-search form-group"><label for=settings-search class=visually-hidden>${d("edit.searchTermVisuallyHiddenLabel")}</label> <input type=search id=settings-search class=form-control placeholder=${d("edit.searchTermPlaceholder")} .value=${v(this.searchTerm)} @change=${e=>this.onSearch(e)} @input=${e=>this.onSearch(e)}></div>${i?p:a`<div class="callout callout-info"><div class=callout-icon><span class=icon-emphasized> <typo3-backend-icon identifier=actions-info size=small></typo3-backend-icon> </span></div><div class=callout-content><div class=callout-title>${d("edit.search.noResultsTitle")}</div><div class=callout-body><p>${d("edit.search.noResultsMessage")}</p><button type=button class="btn btn-default" @click=${()=>this.searchTerm=""}>${d("edit.search.noResultsResetButtonLabel")}</button></div></div></div>`}<div class=settings ?hidden=${!i}><div class=settings-navigation>${this.renderCategoryTree(t??[],1)}</div><div class=settings-body>${this.renderSettings(t??[],1)}</div></div></form>`}filterCategories(t=null){return t??=this.categories,t.map(i=>{const e=this.filterSettings(i.settings),r=this.filterCategories(i.categories),s=e.filter(c=>!c.__hidden).length>0,n=r.filter(c=>!c.__hidden).length>0;return{...i,settings:e,categories:r,__hidden:!s&&!n}})}filterSettings(t){return t.map(i=>({...i,__hidden:!(this.matchesSearchTerm(i.definition.key)||this.matchesSearchTerm(i.definition.label)||this.matchesSearchTerm(i.definition.description??"")||this.valueMatchesSearchTerm(i.value)||i.definition.tags.filter(e=>this.matchesSearchTerm(e)).length>0)}))}matchesSearchTerm(t){return this.searchTerm===""?!0:this.matchesSubstring(t,this.searchTerm)}valueMatchesSearchTerm(t){return typeof t=="string"?this.matchesSearchTerm(t):Array.isArray(t)?t.filter(i=>typeof i=="string"&&this.matchesSearchTerm(i)).length>0:!1}matchesSubstring(t,i){return t.toLowerCase().includes(i.toLowerCase())}};l([h({type:Array})],o.prototype,"categories",void 0),l([h({type:String,attribute:"action-url"})],o.prototype,"actionUrl",void 0),l([h({type:String,attribute:"dump-url"})],o.prototype,"dumpUrl",void 0),l([h({type:Object,attribute:"custom-form-data"})],o.prototype,"customFormData",void 0),l([h({type:Boolean})],o.prototype,"debug",void 0),l([u()],o.prototype,"searchTerm",void 0),l([u()],o.prototype,"activeCategory",void 0),o=l([f("typo3-backend-settings-editor")],o);export{o as SettingsEditorElement};
