/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{LitElement as v,html as r,nothing as c}from"lit";import{property as p,state as f,customElement as y}from"lit/decorators.js";import{live as $}from"lit/directives/live.js";import"@typo3/backend/element/spinner-element.js";import"@typo3/backend/element/icon-element.js";import S from"@typo3/backend/notification.js";import g from"@typo3/backend/utility/dom-helper.js";import T from"@typo3/core/ajax/ajax-request.js";import{copyToClipboard as k}from"@typo3/backend/copy-to-clipboard.js";import{lll as h}from"@typo3/core/lit-helper.js";import{markdown as C}from"@typo3/core/directive/markdown.js";import"@typo3/backend/settings/editor/editable-setting.js";import{SettingsMode as R,sanitizeSettingsMode as _}from"@typo3/backend/settings/enum/settings-mode.enum.js";import"@typo3/backend/settings/type/bool.js";import"@typo3/backend/settings/type/int.js";import"@typo3/backend/settings/type/number.js";import"@typo3/backend/settings/type/string.js";import"@typo3/backend/settings/type/stringlist.js";var d=function(m,i,e,t){var s=arguments.length,n=s<3?i:t===null?t=Object.getOwnPropertyDescriptor(i,e):t,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(m,i,e,t);else for(var o=m.length-1;o>=0;o--)(a=m[o])&&(n=(s<3?a(n):s>3?a(i,e,n):a(i,e))||n);return s>3&&n&&Object.defineProperty(i,e,n),n};class u extends Event{static{this.eventName="typo3:settings-editor:submit"}constructor(i,e){super(u.eventName,{bubbles:!0,composed:!0,cancelable:!1}),this.originalEvent=i,this.formData=e}}let l=class extends v{constructor(){super(...arguments),this.customFormData={},this.mode=R.basic,this.searchTerm="",this.activeCategory="",this.visibleCategories={},this.observer=null}createRenderRoot(){return this}adjustNavigationSize(){const i=g.scrollableParent(this),e=this.querySelector(".settings-navigation-inner");if(e){const t=i.getBoundingClientRect(),s=this.querySelector(".settings-search").getBoundingClientRect(),n=this.querySelector(".settings-navigation").getBoundingClientRect();e.style.maxHeight=`${t.bottom-Math.max(0,t.bottom-n.bottom)-s.bottom}px`}}firstUpdated(){g.scrollableParent(this).addEventListener("scroll",()=>{this.adjustNavigationSize()}),this.observer=new IntersectionObserver(e=>{e.forEach(n=>{const a=n.target.dataset.key;this.visibleCategories[a]=n.isIntersecting});const t=n=>n.reduce((a,o)=>[...a,o.key,...t(o.categories)],[]),s=t(this.categories).filter(n=>this.visibleCategories[n])[0]||"";s&&(this.activeCategory=s)},{root:document.querySelector(".module"),threshold:.1,rootMargin:`-${getComputedStyle(document.querySelector(".settings-navigation-inner")).getPropertyValue("top")} 0px 0px 0px`})}updated(i){if([...this.renderRoot.querySelectorAll(".settings-category")].map(e=>this.observer?.observe(e)),this.adjustNavigationSize(),i.has("activeCategory")){const e=this.querySelector(".settings-navigation-inner"),t=this.querySelector(".settings-navigation-item.active");if(e&&t){const s=e.scrollTop,n=e.getBoundingClientRect().height,a=t.getBoundingClientRect().height,o=t.offsetTop>=s,b=t.offsetTop+a<=s+n;o?b||this.querySelector(".settings-navigation-inner").scrollTo({top:Math.max(0,t.offsetTop+a),behavior:"auto"}):this.querySelector(".settings-navigation-inner").scrollTo({top:Math.max(0,t.offsetTop-a),behavior:"auto"})}}}renderCategoryTree(i,e){const t=g.isRTL()?"actions-chevron-left":"actions-chevron-right";return r`<ul data-level=${e}>${i.map(s=>r`<li ?hidden=${s.__hidden}><button type=button @click=${n=>{n.preventDefault(),this.selectCategory(s)}} class="settings-navigation-item ${this.activeCategory===s.key?"active":""}"><span class=settings-navigation-item-icon> <typo3-backend-icon identifier=${s.icon?s.icon:t} size=small></typo3-backend-icon> </span><span class=settings-navigation-item-label>${s.label}</span></button> ${s.categories.length===0?c:r`${this.renderCategoryTree(s.categories,e+1)}`}</li>`)}</ul>`}renderSettings(i,e){return i.map(t=>r`<div class=settings-category-list data-key=${t.key}><div class=settings-category data-key=${t.key} ?hidden=${t.__hidden}>${this.renderHeadline(Math.min(e+1,6),`category-headline-${t.key}`,t.icon,r`${t.label}`)}<div class=settings-category-description>${t.description?C(t.description,"minimal"):c}</div></div>${t.settings.map(s=>r`<typo3-backend-editable-setting ?hidden=${s.__hidden} .setting=${s} .dumpuri=${this.dumpUrl} .mode=${this.mode}></typo3-backend-editable-setting>`)}</div>${t.categories.length===0?c:r`${this.renderSettings(t.categories,e+1)}`}`)}renderHeadline(i,e,t,s){switch(i){case 1:return r`<h1 class=settings-category-headline id=${e}>${t?r`<typo3-backend-icon identifier=${t}></typo3-backend-icon>`:c}${s}</h1>`;case 2:return r`<h2 class=settings-category-headline id=${e}>${t?r`<typo3-backend-icon identifier=${t}></typo3-backend-icon>`:c}${s}</h2>`;case 3:return r`<h3 class=settings-category-headline id=${e}>${t?r`<typo3-backend-icon identifier=${t}></typo3-backend-icon>`:c}${s}</h3>`;case 4:return r`<h4 class=settings-category-headline id=${e}>${t?r`<typo3-backend-icon identifier=${t}></typo3-backend-icon>`:c}${s}</h4>`;case 5:return r`<h5 class=settings-category-headline id=${e}>${t?r`<typo3-backend-icon identifier=${t}></typo3-backend-icon>`:c}${s}</h5>`;case 6:return r`<h6 class=settings-category-headline id=${e}>${t?r`<typo3-backend-icon identifier=${t}></typo3-backend-icon>`:c}${s}</h6>`;default:throw new Error(`Invalid header level: ${i}`)}}selectCategory(i){const e=`#category-headline-${i.key}`,t=this.renderRoot.querySelector(e.replaceAll(".","\\.")),s=g.scrollableParent(this),n=this.renderRoot.querySelector(".settings-search").offsetHeight,a=parseInt(window.getComputedStyle(this.renderRoot.querySelector(".settings-body-inner")).paddingTop,10),o=t.offsetTop-n-a;s.scrollTo({top:o,behavior:"smooth"}),this.activeCategory=i.key}async onSubmit(i){const e=i.target,t=new FormData(e),s={settings:{}};if(t.forEach((n,a)=>{const o=a.match(/^settings\[(.+?)\]$/);o?s.settings[o[1]]=typeof n=="string"?n:n.name:s[a]=typeof n=="string"?n:n.name}),this.dispatchEvent(new u(i,s)),!i.defaultPrevented&&i.submitter?.value==="export"){i.preventDefault();const n=new FormData(e),o=await(await new T(this.dumpUrl).post(n)).resolve();typeof o.yaml=="string"?k(o.yaml):(console.warn("Value can not be copied to clipboard.",typeof o.yaml),S.error(h("copyToClipboard.error")))}}async onSearch(i){i.preventDefault(),this.searchTerm=i.currentTarget.value}render(){const i=this.filterCategories(),e=i.filter(t=>!t.__hidden).length>0;return r`<form class=settings-container id=sitesettings_form name=sitesettings_form action=${this.actionUrl} method=post @submit=${t=>this.onSubmit(t)}>${Object.entries(this.customFormData).map(([t,s])=>r`<input type=hidden name=${t} value=${s}>`)}<div class=settings><div class=settings-search><label for=settings-search class=visually-hidden>${h("edit.searchTermVisuallyHiddenLabel")}</label> <input type=search id=settings-search class=form-control placeholder=${h("edit.searchTermPlaceholder")} .value=${$(this.searchTerm)} @change=${t=>this.onSearch(t)} @input=${t=>this.onSearch(t)}></div><div class=settings-navigation ?hidden=${!e}><div class=settings-navigation-inner @transitionend=${()=>this.adjustNavigationSize()}>${this.renderCategoryTree(i??[],1)}</div></div><div class=settings-body ?hidden=${!e}><div class=settings-body-inner>${this.renderSettings(i??[],1)}</div></div></div>${e?c:r`<div class="callout callout-info mt-3"><div class=callout-icon><span class=icon-emphasized> <typo3-backend-icon identifier=actions-info size=small></typo3-backend-icon> </span></div><div class=callout-content><div class=callout-title>${h("edit.search.noResultsTitle")}</div><div class=callout-body><p>${h("edit.search.noResultsMessage")}</p><button type=button class="btn btn-default" @click=${()=>this.searchTerm=""}>${h("edit.search.noResultsResetButtonLabel")}</button></div></div></div>`}</form>`}filterCategories(i=null){return i??=this.categories,i.map(e=>{const t=this.filterSettings(e.settings),s=this.filterCategories(e.categories),n=t.filter(o=>!o.__hidden).length>0,a=s.filter(o=>!o.__hidden).length>0;return{...e,settings:t,categories:s,__hidden:!n&&!a}})}filterSettings(i){return i.map(e=>({...e,__hidden:!(this.matchesSearchTerm(e.definition.key)||this.matchesSearchTerm(e.definition.label)||this.matchesSearchTerm(e.definition.description??"")||this.valueMatchesSearchTerm(e.value)||e.definition.tags.filter(t=>this.matchesSearchTerm(t)).length>0)}))}matchesSearchTerm(i){return this.searchTerm===""?!0:this.matchesSubstring(i,this.searchTerm)}valueMatchesSearchTerm(i){return typeof i=="string"?this.matchesSearchTerm(i):Array.isArray(i)?i.filter(e=>typeof e=="string"&&this.matchesSearchTerm(e)).length>0:!1}matchesSubstring(i,e){return i.toLowerCase().includes(e.toLowerCase())}};d([p({type:Array})],l.prototype,"categories",void 0),d([p({type:String,attribute:"action-url"})],l.prototype,"actionUrl",void 0),d([p({type:String,attribute:"dump-url"})],l.prototype,"dumpUrl",void 0),d([p({type:Object,attribute:"custom-form-data"})],l.prototype,"customFormData",void 0),d([p({type:String,converter:_})],l.prototype,"mode",void 0),d([f()],l.prototype,"searchTerm",void 0),d([f()],l.prototype,"activeCategory",void 0),l=d([y("typo3-backend-settings-editor")],l);export{l as SettingsEditorElement,u as SettingsEditorSubmitEvent};
