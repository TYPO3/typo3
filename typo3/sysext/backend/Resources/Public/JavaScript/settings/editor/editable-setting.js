/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{LitElement as f,html as d,nothing as u}from"lit";import{property as y,state as g,customElement as b}from"lit/decorators.js";import{until as h}from"lit/directives/until.js";import"@typo3/backend/element/spinner-element.js";import"@typo3/backend/element/icon-element.js";import{copyToClipboard as v}from"@typo3/backend/copy-to-clipboard.js";import $ from"@typo3/backend/notification.js";import{lll as p}from"@typo3/core/lit-helper.js";import{markdown as w}from"@typo3/core/directive/markdown.js";import k from"@typo3/core/ajax/ajax-request.js";import{SettingsMode as m,sanitizeSettingsMode as A}from"@typo3/backend/settings/enum/settings-mode.enum.js";var l=function(c,t,e,i){var s=arguments.length,o=s<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,n;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(c,t,e,i);else for(var r=c.length-1;r>=0;r--)(n=c[r])&&(o=(s<3?n(o):s>3?n(t,e,o):n(t,e))||o);return s>3&&o&&Object.defineProperty(t,e,o),o};let a=class extends f{constructor(){super(...arguments),this.mode=m.basic,this.hasChange=!1,this.typeElement=null}createRenderRoot(){return this}render(){const{value:t,systemDefault:e,definition:i}=this.setting;return d`<div class=${`settings-item settings-item-${i.type} ${this.hasChange?"has-change":""}`} tabindex=0 data-status=${JSON.stringify(t)===JSON.stringify(e)?"none":"modified"}><div class=settings-item-indicator></div><div class=settings-item-title><label for=${`setting-${i.key}`} class=settings-item-label>${i.label}</label><div class=settings-item-description>${w(i.description??"","minimal")}</div>${this.mode===m.advanced?d`<div class=settings-item-key>${i.key}</div>`:u}</div><div class=settings-item-control>${h(this.renderField(),d`<typo3-backend-spinner></typo3-backend-spinner>`)}</div><div class=settings-item-message></div><div class=settings-item-actions>${this.renderActions()}</div></div>`}renderField(){return this.typeElement!==null?(this.updateFieldAttributes(this.typeElement),this.typeElement):(async()=>{const{typeImplementation:t}=this.setting,e=await import(t);if(!("componentName"in e))throw new Error(`module ${t} is missing the "componentName" export`);const i=document.createElement(e.componentName);return i.addEventListener("typo3:setting:changed",s=>{this.hasChange=JSON.stringify(this.setting.value)!==JSON.stringify(s.detail.value)}),this.updateFieldAttributes(i),this.typeElement=i,i})()}updateFieldAttributes(t){const{definition:e,value:i}=this.setting,s=Object.entries(e.enum||{}),o={key:e.key,formid:`setting-${e.key}`,name:`settings[${e.key}]`,value:Array.isArray(i)?JSON.stringify(i):String(i),debug:this.mode===m.advanced,readonly:e.readonly,enum:s.length>0?JSON.stringify(Object.fromEntries(s)):!1,default:Array.isArray(e.default)?JSON.stringify(e.default):String(e.default)};for(const[n,r]of Object.entries(o)){if(typeof r=="boolean"){r&&!t.hasAttribute(n)&&t.setAttribute(n,""),!r&&t.hasAttribute(n)&&t.removeAttribute(n);continue}t.getAttribute(n)!==r&&t.setAttribute(n,r)}}renderActions(){const{definition:t}=this.setting;return d`<div class=dropdown><button class=dropdown-toggle type=button data-bs-toggle=dropdown aria-expanded=false><typo3-backend-icon identifier=actions-cog size=small></typo3-backend-icon><span class=visually-hidden>More actions</span></button><ul class=dropdown-menu><li><button class="dropdown-item dropdown-item-spaced" type=button ?disabled=${t.readonly} @click=${()=>this.setToDefaultValue()}><typo3-backend-icon identifier=actions-undo size=small></typo3-backend-icon>${p("settingseditor.edit.resetSetting")}</button></li>${this.mode===m.advanced?d`<li><hr class=dropdown-divider></li><li><typo3-copy-to-clipboard text=${t.key} class="dropdown-item dropdown-item-spaced"><typo3-backend-icon identifier=actions-clipboard size=small></typo3-backend-icon>${p("settingseditor.edit.copySettingsIdentifier")}</typo3-copy-to-clipboard></li>${this.dumpuri?d`<li><button class="dropdown-item dropdown-item-spaced" type=button @click=${()=>this.copyAsYaml()}><typo3-backend-icon identifier=actions-clipboard-paste size=small></typo3-backend-icon>${p("settingseditor.edit.copyAsYaml")}</button></li>`:u}`:u}</ul></div>`}setToDefaultValue(){this.typeElement&&(this.typeElement.value=this.setting.systemDefault)}async copyAsYaml(){const t=new FormData(this.typeElement.form),e=`settings[${this.setting.definition.key}]`,i=t.get(e),s=new FormData;s.append("specificSetting",this.setting.definition.key),s.append(e,i);const n=await(await new k(this.dumpuri).post(s)).resolve();typeof n.yaml=="string"?v(n.yaml):(console.warn("Value can not be copied to clipboard.",typeof n.yaml),$.error(p("copyToClipboard.error")))}};l([y({type:Object})],a.prototype,"setting",void 0),l([y({type:String})],a.prototype,"dumpuri",void 0),l([y({type:String,converter:A})],a.prototype,"mode",void 0),l([g()],a.prototype,"hasChange",void 0),a=l([b("typo3-backend-editable-setting")],a);export{a as EditableSettingElement};
