/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{MessageUtility as j}from"@typo3/backend/utility/message-utility.js";import{AjaxDispatcher as F}from"@typo3/backend/form-engine/inline-relation/ajax-dispatcher.js";import S from"nprogress";import w from"sortablejs";import y from"@typo3/backend/form-engine.js";import h from"@typo3/backend/form-engine-validation.js";import C from"@typo3/backend/icons.js";import E from"@typo3/backend/info-window.js";import x from"@typo3/backend/modal.js";import D from"@typo3/core/document-service.js";import f from"@typo3/core/event/regular-event.js";import L from"@typo3/backend/severity.js";import R from"@typo3/backend/utility.js";import{selector as p}from"@typo3/core/literals.js";var u;(function(a){a.toggleSelector='[data-bs-toggle="formengine-file"]',a.controlSectionSelector=".t3js-formengine-file-header-control",a.deleteRecordButtonSelector=".t3js-editform-delete-file-reference",a.enableDisableRecordButtonSelector=".t3js-toggle-visibility-button",a.infoWindowButton='[data-action="infowindow"]',a.synchronizeLocalizeRecordButtonSelector=".t3js-synchronizelocalize-button",a.controlContainer=".t3js-file-controls"})(u||(u={}));var d;(function(a){a.new="isNewFileReference",a.visible="panel-visible",a.collapsed="panel-collapsed",a.notLoaded="t3js-not-loaded"})(d||(d={}));var g;(function(a){a.structureSeparator="-"})(g||(g={}));var b;(function(a){a.DOWN="down",a.UP="up"})(b||(b={}));class B extends HTMLElement{constructor(){super(...arguments),this.container=null,this.recordsContainer=null,this.ajaxDispatcher=null,this.appearance=null,this.requestQueue={},this.progressQueue={},this.handlePostMessage=e=>{if(!j.verifyOrigin(e.origin))throw"Denied message sent by "+e.origin;if(e.data.actionName==="typo3:foreignRelation:insert"){if(typeof e.data.objectGroup>"u")throw"No object group defined for message";if(e.data.objectGroup!==this.container.dataset.objectGroup)return;this.importRecord([e.data.objectGroup,e.data.uid]).then(()=>{if(e.source){const t={actionName:"typo3:foreignRelation:inserted",objectGroup:e.data.objectId,table:e.data.table,uid:e.data.uid};j.send(t,e.source)}})}if(e.data.actionName==="typo3:foreignRelation:delete"){if(e.data.objectGroup!==this.container.dataset.objectGroup)return;const t=e.data.directRemoval||!1,n=[e.data.objectGroup,e.data.uid].join("-");this.deleteRecord(n,t)}}}async connectedCallback(){const e=this.getAttribute("identifier")||"";await D.ready(),this.container=this.querySelector(p`[id="${e}"]`),this.container!==null&&(this.recordsContainer=this.container.querySelector(p`[id="${this.container.getAttribute("id")}_records"]`),this.ajaxDispatcher=new F(this.container.dataset.objectGroup),this.registerEvents())}registerEvents(){this.registerInfoButton(),this.registerSort(),this.registerEnableDisableButton(),this.registerDeleteButton(),this.registerSynchronizeLocalize(),this.registerToggle(),new f("message",this.handlePostMessage).bindTo(window),this.getAppearance().useSortable&&new w(this.recordsContainer,{group:this.recordsContainer.getAttribute("id"),handle:".sortableHandle",onSort:()=>{this.updateSorting()}})}getFileReferenceContainer(e){return this.container.querySelector(p`[data-object-id="${e}"]`)}getCollapseButton(e){return this.container.querySelector(p`[aria-controls="${e}_fields"]`)}collapseElement(e,t){const n=this.getCollapseButton(t);e.classList.remove(d.visible),e.classList.add(d.collapsed),n.setAttribute("aria-expanded","false")}expandElement(e,t){const n=this.getCollapseButton(t);e.classList.remove(d.collapsed),e.classList.add(d.visible),n.setAttribute("aria-expanded","true")}isNewRecord(e){return this.getFileReferenceContainer(e).classList.contains(d.new)}updateExpandedCollapsedStateLocally(e,t){const n=this.getFileReferenceContainer(e),o=this.container.querySelectorAll('[name="uc[inlineView]['+n.dataset.topmostParentTable+"]["+n.dataset.topmostParentUid+"]"+n.dataset.fieldName+'"]');o.length&&(o[0].value=t?"1":"0")}registerToggle(){new f("click",(e,t)=>{e.preventDefault(),e.stopImmediatePropagation(),this.loadRecordDetails(t.closest(u.toggleSelector).parentElement.dataset.objectId)}).delegateTo(this.container,`${u.toggleSelector} .form-irre-header-cell:not(${u.controlSectionSelector}`)}registerSort(){new f("click",(e,t)=>{e.preventDefault(),e.stopImmediatePropagation(),this.changeSortingByButton(t.closest("[data-object-id]").dataset.objectId,t.dataset.direction)}).delegateTo(this.container,u.controlSectionSelector+' [data-action="sort"]')}createRecord(e,t,n=null){let o=this.container.dataset.objectGroup;n!==null&&(o+=g.structureSeparator+n),n!==null?(this.getFileReferenceContainer(o).insertAdjacentHTML("afterend",t),this.memorizeAddRecord(e,n)):(this.recordsContainer.insertAdjacentHTML("beforeend",t),this.memorizeAddRecord(e,null))}async importRecord(e,t){return this.ajaxDispatcher.send(this.ajaxDispatcher.newRequest(this.ajaxDispatcher.getEndpoint("file_reference_create")),e).then(async n=>{this.isBelowMax()&&this.createRecord(n.compilerInput.uid,n.data,typeof t<"u"?t:null)})}registerEnableDisableButton(){new f("click",(e,t)=>{e.preventDefault(),e.stopImmediatePropagation();const n=t.closest("[data-object-id]").dataset.objectId,o=this.getFileReferenceContainer(n),r=p`data${o.dataset.fieldName}[${t.dataset.hiddenField}]`,i=this.recordsContainer.querySelector('[data-formengine-input-name="'+r+'"'),s=this.recordsContainer.querySelector('[name="'+r+'"');i!==null&&s!==null&&(i.checked=!i.checked,s.value=i.checked?"1":"0",h.markFieldAsChanged(i));const l="t3-form-field-container-inline-hidden",c=o.classList.contains(l);let m;c?(m="actions-edit-hide",o.classList.remove(l)):(m="actions-edit-unhide",o.classList.add(l)),C.getIcon(m,C.sizes.small).then(v=>{t.replaceChild(document.createRange().createContextualFragment(v),t.querySelector(".t3js-icon"))})}).delegateTo(this.container,u.enableDisableRecordButtonSelector)}registerInfoButton(){new f("click",(e,t)=>{e.preventDefault(),e.stopImmediatePropagation(),E.showItem(t.dataset.infoTable,t.dataset.infoUid)}).delegateTo(this.container,u.infoWindowButton)}registerDeleteButton(){new f("click",(e,t)=>{e.preventDefault(),e.stopImmediatePropagation();const n=TYPO3.lang["label.confirm.delete_record.title"]||"Delete this record?",o=(TYPO3.lang["label.confirm.delete_record.content"]||"Are you sure you want to delete the record '%s'?").replace("%s",t.dataset.recordInfo);x.confirm(n,o,L.warning,[{text:TYPO3.lang["buttons.confirm.delete_record.no"]||"Cancel",active:!0,btnClass:"btn-default",name:"no",trigger:(r,i)=>i.hideModal()},{text:TYPO3.lang["buttons.confirm.delete_record.yes"]||"Yes, delete this record",btnClass:"btn-warning",name:"yes",trigger:(r,i)=>{this.deleteRecord(t.closest("[data-object-id]").dataset.objectId),i.hideModal()}}])}).delegateTo(this.container,u.deleteRecordButtonSelector)}registerSynchronizeLocalize(){new f("click",(e,t)=>{e.preventDefault(),e.stopImmediatePropagation(),this.ajaxDispatcher.send(this.ajaxDispatcher.newRequest(this.ajaxDispatcher.getEndpoint("file_reference_synchronizelocalize")),[this.container.dataset.objectGroup,t.dataset.type]).then(async n=>{this.recordsContainer.insertAdjacentHTML("beforeend",n.data);const o=this.container.dataset.objectGroup+g.structureSeparator;for(const r of n.compilerInput.delete)this.deleteRecord(o+r,!0);for(const r of Object.values(n.compilerInput.localize)){if(typeof r.remove<"u"){const i=this.getFileReferenceContainer(o+r.remove);i.parentElement.removeChild(i)}this.memorizeAddRecord(r.uid,null)}})}).delegateTo(this.container,u.synchronizeLocalizeRecordButtonSelector)}loadRecordDetails(e){const t=this.recordsContainer.querySelector(p`[id="${e}_fields"]`),n=this.getFileReferenceContainer(e),o=typeof this.requestQueue[e]<"u";if(!(t!==null&&!n.classList.contains(d.notLoaded))){const i=this.getProgress(e,n.dataset.objectIdHash);if(o)this.requestQueue[e].abort(),delete this.requestQueue[e],delete this.progressQueue[e],i.done();else{const s=this.ajaxDispatcher.newRequest(this.ajaxDispatcher.getEndpoint("file_reference_details"));this.ajaxDispatcher.send(s,[e]).then(async c=>{delete this.requestQueue[e],delete this.progressQueue[e],n.classList.remove(d.notLoaded),t.innerHTML=c.data,this.collapseExpandRecord(e),i.done(),y.reinitialize(),h.initializeInputFields(),h.validate(this.container)}),this.requestQueue[e]=s,i.start()}return}this.collapseExpandRecord(e)}collapseExpandRecord(e){const t=this.getFileReferenceContainer(e),n=this.getAppearance().expandSingle===!0,o=t.classList.contains(d.collapsed);let r=[];const i=[];n&&o&&(r=this.collapseAllRecords(t.dataset.objectUid)),t.classList.contains(d.collapsed)?this.expandElement(t,e):this.collapseElement(t,e),this.isNewRecord(e)?this.updateExpandedCollapsedStateLocally(e,o):o?i.push(t.dataset.objectUid):o||r.push(t.dataset.objectUid),this.ajaxDispatcher.send(this.ajaxDispatcher.newRequest(this.ajaxDispatcher.getEndpoint("file_reference_expandcollapse")),[e,i.join(","),r.join(",")])}memorizeAddRecord(e,t=null){const n=this.getFormFieldForElements();if(n===null)return;let o=R.trimExplode(",",n.value);if(t){const r=[];for(let i=0;i<o.length;i++)o[i].length&&r.push(o[i]),t===o[i]&&r.push(e);o=r}else o.push(e);n.value=o.join(","),h.markFieldAsChanged(n),document.dispatchEvent(new Event("change")),this.redrawSortingButtons(this.container.dataset.objectGroup,o),this.isBelowMax()||this.toggleContainerControls(!1),y.reinitialize(),h.initializeInputFields(),h.validate(this.container)}memorizeRemoveRecord(e){const t=this.getFormFieldForElements();if(t===null)return[];const n=R.trimExplode(",",t.value),o=n.indexOf(e);return o>-1&&(n.splice(o,1),t.value=n.join(","),h.markFieldAsChanged(t),document.dispatchEvent(new Event("change")),this.redrawSortingButtons(this.container.dataset.objectGroup,n)),n}changeSortingByButton(e,t){const n=this.getFileReferenceContainer(e),o=n.dataset.objectUid,r=Array.from(this.recordsContainer.children).map(l=>l.dataset.objectUid),i=r.indexOf(o);let s=!1;if(t===b.UP&&i>0?(r[i]=r[i-1],r[i-1]=o,s=!0):t===b.DOWN&&i<r.length-1&&(r[i]=r[i+1],r[i+1]=o,s=!0),s){const l=this.container.dataset.objectGroup+g.structureSeparator,c=t===b.UP?1:0;n.parentElement.insertBefore(this.getFileReferenceContainer(l+r[i-c]),this.getFileReferenceContainer(l+r[i+1-c])),this.updateSorting()}}updateSorting(){const e=this.getFormFieldForElements();if(e===null)return;const t=Array.from(this.recordsContainer.querySelectorAll(p`[data-object-parent-group="${this.container.dataset.objectGroup}"][data-placeholder-record="0"]`)).map(n=>n.dataset.objectUid);e.value=t.join(","),h.markFieldAsChanged(e),document.dispatchEvent(new Event("formengine:files:sorting-changed")),document.dispatchEvent(new Event("change")),this.redrawSortingButtons(this.container.dataset.objectGroup,t)}deleteRecord(e,t=!1){const n=this.getFileReferenceContainer(e),o=n.dataset.objectUid;if(n.classList.add("t3js-file-reference-deleted"),!this.isNewRecord(e)&&!t){const r=this.container.querySelector(p`[name="cmd${n.dataset.fieldName}[delete]"]`);r.removeAttribute("disabled"),n.parentElement.insertAdjacentElement("afterbegin",r)}new f("transitionend",()=>{n.remove(),h.validate(this.container)}).bindTo(n),this.memorizeRemoveRecord(o),n.classList.add("form-irre-object--deleted"),this.isBelowMax()&&this.toggleContainerControls(!0)}toggleContainerControls(e){this.container.querySelectorAll(u.controlContainer).forEach(n=>{n.querySelectorAll("button, a").forEach(r=>{r.style.display=e?null:"none"})})}getProgress(e,t){const n="#"+t+"_header";let o;return typeof this.progressQueue[e]<"u"?o=this.progressQueue[e]:(o=S,o.configure({parent:n,showSpinner:!1}),this.progressQueue[e]=o),o}collapseAllRecords(e){const t=this.getFormFieldForElements(),n=[];if(t!==null){const o=R.trimExplode(",",t.value);for(const r of o){if(r===e)continue;const i=this.container.dataset.objectGroup+g.structureSeparator+r,s=this.getFileReferenceContainer(i);s.classList.contains(d.visible)&&(this.collapseElement(s,i),this.isNewRecord(i)?this.updateExpandedCollapsedStateLocally(i,!1):n.push(r))}}return n}getFormFieldForElements(){const e=this.container.querySelectorAll(p`[name="${this.container.dataset.formField}"]`);return e.length>0?e[0]:null}redrawSortingButtons(e,t=[]){if(t.length===0){const n=this.getFormFieldForElements();n!==null&&(t=R.trimExplode(",",n.value))}t.length!==0&&t.forEach((n,o)=>{const r=this.getFileReferenceContainer(e+g.structureSeparator+n),i=this.container.querySelector('[id="'+r.dataset.objectIdHash+'_header"]'),s=i.querySelector('[data-action="sort"][data-direction="'+b.UP+'"]');if(s!==null){let c="actions-move-up";o===0?(s.classList.add("disabled"),c="empty-empty"):s.classList.remove("disabled"),C.getIcon(c,C.sizes.small).then(m=>{s.replaceChild(document.createRange().createContextualFragment(m),s.querySelector(".t3js-icon"))})}const l=i.querySelector('[data-action="sort"][data-direction="'+b.DOWN+'"]');if(l!==null){let c="actions-move-down";o===t.length-1?(l.classList.add("disabled"),c="empty-empty"):l.classList.remove("disabled"),C.getIcon(c,C.sizes.small).then(m=>{l.replaceChild(document.createRange().createContextualFragment(m),l.querySelector(".t3js-icon"))})}})}isBelowMax(){const e=this.getFormFieldForElements();return e===null?!0:!(typeof TYPO3.settings.FormEngineInline.config[this.container.dataset.objectGroup]<"u"&&R.trimExplode(",",e.value).length>=TYPO3.settings.FormEngineInline.config[this.container.dataset.objectGroup].max)}getAppearance(){if(this.appearance===null&&(this.appearance={},typeof this.container.dataset.appearance=="string"))try{this.appearance=JSON.parse(this.container.dataset.appearance)}catch(e){console.error(e)}return this.appearance}}window.customElements.define("typo3-formengine-container-files",B);
