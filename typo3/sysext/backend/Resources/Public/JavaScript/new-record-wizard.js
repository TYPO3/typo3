/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{property as c,customElement as w}from"lit/decorators.js";import{LitElement as x,css as C,html as r,nothing as h}from"lit";import p from"@typo3/backend/modal.js";import"@typo3/backend/element/icon-element.js";import $ from"@typo3/core/ajax/ajax-request.js";import{lll as k}from"@typo3/core/lit-helper.js";import T from"@typo3/backend/notification.js";import b from"@typo3/backend/viewport.js";import E from"@typo3/core/event/regular-event.js";import{KeyTypesEnum as M}from"@typo3/backend/enum/key-types.js";var l=function(d,e,t,i){var s=arguments.length,o=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,n;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(d,e,t,i);else for(var m=d.length-1;m>=0;m--)(n=d[m])&&(o=(s<3?n(o):s>3?n(e,t,o):n(e,t))||o);return s>3&&o&&Object.defineProperty(e,t,o),o};class v{constructor(e,t,i,s,o,n,m,y,f){this.identifier=e,this.label=t,this.description=i,this.icon=s,this.url=o,this.requestType=n,this.defaultValues=m,this.saveAndClose=y,this.event=f,this.visible=!0}static fromData(e){return new v(e.identifier,e.label,e.description,e.icon,e.url??null,e.requestType??"location",e.defaultValues??[],e.saveAndClose??!1,e.event??null)}reset(){this.visible=!0}}class u{constructor(e,t,i){this.identifier=e,this.label=t,this.items=i,this.disabled=!1}static fromData(e){return new u(e.identifier,e.label,e.items.map(t=>v.fromData(t)))}reset(){this.disabled=!1,this.items.forEach(e=>{e.reset()})}activeItems(){return this.items.filter(e=>e.visible)??[]}}class g{constructor(e){this.items=e}static fromData(e){return new g(Object.values(e).map(t=>u.fromData(t)))}reset(){this.items.forEach(e=>{e.reset()})}categoriesWithItems(){return this.items.filter(e=>e.activeItems().length>0)??[]}}let a=class extends x{constructor(){super(...arguments),this.categories=new g([]),this.searchPlaceholder="newRecordWizard.filter.placeholder",this.searchNothingFoundLabel="newRecordWizard.filter.noResults",this.selectedCategory=null,this.searchTerm="",this.messages=[],this.toggleMenu=!1}static{this.styles=[C`:host{display:block;container-type:inline-size}.element{gap:var(--typo3-spacing);font-size:var(--typo3-component-font-size);line-height:var(--typo3-component-line-height)}.element,.main{display:flex;flex-direction:column}.main{width:100%;gap:calc(var(--typo3-spacing)*2)}@container (min-width: 500px){.main{flex-direction:row}}.main>*{flex-grow:1}.navigation{position:relative;flex-shrink:0}@container (min-width: 500px){.navigation{flex-grow:0;width:200px}.navigation-toggle{display:none!important}}.navigation-list{display:none;flex-direction:column;gap:2px;list-style:none;padding:0;margin:0}.navigation-list.show{display:flex}@container (max-width: 499px){.navigation-list{z-index:1;position:absolute;padding:var(--typo3-component-border-width);background:var(--typo3-component-bg);border:var(--typo3-component-border-width) solid var(--typo3-component-border-color);border-radius:var(--typo3-component-border-radius);box-shadow:var(--typo3-component-box-shadow)}}@container (min-width: 500px){.navigation-list{display:flex}}.navigation-item{cursor:pointer;align-items:center;display:flex;width:100%;gap:calc(var(--typo3-spacing)/2);text-align:start;color:inherit;background:transparent;border:var(--typo3-component-border-width) solid var(--typo3-component-border-color);border-radius:var(--typo3-component-border-radius);padding:var(--typo3-list-item-padding-y) var(--typo3-list-item-padding-x)}@container (max-width: 499px){.navigation-item{border-radius:calc(var(--typo3-component-border-radius) - var(--typo3-component-border-width))}}.navigation-item:hover{color:var(--typo3-component-hover-color);background:var(--typo3-component-hover-bg);border-color:var(--typo3-component-hover-border-color)}.navigation-item:focus{outline:none;color:var(--typo3-component-focus-color);background:var(--typo3-component-focus-bg);border-color:var(--typo3-component-focus-border-color)}.navigation-item.active{color:var(--typo3-component-active-color);background:var(--typo3-component-active-bg);border-color:var(--typo3-component-active-border-color)}.navigation-item:disabled{cursor:not-allowed;color:var(--typo3-component-disabled-color);background:var(--typo3-component-disabled-bg);border-color:var(--typo3-component-disabled-border-color)}.navigation-item-label{flex-grow:1}.navigation-item-count{opacity:.75;flex-shrink:0}.content{container-type:inline-size}.item-list{display:grid;grid-template-columns:repeat(1,1fr);gap:var(--typo3-spacing)}@container (min-width: 500px){.item-list{grid-template-columns:repeat(2,1fr)}}.item{cursor:pointer;display:flex;gap:calc(var(--typo3-spacing)/2);text-align:start;border:var(--typo3-component-border-width) solid transparent;border-radius:var(--typo3-component-border-radius);padding:var(--typo3-list-item-padding-y) var(--typo3-list-item-padding-x);background:transparent;color:inherit}.item:hover{color:var(--typo3-component-hover-color);background:var(--typo3-component-hover-bg);border-color:var(--typo3-component-hover-border-color)}.item:focus{outline:none;color:var(--typo3-component-focus-color);background:var(--typo3-component-focus-bg);border-color:var(--typo3-component-focus-border-color)}.item-body-label{text-wrap:balance;font-weight:700;margin-bottom:.25rem}.item-body-description{opacity:.75;text-wrap:pretty}`]}firstUpdated(){const e=document.createElement("link");e.setAttribute("rel","stylesheet"),e.setAttribute("href",TYPO3.settings.cssUrls.backend),this.shadowRoot.appendChild(e),this.renderRoot.querySelector('input[name="search"]').focus(),this.selectAvailableCategory()}getLanguageLabel(e){const t=k(e);return t!==""?t:e}selectAvailableCategory(){this.categories.categoriesWithItems().filter(t=>t===this.selectedCategory).length===0&&(this.selectedCategory=this.categories.categoriesWithItems()[0]??null),this.messages=[],this.selectedCategory===null&&(this.messages=[{message:this.getLanguageLabel(this.searchNothingFoundLabel),severity:"info"}])}filter(e){this.searchTerm=e,this.categories.reset(),this.categories.items.forEach(t=>{const i=t.label.trim().replace(/\s+/g," ");!(this.searchTerm!==""&&!RegExp(this.searchTerm,"i").test(i))||t.items.forEach(o=>{const n=o.label.trim().replace(/\s+/g," ")+o.description.trim().replace(/\s+/g," ");o.visible=!(this.searchTerm!==""&&!RegExp(this.searchTerm,"i").test(n))}),t.disabled=t.items.filter(o=>o.visible).length===0}),this.selectAvailableCategory()}render(){return r`<div class=element>${this.renderFilter()} ${this.renderMessages()} ${this.selectedCategory===null?h:r`<div class=main><div class=navigation>${this.renderNavigationToggle()} ${this.renderNavigationList()}</div><div class=content>${this.renderCategories()}</div></div>`}</div>`}renderFilter(){return r`<form class=filter @submit=${e=>e.preventDefault()}><input name=search type=search autocomplete=off class=form-control .value=${this.searchTerm} @input=${e=>{this.filter(e.target.value)}} @keydown=${e=>{e.key===M.ESCAPE&&(e.stopImmediatePropagation(),this.filter(""))}} placeholder=${this.getLanguageLabel(this.searchPlaceholder)}></form>`}renderMessages(){return r`${this.messages.length>0?r`<div class=messages>${this.messages.map(e=>r`<div class="alert alert-${e.severity}" role=alert>${e.message}</div>`)}</div>`:h}`}renderNavigationToggle(){return r`<button class="navigation-toggle btn btn-light" @click=${()=>{this.toggleMenu=!this.toggleMenu}}>${this.selectedCategory.label}<typo3-backend-icon identifier=actions-chevron-${this.toggleMenu===!0?"up":"down"} size=small></typo3-backend-icon></button>`}renderNavigationList(){return r`<div class=navigation-list${this.toggleMenu===!0?" show":""} role=tablist>${this.categories.items.map(e=>r`<button data-identifier=${e.identifier} class=navigation-item${this.selectedCategory===e?" active":""} ?disabled=${e.disabled} @click=${()=>{this.selectedCategory=e,this.toggleMenu=!1}}><span class=navigation-item-label>${e.label}</span> <span class=navigation-item-count>${e.activeItems().length}</span></button>`)}</div>`}renderCategories(){return r`<div class=elementwizard-categories>${this.categories.items.map(e=>this.renderCategory(e))}</div>`}renderCategory(e){return r`${this.selectedCategory===e?r`<div class=item-list>${e.items.map(t=>this.renderCategoryButton(t))}</div>`:h}`}renderCategoryButton(e){return r`${e.visible?r`<button type=button class=item data-identifier=${e.identifier} @click=${t=>{t.preventDefault(),this.handleItemClick(e)}}><div class=item-icon><typo3-backend-icon identifier=${e.icon||"empty-empty"} size=medium></typo3-backend-icon></div><div class=item-body><div class=item-body-label>${e.label}</div><div class=item-body-description>${e.description}</div></div></button>`:h}`}handleItemClick(e){if(e.requestType==="event"){const t=new CustomEvent(e.event,{detail:{item:e}});this.dispatchEvent(t),p.dismiss();return}if(e.url.trim()!==""){if(e.requestType==="location"){b.ContentContainer.setUrl(e.url),p.dismiss();return}e.requestType==="ajax"&&new $(e.url).post({defVals:e.defaultValues,saveAndClose:e.saveAndClose?"1":"0"}).then(async t=>{const i=document.createRange().createContextualFragment(await t.resolve());p.currentModal.addEventListener("modal-updated",()=>{new E("click",(s,o)=>{s.preventDefault();const n=o.dataset.target;n&&(b.ContentContainer.setUrl(n),p.dismiss())}).delegateTo(p.currentModal,"button[data-target]")}),p.currentModal.setContent(i)}).catch(()=>{T.error("Could not load module data")})}}};l([c({type:Object,converter:{fromAttribute:d=>{const e=JSON.parse(d);return g.fromData(e)}}})],a.prototype,"categories",void 0),l([c({type:String})],a.prototype,"searchPlaceholder",void 0),l([c({type:String})],a.prototype,"searchNothingFoundLabel",void 0),l([c({type:String,attribute:!1})],a.prototype,"selectedCategory",void 0),l([c({type:String,attribute:!1})],a.prototype,"searchTerm",void 0),l([c({type:Array,attribute:!1})],a.prototype,"messages",void 0),l([c({type:Boolean,attribute:!1})],a.prototype,"toggleMenu",void 0),a=l([w("typo3-backend-new-record-wizard")],a);export{g as Categories,u as Category,a as NewRecordWizard};
