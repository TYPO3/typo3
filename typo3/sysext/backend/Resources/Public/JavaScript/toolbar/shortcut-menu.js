/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import n from"@typo3/core/ajax/ajax-request.js";import i from"@typo3/backend/icons.js";import g from"@typo3/backend/modal.js";import u from"@typo3/backend/notification.js";import k from"@typo3/backend/viewport.js";import S from"@typo3/core/security-utility.js";import"@typo3/backend/element/spinner-element.js";import{Sizes as f}from"@typo3/backend/enum/icon-types.js";import l from"@typo3/core/event/regular-event.js";var r;(function(c){c.containerSelector="#typo3-cms-backend-backend-toolbaritems-shortcuttoolbaritem",c.toolbarIconSelector=".dropdown-toggle span.icon",c.toolbarMenuSelector=".dropdown-menu",c.shortcutItemSelector=".t3js-topbar-shortcut",c.shortcutJumpSelector=".t3js-shortcut-jump",c.shortcutDeleteSelector=".t3js-shortcut-delete",c.shortcutEditSelector=".t3js-shortcut-edit",c.shortcutFormSelector=".t3js-shortcut-form",c.createShortcutSelector='[data-dispatch-action="TYPO3.ShortcutMenu.createShortcut"]'})(r||(r={}));class T{constructor(){this.initializeEvents=()=>{const o=document.querySelector(r.containerSelector);new l("click",(e,t)=>{e.preventDefault(),e.stopImmediatePropagation();const s=t.closest(r.shortcutItemSelector);this.deleteShortcut(parseInt(s.dataset.shortcutid,10))}).delegateTo(o,r.shortcutDeleteSelector),new l("click",(e,t)=>{e.preventDefault(),e.stopImmediatePropagation();const s=t.closest(r.shortcutItemSelector);this.editShortcut(parseInt(s.dataset.shortcutid,10),s.dataset.shortcutgroup)}).delegateTo(o,r.shortcutEditSelector),new l("submit",(e,t)=>{e.preventDefault(),e.stopImmediatePropagation(),this.saveShortcutForm(t)}).delegateTo(o,r.shortcutFormSelector),new l("reset",e=>{e.preventDefault(),e.stopImmediatePropagation(),this.refreshMenu()}).delegateTo(o,r.shortcutFormSelector),new l("click",(e,t)=>{e.preventDefault();const s=document.querySelector("typo3-backend-module-router");s.setAttribute("endpoint",t.href),s.setAttribute("module",t.dataset.module)}).delegateTo(o,r.shortcutJumpSelector)},k.Topbar.Toolbar.registerEvent(this.initializeEvents)}createShortcut(o,e,t,s,a){new n(TYPO3.settings.ajaxUrls.shortcut_create).post({routeIdentifier:o,arguments:e,displayName:t}).then(async m=>{const d=await m.resolve();if(d.result==="success"?u.success(TYPO3.lang["bookmark.savedTitle"],TYPO3.lang["bookmark.savedMessage"]):d.result==="alreadyExists"&&u.info(TYPO3.lang["bookmark.alreadyExistsTitle"],TYPO3.lang["bookmark.alreadyExistsMessage"]),this.refreshMenu(),typeof a!="object"){console.warn(`Expected argument shortcutButton to be an object, got ${typeof a}`);return}const h=a.classList.contains("dropdown-item"),p=new S;i.getIcon("actions-system-shortcut-active",i.sizes.small).then(b=>{a.innerHTML=b+(h?" "+p.encodeHtml(TYPO3.lang["labels.alreadyBookmarked"]):"")}),h?a.setAttribute("disabled","disabled"):a.classList.add("active"),a.dataset.dispatchDisabled="disabled",a.title=p.encodeHtml(TYPO3.lang["labels.alreadyBookmarked"])}).catch(()=>{u.error(TYPO3.lang["bookmark.failedTitle"],TYPO3.lang["bookmark.failedMessage"])})}deleteShortcut(o){const e=g.confirm(TYPO3.lang["bookmark.delete"],TYPO3.lang["bookmark.confirmDelete"]);e.addEventListener("confirm.button.ok",()=>{new n(TYPO3.settings.ajaxUrls.shortcut_remove).post({shortcutId:o}).then(async t=>{const s=await t.resolve();this.refreshMenu(),this.checkIfEnableBookmarkLink(s.data)}),e.hideModal()}),e.addEventListener("confirm.button.cancel",()=>{e.hideModal()})}editShortcut(o,e){new n(TYPO3.settings.ajaxUrls.shortcut_editform).withQueryArguments({shortcutId:o,shortcutGroup:e}).get({cache:"no-cache"}).then(async t=>{document.querySelector(r.containerSelector+" "+r.toolbarMenuSelector).innerHTML=await t.resolve()})}saveShortcutForm(o){new n(TYPO3.settings.ajaxUrls.shortcut_saveform).post(new FormData(o)).then(()=>{u.success(TYPO3.lang["bookmark.savedTitle"],TYPO3.lang["bookmark.savedMessage"]),this.refreshMenu()})}refreshMenu(){const o=document.querySelector(r.containerSelector+" "+r.toolbarIconSelector),e=o.cloneNode(!0),t=document.createElement("typo3-backend-spinner");t.setAttribute("size",f.small),o.replaceWith(t),new n(TYPO3.settings.ajaxUrls.shortcut_list).get({cache:"no-cache"}).then(async s=>{document.querySelector(r.containerSelector+" "+r.toolbarMenuSelector).innerHTML=await s.resolve()}).finally(()=>{document.querySelector(r.containerSelector+" typo3-backend-spinner").replaceWith(e)})}checkIfEnableBookmarkLink(o){const e=top.list_frame?.document.querySelector(r.createShortcutSelector);if(!e)return;const t=JSON.parse(e.dataset.dispatchArgs.replace(/&quot;/g,'"'));if(t[0]!==o.route||t[1]!==o.args)return;const s=new S,a=e.classList.contains("dropdown-item");i.getIcon("actions-system-shortcut-new",i.sizes.small).then(m=>{e.innerHTML=m+(a?" "+s.encodeHtml(TYPO3.lang["labels.makeBookmark"]):"")}),e.title=s.encodeHtml(TYPO3.lang["labels.makeBookmark"]),delete e.dataset.dispatchDisabled,a?e.removeAttribute("disabled"):e.classList.remove("active")}}(!top.TYPO3.ShortcutMenu||typeof top.TYPO3.ShortcutMenu!="object")&&(top.TYPO3.ShortcutMenu=new T);const y=top.TYPO3.ShortcutMenu;export{y as default};
