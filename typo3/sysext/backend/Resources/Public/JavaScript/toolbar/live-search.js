/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{lll as w}from"@typo3/core/lit-helper.js";import p from"@typo3/backend/modal.js";import"@typo3/backend/element/icon-element.js";import"@typo3/backend/input/clearable.js";import"@typo3/backend/live-search/element/hint.js";import"@typo3/backend/live-search/element/result/result-pagination.js";import"@typo3/backend/live-search/element/search-option-item.js";import"@typo3/backend/live-search/live-search-shortcut.js";import E from"@typo3/core/document-service.js";import a from"@typo3/core/event/regular-event.js";import R from"@typo3/core/event/debounce-event.js";import{SeverityEnum as k}from"@typo3/backend/enum/severity.js";import O from"@typo3/core/ajax/ajax-request.js";import d from"@typo3/backend/storage/browser-session.js";import{componentName as C}from"@typo3/backend/live-search/element/result/result-container.js";import{ModuleStateStorage as T}from"@typo3/backend/storage/module-state-storage.js";var v;(function(S){S.toolbarItem=".t3js-topbar-button-search"})(v||(v={}));class j{constructor(){this.currentSearchRequest=null,this.search=async e=>{if(e.get("query").toString()==="")this.updateSearchResults(null);else{const n=document.querySelector(C);n.loading=!0,this.currentSearchRequest?.abort();try{this.currentSearchRequest=new O(TYPO3.settings.ajaxUrls.livesearch);const u=await(await this.currentSearchRequest.post(e)).raw().json();this.currentSearchRequest=null,this.updateSearchResults(u)}catch(c){if(c instanceof DOMException&&c.name==="AbortError")return;throw c}}},E.ready().then(()=>{this.registerEvents()})}registerEvents(){new a("click",()=>{this.openSearchModal()}).delegateTo(document,v.toolbarItem),new a("typo3:live-search:trigger-open",()=>{p.currentModal||this.openSearchModal()}).bindTo(document)}openSearchModal(){const e=new URL(TYPO3.settings.ajaxUrls.livesearch_form,window.location.origin),r=T.current("web");r.identifier&&e.searchParams.set("pageId",r.identifier),e.searchParams.set("query",d.get("livesearch-term")??""),e.searchParams.set("offset",d.get("livesearch-offset")??"0");const n=Object.entries(d.getByPrefix("livesearch-option-")).filter(o=>o[1]==="1").map(o=>{const t=o[0].replace("livesearch-option-",""),[i,m]=t.split("-",2);return{key:i,value:m}}),c=this.composeSearchOptions(n);for(const[o,t]of Object.entries(c))for(const i of t)e.searchParams.append(`${o}[]`,i);const u=p.advanced({type:p.types.ajax,content:e.toString(),title:w("labels.search"),severity:k.notice,size:p.sizes.medium,ajaxCallback:()=>{const o=u.querySelector("typo3-backend-live-search"),t=o.querySelector("form"),i=t.querySelector('input[type="search"]'),m=t.querySelector('input[name="offset"]');new a("livesearch:demand-changed",()=>{m.value="0",t.requestSubmit()}).bindTo(o),new a("livesearch:pagination-selected",h=>{m.value=h.detail.offset.toString(10),t.requestSubmit()}).bindTo(o),new a("submit",h=>{h.preventDefault();const l=new FormData(t);this.search(l).then(()=>{const q=l.get("query").toString(),g=l.get("offset")?.toString();d.set("livesearch-term",q),g&&d.set("livesearch-offset",g)});const s=t.querySelector("[data-active-options-counter]"),y=parseInt(s.dataset.activeOptionsCounter,10);s.querySelector("output").textContent=y.toString(10),s.classList.toggle("hidden",y===0)}).bindTo(t),i.clearable({onClear:()=>{t.requestSubmit()}});const b=document.querySelector("typo3-backend-live-search-result-container");new a("live-search:item-chosen",()=>{p.dismiss()}).bindTo(b),new a("typo3:live-search:option-invoked",h=>{const l=t.querySelector("[data-active-options-counter]");let s=parseInt(l.dataset.activeOptionsCounter,10);s=h.detail.active?s+1:s-1,l.dataset.activeOptionsCounter=s.toString(10),o.dispatchEvent(new CustomEvent("livesearch:demand-changed"))}).bindTo(o),new R("input",()=>{o.dispatchEvent(new CustomEvent("livesearch:demand-changed"))}).bindTo(i),new a("keydown",this.handleKeyDown).bindTo(i),t.requestSubmit()}});["modal-loaded","typo3-modal-shown"].forEach(o=>{u.addEventListener(o,()=>{const t=u.querySelector('input[type="search"]');t!==null&&(t.focus(),t.select())})})}composeSearchOptions(e){const r={};return e.forEach(n=>{r[n.key]===void 0&&(r[n.key]=[]),r[n.key].push(n.value)}),r}handleKeyDown(e){if(e.key!=="ArrowDown")return;e.preventDefault(),document.querySelector("typo3-backend-live-search").querySelector("typo3-backend-live-search-result-item")?.focus()}updateSearchResults(e){const r=document.querySelector("typo3-backend-live-search-result-container");r.results=e?.results??null,r.loading=!1,this.updatePagination(e?.pagination??null)}updatePagination(e){const r=document.querySelector("typo3-backend-live-search-result-pagination");r.pagination=e}}let f;top.TYPO3.LiveSearch?f=top.TYPO3.LiveSearch:(f=new j,top.TYPO3.LiveSearch=f);var P=f;export{P as default};
