/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{lll as w}from"@typo3/core/lit-helper.js";import d from"@typo3/backend/modal.js";import"@typo3/backend/element/icon-element.js";import"@typo3/backend/input/clearable.js";import"@typo3/backend/live-search/element/hint.js";import"@typo3/backend/live-search/element/result/result-pagination.js";import"@typo3/backend/live-search/element/search-option-item.js";import"@typo3/backend/live-search/live-search-shortcut.js";import E from"@typo3/core/document-service.js";import i from"@typo3/core/event/regular-event.js";import k from"@typo3/core/event/debounce-event.js";import{SeverityEnum as R}from"@typo3/backend/enum/severity.js";import O from"@typo3/core/ajax/ajax-request.js";import h from"@typo3/backend/storage/browser-session.js";import{componentName as C}from"@typo3/backend/live-search/element/result/result-container.js";import{ModuleStateStorage as T}from"@typo3/backend/storage/module-state-storage.js";var v;(function(S){S.toolbarItem=".t3js-topbar-button-search"})(v||(v={}));class j{constructor(){this.currentSearchRequest=null,this.search=async e=>{if(e.get("query").toString()==="")this.updateSearchResults(null);else{const n=document.querySelector(C),f=document.querySelector("typo3-backend-live-search-result-pagination");n.loading=!0,f.loading=!0,this.currentSearchRequest?.abort();try{this.currentSearchRequest=new O(TYPO3.settings.ajaxUrls.livesearch);const r=await(await this.currentSearchRequest.post(e)).raw().json();this.currentSearchRequest=null,this.updateSearchResults(r)}catch(a){if(a instanceof DOMException&&a.name==="AbortError")return;throw a}}},E.ready().then(()=>{this.registerEvents()})}registerEvents(){new i("click",()=>{this.openSearchModal()}).delegateTo(document,v.toolbarItem),new i("typo3:live-search:trigger-open",()=>{d.currentModal||this.openSearchModal()}).bindTo(document)}openSearchModal(){const e=new URL(TYPO3.settings.ajaxUrls.livesearch_form,window.location.origin),o=T.current("web");o.identifier&&e.searchParams.set("pageId",o.identifier),e.searchParams.set("query",h.get("livesearch-term")??""),e.searchParams.set("offset",h.get("livesearch-offset")??"0");const n=Object.entries(h.getByPrefix("livesearch-option-")).filter(r=>r[1]==="1").map(r=>{const t=r[0].replace("livesearch-option-",""),[c,p]=t.split("-",2);return{key:c,value:p}}),f=this.composeSearchOptions(n);for(const[r,t]of Object.entries(f))for(const c of t)e.searchParams.append(`${r}[]`,c);const a=d.advanced({type:d.types.ajax,content:e.toString(),title:w("labels.search"),severity:R.notice,size:d.sizes.medium,ajaxCallback:()=>{const r=a.querySelector("typo3-backend-live-search"),t=r.querySelector("form"),c=t.querySelector('input[type="search"]'),p=t.querySelector('input[name="offset"]');new i("livesearch:demand-changed",()=>{p.value="0",t.requestSubmit()}).bindTo(r),new i("livesearch:pagination-selected",u=>{p.value=u.detail.offset.toString(10),t.requestSubmit()}).bindTo(r),new i("submit",u=>{u.preventDefault();const l=new FormData(t);this.search(l).then(()=>{const q=l.get("query").toString(),g=l.get("offset")?.toString();h.set("livesearch-term",q),g&&h.set("livesearch-offset",g)});const s=t.querySelector("[data-active-options-counter]"),y=parseInt(s.dataset.activeOptionsCounter,10);s.querySelector("output").textContent=y.toString(10),s.classList.toggle("hidden",y===0)}).bindTo(t),c.clearable({onClear:()=>{t.requestSubmit()}});const b=document.querySelector("typo3-backend-live-search-result-container");new i("live-search:item-chosen",()=>{d.dismiss()}).bindTo(b),new i("typo3:live-search:option-invoked",u=>{const l=t.querySelector("[data-active-options-counter]");let s=parseInt(l.dataset.activeOptionsCounter,10);s=u.detail.active?s+1:s-1,l.dataset.activeOptionsCounter=s.toString(10),r.dispatchEvent(new CustomEvent("livesearch:demand-changed"))}).bindTo(r),new k("input",()=>{r.dispatchEvent(new CustomEvent("livesearch:demand-changed"))}).bindTo(c),new i("keydown",this.handleKeyDown).bindTo(c),t.requestSubmit()}});["modal-loaded","typo3-modal-shown"].forEach(r=>{a.addEventListener(r,()=>{const t=a.querySelector('input[type="search"]');t!==null&&(t.focus(),t.select())})})}composeSearchOptions(e){const o={};return e.forEach(n=>{o[n.key]===void 0&&(o[n.key]=[]),o[n.key].push(n.value)}),o}handleKeyDown(e){if(e.key!=="ArrowDown")return;e.preventDefault(),document.querySelector("typo3-backend-live-search").querySelector("typo3-backend-live-search-result-item")?.focus()}updateSearchResults(e){const o=document.querySelector("typo3-backend-live-search-result-container");o.results=e?.results??null,o.loading=!1,this.updatePagination(e?.pagination??null)}updatePagination(e){const o=document.querySelector("typo3-backend-live-search-result-pagination");o.pagination=e,o.loading=!1}}let m;top.TYPO3.LiveSearch?m=top.TYPO3.LiveSearch:(m=new j,top.TYPO3.LiveSearch=m);var P=m;export{P as default};
