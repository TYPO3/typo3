/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{lll as w}from"@typo3/core/lit-helper.js";import h from"@typo3/backend/modal.js";import"@typo3/backend/element/icon-element.js";import"@typo3/backend/live-search/element/hint.js";import"@typo3/backend/live-search/element/result/result-pagination.js";import"@typo3/backend/live-search/element/search-option-item.js";import"@typo3/backend/live-search/live-search-shortcut.js";import E from"@typo3/core/document-service.js";import s from"@typo3/core/event/regular-event.js";import R from"@typo3/core/event/debounce-event.js";import{SeverityEnum as k}from"@typo3/backend/enum/severity.js";import O from"@typo3/core/ajax/ajax-request.js";import d from"@typo3/backend/storage/browser-session.js";import{componentName as T}from"@typo3/backend/live-search/element/result/result-container.js";import{ModuleStateStorage as C}from"@typo3/backend/storage/module-state-storage.js";var v;(function(S){S.toolbarItem=".t3js-topbar-button-search"})(v||(v={}));class j{constructor(){this.currentSearchRequest=null,this.search=async e=>{if(e.get("query").toString()==="")this.updateSearchResults();else{const n=document.querySelector(T),f=document.querySelector("typo3-backend-live-search-result-pagination");n.loading=!0,f.loading=!0,this.currentSearchRequest?.abort();try{this.currentSearchRequest=new O(TYPO3.settings.ajaxUrls.livesearch);const r=await(await this.currentSearchRequest.post(e)).raw().json();this.currentSearchRequest=null,this.updateSearchResults(r)}catch(a){if(this.updateSearchResults(null,!0),a instanceof DOMException&&a.name==="AbortError")return;throw a}}},E.ready().then(()=>{this.registerEvents()})}registerEvents(){new s("click",()=>{this.openSearchModal()}).delegateTo(document,v.toolbarItem),new s("typo3:live-search:trigger-open",()=>{h.currentModal||this.openSearchModal()}).bindTo(document)}openSearchModal(){const e=new URL(TYPO3.settings.ajaxUrls.livesearch_form,window.location.origin),o=C.current("web");o.identifier&&e.searchParams.set("pageId",o.identifier),e.searchParams.set("query",d.get("livesearch-term")??""),e.searchParams.set("offset",d.get("livesearch-offset")??"0");const n=Object.entries(d.getByPrefix("livesearch-option-")).filter(r=>r[1]==="1").map(r=>{const t=r[0].replace("livesearch-option-",""),[i,p]=t.split("-",2);return{key:i,value:p}}),f=this.composeSearchOptions(n);for(const[r,t]of Object.entries(f))for(const i of t)e.searchParams.append(`${r}[]`,i);const a=h.advanced({type:h.types.ajax,content:e.toString(),title:w("labels.search"),severity:k.notice,size:h.sizes.medium,ajaxCallback:()=>{const r=a.querySelector("typo3-backend-live-search"),t=r.querySelector("form"),i=t.querySelector('input[type="search"]'),p=t.querySelector('input[name="offset"]');new s("livesearch:demand-changed",()=>{p.value="0",t.requestSubmit()}).bindTo(r),new s("livesearch:pagination-selected",u=>{p.value=u.detail.offset.toString(10),t.requestSubmit()}).bindTo(r),new s("submit",u=>{u.preventDefault();const l=new FormData(t);this.search(l).then(()=>{const q=l.get("query").toString(),g=l.get("offset")?.toString();d.set("livesearch-term",q),g&&d.set("livesearch-offset",g)});const c=t.querySelector("[data-active-options-counter]"),y=parseInt(c.dataset.activeOptionsCounter,10);c.querySelector("output").textContent=y.toString(10),c.classList.toggle("hidden",y===0)}).bindTo(t),new s("search",()=>{i.value===""&&t.requestSubmit()}).bindTo(i);const b=document.querySelector("typo3-backend-live-search-result-container");new s("live-search:item-chosen",()=>{h.dismiss()}).bindTo(b),new s("typo3:live-search:option-invoked",u=>{const l=t.querySelector("[data-active-options-counter]");let c=parseInt(l.dataset.activeOptionsCounter,10);c=u.detail.active?c+1:c-1,l.dataset.activeOptionsCounter=c.toString(10),r.dispatchEvent(new CustomEvent("livesearch:demand-changed"))}).bindTo(r),new R("input",()=>{r.dispatchEvent(new CustomEvent("livesearch:demand-changed"))}).bindTo(i),new s("keydown",this.handleKeyDown).bindTo(i),t.requestSubmit()}});["modal-loaded","typo3-modal-shown"].forEach(r=>{a.addEventListener(r,()=>{const t=a.querySelector('input[type="search"]');t!==null&&(t.focus(),t.select())})})}composeSearchOptions(e){const o={};return e.forEach(n=>{o[n.key]===void 0&&(o[n.key]=[]),o[n.key].push(n.value)}),o}handleKeyDown(e){if(e.key!=="ArrowDown")return;e.preventDefault(),document.querySelector("typo3-backend-live-search").querySelector("typo3-backend-live-search-result-item")?.focus()}updateSearchResults(e=null,o=!1){const n=document.querySelector("typo3-backend-live-search-result-container");n.results=e?.results??null,n.loading=!1,n.hasErrors=o,this.updatePagination(e?.pagination??null)}updatePagination(e){const o=document.querySelector("typo3-backend-live-search-result-pagination");o.pagination=e,o.loading=!1}}let m;top.TYPO3.LiveSearch?m=top.TYPO3.LiveSearch:(m=new j,top.TYPO3.LiveSearch=m);var P=m;export{P as default};
