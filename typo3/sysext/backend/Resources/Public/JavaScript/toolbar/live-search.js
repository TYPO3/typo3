/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{lll as q}from"@typo3/core/lit-helper.js";import u from"@typo3/backend/modal.js";import"@typo3/backend/element/icon-element.js";import"@typo3/backend/input/clearable.js";import"@typo3/backend/live-search/element/result/result-pagination.js";import"@typo3/backend/live-search/element/search-option-item.js";import"@typo3/backend/live-search/live-search-shortcut.js";import T from"@typo3/core/document-service.js";import n from"@typo3/core/event/regular-event.js";import O from"@typo3/core/event/debounce-event.js";import{SeverityEnum as k}from"@typo3/backend/enum/severity.js";import E from"@typo3/core/ajax/ajax-request.js";import d from"@typo3/backend/storage/browser-session.js";import{componentName as C}from"@typo3/backend/live-search/element/result/result-container.js";import{ModuleStateStorage as j}from"@typo3/backend/storage/module-state-storage.js";var m;(function(f){f.toolbarItem=".t3js-topbar-button-search",f.searchOptionDropdownToggle=".t3js-search-provider-dropdown-toggle"})(m||(m={}));class P{constructor(){this.search=async t=>{if(t.get("query").toString()==="")this.updateSearchResults(null);else{const a=document.querySelector(C);a.loading=!0;const S=await(await new E(TYPO3.settings.ajaxUrls.livesearch).post(t)).raw().json();this.updateSearchResults(S)}},T.ready().then(()=>{this.registerEvents()})}registerEvents(){new n("click",()=>{this.openSearchModal()}).delegateTo(document,m.toolbarItem),new n("typo3:live-search:trigger-open",()=>{u.currentModal||this.openSearchModal()}).bindTo(document)}openSearchModal(){const t=new URL(TYPO3.settings.ajaxUrls.livesearch_form,window.location.origin),o=j.current("web");o.identifier&&t.searchParams.set("pageId",o.identifier),t.searchParams.set("query",d.get("livesearch-term")??""),t.searchParams.set("offset",d.get("livesearch-offset")??"0");const a=Object.entries(d.getByPrefix("livesearch-option-")).filter(r=>r[1]==="1").map(r=>{const e=r[0].replace("livesearch-option-",""),[i,h]=e.split("-",2);return{key:i,value:h}}),S=this.composeSearchOptions(a);for(const[r,e]of Object.entries(S))for(const i of e)t.searchParams.append(`${r}[]`,i);const p=u.advanced({type:u.types.ajax,content:t.toString(),title:q("labels.search"),severity:k.notice,size:u.sizes.medium,ajaxCallback:()=>{const r=p.querySelector("typo3-backend-live-search"),e=r.querySelector("form"),i=e.querySelector('input[type="search"]'),h=e.querySelector('input[name="offset"]');new n("livesearch:demand-changed",()=>{h.value="0"}).bindTo(r),new n("livesearch:pagination-selected",l=>{h.value=l.detail.offset.toString(10),e.requestSubmit()}).bindTo(r),new n("submit",l=>{l.preventDefault();const c=new FormData(e);this.search(c).then(()=>{const w=c.get("query").toString(),g=c.get("offset")?.toString();d.set("livesearch-term",w),g&&d.set("livesearch-offset",g)});const s=e.querySelector("[data-active-options-counter]"),y=parseInt(s.dataset.activeOptionsCounter,10);s.querySelector("output").textContent=y.toString(10),s.classList.toggle("hidden",y===0)}).bindTo(e),i.clearable({onClear:()=>{e.requestSubmit()}});const b=document.querySelector("typo3-backend-live-search-result-container");new n("live-search:item-chosen",()=>{u.dismiss()}).bindTo(b),new n("typo3:live-search:option-invoked",l=>{r.dispatchEvent(new CustomEvent("livesearch:demand-changed"));const c=e.querySelector("[data-active-options-counter]");let s=parseInt(c.dataset.activeOptionsCounter,10);s=l.detail.active?s+1:s-1,c.dataset.activeOptionsCounter=s.toString(10)}).bindTo(r),new n("hide.bs.dropdown",()=>{e.requestSubmit()}).bindTo(p.querySelector(m.searchOptionDropdownToggle)),new O("input",()=>{r.dispatchEvent(new CustomEvent("livesearch:demand-changed")),e.requestSubmit()}).bindTo(i),new n("keydown",this.handleKeyDown).bindTo(i),e.requestSubmit()}});["modal-loaded","typo3-modal-shown"].forEach(r=>{p.addEventListener(r,()=>{const e=p.querySelector('input[type="search"]');e!==null&&(e.focus(),e.select())})})}composeSearchOptions(t){const o={};return t.forEach(a=>{o[a.key]===void 0&&(o[a.key]=[]),o[a.key].push(a.value)}),o}handleKeyDown(t){if(t.key!=="ArrowDown")return;t.preventDefault(),document.querySelector("typo3-backend-live-search").querySelector("typo3-backend-live-search-result-item")?.focus()}updateSearchResults(t){const o=document.querySelector("typo3-backend-live-search-result-container");o.results=t?.results??null,o.loading=!1,this.updatePagination(t?.pagination??null)}updatePagination(t){const o=document.querySelector("typo3-backend-live-search-result-pagination");o.pagination=t}}let v;top.TYPO3.LiveSearch?v=top.TYPO3.LiveSearch:(v=new P,top.TYPO3.LiveSearch=v);var R=v;export{R as default};
