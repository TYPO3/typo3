/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import c from"flatpickr";import p from"@typo3/backend/storage/persistent.js";import f from"shortcut-buttons-flatpickr";import{DateTime as u}from"luxon";import D from"@typo3/core/event/throttle-event.js";import"@typo3/backend/input/clearable.js";const l="ISO8601_LOCALTIME";class g{constructor(){this.format=(typeof opener?.top?.TYPO3<"u"?opener.top:top).TYPO3.settings.DateTimePicker.DateFormat}initialize(a){if(!(a instanceof HTMLInputElement)||typeof a.dataset.datepickerInitialized<"u")return;let r=document.documentElement.lang;!r||r==="en"?r="default":r==="ch"&&(r="zh"),a.dataset.datepickerInitialized="1",import("flatpickr/dist/l10n").then(()=>{this.initializeField(a,r)})}initializeField(a,r){const s=this.getScrollEvent(),i=this.getDateOptions(a);i.locale=r;const e=p.get("dateTimeFirstDayOfWeek");if(e!==""){const o=parseInt(e,10)-1;c.l10ns[r].firstDayOfWeek=o,c.l10ns.default.firstDayOfWeek=o}i.onOpen=[()=>{s.bindTo(document.querySelector(".t3js-module-body"))}],i.onClose=()=>{s.release()};const n=c(a,i);n.altInput instanceof HTMLInputElement&&n.input.addEventListener("typo3:internal:clear",()=>{n.clear()}),n._input.addEventListener("change",o=>{const t=o.target.value,d=n.parseDate(t,n.config.altFormat);n.setDate(d,!0)}),n._input.addEventListener("keyup",o=>{o.key==="Escape"&&n.close()})}getScrollEvent(){return new D("scroll",()=>{const a=document.querySelector(".flatpickr-input.active");if(a===null)return;const r=a.getBoundingClientRect(),s=2,i=a._flatpickr.calendarContainer.offsetHeight,n=window.innerHeight-r.bottom<i&&r.top>i;let o,t;n?(o=r.y-i-s,t="arrowBottom"):(o=r.y+r.height+s,t="arrowTop"),a._flatpickr.calendarContainer.style.top=o+"px",a._flatpickr.calendarContainer.classList.remove("arrowBottom","arrowTop"),a._flatpickr.calendarContainer.classList.add(t)},15)}getDateOptions(a){const r=this.format,s=a.dataset.dateType,i=new Date,e={altFormat:"",allowInput:!0,altInput:!0,ariaDateFormat:"DDDD",dateFormat:l,defaultHour:i.getHours(),defaultMinute:i.getMinutes(),enableSeconds:!1,enableTime:!1,formatDate:(n,o)=>{const t=u.fromJSDate(n);return o===l?t.toISO({suppressMilliseconds:!0,includeOffset:!1}):t.toFormat(o)},parseDate:(n,o)=>{if(o===l){const t=u.fromISO(n);if(!t.isValid)throw new Error("Invalid ISO8601 date: "+n);return t.toJSDate()}return u.fromFormat(n,o).toJSDate()},onReady:(n,o,t)=>{if(t.altInput!==void 0){t.altInput.id=t.input.id,t.input.removeAttribute("id"),t.altInput.setAttribute("autocomplete","off"),t.altInput.clearable(),t.input.dataset.formengineInputName!==void 0&&(t.altInput.dataset.formengineDatepickerRealInputName=t.input.dataset.formengineInputName),t.altInput.form.addEventListener("t3-formengine-postfieldvalidation",m=>{m.detail.field===t.input&&t.altInput.classList.toggle("has-error",!m.detail.isValid)});const d=t.altInput.closest(".form-control-clearable-wrapper");d!==null&&d.insertAdjacentElement("afterend",t.input)}},onChange:(n,o,t)=>{t.input.dispatchEvent(new Event("formengine.dp.change"))},maxDate:"",minDate:"",minuteIncrement:1,noCalendar:!1,showMonths:1,monthSelectorType:s.startsWith("date")?"dropdown":"static",weekNumbers:!0,time_24hr:!Intl.DateTimeFormat(navigator.language,{hour:"numeric"}).resolvedOptions().hour12,plugins:[f({theme:"typo3",button:[{label:top.TYPO3.lang["labels.datepicker.today"]||"Today"}],onClick:(n,o)=>{o.setDate(new Date,!0)}})]};switch(s){case"datetime":e.altFormat=r[1],e.enableTime=!0;break;case"date":e.altFormat=r[0];break;case"time":e.altFormat="HH:mm",e.enableTime=!0,e.noCalendar=!0;break;case"timesec":e.altFormat="HH:mm:ss",e.enableSeconds=!0,e.enableTime=!0,e.noCalendar=!0;break;case"datetimesec":e.altFormat=r[0]+" HH:mm:ss",e.enableSeconds=!0,e.enableTime=!0;break;case"year":e.altFormat="yyyy";break;default:}return a.dataset.dateMinDate!==void 0&&(e.minDate=e.parseDate(a.dataset.dateMinDate,l),e.minDate.setSeconds(0)),a.dataset.dateMaxDate!==void 0&&(e.maxDate=e.parseDate(a.dataset.dateMaxDate,l),e.maxDate.setSeconds(59)),e}}var h=new g;export{h as default};
