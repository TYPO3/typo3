/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{html as h,LitElement as _}from"lit";import{state as P,customElement as O}from"lit/decorators.js";import g,{Sizes as m,Styles as f}from"@typo3/backend/modal.js";import{SeverityEnum as p}from"@typo3/backend/enum/severity.js";import d from"@typo3/core/ajax/ajax-request.js";import w from"@typo3/backend/notification.js";import"@typo3/backend/element/progress-bar-element.js";var T=function(n,e,t,i){var o=arguments.length,s=o<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(n,e,t,i);else for(var a=n.length-1;a>=0;a--)(r=n[a])&&(s=(o<3?r(s):o>3?r(e,t,s):r(e,t))||s);return o>3&&s&&Object.defineProperty(e,t,s),s},c;(function(n){n.loginrefresh="t3js-modal-loginrefresh",n.lockedModal="t3js-modal-backendlocked",n.loginFormModal="t3js-modal-backendloginform"})(c||(c={}));class y{constructor(){this.intervalTime=60,this.intervalId=null,this.backendIsLocked=!1,this.timeoutModal=null,this.backendLockedModal=null,this.loginForm=null,this.requestTokenUrl="",this.loginFramesetUrl="",this.logoutUrl="",this.submitForm=async(e,t)=>{e.preventDefault();const o=await(await new d(this.requestTokenUrl).post({})).resolve("application/json");if(!o.headerName||!o.requestToken)return;const s=t.querySelector("input[name=p_field]"),r=t.querySelector("input[name=userident]"),a=s.value;if(a===""&&r.value===""){w.error(TYPO3.lang["mess.refresh_login_failed"],TYPO3.lang["mess.refresh_login_emptyPassword"]),s.focus();return}a&&(r.value=a,s.value="");const v={login_status:"login"};for(const[b,L]of new FormData(t))v[b]=L.toString();const k=new Headers;k.set(o.headerName,o.requestToken),(await(await new d(t.getAttribute("action")).post(v,{headers:k})).resolve()).login.success?this.hideLoginForm():(w.error(TYPO3.lang["mess.refresh_login_failed"],TYPO3.lang["mess.refresh_login_failed_message"]),s.focus())},this.checkActiveSession=async()=>{try{const t=await(await new d(TYPO3.settings.ajaxUrls.login_timedout).get()).resolve();t.login.locked?this.backendIsLocked||(this.backendIsLocked=!0,this.showBackendLockedModal()):this.backendIsLocked&&(this.backendIsLocked=!1,this.hideBackendLockedModal()),this.backendIsLocked||(t.login.timed_out||t.login.will_time_out)&&(t.login.timed_out?this.showLoginForm():this.showTimeoutModal())}catch{this.backendIsLocked=!0,this.showBackendLockedModal()}}}initialize(e){typeof e=="object"&&this.applyOptions(e),this.startTask()}startTask(){if(this.intervalId!==null)return;const e=this.intervalTime*1e3;this.intervalId=setInterval(this.checkActiveSession,e)}stopTask(){clearInterval(this.intervalId),this.intervalId=null}setIntervalTime(e){this.intervalTime=Math.min(e,86400)}setLogoutUrl(e){this.logoutUrl=e}setLoginFramesetUrl(e){this.loginFramesetUrl=e}showTimeoutModal(){this.timeoutModal=this.createTimeoutModal(),this.timeoutModal.addEventListener("typo3-modal-hidden",()=>this.timeoutModal=null),this.timeoutModal.addEventListener("show-login-form",()=>{this.timeoutModal.hideModal(),this.showLoginForm()})}hideTimeoutModal(){this.timeoutModal?.hideModal()}showBackendLockedModal(){this.backendLockedModal||(this.backendLockedModal=this.createBackendLockedModal(),this.backendLockedModal.addEventListener("typo3-modal-hidden",()=>this.backendLockedModal=null))}hideBackendLockedModal(){this.backendLockedModal?.hideModal()}showLoginForm(){this.loginForm||new d(TYPO3.settings.ajaxUrls.logout).get().then(()=>{TYPO3.configuration.showRefreshLoginPopup?this.showLoginPopup():(this.loginForm=this.createLoginFormModal(),this.loginForm.addEventListener("typo3-modal-hidden",()=>this.loginForm=null))})}showLoginPopup(){const e=window.open(this.loginFramesetUrl,"relogin_"+Math.random().toString(16).slice(2),"height=450,width=700,status=0,menubar=0,location=1");e&&e.focus()}hideLoginForm(){this.loginForm?.hideModal()}createBackendLockedModal(){return g.advanced({additionalCssClasses:[c.lockedModal],title:TYPO3.lang["mess.please_wait"],severity:p.notice,style:f.light,size:m.small,staticBackdrop:!0,hideCloseButton:!0,content:h`<p>${TYPO3.lang["mess.be_locked"]}</p>`})}createTimeoutModal(){const e=g.advanced({additionalCssClasses:[c.loginrefresh],title:TYPO3.lang["mess.login_about_to_expire_title"],severity:p.notice,style:f.light,size:m.small,staticBackdrop:!0,hideCloseButton:!0,buttons:[{text:TYPO3.lang["mess.refresh_login_logout_button"],active:!1,btnClass:"btn-default",name:"logout",trigger:()=>top.location.href=this.logoutUrl},{text:TYPO3.lang["mess.refresh_login_refresh_button"],active:!0,btnClass:"btn-primary",name:"refreshSession",trigger:async(t,i)=>{const s=await(await new d(TYPO3.settings.ajaxUrls.login_refresh).get()).resolve();i.hideModal(),s.refresh.success||i.dispatchEvent(new Event("show-login-form"))}}],content:h`<p>${TYPO3.lang["mess.login_about_to_expire"]}</p><typo3-login-refresh-progress-bar @progress-bar-overdue=${()=>e.dispatchEvent(new Event("show-login-form"))}></typo3-login-refresh-progress-bar>`});return e.addEventListener("typo3-modal-hidden",()=>{this.startTask()}),e.addEventListener("typo3-modal-shown",()=>{this.stopTask()}),e}createLoginFormModal(){const e=String(TYPO3.lang["mess.refresh_login_title"]).replace("%s",TYPO3.configuration.username),t=g.advanced({additionalCssClasses:[c.loginFormModal],title:e,severity:p.notice,style:f.light,size:m.small,staticBackdrop:!0,hideCloseButton:!0,buttons:[{text:TYPO3.lang["mess.refresh_exit_button"],active:!1,btnClass:"btn-default",name:"logout",trigger:()=>top.location.href=this.logoutUrl},{text:TYPO3.lang["mess.refresh_login_button"],active:!1,btnClass:"btn-primary",name:"refreshSession",trigger:async(i,o)=>{o.querySelector("form").requestSubmit();const r=await(await new d(TYPO3.settings.ajaxUrls.login_refresh).get()).resolve();o.hideModal(),r.refresh.success||o.dispatchEvent(new Event("show-login-form"))}}],content:h`<p>${TYPO3.lang["mess.login_expired"]}</p><form id=beLoginRefresh method=POST action=${TYPO3.settings.ajaxUrls.login} @submit=${i=>this.submitForm(i,i.currentTarget)}><div><input type=text name=username class=d-none autocomplete=username .value=${TYPO3.configuration.username}> <input type=hidden name=userident id=t3-loginrefresh-userident></div><div class=form-group><input type=password name=p_field autofocus class=form-control autocomplete=current-password placeholder=${TYPO3.lang["mess.refresh_login_password"]}></div></form>`});return t.addEventListener("typo3-modal-hidden",()=>{this.startTask()}),t.addEventListener("typo3-modal-shown",()=>{this.stopTask()}),t}applyOptions(e){e.intervalTime!==void 0&&this.setIntervalTime(e.intervalTime),e.loginFramesetUrl!==void 0&&this.setLoginFramesetUrl(e.loginFramesetUrl),e.logoutUrl!==void 0&&this.setLogoutUrl(e.logoutUrl),e.requestTokenUrl!==void 0&&(this.requestTokenUrl=e.requestTokenUrl)}}let u=class extends _{constructor(){super(...arguments),this.current=0,this.max=100,this.advanceProgressBar=()=>{this.current++,this.current>=this.max&&this.dispatchEvent(new Event("progress-bar-overdue"))}}connectedCallback(){super.connectedCallback(),this.intervalId&&clearInterval(this.intervalId),this.intervalId=setInterval(this.advanceProgressBar,300)}disconnectedCallback(){super.disconnectedCallback(),this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null)}createRenderRoot(){return this}render(){return h`<typo3-backend-progress-bar value=${100-this.current} max=100></typo3-backend-progress-bar>`}};T([P()],u.prototype,"current",void 0),u=T([O("typo3-login-refresh-progress-bar")],u);let l;try{window.opener&&window.opener.TYPO3&&window.opener.TYPO3.LoginRefresh&&(l=window.opener.TYPO3.LoginRefresh),parent&&parent.window.TYPO3&&parent.window.TYPO3.LoginRefresh&&(l=parent.window.TYPO3.LoginRefresh),top&&top.TYPO3&&top.TYPO3.LoginRefresh&&(l=top.TYPO3.LoginRefresh)}catch{}l||(l=new y,typeof TYPO3<"u"&&(TYPO3.LoginRefresh=l));var M=l;export{u as SelfFillingProgressBarElement,M as default};
