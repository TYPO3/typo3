/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import $ from"jquery";import"jquery-ui/droppable.js";import DataHandler from"@typo3/backend/ajax-data-handler.js";import Icons from"@typo3/backend/icons.js";class DragDrop{static initialize(){$(DragDrop.contentIdentifier).draggable({handle:DragDrop.dragHeaderIdentifier,scope:"tt_content",cursor:"move",distance:20,revert:"invalid",zIndex:100,start:e=>{DragDrop.onDragStart($(e.target))},stop:e=>{DragDrop.onDragStop($(e.target))}}),$(DragDrop.dropZoneIdentifier).droppable({accept:this.contentIdentifier,scope:"tt_content",tolerance:"pointer",over:(e,r)=>{DragDrop.onDropHoverOver($(r.draggable),$(e.target))},out:(e,r)=>{DragDrop.onDropHoverOut($(r.draggable),$(e.target))},drop:(e,r)=>{DragDrop.onDrop($(r.draggable),$(e.target),e)}})}static onDragStart(e){DragDrop.originalStyles=e.get(0).style.cssText,e.children(DragDrop.dragIdentifier).addClass("dragitem-shadow"),e.append('<div class="ui-draggable-copy-message">'+TYPO3.lang["dragdrop.copy.message"]+"</div>"),e.children(DragDrop.dropZoneIdentifier).addClass("drag-start"),e.closest(DragDrop.columnIdentifier).removeClass("active"),e.find(DragDrop.dropZoneIdentifier).hide(),$(DragDrop.dropZoneIdentifier).each((e,r)=>{const a=$(r);a.parent().find(DragDrop.addContentIdentifier).length&&a.addClass(DragDrop.validDropZoneClass)})}static onDragStop(e){e.children(DragDrop.dragIdentifier).removeClass("dragitem-shadow"),e.children(DragDrop.dropZoneIdentifier).removeClass("drag-start"),e.closest(DragDrop.columnIdentifier).addClass("active"),e.find(DragDrop.dropZoneIdentifier).show(),e.find(".ui-draggable-copy-message").remove(),e.get(0).style.cssText=DragDrop.originalStyles,$(DragDrop.dropZoneIdentifier+"."+DragDrop.validDropZoneClass).removeClass(DragDrop.validDropZoneClass)}static onDropHoverOver(e,r){r.hasClass(DragDrop.validDropZoneClass)&&r.addClass(DragDrop.dropPossibleHoverClass)}static onDropHoverOut(e,r){r.removeClass(DragDrop.dropPossibleHoverClass)}static onDrop(e,r,a){const t=DragDrop.getColumnPositionForElement(r);r.removeClass(DragDrop.dropPossibleHoverClass);const o=parseInt(e.data("uid"),10);if("number"==typeof o&&o>0){let s={};const n=r.closest(DragDrop.contentIdentifier).data("uid");let i=0;i=void 0===n?parseInt(a.target.offsetParent.getAttribute("data-page"),10):0-parseInt(n,10);let d=parseInt(e.data("language-uid"),10);-1!==d&&(d=parseInt(r.closest("[data-language-uid]").data("language-uid"),10));let p=0;0!==i&&(p=t);const g=a&&a.originalEvent.ctrlKey||r.hasClass("t3js-paste-copy"),l=g?"copy":"move";s.cmd={tt_content:{[o]:{[l]:{action:"paste",target:i,update:{colPos:p,sys_language_uid:d}}}}},DragDrop.ajaxAction(r,e,s,g).then(()=>{const r=$(`.t3-page-column-lang-name[data-language-uid="${d}"]`);if(0===r.length)return;const a=r.data("flagIdentifier"),t=r.data("languageTitle");Icons.getIcon(a,Icons.sizes.small).then(r=>{e.find(".t3js-flag").attr("title",t).html(r)})})}}static ajaxAction(e,r,a,t){const o=Object.keys(a.cmd).shift(),s=parseInt(Object.keys(a.cmd[o]).shift(),10),n={component:"dragdrop",action:t?"copy":"move",table:o,uid:s};return DataHandler.process(a,n).then(a=>{if(a.hasErrors)throw a.messages;e.parent().hasClass(DragDrop.contentIdentifier.substring(1))?r.detach().css({top:0,left:0}).insertAfter(e.closest(DragDrop.contentIdentifier)):r.detach().css({top:0,left:0}).insertAfter(e.closest(DragDrop.dropZoneIdentifier)),t&&self.location.reload()})}static getColumnPositionForElement(e){const r=e.closest("[data-colpos]");return!(!r.length||"undefined"===r.data("colpos"))&&r.data("colpos")}}DragDrop.contentIdentifier=".t3js-page-ce",DragDrop.dragIdentifier=".t3js-page-ce-dragitem ",DragDrop.dragHeaderIdentifier=".t3js-page-ce-draghandle",DragDrop.dropZoneIdentifier=".t3js-page-ce-dropzone-available",DragDrop.columnIdentifier=".t3js-page-column",DragDrop.validDropZoneClass="active",DragDrop.dropPossibleHoverClass="t3-page-ce-dropzone-possible",DragDrop.addContentIdentifier=".t3js-page-new-ce",DragDrop.originalStyles="";export default DragDrop;$(DragDrop.initialize);