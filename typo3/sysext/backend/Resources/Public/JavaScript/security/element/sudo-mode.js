/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{property as p,customElement as m,state as v,query as b}from"lit/decorators.js";import{LitElement as P,nothing as u,html as n}from"lit";import g from"@typo3/core/ajax/ajax-request.js";import{AjaxResponse as I}from"@typo3/core/ajax/ajax-response.js";import E from"@typo3/backend/viewport.js";import{topLevelModuleImport as T}from"@typo3/backend/utility/top-level-module-import.js";import M,{Sizes as $}from"@typo3/backend/modal.js";import{SeverityEnum as y}from"@typo3/backend/enum/severity.js";var o=function(r,e,t,s){var l=arguments.length,a=l<3?e:s===null?s=Object.getOwnPropertyDescriptor(e,t):s,c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")a=Reflect.decorate(r,e,t,s);else for(var h=r.length-1;h>=0;h--)(c=r[h])&&(a=(l<3?c(a):l>3?c(e,t,a):c(e,t))||a);return l>3&&a&&Object.defineProperty(e,t,a),a};class i extends P{}o([p({type:String})],i.prototype,"verifyActionUri",void 0),o([p({type:String})],i.prototype,"cancelUri",void 0),o([p({type:Boolean,attribute:"has-fatal-error"})],i.prototype,"hasFatalError",void 0),o([p({type:Boolean,attribute:"allow-install-tool-password"})],i.prototype,"allowInstallToolPassword",void 0),o([p({type:Object})],i.prototype,"labels",void 0);const w=async r=>{window.location!==window.parent.location&&T("@typo3/backend/security/element/sudo-mode.js");const t=top.document.createElement("typo3-backend-security-sudo-mode");return Object.assign(t,r),top.document.body.append(t),new Promise((s,l)=>{t.addEventListener("typo3:sudo-mode:verified",()=>s()),t.addEventListener("typo3:sudo-mode:finished",()=>l())})};let f=class extends i{render(){return u}async firstUpdated(){if(window.location!==window.parent.location){try{await w(this.getPropertyValues())}catch{history.go(-1)}return}M.advanced({title:this.hasFatalError?this.labels.verificationFailed:this.labels.verifyWithUserPassword,severity:this.hasFatalError?y.error:y.notice,size:$.small,additionalCssClasses:["modal-sudo-mode-verification"],buttons:[this.hasFatalError?{text:this.labels.cancel,active:!0,btnClass:"btn-default",trigger:()=>{top.location.href=this.cancelUri}}:{text:this.labels.verify,active:!0,name:"verify",form:"verify-sudo-mode",btnClass:"btn-primary"}],content:n`<typo3-backend-security-sudo-mode-form .labels=${this.labels} .verifyActionUri=${this.verifyActionUri} .cancelUri=${this.cancelUri} .hasFatalError=${this.hasFatalError} .allowInstallToolPassword=${this.allowInstallToolPassword} @typo3:sudo-mode:verified=${()=>this.dispatchEvent(new Event("typo3:sudo-mode:verified"))}></typo3-backend-security-sudo-mode-form>`}).addEventListener("typo3-modal-hidden",()=>{this.dispatchEvent(new Event("typo3:sudo-mode:finished")),this.remove()})}getPropertyValues(){const e={},t=this.constructor;for(const s of t.elementProperties.keys())e[s]=this[s];return e}};f=o([m("typo3-backend-security-sudo-mode")],f);let d=class extends i{constructor(){super(...arguments),this.useInstallToolPassword=!1,this.errorMessage=null}createRenderRoot(){return this}render(){return this.hasFatalError?n`<div><div class="alert alert-danger">${this.labels.verificationExpired}</div></div>`:n`<div>${this.errorMessage?n`<div class="alert alert-danger" id=invalid-password>${this.labels[this.errorMessage]||this.errorMessage}</div>`:u}<form method=post class=form id=verify-sudo-mode spellcheck=false @submit=${e=>this.verifyPassword(e)}>${this.useInstallToolPassword?u:n`<input hidden aria-hidden=true type=text autocomplete=username value=${TYPO3.configuration.username}>`}<div class=form-group><label class=form-label for=password>${this.labels.password}</label> <input required class=form-control id=password type=password name=password autocomplete=${this.useInstallToolPassword?"section-install current-password":"current-password"}></div></form>${this.allowInstallToolPassword?n`<div class=text-end><a href=# @click=${e=>this.toggleUseInstallToolPassword(e)}> ${this.useInstallToolPassword?this.labels.userPasswordMode:this.labels.installToolPasswordMode} </a></div>`:u}</div>`}updated(e){e.has("useInstallToolPassword")&&(this.closest("typo3-backend-modal").modalTitle=this.getModalTitle())}firstUpdated(e){super.firstUpdated(e),this.passwordElement?.focus()}getModalTitle(){return this.hasFatalError?this.labels.verificationFailed:this.useInstallToolPassword?this.labels.verifyWithInstallToolPassword:this.labels.verifyWithUserPassword}async verifyPassword(e){e.preventDefault(),this.errorMessage=null;try{const s=await(await new g(this.verifyActionUri).post({password:this.passwordElement.value,useInstallToolPassword:this.useInstallToolPassword?1:0})).resolve("application/json");this.dispatchEvent(new Event("typo3:sudo-mode:verified")),this.closest("typo3-backend-modal").hideModal(),s.redirect&&E.ContentContainer.setUrl(s.redirect.uri)}catch(t){if(t instanceof I){const s=await t.resolve("application/json");this.errorMessage=s.message}else throw t}}toggleUseInstallToolPassword(e){e.preventDefault(),this.useInstallToolPassword=!this.useInstallToolPassword}};o([v()],d.prototype,"useInstallToolPassword",void 0),o([v()],d.prototype,"errorMessage",void 0),o([b("#password")],d.prototype,"passwordElement",void 0),d=o([m("typo3-backend-security-sudo-mode-form")],d);export{f as SudoMode,d as SudoModeForm,w as initiateSudoModeModal};
