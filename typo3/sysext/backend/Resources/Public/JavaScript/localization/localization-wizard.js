/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{LitElement as b,html as n}from"lit";import{property as l,state as h,customElement as g}from"lit/decorators.js";import{classMap as m}from"lit/directives/class-map.js";import{Task as v}from"@lit/task";import{lll as p}from"@typo3/core/lit-helper.js";import y from"@typo3/core/ajax/ajax-request.js";import S from"@typo3/backend/modal.js";import"@typo3/backend/element/alert-element.js";import"@typo3/backend/element/icon-element.js";import"@typo3/backend/element/progress-tracker-element.js";import"@typo3/backend/element/spinner-element.js";import{TargetLanguageStep as z}from"@typo3/backend/localization/steps/target-language-step.js";import{SourceLanguageStep as w}from"@typo3/backend/localization/steps/source-language-step.js";import{ContentRecordSelectionStep as k}from"@typo3/backend/localization/steps/content-record-selection-step.js";import{ModeStep as x}from"@typo3/backend/localization/steps/mode-step.js";import{HandlerSelectionStep as T}from"@typo3/backend/localization/steps/handler-selection-step.js";import{ConfirmStep as A}from"@typo3/backend/localization/steps/confirm-step.js";import{FinisherStep as I}from"@typo3/backend/localization/steps/finisher-step.js";var a=function(d,t,e,r){var s=arguments.length,i=s<3?t:r===null?r=Object.getOwnPropertyDescriptor(t,e):r,c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(d,t,e,r);else for(var u=d.length-1;u>=0;u--)(c=d[u])&&(i=(s<3?c(i):s>3?c(t,e,i):c(t,e))||i);return s>3&&i&&Object.defineProperty(t,e,i),i};class f extends CustomEvent{constructor(){super("auto-advance",{bubbles:!0,composed:!0})}}let o=class extends b{constructor(){super(...arguments),this.currentStepIndex=0,this.dataStore={},this.recordInfoTask=new v(this,{task:async([t,e])=>{try{const s=await(await new y(TYPO3.settings.ajaxUrls.wizard_localization_get_record).withQueryArguments({recordType:t,recordUid:e}).get()).resolve();return this.closest("typo3-backend-modal")!==null&&S.currentModal&&(S.currentModal.modalTitle=`${p("localization_wizard.modal.title.record_prefix")} ${s.typeName}, ${s.title}`),s}catch(r){throw console.warn("Failed to fetch record info:",r),r}},args:()=>[this.recordType,this.recordUid]}),this.progressTracker=null,this.handleAutoAdvance=()=>{this.tryAutoAdvance()}}connectedCallback(){super.connectedCallback(),this.addEventListener("auto-advance",this.handleAutoAdvance),this.builtSteps=this.buildSteps(),this.currentStep=this.builtSteps[this.currentStepIndex],this.progressTracker=document.createElement("typo3-backend-progress-tracker")}disconnectedCallback(){super.disconnectedCallback(),this.removeEventListener("auto-advance",this.handleAutoAdvance),this.progressTracker=null}getStepSummaries(){const t=[];for(const e of this.builtSteps)if(this.hasSummary(e)){const r=e.getSummary();t.push(r)}return t}getStoreData(t){return this.dataStore[t]}setStoreData(t,e){this.dataStore={...this.dataStore,[t]:e}}getDataStore(){return this.dataStore}getRecordInfo(){return this.recordInfoTask.value}clearStoreData(t){const e={...this.dataStore};delete e[t],this.dataStore=e}tryAutoAdvance(){const t=this.getCurrentStep();t.autoAdvance&&t.isComplete()&&this.goToNextStep()}dismissWizard(){S.dismiss()}renderLoader(t="localization_wizard.loading"){return n`<div class=localization-wizard-loader><typo3-backend-spinner size=large></typo3-backend-spinner><p>${p(t)}</p></div>`}renderError(t,e,r){const s=e.includes(".")?p(e):e;let i="";r instanceof Error?i=r.message:Array.isArray(r)?i=r.join(`
`):r&&typeof r=="string"&&(i=r);const c=i?`${s}

${i}`:s;return n`<div class=localization-wizard-error><typo3-backend-alert severity=2 heading=${p(t)} message=${c} show-icon></typo3-backend-alert></div>`}render(){return n`<div class=localization-wizard><div class=localization-wizard-progress>${this.renderProgressTracker()}</div><div class=localization-wizard-content aria-live=polite>${this.currentStep.render()}</div><div class=localization-wizard-actions>${this.renderWizardButtons()}</div></div>`}createRenderRoot(){return this}hasSummary(t){return"getSummary"in t}hasValue(t){return"getValue"in t&&"setValue"in t&&"reset"in t}buildSteps(){const t=[],e={wizard:this,recordType:this.recordType,recordUid:this.recordUid,getStoreData:this.getStoreData.bind(this),setStoreData:this.setStoreData.bind(this),clearStoreData:this.clearStoreData.bind(this),getDataStore:this.getDataStore.bind(this),dispatchAutoAdvance:()=>this.dispatchEvent(new f)};return t.push(new z(e)),t.push(new w(e)),this.recordType==="pages"&&t.push(new k(e)),t.push(new x(e)),t.push(new T(e)),t.push(new A(e)),t.push(new I(e)),t}renderWizardButtons(){return n`${this.renderPreviousButton()} ${this.renderNextButton()}`}renderPreviousButton(){const t=this.currentStepIndex===0,e=this.currentStepIndex===this.builtSteps.length-1;return n`<button type=button class=${m({btn:!0,"btn-secondary":!0,disabled:t||e})} @click=${this.handlePrevious}><typo3-backend-icon identifier=actions-arrow-start-alt size=small bidi></typo3-backend-icon>${p("localization_wizard.buttons.previous")}</button>`}renderNextButton(){const t=this.currentStep.isComplete();let e;return this.currentStep.key==="finisher"?e="localization_wizard.buttons.finish":this.currentStep.key==="confirm"?e="localization_wizard.buttons.localize":e="localization_wizard.buttons.next",n`<button type=button class=${m({btn:!0,"btn-primary":!0,disabled:!t})} @click=${this.handleNext}>${p(e)}<typo3-backend-icon identifier=actions-arrow-end-alt bidi size=small></typo3-backend-icon></button>`}getCurrentStep(){return this.currentStep}async gotoStep(t){if(!(t<0||t>=this.builtSteps.length||t===this.currentStepIndex)){if(t>this.currentStepIndex)for(let e=this.currentStepIndex;e<t;e++){const r=this.builtSteps[e];if(!r.isComplete()){e!==this.currentStepIndex&&(this.currentStepIndex=e,this.currentStep=this.builtSteps[e],await this.updateComplete);return}r.beforeAdvance&&await r.beforeAdvance()}else for(let e=this.currentStepIndex;e>t;e--){const r=this.builtSteps[e];this.hasValue(r)&&r.reset()}this.currentStepIndex=t,this.currentStep=this.builtSteps[t],await this.updateComplete}}goToNextStep(){this.currentStepIndex<this.builtSteps.length-1&&this.gotoStep(this.currentStepIndex+1)}goToPreviousStep(){this.currentStepIndex>0&&this.gotoStep(this.currentStepIndex-1)}getProgressSteps(){return this.builtSteps.map(t=>({key:t.key,title:t.title}))}getCurrentStepIndex(){return this.currentStepIndex}renderProgressTracker(){const t=this.getProgressSteps(),e=this.getCurrentStepIndex(),r=t.map(i=>i.title),s=e+1;return this.progressTracker&&(this.progressTracker.stages=r,this.progressTracker.activeStage=s),n`${this.progressTracker}`}handlePrevious(){const t=this.currentStepIndex===0,e=this.currentStepIndex===this.builtSteps.length-1;t||e||this.goToPreviousStep()}async handleNext(){if(!this.currentStep.isComplete())return;if(this.currentStepIndex===this.builtSteps.length-1){this.currentStep.beforeAdvance&&await this.currentStep.beforeAdvance();return}this.goToNextStep()}};a([l({type:String,attribute:"record-type"})],o.prototype,"recordType",void 0),a([l({type:Number,attribute:"record-uid"})],o.prototype,"recordUid",void 0),a([l({type:Number,attribute:"target-language"})],o.prototype,"targetLanguage",void 0),a([h()],o.prototype,"currentStepIndex",void 0),a([h()],o.prototype,"currentStep",void 0),a([h()],o.prototype,"dataStore",void 0),o=a([g("typo3-backend-localization-wizard")],o);export{f as AutoAdvanceEvent,o as LocalizationWizard};
