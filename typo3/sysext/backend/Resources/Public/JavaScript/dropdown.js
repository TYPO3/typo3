/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import u from"@typo3/core/document-service.js";class a{constructor(){this.handleFocusout=e=>{const t=e.currentTarget,o=e.relatedTarget;o!==null&&!t.contains(o)&&t.hidePopover()},this.handleKeydown=e=>{const t=e.currentTarget,o=this.getFocusableItems(t);if(o.length===0)return;const n=o.findIndex(r=>r===document.activeElement);switch(e.key){case"ArrowDown":e.preventDefault(),o[(n+1)%o.length].focus();break;case"ArrowUp":e.preventDefault(),o[(n-1+o.length)%o.length].focus();break;case"Home":e.preventDefault(),o[0].focus();break;case"End":e.preventDefault(),o[o.length-1].focus();break;default:break}},document.addEventListener("toggle",e=>{const t=e.target;t.matches(".dropdown-menu[popover]")&&(e.newState==="open"?(t.addEventListener("keydown",this.handleKeydown),t.addEventListener("focusout",this.handleFocusout)):(t.removeEventListener("keydown",this.handleKeydown),t.removeEventListener("focusout",this.handleFocusout)))},!0),document.addEventListener("keydown",e=>{const t=e.target?.closest(".dropdown-toggle[popovertarget]");if(t&&(e.key==="ArrowDown"||e.key==="ArrowUp")){const o=t.getAttribute("popovertarget"),n=o?document.getElementById(o):null;if(!n?.matches("[popover]"))return;e.preventDefault(),n.showPopover();const r=this.getFocusableItems(n);r.length>0&&(e.key==="ArrowDown"?r[0].focus():r[r.length-1].focus())}}),window.addEventListener("blur",()=>{document.querySelectorAll(".dropdown-menu[popover]:popover-open").forEach(e=>{e.hidePopover()})}),document.addEventListener("click",e=>{const t=e.target,o=t.closest(".dropdown-menu[popover]");o&&t.closest(".dropdown-item")&&o.hidePopover()})}getFocusableItems(e){return Array.from(e.querySelectorAll(".dropdown-item:not(:disabled):not(.disabled)"))}}new a;class d{constructor(){this.dropdownIdCounter=0,document.addEventListener("click",e=>{const t=e.target?.closest('[data-bs-toggle="dropdown"]');if(t){e.preventDefault();const o=this.getMenu(t);this.convert(t),o?.togglePopover()}}),u.ready().then(()=>this.convertAll())}convertAnchorToButton(e){const t=document.createElement("button");t.type="button";for(const o of e.attributes)if(o.name==="href"){const n=o.value;n.startsWith("#")&&!e.hasAttribute("data-bs-target")&&t.setAttribute("data-bs-target",n)}else t.setAttribute(o.name,o.value);return t.innerHTML=e.innerHTML,e.replaceWith(t),t}getMenu(e){const t=e.dataset.bsTarget;if(t){const n=t.startsWith("#")?t:"#"+t;return document.querySelector(n)}const o=e.getAttribute("href");return o?.startsWith("#")?document.querySelector(o):e.nextElementSibling?.matches(".dropdown-menu")?e.nextElementSibling:e.closest(".dropdown")?.querySelector(".dropdown-menu")??null}convert(e){if(e.hasAttribute("popovertarget"))return null;const t=this.getMenu(e);return t?(t.id||(t.id="dropdown-menu-"+this.dropdownIdCounter++),t.setAttribute("popover",""),e.tagName==="A"&&(e=this.convertAnchorToButton(e)),e.closest(".dropdown")||e.parentElement?.classList.add("dropdown"),e.setAttribute("popovertarget",t.id),e.removeAttribute("data-bs-toggle"),e.removeAttribute("data-bs-target"),e.removeAttribute("data-bs-offset"),e.removeAttribute("data-bs-auto-close"),e.removeAttribute("data-bs-reference"),e.removeAttribute("data-bs-display"),e.removeAttribute("data-bs-boundary"),e.removeAttribute("aria-haspopup"),e.removeAttribute("aria-expanded"),e):null}convertAll(){document.querySelectorAll('[data-bs-toggle="dropdown"]').forEach(e=>this.convert(e))}}new d;
