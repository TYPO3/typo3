/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{LitElement as F,html as i,nothing as y}from"lit";import{property as T,state as w,customElement as D}from"lit/decorators.js";import{classMap as I}from"lit/directives/class-map.js";import{repeat as x}from"lit/directives/repeat.js";import{lll as o}from"@typo3/core/lit-helper.js";import p,{BookmarkStoreChangedEvent as z,BookmarkGroupType as S}from"@typo3/backend/bookmark/bookmark-store.js";import $ from"@typo3/backend/modal.js";import b from"@typo3/backend/notification.js";import{SeverityEnum as B}from"@typo3/backend/enum/severity.js";import{PseudoButtonLitElement as R}from"@typo3/backend/element/pseudo-button.js";import"@typo3/backend/element/spinner-element.js";import"@typo3/backend/element/icon-element.js";var u=function(h,e,t,a){var r=arguments.length,s=r<3?e:a===null?a=Object.getOwnPropertyDescriptor(e,t):a,l;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(h,e,t,a);else for(var c=h.length-1;c>=0;c--)(l=h[c])&&(s=(r<3?l(s):r>3?l(e,t,s):l(e,t))||s);return r>3&&s&&Object.defineProperty(e,t,s),s};class M{constructor(){this.view="list"}}class V{constructor(e){this.bookmark=e,this.view="editBookmark"}}class E{constructor(){this.view="createGroup",this.draft={label:""}}}class L{constructor(e){this.group=e,this.view="editGroup"}}class C{constructor(){this.view="manageGroups"}}let g=class extends F{constructor(){super(...arguments),this.editId=null,this.bookmarks=[],this.groups=[],this.selectedIds=new Set,this.draggedItem=null,this.dropTarget=null,this.groupedBookmarks=new Map,this.viewState=new M,this.handleStoreUpdate=()=>{this.syncFromStore()},this.handleBookmarkBulkDelete=()=>{const e=Array.from(this.selectedIds),t=$.confirm(o("core.bookmarks:confirmDeleteMultiple.title"),o("core.bookmarks:confirmDeleteMultiple.message",e.length),B.notice,[{text:o("core.bookmarks:action.cancel"),btnClass:"btn-default",name:"cancel",trigger:()=>t.hideModal()},{text:o("core.bookmarks:action.delete"),btnClass:"btn-primary",name:"delete",trigger:async()=>{await p.deleteMultiple(e)?(b.success(o("core.bookmarks:success.deletedMultiple.title"),o("core.bookmarks:success.deletedMultiple.message",e.length)),this.selectedIds=new Set):b.error(o("core.bookmarks:error.deleteFailed.title"),o("core.bookmarks:error.deleteFailed.message")),t.hideModal()}}])},this.handleDragOver=e=>{e.preventDefault(),e.dataTransfer&&(e.dataTransfer.dropEffect="move")},this.handleItemDragLeave=e=>{const t=e.relatedTarget;t&&e.currentTarget.contains(t)||(this.dropTarget=null)},this.handleDragEnd=()=>{this.draggedItem=null,this.dropTarget=null}}connectedCallback(){super.connectedCallback(),document.addEventListener(z,this.handleStoreUpdate),this.initFromStore()}disconnectedCallback(){super.disconnectedCallback(),document.removeEventListener(z,this.handleStoreUpdate)}createRenderRoot(){return this}render(){let e;return this.viewState instanceof V?e=this.renderBookmarkEditView(this.viewState):this.viewState instanceof C?e=this.renderGroupListView():this.viewState instanceof E?e=this.renderGroupCreateView(this.viewState):this.viewState instanceof L?e=this.renderGroupEditView(this.viewState):e=this.renderBookmarkListView(),i`<div class=bookmark-manager><div class=bookmark-manager-toolbar>${e.toolbar}</div><div class=bookmark-manager-content>${e.content}</div></div>`}async initFromStore(){if(await this.syncFromStore(),this.editId!==null){const e=this.bookmarks.find(t=>t.id===this.editId);e&&this.navigateToBookmarkEditView(e)}}navigateToBookmarkListView(){this.viewState=new M}navigateToBookmarkEditView(e){this.viewState=new V(e)}navigateToGroupListView(){this.viewState=new C}navigateToGroupCreateView(){this.viewState=new E}navigateToGroupEditView(e){this.viewState=new L(e)}renderBookmarkListView(){const e=this.groupedBookmarks,t=this.selectedIds.size>0,a=this.bookmarks.length>0,r=this.selectedIds.size===this.bookmarks.length&&this.bookmarks.length>0,s=this.helperGetGroupSections(this.getSelectableGroups()),l=i`<div class=bookmark-manager-toolbar-start><div class=form-slim><div class=form-group><div class="form-check form-check-type-toggle mb-0"><input type=checkbox class=form-check-input id=selectAll .checked=${r} @change=${n=>{this.selectedIds=n.target.checked?new Set(this.bookmarks.map(k=>k.id)):new Set}}> <label class=form-check-label for=selectAll>${r?o("core.bookmarks:manager.deselectAll"):o("core.bookmarks:manager.selectAll")}</label></div></div>${t?i`<div class="form-group dropdown"><button class="btn btn-sm btn-default dropdown-toggle" type=button data-bs-toggle=dropdown aria-expanded=false><typo3-backend-icon identifier=actions-bookmarks size=small></typo3-backend-icon>${o("core.bookmarks:manager.moveToGroup")}</button><ul class=dropdown-menu>${s.map((n,k)=>i`${k>0?i`<li><hr class=dropdown-divider></li>`:y}<li><div class=dropdown-header>${n.label}</div></li>${n.groups.map(f=>i`<li><button class=dropdown-item type=button @click=${()=>this.handleBookmarkBulkMove(f.id)}>${f.label}</button></li>`)}`)}</ul></div><div class=form-group><button class="btn btn-sm btn-default" type=button @click=${this.handleBookmarkBulkDelete}><typo3-backend-icon identifier=actions-delete size=small></typo3-backend-icon>${o("core.bookmarks:manager.deleteSelected")}</button></div>`:y}</div></div><div class=bookmark-manager-toolbar-end><button class="btn btn-sm btn-default" type=button @click=${this.navigateToGroupListView}><typo3-backend-icon identifier=actions-cog size=small></typo3-backend-icon>${o("core.bookmarks:manager.manageGroups")}</button></div>`,c=i`${a?y:i`<div class="alert alert-info"><typo3-backend-icon identifier=actions-info-circle size=small></typo3-backend-icon><span class=ms-2>${o("core.bookmarks:empty")}</span></div>`} ${x(Array.from(e.entries()),([n])=>n,([n,k])=>{const m=this.groups.find(v=>v.id===n)?.label||o("core.bookmarks:notGrouped"),d=`bookmark-group-${typeof n=="number"?n:n.replace(/-/g,"")}`;return i`<div class="panel panel-default" data-group-id=${n} @dragover=${this.handleDragOver} @drop=${v=>this.handleDrop(v,n)}><div class=panel-heading role=tab><div class=panel-heading-row><button class=panel-button type=button data-bs-toggle=collapse data-bs-target=#${d} aria-expanded=true aria-controls=${d}><div class=panel-title>${m}</div><span class=caret></span></button></div></div><div class="panel-collapse collapse show" id=${d} role=tabpanel><div class=table-fit><table class="table table-striped table-hover mb-0"><tbody>${x(k,v=>v.id,v=>this.renderBookmarkRow(v))}</tbody></table></div></div></div>`})}`;return{toolbar:l,content:c}}renderBookmarkRow(e){const t=this.selectedIds.has(e.id),a=this.draggedItem?.id===e.id,r=this.dropTarget?.item.id===e.id,s=this.dropTarget?.position,l=I({"table-active":t,"opacity-50":a,"row-drop-before":r&&s==="before","row-drop-after":r&&s==="after"}),c=()=>{const d=new Set(this.selectedIds);d.has(e.id)?d.delete(e.id):d.add(e.id),this.selectedIds=d},n=this.groupedBookmarks.get(e.groupId)??[],k=n.findIndex(d=>d.id===e.id),f=k===0,m=k===n.length-1;return i`<tr class=${l} data-bookmark-id=${e.id} draggable=${e.editable?"true":"false"} @dragstart=${d=>this.handleDragStart(d,"bookmark",e)} @dragover=${d=>this.handleItemDragOver(d,e)} @dragleave=${this.handleItemDragLeave} @drop=${d=>this.handleDrop(d,e)} @dragend=${this.handleDragEnd}><td class=col-checkbox>${e.editable?i`<span class="form-check form-check-type-toggle"> <input type=checkbox class=form-check-input .checked=${t} @change=${c} @click=${d=>d.stopPropagation()}> </span>`:i`<typo3-backend-icon identifier=actions-lock size=small title=${o("core.bookmarks:manager.locked")}></typo3-backend-icon>`}</td><td class=col-icon><typo3-backend-icon identifier=${e.iconIdentifier} overlay=${e.iconOverlayIdentifier} size=small></typo3-backend-icon></td><td class=col-title>${e.accessible?i`<button type=button class="btn btn-link" title=${e.title} @click=${()=>this.handleBookmarkNavigate(e)}>${e.title}</button>`:i`<span class=text-muted title=${e.title}>${e.title}</span><typo3-backend-icon class=text-warning identifier=actions-exclamation-triangle size=small title=${o("core.bookmarks:manager.notAccessible")}></typo3-backend-icon>`}</td><td class="col-control nowrap">${e.editable?i`<div class=btn-group><button type=button class="btn btn-default btn-sm" title=${o("core.bookmarks:manager.editBookmark")} @click=${()=>this.navigateToBookmarkEditView(e)}><typo3-backend-icon identifier=actions-cog size=small></typo3-backend-icon><span class=visually-hidden>${o("core.bookmarks:manager.editBookmark")}</span></button> ${f?i`<span class="btn btn-default btn-sm disabled"> <typo3-backend-icon identifier=empty-empty size=small></typo3-backend-icon> </span>`:i`<button type=button class="btn btn-default btn-sm" data-action=move-up title=${o("core.bookmarks:manager.moveUp")} @click=${()=>this.handleBookmarkMoveUp(e)}><typo3-backend-icon identifier=actions-chevron-up size=small></typo3-backend-icon><span class=visually-hidden>${o("core.bookmarks:manager.moveUp")}</span></button>`} ${m?i`<span class="btn btn-default btn-sm disabled"> <typo3-backend-icon identifier=empty-empty size=small></typo3-backend-icon> </span>`:i`<button type=button class="btn btn-default btn-sm" data-action=move-down title=${o("core.bookmarks:manager.moveDown")} @click=${()=>this.handleBookmarkMoveDown(e)}><typo3-backend-icon identifier=actions-chevron-down size=small></typo3-backend-icon><span class=visually-hidden>${o("core.bookmarks:manager.moveDown")}</span></button>`} <span class="btn btn-default btn-sm" style=cursor:grab title=${o("core.bookmarks:manager.dragToReorder")}><typo3-backend-icon identifier=actions-drag size=small></typo3-backend-icon> <span class=visually-hidden>${o("core.bookmarks:manager.dragToReorder")}</span> </span></div>`:y}</td></tr>`}renderBookmarkEditView(e){const{bookmark:t}=e,a=i`<div class=bookmark-manager-toolbar-start><button type=button class="btn btn-sm btn-default" @click=${this.navigateToBookmarkListView}><typo3-backend-icon identifier=actions-arrow-left size=small></typo3-backend-icon>${o("core.bookmarks:manager.back")}</button></div><div class=bookmark-manager-toolbar-end><button type=button class="btn btn-sm btn-danger" @click=${()=>this.handleBookmarkDelete(t.id)}><typo3-backend-icon identifier=actions-delete size=small></typo3-backend-icon>${o("core.bookmarks:action.delete")}</button> <button type=submit form=bookmark-edit-form class="btn btn-sm btn-primary"><typo3-backend-icon identifier=actions-check size=small></typo3-backend-icon>${o("core.bookmarks:action.save")}</button></div>`,r=this.helperParseParameters(t.arguments),s=this.helperGetGroupSections(this.getSelectableGroups()),l=i`<div class=bookmark-edit-view><form id=bookmark-edit-form @submit=${c=>this.handleBookmarkUpdate(c,t)}><div class=form-group><label class=form-label for=bookmark-title>${o("core.bookmarks:fieldTitle")}</label> <input type=text id=bookmark-title name=title class=form-control .value=${t.title} @input=${c=>{t.title=c.target.value,this.requestUpdate()}} required></div><div class=form-group><label class=form-label for=bookmark-group>${o("core.bookmarks:fieldGroup")}</label> <select id=bookmark-group name=group class=form-select .value=${String(t.groupId)} @change=${c=>{const n=c.target.value,k=this.groups.find(f=>String(f.id)===n);k&&(t.groupId=k.id,this.requestUpdate())}}>${s.map(c=>i`<optgroup label=${c.label}>${c.groups.map(n=>i`<option value=${n.id} ?selected=${n.id===t.groupId}>${n.label}</option>`)}</optgroup>`)}</select></div><div class=mb-3><label class=form-label>${o("core.bookmarks:details")}</label><div class=table-fit><table class="table table-striped table-sm mb-0"><tbody>${t.href?i`<tr><th class=nowrap>${o("core.bookmarks:details.url")}</th><td class=text-break>${this.helperStripToken(t.href)}</td></tr>`:y}<tr><th class=nowrap>${o("core.bookmarks:details.route")}</th><td>${t.route}</td></tr>${r!==null?i`<tr><th class="nowrap align-top">${o("core.bookmarks:details.parameters")}</th><td>${r}</td></tr>`:y}</tbody></table></div></div></form></div>`;return{toolbar:a,content:l}}renderGroupListView(){const e=this.groups.filter(r=>r.editable),t=i`<div class=bookmark-manager-toolbar-start><button type=button class="btn btn-sm btn-default" @click=${this.navigateToBookmarkListView}><typo3-backend-icon identifier=actions-arrow-left size=small></typo3-backend-icon>${o("core.bookmarks:manager.back")}</button></div><div class=bookmark-manager-toolbar-end><button class="btn btn-sm btn-primary" type=button @click=${this.navigateToGroupCreateView}><typo3-backend-icon identifier=actions-plus size=small></typo3-backend-icon>${o("core.bookmarks:manager.newGroup")}</button></div>`,a=i`<div class=bookmark-manage-groups-view>${e.length>0?i`<div class=table-fit><table class="table table-striped table-hover mb-0"><tbody>${e.map(r=>this.renderGroupRow(r))}</tbody></table></div>`:i`<div class="alert alert-info"><typo3-backend-icon identifier=actions-info-circle size=small></typo3-backend-icon><span class=ms-2>${o("core.bookmarks:manager.noGroups")}</span></div>`}</div>`;return{toolbar:t,content:a}}renderGroupRow(e){const t=this.bookmarks.filter(m=>m.groupId===e.id).length,a=this.draggedItem?.id===e.id,r=this.dropTarget?.item.id===e.id,s=this.dropTarget?.position,l=I({"opacity-50":a,"row-drop-before":r&&s==="before","row-drop-after":r&&s==="after"}),c=this.groups.filter(m=>m.editable),n=c.findIndex(m=>m.id===e.id),k=n===0,f=n===c.length-1;return i`<tr class=${l} data-group-id=${e.id} draggable=true @dragstart=${m=>this.handleDragStart(m,"group",e)} @dragover=${m=>this.handleItemDragOver(m,e)} @dragleave=${this.handleItemDragLeave} @drop=${m=>this.handleDrop(m,e)} @dragend=${this.handleDragEnd}><td class=col-title><button type=button class="btn btn-link" @click=${()=>this.navigateToGroupEditView(e)}><typo3-backend-icon identifier=apps-pagetree-folder-default size=small></typo3-backend-icon>${e.label} ${t>0?i`<span class="badge badge-default">${t}</span>`:y}</button></td><td class="col-control nowrap"><div class=btn-group><button type=button class="btn btn-default btn-sm" title=${o("core.bookmarks:manager.editGroup")} @click=${()=>this.navigateToGroupEditView(e)}><typo3-backend-icon identifier=actions-cog size=small></typo3-backend-icon><span class=visually-hidden>${o("core.bookmarks:manager.editGroup")}</span></button> ${k?i`<span class="btn btn-default btn-sm disabled"> <typo3-backend-icon identifier=empty-empty size=small></typo3-backend-icon> </span>`:i`<button type=button class="btn btn-default btn-sm" data-action=move-up title=${o("core.bookmarks:manager.moveUp")} @click=${()=>this.handleGroupMoveUp(e)}><typo3-backend-icon identifier=actions-chevron-up size=small></typo3-backend-icon><span class=visually-hidden>${o("core.bookmarks:manager.moveUp")}</span></button>`} ${f?i`<span class="btn btn-default btn-sm disabled"> <typo3-backend-icon identifier=empty-empty size=small></typo3-backend-icon> </span>`:i`<button type=button class="btn btn-default btn-sm" data-action=move-down title=${o("core.bookmarks:manager.moveDown")} @click=${()=>this.handleGroupMoveDown(e)}><typo3-backend-icon identifier=actions-chevron-down size=small></typo3-backend-icon><span class=visually-hidden>${o("core.bookmarks:manager.moveDown")}</span></button>`} <span class="btn btn-default btn-sm" style=cursor:grab title=${o("core.bookmarks:manager.dragToReorder")}><typo3-backend-icon identifier=actions-drag size=small></typo3-backend-icon> <span class=visually-hidden>${o("core.bookmarks:manager.dragToReorder")}</span> </span></div></td></tr>`}renderGroupCreateView(e){const{draft:t}=e,a=i`<div class=bookmark-manager-toolbar-start><button type=button class="btn btn-sm btn-default" @click=${this.navigateToGroupListView}><typo3-backend-icon identifier=actions-arrow-left size=small></typo3-backend-icon>${o("core.bookmarks:manager.back")}</button></div><div class=bookmark-manager-toolbar-end><button type=submit form=bookmark-group-create-form class="btn btn-sm btn-primary"><typo3-backend-icon identifier=actions-check size=small></typo3-backend-icon>${o("core.bookmarks:manager.createGroup")}</button></div>`,r=i`<div class=bookmark-group-create-view><form id=bookmark-group-create-form @submit=${s=>this.handleGroupCreate(s,t)}><div class=mb-3><label class=form-label for=group-label>${o("core.bookmarks:manager.label")}</label> <input type=text id=group-label name=label class=form-control .value=${t.label} @input=${s=>{t.label=s.target.value,this.requestUpdate()}} required autofocus></div></form></div>`;return{toolbar:a,content:r}}renderGroupEditView(e){const{group:t}=e,a=i`<div class=bookmark-manager-toolbar-start><button type=button class="btn btn-sm btn-default" @click=${this.navigateToGroupListView}><typo3-backend-icon identifier=actions-arrow-left size=small></typo3-backend-icon>${o("core.bookmarks:manager.back")}</button></div><div class=bookmark-manager-toolbar-end><button type=button class="btn btn-sm btn-danger" @click=${()=>this.handleGroupDelete(t)}><typo3-backend-icon identifier=actions-delete size=small></typo3-backend-icon>${o("core.bookmarks:action.delete")}</button> <button type=submit form=bookmark-group-edit-form class="btn btn-sm btn-primary"><typo3-backend-icon identifier=actions-check size=small></typo3-backend-icon>${o("core.bookmarks:action.save")}</button></div>`,r=i`<div class=bookmark-group-edit-view><form id=bookmark-group-edit-form @submit=${s=>this.handleGroupUpdate(s,t)}><div class=mb-3><label class=form-label for=group-label>${o("core.bookmarks:manager.label")}</label> <input type=text id=group-label name=label class=form-control .value=${t.label} @input=${s=>{t.label=s.target.value,this.requestUpdate()}} required></div></form></div>`;return{toolbar:a,content:r}}async syncFromStore(){this.bookmarks=await p.getBookmarks(),this.groups=await p.getGroups(),this.groupedBookmarks=await p.getGroupedBookmarks()}getSelectableGroups(){return this.groups.filter(e=>e.selectable)}handleBookmarkNavigate(e){this.closest("typo3-backend-modal")?.hideModal(),p.navigate(e)}async handleBookmarkUpdate(e,t){e.preventDefault();const a=await p.update(t.id,t.title,t.groupId);a.success?(b.success(o("core.bookmarks:success.updated.title"),o("core.bookmarks:success.updated.message")),this.navigateToBookmarkListView()):b.error(o("core.bookmarks:error.updateFailed.title"),a.error||o("core.bookmarks:error.unknown.message"))}handleBookmarkDelete(e){const t=$.confirm(o("core.bookmarks:confirmDelete.title"),o("core.bookmarks:confirmDelete.message"),B.notice,[{text:o("core.bookmarks:action.cancel"),btnClass:"btn-default",name:"cancel",trigger:()=>t.hideModal()},{text:o("core.bookmarks:action.delete"),btnClass:"btn-primary",name:"delete",trigger:async()=>{await p.deleteMultiple([e])?(b.success(o("core.bookmarks:success.deleted.title"),o("core.bookmarks:success.deleted.message")),this.navigateToBookmarkListView()):b.error(o("core.bookmarks:error.deleteFailed.title"),o("core.bookmarks:error.deleteFailed.message")),t.hideModal()}}])}async handleBookmarkBulkMove(e){const t=Array.from(this.selectedIds);await p.move(t,e)?(b.success(o("core.bookmarks:success.moved.title"),o("core.bookmarks:success.moved.message",t.length)),this.selectedIds=new Set):b.error(o("core.bookmarks:error.moveFailed.title"),o("core.bookmarks:error.moveFailed.message"))}async handleBookmarkMoveUp(e){await this.reorderBookmarkRelative(e,-1),await this.restoreFocus("bookmark",e.id,"up")}async handleBookmarkMoveDown(e){await this.reorderBookmarkRelative(e,1),await this.restoreFocus("bookmark",e.id,"down")}async handleGroupMoveUp(e){await this.reorderGroupRelative(e,-1),await this.restoreFocus("group",e.id,"up")}async handleGroupMoveDown(e){await this.reorderGroupRelative(e,1),await this.restoreFocus("group",e.id,"down")}async handleGroupCreate(e,t){if(e.preventDefault(),!t.label.trim())return;const a=await p.createGroup(t.label.trim());a.success?(b.success(o("core.bookmarks:success.groupCreated.title"),o("core.bookmarks:success.groupCreated.message")),this.navigateToGroupListView()):b.error(o("core.bookmarks:error.groupCreateFailed.title"),a.error||o("core.bookmarks:error.groupCreateFailed.message"))}async handleGroupUpdate(e,t){if(e.preventDefault(),!t.label.trim()||!t.editable)return;const a=await p.updateGroup(t.id,t.label.trim());a.success?(b.success(o("core.bookmarks:success.groupUpdated.title"),o("core.bookmarks:success.groupUpdated.message")),this.navigateToGroupListView()):b.error(o("core.bookmarks:error.groupUpdateFailed.title"),a.error||o("core.bookmarks:error.groupUpdateFailed.message"))}handleGroupDelete(e){if(!e.editable)return;const t=$.confirm(o("core.bookmarks:confirmDeleteGroup.title"),o("core.bookmarks:confirmDeleteGroup.message",e.label),B.notice,[{text:o("core.bookmarks:action.cancel"),btnClass:"btn-default",name:"cancel",trigger:()=>t.hideModal()},{text:o("core.bookmarks:action.delete"),btnClass:"btn-primary",name:"delete",trigger:async()=>{const a=await p.deleteGroup(e.id);a.success?(b.success(o("core.bookmarks:success.groupDeleted.title"),o("core.bookmarks:success.groupDeleted.message")),this.navigateToGroupListView()):b.error(o("core.bookmarks:error.groupDeleteFailed.title"),a.error||o("core.bookmarks:error.groupDeleteFailed.message")),t.hideModal()}}])}async restoreFocus(e,t,a){await this.updateComplete;const r=e==="bookmark"?`tr[data-bookmark-id="${t}"]`:`tr[data-group-id="${t}"]`,s=this.querySelector(r);if(!s)return;const l=a==="up"?"move-up":"move-down",c=a==="up"?"move-down":"move-up";(s.querySelector(`button[data-action="${l}"]`)??s.querySelector(`button[data-action="${c}"]`))?.focus()}async reorderBookmarkRelative(e,t){const a=[...this.groupedBookmarks.get(e.groupId)??[]],r=a.findIndex(l=>l.id===e.id),s=r+t;r<0||s<0||s>=a.length||([a[r],a[s]]=[a[s],a[r]],await p.reorder(a.map(l=>l.id)),await this.syncFromStore())}async reorderBookmarkToPosition(e,t,a){e.groupId!==t&&await p.update(e.id,e.title,t);const r=[...this.groupedBookmarks.get(t)??[]].filter(s=>s.id!==e.id);r.splice(a,0,e),await p.reorder(r.map(s=>s.id)),await this.syncFromStore()}async reorderGroupRelative(e,t){const a=this.groups.filter(l=>l.editable),r=a.findIndex(l=>l.id===e.id),s=r+t;r<0||s<0||s>=a.length||([a[r],a[s]]=[a[s],a[r]],await p.reorderGroups(a.map(l=>l.id)),await this.syncFromStore())}async reorderGroupToPosition(e,t){const a=this.groups.filter(r=>r.editable&&r.id!==e.id);a.splice(t,0,e),await p.reorderGroups(a.map(r=>r.id)),await this.syncFromStore()}handleDragStart(e,t,a){if(this.draggedItem=a,e.dataTransfer){e.dataTransfer.effectAllowed="move";const r={type:t,id:a.id};e.dataTransfer.setData("application/json",JSON.stringify(r))}}handleItemDragOver(e,t){if(e.preventDefault(),e.stopPropagation(),this.draggedItem===null||this.draggedItem.id===t.id)return;e.dataTransfer&&(e.dataTransfer.dropEffect="move");const a=e.currentTarget.getBoundingClientRect(),r=a.top+a.height/2,s=e.clientY<r?"before":"after";this.dropTarget={item:t,position:s}}async handleDrop(e,t){e.preventDefault(),e.stopPropagation();const a=this.draggedItem,r=this.dropTarget?.position;if(this.dropTarget=null,a===null)return;const s=JSON.parse(e.dataTransfer?.getData("application/json")??"{}");s.type==="bookmark"?await this.handleDropBookmark(a,t,r):s.type==="group"&&await this.handleDropGroup(a,t,r),this.draggedItem=null}async handleDropBookmark(e,t,a){if(typeof t=="object"&&"route"in t){const r=t;if(e.id===r.id)return;const l=[...this.groupedBookmarks.get(r.groupId)??[]].filter(n=>n.id!==e.id).findIndex(n=>n.id===r.id),c=a==="before"?l:l+1;await this.reorderBookmarkToPosition(e,r.groupId,c)}else{const r=t;if(e.groupId!==r){const s=[...this.groupedBookmarks.get(r)??[]];await this.reorderBookmarkToPosition(e,r,s.length)}}}async handleDropGroup(e,t,a){if(e.id===t.id)return;const s=this.groups.filter(c=>c.editable&&c.id!==e.id).findIndex(c=>c.id===t.id),l=a==="before"?s:s+1;await this.reorderGroupToPosition(e,l)}helperGetGroupSections(e){const t=Map.groupBy(e,r=>r.type),a={[S.USER]:o("core.bookmarks:groupType.user"),[S.SYSTEM]:o("core.bookmarks:groupType.system"),[S.GLOBAL]:o("core.bookmarks:groupType.global")};return Array.from(t.entries()).map(([r,s])=>({label:a[r]??r,groups:s}))}helperParseParameters(e){if(!e)return null;try{const t=Object.entries(JSON.parse(e));if(t.length===0)return null;const a=r=>typeof r=="object"&&r!==null?JSON.stringify(r):String(r);return i`<ul class="list-unstyled mb-0">${t.map(([r,s])=>i`<li><strong>${r}:</strong> ${a(s)}</li>`)}</ul>`}catch{return i`${e}`}}helperStripToken(e){try{const t=new URL(e,window.location.origin);return t.searchParams.delete("token"),decodeURIComponent(t.pathname+t.search)}catch{return e}}};u([T({type:Number})],g.prototype,"editId",void 0),u([w()],g.prototype,"bookmarks",void 0),u([w()],g.prototype,"groups",void 0),u([w()],g.prototype,"selectedIds",void 0),u([w()],g.prototype,"draggedItem",void 0),u([w()],g.prototype,"dropTarget",void 0),u([w()],g.prototype,"groupedBookmarks",void 0),u([w()],g.prototype,"viewState",void 0),g=u([D("typo3-backend-bookmark-manager-content")],g);let G=class extends R{createRenderRoot(){return this}buttonActivated(){const t=(top?.document??document).createElement("typo3-backend-bookmark-manager-content");this.editId!==void 0&&(t.editId=this.editId),$.advanced({type:$.types.default,title:o("core.bookmarks:manage"),size:$.sizes.medium,severity:B.notice,content:t,buttons:[],staticBackdrop:!0})}};u([T({type:Number,attribute:"edit-id"})],G.prototype,"editId",void 0),G=u([D("typo3-backend-bookmark-manager-button")],G);export{G as BookmarkManagerButtonElement,g as BookmarkManagerContentElement};
