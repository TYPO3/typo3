/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{LitElement as h,html as p,nothing as f}from"lit";import{property as c,state as T,customElement as D}from"lit/decorators.js";import{DateTime as d}from"luxon";var u=function(m,t,e,i){var a=arguments.length,o=a<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(m,t,e,i);else for(var l=m.length-1;l>=0;l--)(s=m[l])&&(o=(a<3?s(o):a>3?s(t,e,o):s(t,e))||o);return a>3&&o&&Object.defineProperty(t,e,o),o},n;(function(m){m.Relative="relative",m.Absolute="absolute"})(n||(n={}));let r=class extends h{constructor(){super(...arguments),this.datetime="",this.mode=n.Absolute,this.format="date",this.thresholdDays=0,this.displayTime="",this.updateTimeoutId=null}disconnectedCallback(){super.disconnectedCallback(),this.clearUpdateTimeout()}willUpdate(t){(t.has("datetime")||t.has("mode")||t.has("format"))&&(this.updateDisplayTime(),this.clearUpdateTimeout(),this.startUpdateTimeout())}createRenderRoot(){return this}render(){const t=this.parseDateTime(this.datetime),e=t?.toISO()||this.datetime,i=t&&this.mode===n.Relative?this.formatAbsoluteDateTime(this.getLocalizedDateTime(t)):"",a=i?`${this.displayTime||this.datetime}. ${i}`:null;return p`<time datetime=${e} title=${i||f} aria-label=${a||f}>${this.displayTime||this.datetime}</time>`}clearUpdateTimeout(){this.updateTimeoutId!==null&&(window.clearTimeout(this.updateTimeoutId),this.updateTimeoutId=null)}startUpdateTimeout(){if(this.mode===n.Relative){const t=this.parseDateTime(this.datetime),e=t?this.calculateNextStateChange(t):null,i=e?Math.abs(e.diffNow("milliseconds").milliseconds):1e3;this.updateTimeoutId=window.setTimeout(()=>{this.updateTimeoutId=null,this.updateDisplayTime(),this.startUpdateTimeout()},i)}}calculateNextStateChange(t){const e=["years","months","days","hours","minutes","seconds"],i=t.diffNow(e);for(const a of e){const o=i.get(a);if(o!==0){const s=o<0?-1:1;return t.minus({[a]:o+s})}}return t.plus({seconds:1})}updateDisplayTime(){const t=this.parseDateTime(this.datetime);t?this.displayTime=this.mode===n.Absolute?this.formatAbsoluteTime(t):this.formatRelativeTime(t):this.displayTime=this.datetime}formatAbsoluteTime(t){const e=this.getLocalizedDateTime(t),i=this.getConfiguredDateFormats();return this.format==="date"&&i?e.toFormat(i.formats.date):this.format==="datetime"&&i?e.toFormat(i.formats.datetime):this.format?e.toFormat(this.format):i?e.toFormat(i.formats.date):e.toLocaleString(d.DATE_SHORT)}parseDateTime(t){if(!t)return null;const i=this.getConfiguredDateFormats()?.timezone,a=Number(t);if(!isNaN(a)&&a>0){const s=i?{zone:i}:{},l=d.fromSeconds(a,s);if(l.isValid)return l}const o=d.fromISO(t);return o.isValid?o:null}getLocalizedDateTime(t){let e=document.documentElement.lang||"en";e==="ch"&&(e="zh");const a=this.getConfiguredDateFormats()?.timezone;let o=t.setLocale(e);return a&&(o=o.setZone(a)),o}formatRelativeTime(t){const e=this.getLocalizedDateTime(t);return this.thresholdDays>0&&Math.abs(d.now().diff(e,"days").days)>this.thresholdDays?this.formatAbsoluteDate(e):e.toRelative()||this.formatAbsoluteDateTime(e)}formatAbsoluteDate(t){const e=this.getLocalizedDateTime(t),i=this.getConfiguredDateFormats();return i?e.toFormat(i.formats.date):e.toLocaleString(d.DATE_SHORT)}formatAbsoluteDateTime(t){const e=this.getLocalizedDateTime(t),i=this.getConfiguredDateFormats();return i?e.toFormat(i.formats.datetime):e.toLocaleString(d.DATETIME_SHORT)}getConfiguredDateFormats(){try{return(typeof opener?.top?.TYPO3<"u"?opener.top:top).TYPO3.settings.DateConfiguration}catch{return null}}};u([c({type:String})],r.prototype,"datetime",void 0),u([c()],r.prototype,"mode",void 0),u([c()],r.prototype,"format",void 0),u([c({type:Number,attribute:"threshold-days"})],r.prototype,"thresholdDays",void 0),u([T()],r.prototype,"displayTime",void 0),r=u([D("typo3-backend-datetime")],r);export{n as DateTimeDisplayMode,r as DateTimeElement};
