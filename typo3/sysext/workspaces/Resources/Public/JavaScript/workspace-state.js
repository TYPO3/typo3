/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import c from"@typo3/core/ajax/ajax-request.js";import{lll as p}from"@typo3/core/lit-helper.js";import{ModuleStateStorage as l}from"@typo3/backend/storage/module-state-storage.js";import o from"@typo3/backend/module-menu.js";import{UrlFactory as u}from"@typo3/core/factory/url-factory.js";import"@typo3/workspaces/element/workspace-top-indicator-element.js";const h=["red","orange","yellow","lime","green","teal","blue","indigo","purple","magenta"];class i extends CustomEvent{static{this.eventName="typo3:workspace:changed"}constructor(){super(i.eventName,{bubbles:!0})}}class w{constructor(){this.currentWorkspace=null,this.workspaces=[],this.initialized=!1,this.initPromise=null,document.addEventListener("typo3:workspaces:refresh",()=>{this.refresh()}),this.initialize()}get defaultWorkspace(){return{id:0,title:p("workspaces.messages:workspaceInfo.live.title")||"LIVE",color:"red",description:p("workspaces.messages:workspaceInfo.live.description")||""}}async initialize(){if(!this.initialized){if(this.initPromise)return this.initPromise;this.initPromise=this.fetchWorkspaceInfo(),await this.initPromise,this.initialized=!0,this.ensureWorkspaceIndicator()}}async getCurrentWorkspace(){return await this.initialize(),this.currentWorkspace}async getWorkspaces(){return await this.initialize(),this.workspaces}async isInWorkspace(){return(await this.getCurrentWorkspace()).id>0}async switchWorkspace(e){if((this.currentWorkspace?.id??0)!==e)try{const r=await(await new c(TYPO3.settings.ajaxUrls.workspace_switch).post({workspaceId:e,pageId:l.current("web").identifier})).resolve();if(r.workspaceId===void 0||r.workspaceId===null)return;const n=this.workspaces.find(d=>d.id===r.workspaceId);n&&(this.currentWorkspace=n),this.notifyChanged(),this.handlePostSwitchNavigation(r)}catch(s){throw console.error("Failed to switch workspace",s),s}}async refresh(){await this.fetchWorkspaceInfo(),this.notifyChanged()}notifyChanged(){document.dispatchEvent(new i);for(let e=0;e<window.frames.length;e++)try{window.frames[e].document.dispatchEvent(new i)}catch{}}async fetchWorkspaceInfo(){try{const t=await(await new c(TYPO3.settings.ajaxUrls.workspace_info).get()).resolve();this.currentWorkspace=t.current,this.workspaces=t.workspaces}catch(e){console.error("Failed to fetch workspace info",e),this.currentWorkspace=this.defaultWorkspace,this.workspaces=[]}}ensureWorkspaceIndicator(){if(!document.querySelector("typo3-backend-workspace-top-indicator")){const e=document.querySelector(".t3js-scaffold-state");if(!e)return;const t=document.createElement("typo3-backend-workspace-top-indicator");e.insertBefore(t,e.firstChild)}}handlePostSwitchNavigation(e){const t=o.App.getCurrentModule();if(e.pageId){const s=u.createUrl(TYPO3.Backend.ContentContainer.getUrl(),{id:e.pageId});import("@typo3/backend/viewport.js").then(({default:r})=>{r.ContentContainer.setUrl(s)})}else t==="workspaces_publish"?o.App.showModule(t,"workspace="+e.workspaceId):t?.startsWith("web_")?o.App.reloadFrames():e.pageModule&&o.App.showModule(e.pageModule);document.dispatchEvent(new CustomEvent("typo3:pagetree:refresh")),o.App.refreshMenu()}}function f(){if(top?.TYPO3?.WorkspaceState)return top.TYPO3.WorkspaceState;const a=new w;return top?.TYPO3&&(top.TYPO3.WorkspaceState=a),a}var k=f();export{i as WorkspaceChangedEvent,k as default,h as workspaceColors};
