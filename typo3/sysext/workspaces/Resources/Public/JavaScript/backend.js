/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import A from"@typo3/core/document-service.js";import{html as v}from"lit";import"@typo3/backend/element/icon-element.js";import{SeverityEnum as w}from"@typo3/backend/enum/severity.js";import"@typo3/workspaces/renderable/record-table.js";import"@typo3/backend/element/pagination.js";import T from"@typo3/workspaces/workspaces.js";import h from"@typo3/backend/modal.js";import k from"@typo3/backend/storage/persistent.js";import y from"@typo3/backend/utility.js";import M from"@typo3/backend/window-manager.js";import d from"@typo3/core/event/regular-event.js";import{topLevelModuleImport as S}from"@typo3/backend/utility/top-level-module-import.js";import{selector as x}from"@typo3/core/literals.js";import C from"@typo3/workspaces/utility/icon-helper.js";import b from"@typo3/backend/action-button/deferred-action.js";import l from"~labels/workspaces.messages";var s;(function(c){c.searchForm="#workspace-settings-form",c.searchTextField='#workspace-settings-form input[name="search-text"]',c.searchSubmitBtn='#workspace-settings-form button[type="submit"]',c.depthSelector='#workspace-settings-form [name="depth"]',c.languageSelector='#workspace-settings-form select[name="languages"]',c.stagesSelector='#workspace-settings-form select[name="stages"]',c.workspaceActions=".workspace-actions",c.chooseStageAction='.workspace-actions [name="stage-action"]',c.chooseSelectionAction='.workspace-actions [name="selection-action"]',c.chooseMassAction='.workspace-actions [name="mass-action"]',c.publishAction='[data-action="publish"]',c.prevStageAction='[data-action="prevstage"]',c.nextStageAction='[data-action="nextstage"]',c.changesAction='[data-action="changes"]',c.previewAction='[data-action="preview"]',c.openAction='[data-action="open"]',c.versionAction='[data-action="version"]',c.removeAction='[data-action="remove"]',c.expandAction='[data-action="expand"]',c.workspaceRecipientsSelectAll=".t3js-workspace-recipients-selectall",c.workspaceRecipientsDeselectAll=".t3js-workspace-recipients-deselectall",c.container="#workspace-panel",c.contentsContainer="#workspace-contents",c.noContentsContainer="#workspace-contents-empty",c.previewLinksButton=".t3js-preview-link",c.pagination="#workspace-pagination"})(s||(s={}));class p extends T{constructor(){super(),this.settings={id:TYPO3.settings.Workspaces.id,depth:1,language:"all",limit:30,query:"",start:0,filterTxt:""},this.paging={currentPage:1,totalPages:1,totalItems:0},this.markedRecordsForMassAction=[],this.handleCheckboxStateChanged=n=>{const t=n.target,e=t.closest("tr"),o=t.checked,a=e.dataset.table,i=e.dataset.uid,r=e.dataset.t3ver_oid,u=a+":"+i+":"+r;if(o)this.markedRecordsForMassAction.push(u);else{const m=this.markedRecordsForMassAction.indexOf(u);m>-1&&this.markedRecordsForMassAction.splice(m,1)}e.dataset.collectionCurrent?p.changeCollectionChildrenState(e.dataset.collectionCurrent,o):e.dataset.collection&&(p.changeCollectionChildrenState(e.dataset.collection,o),p.changeCollectionParentState(e.dataset.collection,o));const g=document.querySelector(s.chooseMassAction);g!==null&&(g.disabled=this.markedRecordsForMassAction.length>0)},this.openIntegrityWarningModal=()=>{const n=h.confirm(l.get("window.integrity_warning.title"),v`<p>${l.get("integrity.hasIssuesDescription")}<br>${l.get("integrity.hasIssuesQuestion")}</p>`,w.warning);return n.addEventListener("button.clicked",()=>n.hideModal()),n},S("@typo3/workspaces/renderable/send-to-stage-form.js"),S("@typo3/workspaces/renderable/record-information.js"),A.ready().then(()=>{this.registerEvents(),this.settings.depth=document.querySelector(s.depthSelector)?.value,this.settings.language=document.querySelector(s.languageSelector)?.value,this.settings.stage=document.querySelector(s.stagesSelector)?.value,document.querySelector(s.container)!==null&&this.getWorkspaceInfos()})}static refreshPageTree(){top.document.dispatchEvent(new CustomEvent("typo3:pagetree:refresh"))}static changeCollectionParentState(n,t){const e=document.querySelector('tr[data-collection-current="'+n+'"] input[type=checkbox]');e!==null&&e.checked!==t&&(e.checked=t,e.dataset.manuallyChanged="true",e.dispatchEvent(new CustomEvent("multiRecordSelection:checkbox:state:changed",{bubbles:!0,cancelable:!1})))}static changeCollectionChildrenState(n,t){const e=document.querySelectorAll(x`tr[data-collection="${n}"] input[type=checkbox]`);e.length&&e.forEach(o=>{o.checked!==t&&(o.checked=t,o.dataset.manuallyChanged="true",o.dispatchEvent(new CustomEvent("multiRecordSelection:checkbox:state:changed",{bubbles:!0,cancelable:!1})))})}checkIntegrity(n){return this.sendRemoteRequest(this.generateRemotePayloadBody("checkIntegrity",n))}registerEvents(){new d("click",(n,t)=>{const e=t.closest("tr");this.checkIntegrity({selection:[{liveId:e.dataset.uid,versionId:e.dataset.t3ver_oid,table:e.dataset.table}],type:"selection"}).then(async o=>{(await o.resolve())[0].result.result==="warning"?this.openIntegrityWarningModal().addEventListener("confirm.button.ok",()=>{this.renderPublishModal(e)}):this.renderPublishModal(e)})}).delegateTo(document,s.publishAction),new d("click",(n,t)=>{this.sendToStage(t.closest("tr"),"prev")}).delegateTo(document,s.prevStageAction),new d("click",(n,t)=>{this.sendToStage(t.closest("tr"),"next")}).delegateTo(document,s.nextStageAction),new d("click",this.viewChanges.bind(this)).delegateTo(document,s.changesAction),new d("click",this.openPreview.bind(this)).delegateTo(document,s.previewAction),new d("click",(n,t)=>{const e=t.closest("tr"),o=TYPO3.settings.FormEngine.moduleUrl+"&returnUrl="+encodeURIComponent(document.location.href)+"&module="+encodeURIComponent(top.TYPO3.ModuleMenu.App.getCurrentModule())+"&id="+TYPO3.settings.Workspaces.id+"&edit["+e.dataset.table+"]["+e.dataset.uid+"]=edit";window.location.href=o}).delegateTo(document,s.openAction),new d("click",(n,t)=>{const e=t.closest("tr"),o=e.dataset.table==="pages"?e.dataset.t3ver_oid:e.dataset.pid;window.location.href=TYPO3.settings.WebLayout.moduleUrl+"&id="+o}).delegateTo(document,s.versionAction),new d("click",this.confirmDeleteRecordFromWorkspace.bind(this)).delegateTo(document,s.removeAction),new d("click",(n,t)=>{let e;t.ariaExpanded==="true"?e="actions-caret-down":e="actions-caret-right",t.replaceChildren(document.createRange().createContextualFragment(C.getIcon(e)))}).delegateTo(document,s.expandAction),new d("click",()=>{window.top.document.querySelectorAll(".t3js-workspace-recipient").forEach(t=>{t.disabled||(t.checked=!0)})}).delegateTo(window.top.document,s.workspaceRecipientsSelectAll),new d("click",()=>{window.top.document.querySelectorAll(".t3js-workspace-recipient").forEach(t=>{t.disabled||(t.checked=!1)})}).delegateTo(window.top.document,s.workspaceRecipientsDeselectAll),new d("submit",n=>{n.preventDefault(),this.getWorkspaceInfos()}).delegateTo(document,s.searchForm),new d("input",(n,t)=>{const e=document.querySelector(s.searchSubmitBtn);t.value!==""?e.disabled=!1:(e.disabled=!0,this.settings.filterTxt="",this.getWorkspaceInfos())}).delegateTo(document,s.searchTextField),new d("change",(n,t)=>{this.settings.filterTxt=t.value,this.settings.filterTxt!==""&&this.getWorkspaceInfos()}).delegateTo(document,s.searchTextField),new d("search",(n,t)=>{if(t.value===""){const e=document.querySelector(s.searchSubmitBtn);e.disabled=!0,this.settings.filterTxt="",this.getWorkspaceInfos()}}).delegateTo(document,s.searchTextField),new d("multiRecordSelection:checkbox:state:changed",this.handleCheckboxStateChanged).bindTo(document),new d("change",(n,t)=>{const e=t.value;k.set("moduleData.workspaces_publish.depth",e),this.settings.depth=e,this.getWorkspaceInfos()}).delegateTo(document,s.depthSelector),new d("click",this.generatePreviewLinks.bind(this)).delegateTo(document,s.previewLinksButton),new d("change",(n,t)=>{k.set("moduleData.workspaces_publish.language",t.value),this.settings.language=t.value,this.sendRemoteRequest(this.generateRemotePayloadBody("getWorkspaceInfos",this.settings)).then(async e=>{const o=await e.resolve();t.previousElementSibling.innerHTML=t.querySelector("option:checked").dataset.icon,this.renderWorkspaceInfos(o[0].result)})}).delegateTo(document,s.languageSelector),new d("change",(n,t)=>{const e=t.value;k.set("moduleData.workspaces_publish.stage",e),this.settings.stage=e,this.getWorkspaceInfos()}).delegateTo(document,s.stagesSelector),new d("change",this.sendToSpecificStageAction.bind(this)).delegateTo(document,s.chooseStageAction),new d("change",this.runSelectionAction.bind(this)).delegateTo(document,s.chooseSelectionAction),new d("change",this.runMassAction.bind(this)).delegateTo(document,s.chooseMassAction),new d("click",n=>{n.preventDefault();const t=n.target.closest("button");let e=!1;switch(t.dataset.action){case"previous":this.paging.currentPage>1&&(this.paging.currentPage--,e=!0);break;case"next":this.paging.currentPage<this.paging.totalPages&&(this.paging.currentPage++,e=!0);break;case"page":this.paging.currentPage=parseInt(t.dataset.page,10),e=!0;break;default:throw'Unknown action "'+t.dataset.action+'"'}e&&(this.settings.start=parseInt(this.settings.limit.toString(),10)*(this.paging.currentPage-1),this.getWorkspaceInfos())}).delegateTo(document,s.pagination)}sendToStage(n,t){let e,o,a;if(t==="next")e=n.dataset.nextStage,o="sendToNextStageWindow",a="sendToNextStageExecute";else if(t==="prev")e=n.dataset.prevStage,o="sendToPrevStageWindow",a="sendToPrevStageExecute";else throw"Invalid direction given.";this.sendRemoteRequest(this.generateRemotePayloadBody(o,[n.dataset.uid,n.dataset.table,n.dataset.t3ver_oid])).then(async i=>{const r=this.renderSendToStageWindow(await i.resolve());r.addEventListener("button.clicked",u=>{if(u.target.name==="ok"){const m=y.convertFormToObject(r.querySelector("form"));m.affects={table:n.dataset.table,nextStage:e,t3ver_oid:n.dataset.t3ver_oid,uid:n.dataset.uid,elements:[]},this.sendRemoteRequest([this.generateRemotePayloadBody(a,[m]),this.generateRemotePayloadBody("getWorkspaceInfos",this.settings)]).then(async f=>{const R=await f.resolve();r.hideModal(),this.renderWorkspaceInfos(R[1].result),p.refreshPageTree()})}})})}getWorkspaceInfos(){this.sendRemoteRequest(this.generateRemotePayloadBody("getWorkspaceInfos",this.settings)).then(async n=>{this.renderWorkspaceInfos((await n.resolve())[0].result)})}renderWorkspaceInfos(n){const t=document.querySelector(s.contentsContainer),e=document.querySelector(s.noContentsContainer);this.resetMassActionState(n.data.length),this.buildPagination(n.total),n.total===0?(t.style.display="none",e.style.display="block"):(t.style.display="block",e.style.display="none");const o=document.querySelector("typo3-workspaces-record-table");o.results=n.data}buildPagination(n){const t=document.querySelector(s.pagination);if(n===0){t.replaceChildren();return}if(this.paging.totalItems=n,this.paging.totalPages=Math.ceil(n/parseInt(this.settings.limit.toString(),10)),this.paging.totalPages===1){t.replaceChildren();return}let e=t.querySelector("typo3-backend-pagination");e===null&&(e=document.createElement("typo3-backend-pagination"),t.append(e)),e.paging={...this.paging}}viewChanges(n,t){n.preventDefault();const e=t.closest("tr");this.sendRemoteRequest(this.generateRemotePayloadBody("getRowDetails",{stage:parseInt(e.dataset.stage,10),t3ver_oid:parseInt(e.dataset.t3ver_oid,10),table:e.dataset.table,uid:parseInt(e.dataset.uid,10),filterFields:!0})).then(async o=>{const a=(await o.resolve())[0].result.data[0],i=[],r=document.createElement("typo3-workspaces-record-information");r.record=a,a.label_PrevStage!==!1&&e.dataset.stage!==e.dataset.prevStage&&i.push({text:a.label_PrevStage.title,active:!0,btnClass:"btn-default",name:"prevstage",trigger:(u,g)=>{g.hideModal(),this.sendToStage(e,"prev")}}),a.label_NextStage!==!1&&i.push({text:a.label_NextStage.title,active:!0,btnClass:"btn-default",name:"nextstage",trigger:(u,g)=>{g.hideModal(),this.sendToStage(e,"next")}}),i.push({text:l.get("close"),active:!0,btnClass:"btn-info",name:"cancel",trigger:(u,g)=>g.hideModal()}),h.advanced({type:h.types.default,title:l.get("window.recordInformation").replace("{0}",e.querySelector(".t3js-title-workspace").innerText.trim()),content:r,severity:w.info,buttons:i,size:h.sizes.medium})})}openPreview(n,t){const e=t.closest("tr");this.sendRemoteRequest(this.generateRemotePayloadBody("viewSingleRecord",[e.dataset.table,e.dataset.uid])).then(async o=>{const a=(await o.resolve())[0].result;M.localOpen(a)})}confirmDeleteRecordFromWorkspace(n,t){const e=t.closest("tr"),o=h.confirm(l.get("window.discard.title"),l.get("window.discard.message"),w.warning,[{text:l.get("cancel"),active:!0,btnClass:"btn-default",name:"cancel",trigger:()=>{o.hideModal()}},{text:l.get("ok"),btnClass:"btn-warning",name:"ok"}]);o.addEventListener("button.clicked",a=>{a.target.name==="ok"&&this.sendRemoteRequest([this.generateRemotePayloadBody("discardSingleRecord",[e.dataset.table,e.dataset.uid])]).then(()=>{o.hideModal(),this.getWorkspaceInfos(),p.refreshPageTree()})})}runSelectionAction(n,t){const e=t.value,o=e!=="discard";if(e.length===0)return;const a=[];for(let i=0;i<this.markedRecordsForMassAction.length;++i){const r=this.markedRecordsForMassAction[i].split(":");a.push({table:r[0],liveId:r[2],versionId:r[1]})}o?this.checkIntegrity({selection:a,type:"selection"}).then(async i=>{(await i.resolve())[0].result.result==="warning"?this.openIntegrityWarningModal().addEventListener("confirm.button.ok",()=>{this.renderSelectionActionModal(e,a)}):this.renderSelectionActionModal(e,a)}):this.renderSelectionActionModal(e,a)}renderPublishModal(n){const t=h.advanced({title:l.get("window.publish.title"),content:l.get("window.publish.message"),severity:w.info,staticBackdrop:!0,buttons:[{text:l.get("cancel"),btnClass:"btn-default",trigger:function(){t.hideModal()}},{text:l.get("label_doaction_publish"),btnClass:"btn-info",action:new b(async()=>{await this.sendRemoteRequest(this.generateRemotePayloadBody("publishSingleRecord",[n.dataset.table,n.dataset.t3ver_oid,n.dataset.uid])),this.getWorkspaceInfos(),p.refreshPageTree()})}]})}renderSelectionActionModal(n,t){const e=h.advanced({title:l.get("window.selectionAction.title"),content:v`<p>${l.get("tooltip."+n+"Selected")}</p>`,severity:w.warning,staticBackdrop:!0,buttons:[{text:l.get("cancel"),btnClass:"btn-default",trigger:function(){e.hideModal()}},{text:l.get("label_doaction_"+n),btnClass:"btn-warning",action:new b(async()=>{await this.sendRemoteRequest(this.generateRemotePayloadBody("executeSelectionAction",{action:n,selection:t})),this.markedRecordsForMassAction=[],this.getWorkspaceInfos(),p.refreshPageTree()})}]});e.addEventListener("typo3-modal-hidden",()=>{const o=document.querySelector(s.chooseSelectionAction);o!==null&&(o.value="")})}runMassAction(n,t){const e=t.value,o=e!=="discard";e.length!==0&&(o?this.checkIntegrity({language:this.settings.language,type:e}).then(async a=>{(await a.resolve())[0].result.result==="warning"?this.openIntegrityWarningModal().addEventListener("confirm.button.ok",()=>{this.renderMassActionModal(e)}):this.renderMassActionModal(e)}):this.renderMassActionModal(e))}renderMassActionModal(n){let t,e;switch(n){case"publish":t="publishEntireWorkspace",e=l.get("label_doaction_publish");break;case"discard":t="discardEntireWorkspace",e=l.get("label_doaction_discard");break;default:throw"Invalid mass action "+n+" called."}const o=async i=>{const r=(await i.resolve())[0].result;r.processed<r.total?this.sendRemoteRequest(this.generateRemotePayloadBody(t,r)).then(o):(this.getWorkspaceInfos(),h.dismiss())},a=h.advanced({title:l.get("window.massAction.title"),content:v`<p>${l.get("tooltip."+n+"All")}</p><p>${l.get("tooltip.affectWholeWorkspace")}</p>`,severity:w.warning,staticBackdrop:!0,buttons:[{text:l.get("cancel"),btnClass:"btn-default",trigger:function(){a.hideModal()}},{text:e,btnClass:"btn-warning",action:new b(async()=>{const i=await this.sendRemoteRequest(this.generateRemotePayloadBody(t,{init:!0,total:0,processed:0,language:this.settings.language}));await o(i)})}]});a.addEventListener("typo3-modal-hidden",()=>{const i=document.querySelector(s.chooseMassAction);i!==null&&(i.value="")})}sendToSpecificStageAction(n,t){const e=[],o=t.value;for(let a=0;a<this.markedRecordsForMassAction.length;++a){const i=this.markedRecordsForMassAction[a].split(":");e.push({table:i[0],uid:i[1],t3ver_oid:i[2]})}this.sendRemoteRequest(this.generateRemotePayloadBody("sendToSpecificStageWindow",[o])).then(async a=>{const i=this.renderSendToStageWindow(await a.resolve());i.addEventListener("button.clicked",r=>{if(r.target.name==="ok"){const g=y.convertFormToObject(i.querySelector("form"));g.affects={elements:e,nextStage:o},this.sendRemoteRequest([this.generateRemotePayloadBody("sendToSpecificStageExecute",[g]),this.generateRemotePayloadBody("getWorkspaceInfos",this.settings)]).then(async m=>{const f=await m.resolve();i.hideModal(),this.renderWorkspaceInfos(f[1].result),p.refreshPageTree()})}}),i.addEventListener("typo3-modal-hide",()=>{const r=document.querySelector(s.chooseStageAction);r!==null&&(r.value="")})})}generatePreviewLinks(){this.sendRemoteRequest(this.generateRemotePayloadBody("generateWorkspacePreviewLinksForAllLanguages",[this.settings.id])).then(async n=>{const t=(await n.resolve())[0].result,e=document.createElement("dl");for(const[o,a]of Object.entries(t)){const i=document.createElement("dt");i.textContent=o;const r=document.createElement("a");r.href=a,r.target="_blank",r.textContent=a;const u=document.createElement("dd");u.appendChild(r),e.append(i,u)}h.show(l.get("previewLink"),e,w.info,[{text:l.get("ok"),active:!0,btnClass:"btn-info",name:"ok",trigger:(o,a)=>a.hideModal()}],["modal-inner-scroll"])})}resetMassActionState(n){if(this.markedRecordsForMassAction=[],n){const t=document.querySelector(s.workspaceActions);t!==null&&t.classList.remove("hidden");const e=document.querySelector(s.chooseMassAction);e!==null&&(e.disabled=!1)}document.dispatchEvent(new CustomEvent("multiRecordSelection:actions:hide")),document.dispatchEvent(new CustomEvent("multiRecordSelection:checkboxes:uncheck"))}}var P=new p;export{P as default};
