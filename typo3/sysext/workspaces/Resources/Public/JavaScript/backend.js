/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import R from"@typo3/core/document-service.js";import{html as f}from"lit";import"@typo3/backend/element/icon-element.js";import{SeverityEnum as m}from"@typo3/backend/enum/severity.js";import"@typo3/workspaces/renderable/record-table.js";import"@typo3/backend/element/pagination.js";import T from"@typo3/workspaces/workspaces.js";import u from"@typo3/backend/modal.js";import v from"@typo3/backend/storage/persistent.js";import b from"@typo3/backend/utility.js";import P from"@typo3/backend/window-manager.js";import l from"@typo3/core/event/regular-event.js";import{topLevelModuleImport as y}from"@typo3/backend/utility/top-level-module-import.js";import{selector as A}from"@typo3/core/literals.js";import M from"@typo3/workspaces/utility/icon-helper.js";import k from"@typo3/backend/action-button/deferred-action.js";var a;(function(r){r.searchForm="#workspace-settings-form",r.searchTextField='#workspace-settings-form input[name="search-text"]',r.searchSubmitBtn='#workspace-settings-form button[type="submit"]',r.depthSelector='#workspace-settings-form [name="depth"]',r.languageSelector='#workspace-settings-form select[name="languages"]',r.stagesSelector='#workspace-settings-form select[name="stages"]',r.workspaceActions=".workspace-actions",r.chooseStageAction='.workspace-actions [name="stage-action"]',r.chooseSelectionAction='.workspace-actions [name="selection-action"]',r.chooseMassAction='.workspace-actions [name="mass-action"]',r.publishAction='[data-action="publish"]',r.prevStageAction='[data-action="prevstage"]',r.nextStageAction='[data-action="nextstage"]',r.changesAction='[data-action="changes"]',r.previewAction='[data-action="preview"]',r.openAction='[data-action="open"]',r.versionAction='[data-action="version"]',r.removeAction='[data-action="remove"]',r.expandAction='[data-action="expand"]',r.workspaceRecipientsSelectAll=".t3js-workspace-recipients-selectall",r.workspaceRecipientsDeselectAll=".t3js-workspace-recipients-deselectall",r.container="#workspace-panel",r.contentsContainer="#workspace-contents",r.noContentsContainer="#workspace-contents-empty",r.previewLinksButton=".t3js-preview-link",r.pagination="#workspace-pagination"})(a||(a={}));class h extends T{constructor(){super(),this.settings={id:TYPO3.settings.Workspaces.id,depth:1,language:"all",limit:30,query:"",start:0,filterTxt:""},this.paging={currentPage:1,totalPages:1,totalItems:0},this.markedRecordsForMassAction=[],this.handleCheckboxStateChanged=n=>{const t=n.target,e=t.closest("tr"),o=t.checked,s=e.dataset.table,i=e.dataset.uid,c=e.dataset.t3ver_oid,g=s+":"+i+":"+c;if(o)this.markedRecordsForMassAction.push(g);else{const p=this.markedRecordsForMassAction.indexOf(g);p>-1&&this.markedRecordsForMassAction.splice(p,1)}e.dataset.collectionCurrent?h.changeCollectionChildrenState(e.dataset.collectionCurrent,o):e.dataset.collection&&(h.changeCollectionChildrenState(e.dataset.collection,o),h.changeCollectionParentState(e.dataset.collection,o));const d=document.querySelector(a.chooseMassAction);d!==null&&(d.disabled=this.markedRecordsForMassAction.length>0)},this.openIntegrityWarningModal=()=>{const n=u.confirm(TYPO3.lang["window.integrity_warning.title"],f`<p>${TYPO3.lang["integrity.hasIssuesDescription"]}<br>${TYPO3.lang["integrity.hasIssuesQuestion"]}</p>`,m.warning);return n.addEventListener("button.clicked",()=>n.hideModal()),n},y("@typo3/workspaces/renderable/send-to-stage-form.js"),y("@typo3/workspaces/renderable/record-information.js"),R.ready().then(()=>{this.registerEvents(),this.settings.depth=document.querySelector(a.depthSelector)?.value,this.settings.language=document.querySelector(a.languageSelector)?.value,this.settings.stage=document.querySelector(a.stagesSelector)?.value,document.querySelector(a.container)!==null&&this.getWorkspaceInfos()})}static refreshPageTree(){top.document.dispatchEvent(new CustomEvent("typo3:pagetree:refresh"))}static changeCollectionParentState(n,t){const e=document.querySelector('tr[data-collection-current="'+n+'"] input[type=checkbox]');e!==null&&e.checked!==t&&(e.checked=t,e.dataset.manuallyChanged="true",e.dispatchEvent(new CustomEvent("multiRecordSelection:checkbox:state:changed",{bubbles:!0,cancelable:!1})))}static changeCollectionChildrenState(n,t){const e=document.querySelectorAll(A`tr[data-collection="${n}"] input[type=checkbox]`);e.length&&e.forEach(o=>{o.checked!==t&&(o.checked=t,o.dataset.manuallyChanged="true",o.dispatchEvent(new CustomEvent("multiRecordSelection:checkbox:state:changed",{bubbles:!0,cancelable:!1})))})}checkIntegrity(n){return this.sendRemoteRequest(this.generateRemotePayloadBody("checkIntegrity",n))}registerEvents(){new l("click",(n,t)=>{const e=t.closest("tr");this.checkIntegrity({selection:[{liveId:e.dataset.uid,versionId:e.dataset.t3ver_oid,table:e.dataset.table}],type:"selection"}).then(async o=>{(await o.resolve())[0].result.result==="warning"?this.openIntegrityWarningModal().addEventListener("confirm.button.ok",()=>{this.renderPublishModal(e)}):this.renderPublishModal(e)})}).delegateTo(document,a.publishAction),new l("click",(n,t)=>{this.sendToStage(t.closest("tr"),"prev")}).delegateTo(document,a.prevStageAction),new l("click",(n,t)=>{this.sendToStage(t.closest("tr"),"next")}).delegateTo(document,a.nextStageAction),new l("click",this.viewChanges.bind(this)).delegateTo(document,a.changesAction),new l("click",this.openPreview.bind(this)).delegateTo(document,a.previewAction),new l("click",(n,t)=>{const e=t.closest("tr"),o=TYPO3.settings.FormEngine.moduleUrl+"&returnUrl="+encodeURIComponent(document.location.href)+"&module="+encodeURIComponent(top.TYPO3.ModuleMenu.App.getCurrentModule())+"&id="+TYPO3.settings.Workspaces.id+"&edit["+e.dataset.table+"]["+e.dataset.uid+"]=edit";window.location.href=o}).delegateTo(document,a.openAction),new l("click",(n,t)=>{const e=t.closest("tr"),o=e.dataset.table==="pages"?e.dataset.t3ver_oid:e.dataset.pid;window.location.href=TYPO3.settings.WebLayout.moduleUrl+"&id="+o}).delegateTo(document,a.versionAction),new l("click",this.confirmDeleteRecordFromWorkspace.bind(this)).delegateTo(document,a.removeAction),new l("click",(n,t)=>{let e;t.ariaExpanded==="true"?e="actions-caret-down":e="actions-caret-right",t.replaceChildren(document.createRange().createContextualFragment(M.getIcon(e)))}).delegateTo(document,a.expandAction),new l("click",()=>{window.top.document.querySelectorAll(".t3js-workspace-recipient").forEach(t=>{t.disabled||(t.checked=!0)})}).delegateTo(window.top.document,a.workspaceRecipientsSelectAll),new l("click",()=>{window.top.document.querySelectorAll(".t3js-workspace-recipient").forEach(t=>{t.disabled||(t.checked=!1)})}).delegateTo(window.top.document,a.workspaceRecipientsDeselectAll),new l("submit",n=>{n.preventDefault(),this.getWorkspaceInfos()}).delegateTo(document,a.searchForm),new l("input",(n,t)=>{const e=document.querySelector(a.searchSubmitBtn);t.value!==""?e.disabled=!1:(e.disabled=!0,this.settings.filterTxt="",this.getWorkspaceInfos())}).delegateTo(document,a.searchTextField),new l("change",(n,t)=>{this.settings.filterTxt=t.value,this.settings.filterTxt!==""&&this.getWorkspaceInfos()}).delegateTo(document,a.searchTextField),new l("search",(n,t)=>{if(t.value===""){const e=document.querySelector(a.searchSubmitBtn);e.disabled=!0,this.settings.filterTxt="",this.getWorkspaceInfos()}}).delegateTo(document,a.searchTextField),new l("multiRecordSelection:checkbox:state:changed",this.handleCheckboxStateChanged).bindTo(document),new l("change",(n,t)=>{const e=t.value;v.set("moduleData.workspaces_publish.depth",e),this.settings.depth=e,this.getWorkspaceInfos()}).delegateTo(document,a.depthSelector),new l("click",this.generatePreviewLinks.bind(this)).delegateTo(document,a.previewLinksButton),new l("change",(n,t)=>{v.set("moduleData.workspaces_publish.language",t.value),this.settings.language=t.value,this.sendRemoteRequest(this.generateRemotePayloadBody("getWorkspaceInfos",this.settings)).then(async e=>{const o=await e.resolve();t.previousElementSibling.innerHTML=t.querySelector("option:checked").dataset.icon,this.renderWorkspaceInfos(o[0].result)})}).delegateTo(document,a.languageSelector),new l("change",(n,t)=>{const e=t.value;v.set("moduleData.workspaces_publish.stage",e),this.settings.stage=e,this.getWorkspaceInfos()}).delegateTo(document,a.stagesSelector),new l("change",this.sendToSpecificStageAction.bind(this)).delegateTo(document,a.chooseStageAction),new l("change",this.runSelectionAction.bind(this)).delegateTo(document,a.chooseSelectionAction),new l("change",this.runMassAction.bind(this)).delegateTo(document,a.chooseMassAction),new l("click",n=>{n.preventDefault();const t=n.target.closest("button");let e=!1;switch(t.dataset.action){case"previous":this.paging.currentPage>1&&(this.paging.currentPage--,e=!0);break;case"next":this.paging.currentPage<this.paging.totalPages&&(this.paging.currentPage++,e=!0);break;case"page":this.paging.currentPage=parseInt(t.dataset.page,10),e=!0;break;default:throw'Unknown action "'+t.dataset.action+'"'}e&&(this.settings.start=parseInt(this.settings.limit.toString(),10)*(this.paging.currentPage-1),this.getWorkspaceInfos())}).delegateTo(document,a.pagination)}sendToStage(n,t){let e,o,s;if(t==="next")e=n.dataset.nextStage,o="sendToNextStageWindow",s="sendToNextStageExecute";else if(t==="prev")e=n.dataset.prevStage,o="sendToPrevStageWindow",s="sendToPrevStageExecute";else throw"Invalid direction given.";this.sendRemoteRequest(this.generateRemotePayloadBody(o,[n.dataset.uid,n.dataset.table,n.dataset.t3ver_oid])).then(async i=>{const c=this.renderSendToStageWindow(await i.resolve());c.addEventListener("button.clicked",g=>{if(g.target.name==="ok"){const p=b.convertFormToObject(c.querySelector("form"));p.affects={table:n.dataset.table,nextStage:e,t3ver_oid:n.dataset.t3ver_oid,uid:n.dataset.uid,elements:[]},this.sendRemoteRequest([this.generateRemotePayloadBody(s,[p]),this.generateRemotePayloadBody("getWorkspaceInfos",this.settings)]).then(async w=>{const S=await w.resolve();c.hideModal(),this.renderWorkspaceInfos(S[1].result),h.refreshPageTree()})}})})}getWorkspaceInfos(){this.sendRemoteRequest(this.generateRemotePayloadBody("getWorkspaceInfos",this.settings)).then(async n=>{this.renderWorkspaceInfos((await n.resolve())[0].result)})}renderWorkspaceInfos(n){const t=document.querySelector(a.contentsContainer),e=document.querySelector(a.noContentsContainer);this.resetMassActionState(n.data.length),this.buildPagination(n.total),n.total===0?(t.style.display="none",e.style.display="block"):(t.style.display="block",e.style.display="none");const o=document.querySelector("typo3-workspaces-record-table");o.results=n.data}buildPagination(n){const t=document.querySelector(a.pagination);if(n===0){t.replaceChildren();return}if(this.paging.totalItems=n,this.paging.totalPages=Math.ceil(n/parseInt(this.settings.limit.toString(),10)),this.paging.totalPages===1){t.replaceChildren();return}let e=t.querySelector("typo3-backend-pagination");e===null&&(e=document.createElement("typo3-backend-pagination"),t.append(e)),e.paging={...this.paging}}viewChanges(n,t){n.preventDefault();const e=t.closest("tr");this.sendRemoteRequest(this.generateRemotePayloadBody("getRowDetails",{stage:parseInt(e.dataset.stage,10),t3ver_oid:parseInt(e.dataset.t3ver_oid,10),table:e.dataset.table,uid:parseInt(e.dataset.uid,10),filterFields:!0})).then(async o=>{const s=(await o.resolve())[0].result.data[0],i=[],c=document.createElement("typo3-workspaces-record-information");c.record=s,c.TYPO3lang=TYPO3.lang,s.label_PrevStage!==!1&&e.dataset.stage!==e.dataset.prevStage&&i.push({text:s.label_PrevStage.title,active:!0,btnClass:"btn-default",name:"prevstage",trigger:(g,d)=>{d.hideModal(),this.sendToStage(e,"prev")}}),s.label_NextStage!==!1&&i.push({text:s.label_NextStage.title,active:!0,btnClass:"btn-default",name:"nextstage",trigger:(g,d)=>{d.hideModal(),this.sendToStage(e,"next")}}),i.push({text:TYPO3.lang.close,active:!0,btnClass:"btn-info",name:"cancel",trigger:(g,d)=>d.hideModal()}),u.advanced({type:u.types.default,title:TYPO3.lang["window.recordInformation"].replace("{0}",e.querySelector(".t3js-title-workspace").innerText.trim()),content:c,severity:m.info,buttons:i,size:u.sizes.medium})})}openPreview(n,t){const e=t.closest("tr");this.sendRemoteRequest(this.generateRemotePayloadBody("viewSingleRecord",[e.dataset.table,e.dataset.uid])).then(async o=>{const s=(await o.resolve())[0].result;P.localOpen(s)})}confirmDeleteRecordFromWorkspace(n,t){const e=t.closest("tr"),o=u.confirm(TYPO3.lang["window.discard.title"],TYPO3.lang["window.discard.message"],m.warning,[{text:TYPO3.lang.cancel,active:!0,btnClass:"btn-default",name:"cancel",trigger:()=>{o.hideModal()}},{text:TYPO3.lang.ok,btnClass:"btn-warning",name:"ok"}]);o.addEventListener("button.clicked",s=>{s.target.name==="ok"&&this.sendRemoteRequest([this.generateRemotePayloadBody("discardSingleRecord",[e.dataset.table,e.dataset.uid])]).then(()=>{o.hideModal(),this.getWorkspaceInfos(),h.refreshPageTree()})})}runSelectionAction(n,t){const e=t.value,o=e!=="discard";if(e.length===0)return;const s=[];for(let i=0;i<this.markedRecordsForMassAction.length;++i){const c=this.markedRecordsForMassAction[i].split(":");s.push({table:c[0],liveId:c[2],versionId:c[1]})}o?this.checkIntegrity({selection:s,type:"selection"}).then(async i=>{(await i.resolve())[0].result.result==="warning"?this.openIntegrityWarningModal().addEventListener("confirm.button.ok",()=>{this.renderSelectionActionModal(e,s)}):this.renderSelectionActionModal(e,s)}):this.renderSelectionActionModal(e,s)}renderPublishModal(n){const t=u.advanced({title:TYPO3.lang["window.publish.title"],content:TYPO3.lang["window.publish.message"],severity:m.info,staticBackdrop:!0,buttons:[{text:TYPO3.lang.cancel,btnClass:"btn-default",trigger:function(){t.hideModal()}},{text:TYPO3.lang.label_doaction_publish,btnClass:"btn-info",action:new k(async()=>{await this.sendRemoteRequest(this.generateRemotePayloadBody("publishSingleRecord",[n.dataset.table,n.dataset.t3ver_oid,n.dataset.uid])),this.getWorkspaceInfos(),h.refreshPageTree()})}]})}renderSelectionActionModal(n,t){const e=u.advanced({title:TYPO3.lang["window.selectionAction.title"],content:f`<p>${TYPO3.lang["tooltip."+n+"Selected"]}</p>`,severity:m.warning,staticBackdrop:!0,buttons:[{text:TYPO3.lang.cancel,btnClass:"btn-default",trigger:function(){e.hideModal()}},{text:TYPO3.lang["label_doaction_"+n],btnClass:"btn-warning",action:new k(async()=>{await this.sendRemoteRequest(this.generateRemotePayloadBody("executeSelectionAction",{action:n,selection:t})),this.markedRecordsForMassAction=[],this.getWorkspaceInfos(),h.refreshPageTree()})}]});e.addEventListener("typo3-modal-hidden",()=>{const o=document.querySelector(a.chooseSelectionAction);o!==null&&(o.value="")})}runMassAction(n,t){const e=t.value,o=e!=="discard";e.length!==0&&(o?this.checkIntegrity({language:this.settings.language,type:e}).then(async s=>{(await s.resolve())[0].result.result==="warning"?this.openIntegrityWarningModal().addEventListener("confirm.button.ok",()=>{this.renderMassActionModal(e)}):this.renderMassActionModal(e)}):this.renderMassActionModal(e))}renderMassActionModal(n){let t,e;switch(n){case"publish":t="publishEntireWorkspace",e=TYPO3.lang.label_doaction_publish;break;case"discard":t="discardEntireWorkspace",e=TYPO3.lang.label_doaction_discard;break;default:throw"Invalid mass action "+n+" called."}const o=async i=>{const c=(await i.resolve())[0].result;c.processed<c.total?this.sendRemoteRequest(this.generateRemotePayloadBody(t,c)).then(o):(this.getWorkspaceInfos(),u.dismiss())},s=u.advanced({title:TYPO3.lang["window.massAction.title"],content:f`<p>${TYPO3.lang["tooltip."+n+"All"]}</p><p>${TYPO3.lang["tooltip.affectWholeWorkspace"]}</p>`,severity:m.warning,staticBackdrop:!0,buttons:[{text:TYPO3.lang.cancel,btnClass:"btn-default",trigger:function(){s.hideModal()}},{text:e,btnClass:"btn-warning",action:new k(async()=>{const i=await this.sendRemoteRequest(this.generateRemotePayloadBody(t,{init:!0,total:0,processed:0,language:this.settings.language}));await o(i)})}]});s.addEventListener("typo3-modal-hidden",()=>{const i=document.querySelector(a.chooseMassAction);i!==null&&(i.value="")})}sendToSpecificStageAction(n,t){const e=[],o=t.value;for(let s=0;s<this.markedRecordsForMassAction.length;++s){const i=this.markedRecordsForMassAction[s].split(":");e.push({table:i[0],uid:i[1],t3ver_oid:i[2]})}this.sendRemoteRequest(this.generateRemotePayloadBody("sendToSpecificStageWindow",[o])).then(async s=>{const i=this.renderSendToStageWindow(await s.resolve());i.addEventListener("button.clicked",c=>{if(c.target.name==="ok"){const d=b.convertFormToObject(i.querySelector("form"));d.affects={elements:e,nextStage:o},this.sendRemoteRequest([this.generateRemotePayloadBody("sendToSpecificStageExecute",[d]),this.generateRemotePayloadBody("getWorkspaceInfos",this.settings)]).then(async p=>{const w=await p.resolve();i.hideModal(),this.renderWorkspaceInfos(w[1].result),h.refreshPageTree()})}}),i.addEventListener("typo3-modal-hide",()=>{const c=document.querySelector(a.chooseStageAction);c!==null&&(c.value="")})})}generatePreviewLinks(){this.sendRemoteRequest(this.generateRemotePayloadBody("generateWorkspacePreviewLinksForAllLanguages",[this.settings.id])).then(async n=>{const t=(await n.resolve())[0].result,e=document.createElement("dl");for(const[o,s]of Object.entries(t)){const i=document.createElement("dt");i.textContent=o;const c=document.createElement("a");c.href=s,c.target="_blank",c.textContent=s;const g=document.createElement("dd");g.appendChild(c),e.append(i,g)}u.show(TYPO3.lang.previewLink,e,m.info,[{text:TYPO3.lang.ok,active:!0,btnClass:"btn-info",name:"ok",trigger:(o,s)=>s.hideModal()}],["modal-inner-scroll"])})}resetMassActionState(n){if(this.markedRecordsForMassAction=[],n){const t=document.querySelector(a.workspaceActions);t!==null&&t.classList.remove("hidden");const e=document.querySelector(a.chooseMassAction);e!==null&&(e.disabled=!1)}document.dispatchEvent(new CustomEvent("multiRecordSelection:actions:hide")),document.dispatchEvent(new CustomEvent("multiRecordSelection:checkboxes:uncheck"))}}var x=new h;export{x as default};
