/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import v from"@typo3/core/document-service.js";import"@typo3/backend/element/progress-bar-element.js";import"@typo3/backend/element/alert-element.js";import"@typo3/backend/element/icon-element.js";import"@typo3/backend/element/pagination.js";import S from"@typo3/backend/action-button/deferred-action.js";import y from"@typo3/backend/modal.js";import x from"@typo3/backend/notification.js";import{SeverityEnum as T}from"@typo3/backend/enum/severity.js";import d from"@typo3/core/event/regular-event.js";import f from"@typo3/core/ajax/ajax-request.js";var s;(function(i){i.searchForm="#recycler-form",i.searchText="#recycler-form [name=search-text]",i.searchSubmitBtn="#recycler-form button[type=submit]",i.depthSelector="#recycler-form [name=depth]",i.tableSelector="#recycler-form [name=pages]",i.recyclerTable="#itemsInRecycler",i.paginator="#recycler-index nav",i.reloadAction="a[data-action=reload]",i.undo="button[data-action=undo]",i.delete="button[data-action=delete]",i.massUndo="button[data-multi-record-selection-action=massundo]",i.massDelete="button[data-multi-record-selection-action=massdelete]"})(s||(s={}));class P{constructor(){this.paging={currentPage:1,totalPages:1,totalItems:0,itemsPerPage:parseInt(TYPO3.settings.Recycler.pagingSize,10)},this.markedRecordsForMassAction=[],this.progressBar=null,v.ready().then(()=>{this.initialize()})}static refreshPageTree(){top.document.dispatchEvent(new CustomEvent("typo3:pagetree:refresh"))}getProgress(){return(!this.progressBar||!this.progressBar.isConnected)&&(this.progressBar=document.createElement("typo3-backend-progress-bar"),document.querySelector(s.recyclerTable).prepend(this.progressBar)),this.progressBar}registerEvents(){new d("submit",e=>{e.preventDefault(),document.querySelector(s.searchText).value!==""&&this.loadDeletedElements()}).delegateTo(document,s.searchForm),new d("input",(e,t)=>{const l=document.querySelector(s.searchSubmitBtn);t.value!==""?l.disabled=!1:(l.disabled=!0,this.loadDeletedElements())}).delegateTo(document,s.searchText),new d("change",()=>{this.loadAvailableTables().then(()=>{this.loadDeletedElements()})}).delegateTo(document,s.depthSelector),new d("change",()=>{this.paging.currentPage=1,this.loadDeletedElements()}).delegateTo(document,s.tableSelector),new d("click",this.undoRecord.bind(this)).delegateTo(document,s.undo),new d("click",this.deleteRecord.bind(this)).delegateTo(document,s.delete),new d("click",e=>{e.preventDefault(),this.loadAvailableTables().then(()=>{this.loadDeletedElements()})}).delegateTo(document,s.reloadAction),new d("search",(e,t)=>{if(t.value===""){const l=document.querySelector(s.searchSubmitBtn);l.disabled=!0,this.loadDeletedElements()}}).delegateTo(document,s.searchText),new d("click",e=>{e.preventDefault();const t=e.target.closest("button");t&&(t.dataset.action==="previous"?this.paging.currentPage>1&&this.paging.currentPage--:t.dataset.action==="next"?this.paging.currentPage<this.paging.totalPages&&this.paging.currentPage++:t.dataset.action==="page"&&(this.paging.currentPage=parseInt(t.querySelector("span").textContent,10)),this.loadDeletedElements())}).delegateTo(document,s.paginator),new d("multiRecordSelection:checkbox:state:changed",this.handleCheckboxStateChanged.bind(this)).bindTo(document),new d("multiRecordSelection:action:massundo",this.undoRecord.bind(this)).bindTo(document),new d("multiRecordSelection:action:massdelete",this.deleteRecord.bind(this)).bindTo(document)}initialize(){this.registerEvents(),TYPO3.settings.Recycler.depthSelection>0&&(document.querySelector(s.depthSelector).value=String(TYPO3.settings.Recycler.depthSelection)),this.loadAvailableTables().then(()=>{this.loadDeletedElements()})}handleCheckboxStateChanged(e){const t=e.target,l=t.closest("tr"),r=l.dataset.table,o=l.dataset.uid,n=r+":"+o;if(t.checked)this.markedRecordsForMassAction.push(n);else{const a=this.markedRecordsForMassAction.indexOf(n);a>-1&&this.markedRecordsForMassAction.splice(a,1)}if(this.markedRecordsForMassAction.length>0){const a=document.querySelector(s.massUndo);if(a.querySelector("span.text").textContent=this.createMessage(TYPO3.lang["button.undoselected"],[this.markedRecordsForMassAction.length.toString(10)]),!TYPO3.settings.Recycler.deleteDisable){const c=document.querySelector(s.massDelete);c.querySelector("span.text").textContent=this.createMessage(TYPO3.lang["button.deleteselected"],[this.markedRecordsForMassAction.length.toString(10)])}}else this.resetMassActionButtons()}resetMassActionButtons(){const e=document.querySelector(s.massUndo);if(this.markedRecordsForMassAction=[],e.querySelector("span.text").textContent=TYPO3.lang["button.undo"],!TYPO3.settings.Recycler.deleteDisable){const t=document.querySelector(s.massDelete);t.querySelector("span.text").textContent=TYPO3.lang["button.delete"]}document.dispatchEvent(new CustomEvent("multiRecordSelection:actions:hide"))}async loadAvailableTables(){const e=document.querySelector(s.tableSelector),t=document.querySelector(s.depthSelector);return this.getProgress().start(),e.value="",this.paging.currentPage=1,new f(TYPO3.settings.ajaxUrls.recycler).withQueryArguments({action:"getTables",startUid:TYPO3.settings.Recycler.startUid,depth:t.value}).get().then(async l=>{const r=await l.resolve(),o=[];e.replaceChildren();for(const n of r){const a=n[0],c=n[1],u=(n[2]?n[2]:TYPO3.lang.label_allrecordtypes)+" ("+c+")",g=document.createElement("option");g.value=a,g.textContent=u,o.push(g)}return o.length>0&&(e.append(...o),TYPO3.settings.Recycler.tableSelection!==""&&(e.value=TYPO3.settings.Recycler.tableSelection)),l}).finally(()=>{this.progressBar&&this.progressBar.done()})}async loadDeletedElements(){const e=document.querySelector(s.depthSelector),t=document.querySelector(s.tableSelector),l=document.querySelector(s.searchText);return this.getProgress().start(),this.resetMassActionButtons(),new f(TYPO3.settings.ajaxUrls.recycler).withQueryArguments({action:"getDeletedRecords",depth:e.value,startUid:TYPO3.settings.Recycler.startUid,table:t.value,filterTxt:l.value,start:(this.paging.currentPage-1)*this.paging.itemsPerPage,limit:this.paging.itemsPerPage}).get().then(async r=>{const o=document.querySelector(s.recyclerTable),n=o.querySelector("tbody"),a=await r.resolve();if(a.totalItems===0){if(o.parentElement.querySelector("#no-recycler-records")===null){const c=document.createElement("typo3-backend-alert");c.id="no-recycler-records",c.severity=T.info,c.message=TYPO3.lang["alert.noDeletedRecords"],c.showIcon=!0,o.parentElement.insertBefore(c,o)}}else o.parentElement.querySelector("#no-recycler-records")?.remove(),n.innerHTML=a.rows;return o.toggleAttribute("hidden",a.totalItems===0),this.buildPaginator(a.totalItems),r}).finally(()=>{this.progressBar&&this.progressBar.done()})}deleteRecord(e,t){if(TYPO3.settings.Recycler.deleteDisable)return;const r=(t||e.target).closest("tr"),o=r===null||r.parentElement.tagName!=="TBODY";let n,a;if(o)n=this.markedRecordsForMassAction,a=TYPO3.lang["modal.massdelete.text"];else{const c=r.dataset.uid,m=r.dataset.table,u=r.dataset.recordtitle;n=[m+":"+c],a=m==="pages"?TYPO3.lang["modal.deletepage.text"]:TYPO3.lang["modal.deletecontent.text"],a=this.createMessage(a,[u,"["+n[0]+"]"])}y.advanced({title:TYPO3.lang["modal.delete.header"],content:a,severity:T.error,staticBackdrop:!0,buttons:[{text:TYPO3.lang["button.cancel"],btnClass:"btn-default",trigger:function(){y.dismiss()}},{text:TYPO3.lang["button.delete"],btnClass:"btn-danger",action:new S(()=>{this.callAjaxAction("delete",n,o)})}]})}undoRecord(e,t){const r=(t||e.target).closest("tr"),o=r===null||r.parentElement.tagName!=="TBODY";let n,a,c;if(o)n=this.markedRecordsForMassAction,a=TYPO3.lang["modal.massundo.text"],c=!0;else{const u=r.dataset.uid,g=r.dataset.table,h=r.dataset.recordtitle;n=[g+":"+u],c=g==="pages",a=c?TYPO3.lang["modal.undopage.text"]:TYPO3.lang["modal.undocontent.text"],a=this.createMessage(a,[h,"["+n[0]+"]"]),c&&r.dataset.parentDeleted&&(a+=TYPO3.lang["modal.undo.parentpages"])}let m=null;if(c){const u=document.createElement("div"),g=document.createElement("p");g.textContent=a;const h=document.createElement("div");h.classList.add("form-check");const p=document.createElement("input");p.type="checkbox",p.id="undo-recursive",p.classList.add("form-check-input");const b=document.createElement("label");b.classList.add("form-check-label"),b.htmlFor="undo-recursive",b.textContent=TYPO3.lang["modal.undo.recursive"],h.append(p,b),u.append(g,h),m=u}else{const u=document.createElement("p");u.textContent=a,m=u}y.advanced({title:TYPO3.lang["modal.undo.header"],content:m,severity:T.ok,staticBackdrop:!0,buttons:[{text:TYPO3.lang["button.cancel"],btnClass:"btn-default",trigger:function(){y.dismiss()}},{text:TYPO3.lang["button.undo"],btnClass:"btn-success",action:new S(()=>{this.callAjaxAction("undo",typeof n=="object"?n:[n],o,m.querySelector("#undo-recursive")?.checked)})}]})}async callAjaxAction(e,t,l,r=!1){const o={records:t,action:""};let n=!1;if(e==="undo")o.action="undoRecords",o.recursive=r?1:0,n=!0;else if(e==="delete")o.action="deleteRecords";else return null;return this.getProgress().start(),new f(TYPO3.settings.ajaxUrls.recycler).post(o).then(async a=>{const c=await a.resolve();return c.success?x.success("",c.message):x.error("",c.message),this.paging.currentPage=1,this.loadAvailableTables().then(()=>{this.loadDeletedElements(),l&&this.resetMassActionButtons(),n&&P.refreshPageTree()}),a})}createMessage(e,t){return typeof e>"u"?"":e.replace(/\{([0-9]+)\}/g,function(l,r){return t[r]})}buildPaginator(e){const t=document.querySelector(s.paginator);if(e===0){t.replaceChildren();return}if(this.paging.totalItems=e,this.paging.totalPages=Math.ceil(e/this.paging.itemsPerPage),this.paging.totalPages===1){t.replaceChildren();return}const l=document.createElement("typo3-backend-pagination");l.paging=this.paging,t.replaceChildren(l)}}var R=new P;export{R as default};
