/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import AjaxRequest from"@typo3/core/ajax/ajax-request.js";import"@typo3/backend/element/spinner-element.js";import Viewport from"@typo3/backend/viewport.js";import{ModuleStateStorage}from"@typo3/backend/storage/module-state-storage.js";import{Sizes}from"@typo3/backend/enum/icon-types.js";import RegularEvent from"@typo3/core/event/regular-event.js";var Selectors;!function(e){e.containerSelector="#typo3-cms-opendocs-backend-toolbaritems-opendocstoolbaritem",e.closeSelector=".t3js-topbar-opendocs-close",e.menuContainerSelector=".dropdown-menu",e.toolbarIconSelector=".toolbar-item-icon .t3js-icon",e.counterSelector="#tx-opendocs-counter",e.entrySelector=".t3js-open-doc"}(Selectors||(Selectors={}));class OpendocsMenu{constructor(){this.hashDataAttributeName="opendocsidentifier",document.addEventListener("typo3:opendocs:updateRequested",(()=>this.updateMenu())),Viewport.Topbar.Toolbar.registerEvent((()=>{this.initializeEvents(),this.updateMenu()}))}static updateNumberOfDocs(){const e=document.querySelector(Selectors.containerSelector),t=document.querySelector(Selectors.counterSelector);let o=parseInt(e.querySelector("[data-open-docs]")?.dataset.openDocs,10);isNaN(o)&&(o=0),t.textContent=o.toString(),t.classList.toggle("hidden",0===o)}updateMenu(){const e=document.querySelector(Selectors.containerSelector+" "+Selectors.toolbarIconSelector),t=e.cloneNode(!0),o=document.createElement("typo3-backend-spinner");o.setAttribute("size",Sizes.small),e.replaceWith(o),new AjaxRequest(TYPO3.settings.ajaxUrls.opendocs_menu).get().then((async e=>{document.querySelector(Selectors.containerSelector+" "+Selectors.menuContainerSelector).innerHTML=await e.resolve(),OpendocsMenu.updateNumberOfDocs()})).finally((()=>{document.querySelector(Selectors.containerSelector+" typo3-backend-spinner").replaceWith(t)}))}initializeEvents(){const e=document.querySelector(Selectors.containerSelector);new RegularEvent("click",((e,t)=>{e.preventDefault(),e.stopImmediatePropagation();const o=t.dataset[this.hashDataAttributeName];this.closeDocument(o)})).delegateTo(e,Selectors.closeSelector),new RegularEvent("click",((e,t)=>{e.preventDefault(),ModuleStateStorage.updateWithCurrentMount("web",t.dataset.pid,!0);document.querySelector("typo3-backend-module-router").setAttribute("endpoint",t.getAttribute("href"))})).delegateTo(e,Selectors.entrySelector)}closeDocument(e){const t={};e&&(t.md5sum=e),new AjaxRequest(TYPO3.settings.ajaxUrls.opendocs_closedoc).post(t).then((async e=>{document.querySelector(Selectors.containerSelector).querySelector(Selectors.menuContainerSelector).innerHTML=await e.resolve(),OpendocsMenu.updateNumberOfDocs()}))}}export default new OpendocsMenu;